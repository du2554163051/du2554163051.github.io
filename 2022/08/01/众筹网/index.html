<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>众筹网 | dwjBlog</title>
  <meta name="keywords" content=" java , SSM ">
  <meta name="description" content="众筹网 | dwjBlog">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="Spring5框架1、Spring框架概述 Spring是轻量级的开源的JavaEE框架  spring可以解决企业应用开发的复杂性  Spring有两个核心部分:IOC和Aop    IOC:控制反转，把创建对象的过程交给Spring进行管理  Aop：面向切面，不修改源代码进行功能的增强    Spring的特点   方便解耦，简化开发 Aop 编程支持 方便程序测试 方便和其他框架进行整合">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring5">
<meta property="og:url" content="http://example.com/2022/07/05/Spring5/index.html">
<meta property="og:site_name" content="dwjBlog">
<meta property="og:description" content="Spring5框架1、Spring框架概述 Spring是轻量级的开源的JavaEE框架  spring可以解决企业应用开发的复杂性  Spring有两个核心部分:IOC和Aop    IOC:控制反转，把创建对象的过程交给Spring进行管理  Aop：面向切面，不修改源代码进行功能的增强    Spring的特点   方便解耦，简化开发 Aop 编程支持 方便程序测试 方便和其他框架进行整合">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-07-05T08:06:32.000Z">
<meta property="article:modified_time" content="2022-07-22T07:46:42.608Z">
<meta property="article:author" content="杜文杰">
<meta property="article:tag" content="后端">
<meta property="article:tag" content="spring5">
<meta property="article:tag" content="SSM">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/github.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 6.2.0"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/avatar.jpg"/>
</a>
<div class="author">
    <span>杜文杰</span>
</div>

<div class="icon">
    
        
            <a title="rss"
               href="/atom.xml"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-rss"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="github"
               href="https://github.com/du2554163051"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
    
        
    
        
            <a title="reddit"
               href="https://www.reddit.com/user/yelog/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-reddit"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="weibo"
               href="http://weibo.com/u/2307534817"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-weibo"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="oschina"
               href="https://my.oschina.net/yelog"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-oschina"></use>
                    </svg>
                
            </a>
        
    
        
    
        
            <a title="email"
               href="mailto:2554163051@qq.com"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-email"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="qq"
               href="http://wpa.qq.com/msgrd?v=3&uin=2554163051&site=qq&menu=yes"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-qq"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="kugou"
               href="https://www.kugou.com/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-kugou"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="neteasemusic"
               href="https://music.163.com/#/user/home?id=88151013"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-neteasemusic"></use>
                    </svg>
                
            </a>
        
    
</div>




<ul>
    <li>
        <div class="all active" data-rel="All">All
            
                <small>(6)</small>
            
        </div>
    </li>
    
        
            
                <li>
                    <div data-rel="算法">
                        
                        算法
                        <small>(1)</small>
                        
                    </div>
                    
                </li>
            
        
    
        
            
                <li>
                    <div data-rel="后端">
                        
                        后端
                        <small>(5)</small>
                        
                    </div>
                    
                </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">About</a>
        
        <a style="width: 50%"
                
                                           class="friends">Friends</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="6">
<input type="hidden" id="yelog_site_word_count" value="82.6k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        Links
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">叶落阁</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">All</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>java</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>MyBatis</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>spring5</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>SSM</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>后端</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>开始</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>算法</a>
            </li>
        
    </div>

</div>

    
    <div id="local-search-result">

    </div>
    
    <nav id="title-list-nav">
        
        
        <a  class="All 后端 "
           href="/2022/08/01/%E4%BC%97%E7%AD%B9%E7%BD%91/"
           data-tag="java,SSM"
           data-author="" >
            <span class="post-title" title="众筹网">众筹网</span>
            <span class="post-date" title="2022-08-01 10:39:49">2022/08/01</span>
        </a>
        
        
        <a  class="All 后端 "
           href="/2022/07/14/MyBatis/"
           data-tag="后端,SSM,MyBatis"
           data-author="" >
            <span class="post-title" title="MyBatis">MyBatis</span>
            <span class="post-date" title="2022-07-14 18:14:12">2022/07/14</span>
        </a>
        
        
        <a  class="All 后端 "
           href="/2022/07/05/Spring5/"
           data-tag="后端,spring5,SSM"
           data-author="" >
            <span class="post-title" title="Spring5">Spring5</span>
            <span class="post-date" title="2022-07-05 16:06:32">2022/07/05</span>
        </a>
        
        
        <a  class="All 后端 "
           href="/2022/07/05/%E6%88%91%E7%9A%84%E7%AC%AC%E4%B8%80%E7%AF%87%E5%8D%9A%E5%AE%A2/"
           data-tag="开始"
           data-author="" >
            <span class="post-title" title="我的第一篇博客">我的第一篇博客</span>
            <span class="post-date" title="2022-07-05 14:23:41">2022/07/05</span>
        </a>
        
        
        <a  class="All 算法 "
           href="/2022/05/05/%E7%AE%97%E6%B3%95/"
           data-tag="算法"
           data-author="" >
            <span class="post-title" title="数组">数组</span>
            <span class="post-date" title="2022-05-05 14:47:21">2022/05/05</span>
        </a>
        
        
        <a  class="All 后端 "
           href="/2022/03/07/Java%E5%AD%A6%E4%B9%A0/"
           data-tag="java"
           data-author="" >
            <span class="post-title" title="Java语言学习">Java语言学习</span>
            <span class="post-date" title="2022-03-07 10:19:54">2022/03/07</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-众筹网" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">众筹网</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="后端">后端</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color5">java</a>
            
            <a class="color4">SSM</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            Created At : <time class="date" title='Updated At: 2022-08-20 09:35:31'>2022-08-01 10:39</time>
        
    </div>
    <div class="article-meta">
        
        <span>Count:56.6k</span>
        
        
        <span id="busuanzi_container_page_pv">
            Views 👀 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="toc-text">项目介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E6%90%AD%E5%BB%BA"><span class="toc-text">一、项目结构搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9E%84%E5%BB%BA%E4%B8%8E%E9%80%86%E5%90%91"><span class="toc-text">二、数据库构建与逆向</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%BB%BA%E8%A1%A8%EF%BC%9A"><span class="toc-text">1、建表：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%9C%A8reverse%E6%A8%A1%E5%9D%97%E4%B8%AD%E8%BF%9B%E8%A1%8C%E9%80%86%E5%90%91%EF%BC%9A"><span class="toc-text">2、在reverse模块中进行逆向：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E3%80%81pom-xml%E4%B8%AD%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">1）、pom.xml中导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E3%80%81%E7%BC%96%E5%86%99generatorConfig-xml%E6%96%87%E4%BB%B6"><span class="toc-text">2）、编写generatorConfig.xml文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%80%9A%E8%BF%87%E7%88%B6%E5%B7%A5%E7%A8%8B%E7%AE%A1%E7%90%86%E4%BE%9D%E8%B5%96%E7%89%88%E6%9C%AC"><span class="toc-text">三、通过父工程管理依赖版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Spring%E6%95%B4%E5%90%88MyBatis"><span class="toc-text">四、Spring整合MyBatis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E9%85%8D%E7%BD%AEMaven%E4%BE%9D%E8%B5%96"><span class="toc-text">1、配置Maven依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%B5%8B%E8%AF%95%E6%95%B4%E5%90%88%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F"><span class="toc-text">2、测试整合是否成功</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E9%85%8D%E7%BD%AE%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F"><span class="toc-text">五、配置日志系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%9C%A8component%E4%B8%AD%E5%A2%9E%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-text">1、在component中增加依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E4%BD%BF%E7%94%A8%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-text">2、使用日志打印的方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E9%85%8D%E7%BD%AE%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-text">六、配置声明式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%89%80%E4%BE%9D%E8%B5%96%E7%9A%84%E5%8C%85"><span class="toc-text">1、声明式事务所依赖的包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E9%85%8D%E7%BD%AE%E9%92%88%E5%AF%B9%E4%BA%8B%E5%8A%A1%E7%9A%84Spring%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">2、配置针对事务的Spring配置文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E8%A1%A8%E8%BF%B0%E5%B1%82%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">七、表述层环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E9%85%8D%E7%BD%AEweb-xml"><span class="toc-text">1、配置web.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E9%85%8D%E7%BD%AESpringMVC%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">2、配置SpringMVC配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%B5%8B%E8%AF%95SSM%E6%95%B4%E5%90%88%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F"><span class="toc-text">3、测试SSM整合是否成功</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81SpringMVC%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84Ajax%E8%AF%B7%E6%B1%82"><span class="toc-text">八、SpringMVC环境下的Ajax请求</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E5%90%8E%E7%AB%AF%E8%BF%94%E5%9B%9E%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F"><span class="toc-text">统一后端返回数据格式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-text">九、异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%98%A0%E5%B0%84%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-text">异常映射实现的方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%80%9A%E8%BF%87XML%E9%85%8D%E7%BD%AE%E5%AE%9E%E7%8E%B0"><span class="toc-text">一、通过XML配置实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E9%80%9A%E8%BF%87%E6%B3%A8%E8%A7%A3%E5%AE%9E%E7%8E%B0"><span class="toc-text">二、通过注解实现</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E4%BB%A5%E5%B8%B8%E9%87%8F%E7%AE%A1%E7%90%86%E5%B8%B8%E7%94%A8%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-text">十、以常量管理常用的属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E5%BC%95%E5%85%A5"><span class="toc-text">十一、前端页面引入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%85%A5%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2"><span class="toc-text">引入登录页面</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E5%A5%87%E6%80%AA%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-text">遇到的奇怪的问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E4%BD%BF%E7%94%A8layer%E5%BC%B9%E5%B1%82%E7%BB%84%E4%BB%B6"><span class="toc-text">尝试使用layer弹层组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E9%A5%B0%E9%94%99%E8%AF%AF%E9%A1%B5%E9%9D%A2"><span class="toc-text">修饰错误页面</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E5%91%98%E7%99%BB%E5%BD%95%E4%B8%8E%E7%BB%B4%E6%8A%A4"><span class="toc-text">管理员登录与维护</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E7%AE%A1%E7%90%86%E5%91%98%E7%99%BB%E9%99%86"><span class="toc-text">一、管理员登陆</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E3%80%81MD5%E5%8A%A0%E5%AF%86"><span class="toc-text">1）、MD5加密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E3%80%81%E5%88%A4%E6%96%AD%E7%99%BB%E5%BD%95%E6%98%AF%E5%90%A6%E6%88%90%E5%8A%9F"><span class="toc-text">2）、判断登录是否成功</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%BC%89%E3%80%81%E6%8A%BD%E5%8F%96%E5%90%8E%E5%8F%B0%E5%85%AC%E5%85%B1%E9%A1%B5%E9%9D%A2"><span class="toc-text">3）、抽取后台公共页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%EF%BC%89%E3%80%81%E5%AF%B9%E7%99%BB%E5%BD%95%E7%8A%B6%E6%80%81%E8%BF%9B%E8%A1%8C%E6%A3%80%E6%9F%A5"><span class="toc-text">4）、对登录状态进行检查</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%AE%A1%E7%90%86%E5%91%98%E7%BB%B4%E6%8A%A4"><span class="toc-text">二、管理员维护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E3%80%81%E5%88%86%E9%A1%B5%E6%98%BE%E7%A4%BA%E4%BF%A1%E6%81%AF"><span class="toc-text">1）、分页显示信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">①引入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-text">②后端代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A2%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-text">③前端代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E3%80%81%E5%AE%9E%E7%8E%B0%E5%85%B3%E9%94%AE%E5%AD%97%E6%9F%A5%E8%AF%A2"><span class="toc-text">2）、实现关键字查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%BC%89%E3%80%81%E5%88%A0%E9%99%A4%E7%AE%A1%E7%90%86%E5%91%98"><span class="toc-text">3）、删除管理员</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-text">①后端代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-text">②前端代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%EF%BC%89%E3%80%81%E5%A2%9E%E5%8A%A0%E7%AE%A1%E7%90%86%E5%91%98"><span class="toc-text">4）、增加管理员</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-text"></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="toc-text">①数据库操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81%EF%BC%9A"><span class="toc-text">②前端代码：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A2%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-text">③后端代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%EF%BC%89%E3%80%81%E6%9B%B4%E6%96%B0%E7%AE%A1%E7%90%86%E5%91%98%E4%BF%A1%E6%81%AF"><span class="toc-text">5）、更新管理员信息</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E3%80%90%E8%A7%92%E8%89%B2%E7%BB%B4%E6%8A%A4%E3%80%91%E9%A1%B5%E9%9D%A2"><span class="toc-text">【角色维护】页面</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%88%86%E9%A1%B5%E6%93%8D%E4%BD%9C"><span class="toc-text">一、分页操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87"><span class="toc-text">目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-text">代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%85%B3%E9%94%AE%E5%AD%97%E6%9F%A5%E8%AF%A2"><span class="toc-text">二、关键字查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87-1"><span class="toc-text">目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-1"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-1"><span class="toc-text">代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E4%BF%9D%E5%AD%98%E8%A7%92%E8%89%B2"><span class="toc-text">三、保存角色</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87-2"><span class="toc-text">目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-2"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-2"><span class="toc-text">代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%9B%B4%E6%96%B0%E8%A7%92%E8%89%B2"><span class="toc-text">四、更新角色</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87-3"><span class="toc-text">目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-3"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-3"><span class="toc-text">代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%88%A0%E9%99%A4%E8%A7%92%E8%89%B2"><span class="toc-text">五、删除角色</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87-4"><span class="toc-text">目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-4"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-4"><span class="toc-text">代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-text">准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%9B%E5%BB%BA%E8%8F%9C%E5%8D%95%E8%A1%A8%EF%BC%9A"><span class="toc-text">一、在数据库创建菜单表：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B"><span class="toc-text">二、逆向工程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E9%A1%B5%E9%9D%A2%E6%98%BE%E7%A4%BA%E6%A0%91%E5%BD%A2%E7%BB%93%E6%9E%84"><span class="toc-text">在页面显示树形结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%90%8E%E7%AB%AF%E6%93%8D%E4%BD%9C"><span class="toc-text">一、后端操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%89%8D%E7%AB%AF%E6%93%8D%E4%BD%9C"><span class="toc-text">二、前端操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%80%90%E6%B7%BB%E5%8A%A0%E5%AD%90%E8%8A%82%E7%82%B9%E3%80%91%E6%8C%89%E9%92%AE"><span class="toc-text">【添加子节点】按钮</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87%EF%BC%9A"><span class="toc-text">目标：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%EF%BC%9A"><span class="toc-text">思路：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%EF%BC%9A"><span class="toc-text">代码：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81%EF%BC%9A"><span class="toc-text">后端代码：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81%EF%BC%9A"><span class="toc-text">前端代码：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%80%90%E4%BF%AE%E6%94%B9%E8%8A%82%E7%82%B9%E3%80%91%E6%8C%89%E9%92%AE"><span class="toc-text">【修改节点】按钮</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87%EF%BC%9A-1"><span class="toc-text">目标：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%EF%BC%9A-1"><span class="toc-text">思路：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%EF%BC%9A-1"><span class="toc-text">代码：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81%EF%BC%9A-1"><span class="toc-text">后端代码：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81%EF%BC%9A-1"><span class="toc-text">前端代码：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E3%80%90%E5%88%A0%E9%99%A4%E8%8A%82%E7%82%B9%E3%80%91%E6%8C%89%E9%92%AE"><span class="toc-text">【删除节点】按钮</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87%EF%BC%9A-2"><span class="toc-text">目标：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%EF%BC%9A-2"><span class="toc-text">思路：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%EF%BC%9A-2"><span class="toc-text">代码：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81%EF%BC%9A-2"><span class="toc-text">后端代码：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81%EF%BC%9A-2"><span class="toc-text">前端代码：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%EF%BC%9A"><span class="toc-text">注意：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D"><span class="toc-text">权限分配</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E7%BB%99Admin%E5%88%86%E9%85%8DRole"><span class="toc-text">一、给Admin分配Role</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87-5"><span class="toc-text">目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-5"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-5"><span class="toc-text">代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E3%80%81%E5%88%9B%E5%BB%BA%E5%85%B3%E8%81%94%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8"><span class="toc-text">1）、创建关联数据库表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81"><span class="toc-text">2）、前后端代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%BB%99Role%E5%88%86%E9%85%8DAuth"><span class="toc-text">二、给Role分配Auth</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87-6"><span class="toc-text">目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-6"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-6"><span class="toc-text">代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E3%80%81%E5%87%86%E5%A4%87%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8"><span class="toc-text">1）、准备数据库表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E3%80%81%E5%89%8D%E5%90%8E%E7%AB%AF%E4%BB%A3%E7%A0%81-1"><span class="toc-text">2）、前后端代码</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E6%A0%91%E5%BD%A2%E7%BB%93%E6%9E%84"><span class="toc-text">显示树形结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E9%85%8D%E6%9D%83%E9%99%90%E5%8A%9F%E8%83%BD"><span class="toc-text">分配权限功能</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9C%A8%E9%A1%B9%E7%9B%AE%E4%B8%AD%E5%8A%A0%E5%85%A5SpringSecurity"><span class="toc-text">在项目中加入SpringSecurity</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%8A%A0%E5%85%A5SpringSecurity%E7%8E%AF%E5%A2%83"><span class="toc-text">一、加入SpringSecurity环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E3%80%81%E5%8A%A0%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">1）、加入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E3%80%81%E5%9C%A8web-xml%E4%B8%AD%E9%85%8D%E7%BD%AE"><span class="toc-text">2）、在web.xml中配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%BC%89%E3%80%81%E5%88%9B%E5%BB%BA%E5%9F%BA%E4%BA%8E%E6%B3%A8%E8%A7%A3%E7%9A%84SpringSecurity%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-text">3）、创建基于注解的SpringSecurity配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%EF%BC%9A-1"><span class="toc-text">注意：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%9C%A8%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8SpringSecurity"><span class="toc-text">二、在项目中使用SpringSecurity</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%EF%BC%89%E3%80%81%E6%94%BE%E8%A1%8C%E7%99%BB%E5%BD%95%E9%A1%B5%E4%B8%8E%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90"><span class="toc-text">1）、放行登录页与静态资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%EF%BC%89%E3%80%81%E8%BF%9B%E8%A1%8C%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81"><span class="toc-text">2）、进行登录认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%EF%BC%89%E3%80%81%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86%E4%B8%8E%E6%93%A6%E9%99%A4"><span class="toc-text">3）、密码加密与擦除</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A0%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86"><span class="toc-text">①密码加密</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%91%A1%E5%AF%86%E7%A0%81%E6%93%A6%E9%99%A4"><span class="toc-text">②密码擦除</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%EF%BC%89%E3%80%81%E5%89%8D%E7%AB%AF%E6%98%BE%E7%A4%BA%E7%99%BB%E5%BD%95%E7%94%A8%E6%88%B7%E6%98%B5%E7%A7%B0"><span class="toc-text">4）、前端显示登录用户昵称</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%EF%BC%89%E3%80%81%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="toc-text">5）、权限控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A1%B5%E9%9D%A2%E5%85%83%E7%B4%A0%E7%9A%84%E6%9D%83%E9%99%90%E6%8E%A7%E5%88%B6"><span class="toc-text">页面元素的权限控制</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81Spring-Cloud%E5%9F%BA%E6%9C%AC%E7%BB%84%E4%BB%B6"><span class="toc-text">一、Spring Cloud基本组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-text">原理：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%90%84%E6%9C%8D%E5%8A%A1%E5%85%B7%E4%BD%93%E9%85%8D%E7%BD%AE%E5%86%85%E5%AE%B9"><span class="toc-text">二、各服务具体配置内容</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Eureka"><span class="toc-text">Eureka</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%9A"><span class="toc-text">服务端：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%9A"><span class="toc-text">客户端：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Feign"><span class="toc-text">Feign</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E6%8E%A5%E5%8F%A3"><span class="toc-text">统一接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95"><span class="toc-text">远程方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Consumer"><span class="toc-text">Consumer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hystrix"><span class="toc-text">Hystrix</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%86%94%E6%96%AD%EF%BC%9A"><span class="toc-text">熔断：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%8D%E7%BA%A7%EF%BC%9A"><span class="toc-text">降级：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7"><span class="toc-text">监控</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zuul"><span class="toc-text">Zuul</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ZuulFilter"><span class="toc-text">ZuulFilter</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E5%8F%B0%E4%BC%9A%E5%91%98%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc-text">前台会员系统架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="toc-text">架构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E5%88%9B%E5%BB%BA%E7%9A%84%E5%B7%A5%E7%A8%8B"><span class="toc-text">需要创建的工程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#parent%E5%B7%A5%E7%A8%8B%E7%BA%A6%E5%AE%9A%E7%89%88%E6%9C%AC%E5%8F%B7"><span class="toc-text">parent工程约定版本号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83%E7%BA%A6%E5%AE%9A"><span class="toc-text">搭建环境约定</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%9A%84%E5%90%84%E4%B8%AA%E5%B7%A5%E7%A8%8B"><span class="toc-text">分布式的各个工程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81Eureka"><span class="toc-text">1、Eureka</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81Entity"><span class="toc-text">2、Entity</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81MySQL"><span class="toc-text">3、MySQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2%E6%9C%8D%E5%8A%A1"><span class="toc-text">MySQL对外暴露服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81Redis"><span class="toc-text">4、Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2%E6%9C%8D%E5%8A%A1"><span class="toc-text">Redis对外暴露服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E8%AE%A4%E8%AF%81%E9%A1%B5%E9%9D%A2%E5%B7%A5%E7%A8%8B"><span class="toc-text">5、认证页面工程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81Zuul%E7%BD%91%E5%85%B3"><span class="toc-text">6、Zuul网关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87-7"><span class="toc-text">目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%9C%A8%E9%98%BF%E9%87%8C%E4%BA%91%E5%B8%82%E5%9C%BA%E8%B4%AD%E4%B9%B0%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-text">1、在阿里云市场购买短信验证码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%B0%86%E8%AF%A5API%E5%9C%A8%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8"><span class="toc-text">2、将该API在项目中使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%9A%E5%91%98%E7%99%BB%E5%BD%95"><span class="toc-text">会员登录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E7%9A%84%E7%99%BB%E5%BD%95%E6%93%8D%E4%BD%9C"><span class="toc-text">初始的登录操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%80%E5%87%BA%E7%99%BB%E9%99%86"><span class="toc-text">退出登陆</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Session%E5%85%B1%E4%BA%AB"><span class="toc-text">Session共享</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81%E6%93%8D%E4%BD%9C"><span class="toc-text">登录验证操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%A1%B9%E7%9B%AE%E4%B8%AD%E9%87%8D%E5%AE%9A%E5%90%91%E9%97%AE%E9%A2%98"><span class="toc-text">分布式项目中重定向问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ClassNotFound%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-text">ClassNotFound异常处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E8%B7%B3%E8%BD%AC%E5%88%B0%E5%8F%91%E8%B5%B7%E9%A1%B9%E7%9B%AE%E7%9A%84%E9%A1%B5%E9%9D%A2%EF%BC%9A"><span class="toc-text">从个人中心跳转到发起项目的页面：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E4%B8%8E%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD%E7%9A%84view-controller"><span class="toc-text">登录与注册功能的view-controller</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%A6%96%E9%A1%B5%E6%98%BE%E7%A4%BA%E9%A1%B9%E7%9B%AE%E6%95%B0%E6%8D%AE"><span class="toc-text">一、首页显示项目数据</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-text">1、创建实体类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E7%BC%96%E5%86%99SQL%E8%AF%AD%E5%8F%A5"><span class="toc-text">2、编写SQL语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2%E6%8E%A5%E5%8F%A3"><span class="toc-text">3、对外暴露接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E8%B0%83%E7%94%A8%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95"><span class="toc-text">4、调用远程方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E5%89%8D%E7%AB%AF%E6%98%BE%E7%A4%BA"><span class="toc-text">5、前端显示</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%98%BE%E7%A4%BA%E5%8D%95%E4%B8%AA%E9%A1%B9%E7%9B%AE%E8%AF%A6%E6%83%85"><span class="toc-text">二、显示单个项目详情</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BD%93%E7%B1%BB-1"><span class="toc-text">1、创建实体类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E7%BC%96%E5%86%99SQL%E8%AF%AD%E5%8F%A5-1"><span class="toc-text">2、编写SQL语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2%E6%8E%A5%E5%8F%A3-1"><span class="toc-text">3、对外暴露接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E8%B0%83%E7%94%A8%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95-1"><span class="toc-text">4、调用远程方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E5%89%8D%E7%AB%AF%E6%98%BE%E7%A4%BA-1"><span class="toc-text">5、前端显示</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%A6%96%E9%A1%B5%E6%98%BE%E7%A4%BA%E9%A1%B9%E7%9B%AE%E6%95%B0%E6%8D%AE-1"><span class="toc-text">一、首页显示项目数据</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BD%93%E7%B1%BB-2"><span class="toc-text">1、创建实体类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E7%BC%96%E5%86%99SQL%E8%AF%AD%E5%8F%A5-2"><span class="toc-text">2、编写SQL语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2%E6%8E%A5%E5%8F%A3-2"><span class="toc-text">3、对外暴露接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E8%B0%83%E7%94%A8%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95-2"><span class="toc-text">4、调用远程方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E5%89%8D%E7%AB%AF%E6%98%BE%E7%A4%BA-2"><span class="toc-text">5、前端显示</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%98%BE%E7%A4%BA%E5%8D%95%E4%B8%AA%E9%A1%B9%E7%9B%AE%E8%AF%A6%E6%83%85-1"><span class="toc-text">二、显示单个项目详情</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BD%93%E7%B1%BB-3"><span class="toc-text">1、创建实体类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E7%BC%96%E5%86%99SQL%E8%AF%AD%E5%8F%A5-3"><span class="toc-text">2、编写SQL语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2%E6%8E%A5%E5%8F%A3-3"><span class="toc-text">3、对外暴露接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E8%B0%83%E7%94%A8%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95-3"><span class="toc-text">4、调用远程方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%90%AD%E5%BB%BAorder-consumer%E7%8E%AF%E5%A2%83"><span class="toc-text">一、搭建order-consumer环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E4%BE%9D%E8%B5%96"><span class="toc-text">1、依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81application-yml"><span class="toc-text">2、application.yml</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%9C%A8Zuul%E4%B8%AD%E6%B7%BB%E5%8A%A0%E6%A8%A1%E5%9D%97"><span class="toc-text">3、在Zuul中添加模块</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%88%9B%E5%BB%BA%E5%AF%B9%E5%BA%94%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8"><span class="toc-text">二、创建对应数据库表</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%A1%B5%E9%9D%A2-%E7%A1%AE%E8%AE%A4%E5%9B%9E%E6%8A%A5%E5%86%85%E5%AE%B9"><span class="toc-text">三、页面-确认回报内容</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E8%B7%B3%E8%BD%AC%E5%88%B0%E7%A1%AE%E8%AE%A4%E5%9B%9E%E6%8A%A5%E9%A1%B5%E9%9D%A2"><span class="toc-text">1、跳转到确认回报页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95"><span class="toc-text">2、远程方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%89%8D%E5%8F%B0%E6%98%BE%E7%A4%BA"><span class="toc-text">3、前台显示</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E9%A1%B5%E9%9D%A2-%E7%A1%AE%E8%AE%A4%E8%AE%A2%E5%8D%95"><span class="toc-text">四、页面-确认订单</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E8%B7%B3%E8%BD%AC%E5%88%B0%E7%A1%AE%E8%AE%A4%E8%AE%A2%E5%8D%95%E7%9A%84%E9%A1%B5%E9%9D%A2"><span class="toc-text">1、跳转到确认订单的页面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%9C%A8%E7%A1%AE%E8%AE%A4%E8%AE%A2%E5%8D%95%E9%A1%B5%E9%9D%A2%E6%98%BE%E7%A4%BA%E9%9C%80%E8%A6%81%E7%9A%84%E6%95%B0%E6%8D%AE"><span class="toc-text">2、在确认订单页面显示需要的数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E6%94%B6%E8%B4%A7%E4%BF%A1%E6%81%AF"><span class="toc-text">显示收货信息</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-6 i,
    .toc-level-6 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h2><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h2 id="一、项目结构搭建"><a href="#一、项目结构搭建" class="headerlink" title="一、项目结构搭建"></a>一、项目结构搭建</h2><p>模块关系</p>
<pre><code>parent模块仅仅用来确定各个Maven依赖的版本

webui、component、entity模块继承自parent模块

util、reverse模块属于独立工程，不参与继承与聚合

且webui依赖于component，component依赖于entity、util。
</code></pre>
<p><img src="/images%5C%E9%A1%B9%E7%9B%AE%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB.png" alt="依赖结构"></p>
<pre><code>各个工程的打包方式：
</code></pre>
<pre><code class="xml">&lt;!--parent--&gt;
    &lt;groupId&gt;org.example&lt;/groupId&gt;
    &lt;artifactId&gt;crowdfunding01-admin-parent&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
&lt;packaging&gt;pom&lt;/packaging&gt;

&lt;!--webui--&gt;
    &lt;packaging&gt;war&lt;/packaging&gt;
&lt;!--其他的模块都是默认打包方式（jar）--&gt;
</code></pre>
<pre><code>IDEA中创建多模块工程：

    先创建一个Empty Project（空工程），创建完成后一个个添加各个Maven模块

    由于webui模块，需要打成war包，因此需要有web工程的目录结构，可以通过在Modules中添		加，产生对应的结构：
</code></pre>
<p><img src="/images%5C%E5%88%9B%E5%BB%BAweb.xml.png" alt="产生web.xml"></p>
<pre><code>    模块创建时应该选择好父模块
</code></pre>
<h2 id="二、数据库构建与逆向"><a href="#二、数据库构建与逆向" class="headerlink" title="二、数据库构建与逆向"></a>二、数据库构建与逆向</h2><h3 id="1、建表："><a href="#1、建表：" class="headerlink" title="1、建表："></a>1、建表：</h3><pre><code class="sql">CREATE DATABASE project_rowd CHARACTER SET utf8;

USE project_rowd;
drop table if exists t_admin;				# 如果存在t_admin则删除存在的表
    CREATE TABLE t_admin (
    id INT NOT NULL auto_increment,			# 主键
    login_acct VARCHAR ( 255 ) NOT NULL,	# 登录账号
    user_pswd CHAR ( 32 ) NOT NULL,			# 登录密码
    user_name VARCHAR ( 255 ) NOT NULL,		# 昵称
    email VARCHAR ( 255 ) NOT NULL,			# 邮件地址
    create_time CHAR ( 19 ),				# 创建时间
    PRIMARY KEY ( id ) 						# 设置主键
);
</code></pre>
<pre><code>进行基于Maven的逆向工程（根据已存在的表，在项目中逆向生成对应的实体类、Mapper文件、Mapper接口）
</code></pre>
<h3 id="2、在reverse模块中进行逆向："><a href="#2、在reverse模块中进行逆向：" class="headerlink" title="2、在reverse模块中进行逆向："></a>2、在reverse模块中进行逆向：</h3><h4 id="1）、pom-xml中导入依赖"><a href="#1）、pom-xml中导入依赖" class="headerlink" title="1）、pom.xml中导入依赖"></a>1）、pom.xml中导入依赖</h4><pre><code class="xml">&lt;!-- 控制Maven在构建过程中的相关配置 --&gt;
&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.mybatis.generator&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-generator-maven-plugin&lt;/artifactId&gt;
            &lt;version&gt;1.3.0&lt;/version&gt;

            &lt;dependencies&gt;
                &lt;!-- 逆向工程核心依赖 --&gt;
                &lt;dependency&gt;
                    &lt;groupId&gt;org.mybatis.generator&lt;/groupId&gt;
                    &lt;artifactId&gt;mybatis-generator-core&lt;/artifactId&gt;
                    &lt;version&gt;1.3.2&lt;/version&gt;
                &lt;/dependency&gt;
                &lt;dependency&gt;
                    &lt;groupId&gt;com.mchange&lt;/groupId&gt;
                    &lt;artifactId&gt;c3p0&lt;/artifactId&gt;
                    &lt;version&gt;0.9.2&lt;/version&gt;
                &lt;/dependency&gt;
                &lt;!--MySQL驱动--&gt;
                &lt;dependency&gt;
                    &lt;groupId&gt;mysql&lt;/groupId&gt;
                    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
                    &lt;version&gt;8.0.15&lt;/version&gt;
                &lt;/dependency&gt;
            &lt;/dependencies&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;
</code></pre>
<h4 id="2）、编写generatorConfig-xml文件"><a href="#2）、编写generatorConfig-xml文件" class="headerlink" title="2）、编写generatorConfig.xml文件"></a>2）、编写generatorConfig.xml文件</h4><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE generatorConfiguration
        PUBLIC &quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;&gt;

&lt;generatorConfiguration&gt;
    &lt;context id=&quot;atguiguTables&quot; targetRuntime=&quot;MyBatis3&quot;&gt;
        &lt;commentGenerator&gt;
            &lt;!-- 是否去除自动生成的注释 true：是 ： false:否 --&gt;
            &lt;property name=&quot;suppressAllComments&quot; value=&quot;true&quot; /&gt;
        &lt;/commentGenerator&gt;

        &lt;!-- 数据库链接URL、用户名、密码 --&gt;
        &lt;jdbcConnection
                driverClass=&quot;com.mysql.cj.jdbc.Driver&quot;
                connectionURL=&quot;jdbc:mysql://localhost:3306/project_rowd?serverTimezone=UTC&quot;
                userId=&quot;root&quot;
                password=&quot;root&quot;&gt;
        &lt;/jdbcConnection&gt;

        &lt;!--
        默认false，把JDBC DECIMAL 和 NUMERIC 类型解析为 Integer
            true，把JDBC DECIMAL 和 NUMERIC 类型解析为java.math.BigDecimal
        --&gt;
        &lt;javaTypeResolver&gt;
            &lt;property name=&quot;forceBigDecimals&quot; value=&quot;false&quot; /&gt;
        &lt;/javaTypeResolver&gt;

        &lt;!--
        生成model模型，对应的包路径，以及文件存放路径(targetProject)，targetProject可以指定具体的路径,如./src/main/java，
        也可以使用“MAVEN”来自动生成，这样生成的代码会在target/generatord-source目录下
        --&gt;
        &lt;!--&lt;javaModelGenerator targetPackage=&quot;com.joey.mybaties.test.pojo&quot; targetProject=&quot;MAVEN&quot;&gt;--&gt;
        &lt;javaModelGenerator targetPackage=&quot;crowd.entity&quot; targetProject=&quot;.\src\main\java&quot;&gt;
            &lt;!--是否让schema作为包的后缀--&gt;
            &lt;property name=&quot;enableSubPackages&quot; value=&quot;false&quot;/&gt;
            &lt;!-- 从数据库返回的值被清理前后的空格  --&gt;
            &lt;property name=&quot;trimStrings&quot; value=&quot;true&quot; /&gt;
        &lt;/javaModelGenerator&gt;

        &lt;!--对应的mapper.xml文件  --&gt;
        &lt;sqlMapGenerator targetPackage=&quot;mapper&quot; targetProject=&quot;.\src\main\java&quot;&gt;
            &lt;!--是否让schema作为包的后缀--&gt;
            &lt;property name=&quot;enableSubPackages&quot; value=&quot;false&quot;/&gt;
        &lt;/sqlMapGenerator&gt;

        &lt;!-- 对应的Mapper接口类文件 --&gt;
        &lt;javaClientGenerator type=&quot;XMLMAPPER&quot; targetPackage=&quot;org.fall.mapper&quot; targetProject=&quot;.\src\main\java&quot;&gt;
            &lt;!--是否让schema作为包的后缀--&gt;
            &lt;property name=&quot;enableSubPackages&quot; value=&quot;false&quot;/&gt;
        &lt;/javaClientGenerator&gt;

        &lt;!-- 数据库表名与需要的实体类对应映射的指定 --&gt;
        &lt;table tableName=&quot;t_admin&quot; domainObjectName=&quot;Admin&quot;/&gt;
    &lt;/context&gt;
&lt;/generatorConfiguration&gt;
</code></pre>
<pre><code>        在IDEA中进行逆向工程的方法：
</code></pre>
<p><img src="/images%5C%E8%BF%9B%E8%A1%8C%E9%80%86%E5%90%91.png" alt="逆向工程"></p>
<p>运行完后，应当对产生的所有文件各归各位（Mapper接口放入component的mapper包下；实体类放入entity模块的entity包；xxxMapper.xml放入webui的resources文件夹下<strong>（xml放在web模块下方便寻找）</strong>）</p>
<h2 id="三、通过父工程管理依赖版本"><a href="#三、通过父工程管理依赖版本" class="headerlink" title="三、通过父工程管理依赖版本"></a>三、通过父工程管理依赖版本</h2><p>在父工程通过<strong>dependencyManagement</strong>标签管理依赖版本，但是在子工程正式通过<strong>dependencies</strong>标签导入依赖前，这些依赖并不会生效</p>
<pre><code class="xml">&lt;!--通过properties标签指定一些需要重用的版本号，方便在后面调用--&gt;
&lt;properties&gt;
    &lt;fall.spring.version&gt;4.3.20.RELEASE&lt;/fall.spring.version&gt;
    &lt;fall.spring.security.version&gt;4.2.10.RELEASE&lt;/fall.spring.security.version&gt;
&lt;/properties&gt;

&lt;!--依赖管理--&gt;
&lt;dependencyManagement&gt;
    &lt;dependencies&gt;

        &lt;!-- Spring 依赖 --&gt;
        &lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-orm --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-orm&lt;/artifactId&gt;
            &lt;version&gt;$&#123;fall.spring.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-webmvc --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;
            &lt;version&gt;$&#123;fall.spring.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-test&lt;/artifactId&gt;
            &lt;version&gt;$&#123;fall.spring.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- Spring AOP --&gt;
        &lt;!-- https://mvnrepository.com/artifact/org.aspectj/aspectjweaver --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
            &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;
            &lt;version&gt;1.9.2&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- https://mvnrepository.com/artifact/cglib/cglib --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;cglib&lt;/groupId&gt;
            &lt;artifactId&gt;cglib&lt;/artifactId&gt;
            &lt;version&gt;2.2&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- 数据库依赖 --&gt;
        &lt;!-- MySQL 驱动 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;version&gt;8.0.15&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- 数据源 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;druid&lt;/artifactId&gt;
            &lt;version&gt;1.1.17&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- MyBatis --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mybatis&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis&lt;/artifactId&gt;
            &lt;version&gt;3.2.8&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- MyBatis 与 Spring 整合 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mybatis&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-spring&lt;/artifactId&gt;
            &lt;version&gt;1.2.2&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- MyBatis 分页插件 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;
            &lt;artifactId&gt;pagehelper&lt;/artifactId&gt;
            &lt;version&gt;4.0.0&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- 日志 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
            &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
            &lt;version&gt;1.7.7&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
            &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
            &lt;version&gt;1.2.3&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- 其他日志框架的中间转换包 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
            &lt;artifactId&gt;jcl-over-slf4j&lt;/artifactId&gt;
            &lt;version&gt;1.7.25&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
            &lt;artifactId&gt;jul-to-slf4j&lt;/artifactId&gt;
            &lt;version&gt;1.7.25&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- Spring 进行 JSON 数据转换依赖 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
            &lt;artifactId&gt;jackson-core&lt;/artifactId&gt;
            &lt;version&gt;2.11.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
            &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;
            &lt;version&gt;2.11.0&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- JSTL 标签库 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;jstl&lt;/groupId&gt;
            &lt;artifactId&gt;jstl&lt;/artifactId&gt;
            &lt;version&gt;1.2&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- junit 测试 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;junit&lt;/groupId&gt;
            &lt;artifactId&gt;junit&lt;/artifactId&gt;
            &lt;version&gt;4.12&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;!-- 引入 Servlet 容器中相关依赖 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;javax.servlet&lt;/groupId&gt;
            &lt;artifactId&gt;servlet-api&lt;/artifactId&gt;
            &lt;version&gt;2.5&lt;/version&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;!-- JSP 页面使用的依赖 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;javax.servlet.jsp&lt;/groupId&gt;
            &lt;artifactId&gt;jsp-api&lt;/artifactId&gt;
            &lt;version&gt;2.1.3-b06&lt;/version&gt;
            &lt;scope&gt;provided&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;!-- https://mvnrepository.com/artifact/com.google.code.gson/gson --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt;
            &lt;artifactId&gt;gson&lt;/artifactId&gt;
            &lt;version&gt;2.8.5&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- SpringSecurity 对 Web 应用进行权限管理 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
            &lt;artifactId&gt;spring-security-web&lt;/artifactId&gt;
            &lt;version&gt;$&#123;fall.spring.security.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- SpringSecurity 配置 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
            &lt;artifactId&gt;spring-security-config&lt;/artifactId&gt;
            &lt;version&gt;$&#123;fall.spring.security.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- SpringSecurity 标签库 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
            &lt;artifactId&gt;spring-security-taglibs&lt;/artifactId&gt;
            &lt;version&gt;$&#123;fall.spring.security.version&#125;&lt;/version&gt;
        &lt;/dependency&gt;

    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;
</code></pre>
<h2 id="四、Spring整合MyBatis"><a href="#四、Spring整合MyBatis" class="headerlink" title="四、Spring整合MyBatis"></a>四、Spring整合MyBatis</h2><h3 id="1、配置Maven依赖"><a href="#1、配置Maven依赖" class="headerlink" title="1、配置Maven依赖"></a>1、配置Maven依赖</h3><p>在<strong>component模块</strong>的pom.xml配置一些必要的依赖</p>
<pre><code class="xml">&lt;dependencies&gt;
    &lt;!--依赖entity--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.example&lt;/groupId&gt;
        &lt;artifactId&gt;crowdfunding04-admin-entity&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;!--依赖util--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.example&lt;/groupId&gt;
        &lt;artifactId&gt;crowdfunding05-common-util&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;!-- Spring 依赖 --&gt;
    &lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-orm --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework&lt;/groupId&gt;
        &lt;artifactId&gt;spring-orm&lt;/artifactId&gt;
        &lt;exclusions&gt;
            &lt;exclusion&gt;
                &lt;artifactId&gt;commons-logging&lt;/artifactId&gt;
                &lt;groupId&gt;commons-logging&lt;/groupId&gt;
            &lt;/exclusion&gt;
        &lt;/exclusions&gt;
    &lt;/dependency&gt;
    &lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-webmvc --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework&lt;/groupId&gt;
        &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- Spring AOP --&gt;
    &lt;!-- https://mvnrepository.com/artifact/org.aspectj/aspectjweaver --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
        &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- https://mvnrepository.com/artifact/cglib/cglib --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;cglib&lt;/groupId&gt;
        &lt;artifactId&gt;cglib&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;!-- 数据库依赖 --&gt;
    &lt;!-- MySQL 驱动 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;mysql&lt;/groupId&gt;
        &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- 数据源 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
        &lt;artifactId&gt;druid&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- MyBatis --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.mybatis&lt;/groupId&gt;
        &lt;artifactId&gt;mybatis&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- MyBatis 与 Spring 整合 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.mybatis&lt;/groupId&gt;
        &lt;artifactId&gt;mybatis-spring&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- MyBatis 分页插件 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;
        &lt;artifactId&gt;pagehelper&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- Spring 进行 JSON 数据转换依赖 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
        &lt;artifactId&gt;jackson-core&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
        &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;!-- JSTL 标签库 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;jstl&lt;/groupId&gt;
        &lt;artifactId&gt;jstl&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;!-- https://mvnrepository.com/artifact/com.google.code.gson/gson --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt;
        &lt;artifactId&gt;gson&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;junit&lt;/groupId&gt;
        &lt;artifactId&gt;junit&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework&lt;/groupId&gt;
        &lt;artifactId&gt;spring-test&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<pre><code>    **webui模块**配置依赖于component，并引入一些scope为test的依赖（如junit）
</code></pre>
<pre><code class="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.example&lt;/groupId&gt;
        &lt;artifactId&gt;crowdfunding03-admin-component&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;junit&lt;/groupId&gt;
        &lt;artifactId&gt;junit&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework&lt;/groupId&gt;
        &lt;artifactId&gt;spring-test&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<pre><code>2、创建各配置文件

    ①resources/mybatis/**mybatis-config.xml**（Mybatis配置文件，可以省略）
</code></pre>
<pre><code class="xml">    &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
    &lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0/EN&quot;
            &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;
    &lt;configuration&gt;
        &lt;!--Spring与MyBatis整合后，MyBatis的配置文件可有可不有--&gt;
    &lt;/configuration&gt;
</code></pre>
<pre><code>    ②resources/**spring-persist-mybatis.xml**（Spring配置文件，用于整合MyBatis）
</code></pre>
<pre><code class="xml">    &lt;!--引入properties文件--&gt;
    &lt;context:property-placeholder location=&quot;classpath:jdbc.properties&quot;/&gt;

    &lt;!--数据源配置--&gt;
    &lt;bean id=&quot;dataSource&quot; class=&quot;com.alibaba.druid.pool.DruidDataSource&quot;&gt;
        &lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.user&#125;&quot;/&gt;
        &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot;/&gt;
        &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot;/&gt;
        &lt;property name=&quot;driverClassName&quot; value=&quot;$&#123;jdbc.driver&#125;&quot;/&gt;
    &lt;/bean&gt;

    &lt;!--配置SqlSessionFactory（设置mybatis配置文件的路径、mapper.xml文件的路径、注入数据源）--&gt;
    &lt;bean class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot; id=&quot;sqlSessionFactoryBean&quot;&gt;
        &lt;property name=&quot;configLocation&quot; value=&quot;classpath:mybatis/mybatis-config.xml&quot;/&gt;
        &lt;property name=&quot;mapperLocations&quot; value=&quot;classpath:mybatis/mapper/*.xml&quot;/&gt;
        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;
    &lt;/bean&gt;

    &lt;!--配置与mapper.xml对应的mapper接口的包路径--&gt;
    &lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;
        &lt;property name=&quot;basePackage&quot; value=&quot;org.fall.mapper&quot;/&gt;
    &lt;/bean&gt;
</code></pre>
<pre><code>    ③resources/**jdbc.properties**（存放数据库连接信息）
</code></pre>
<pre><code class="properties">    jdbc.user=root
    jdbc.password=root
    jdbc.url=jdbc:mysql://localhost:3306/project_rowd?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=UTF-8
    jdbc.driver=com.mysql.cj.jdbc.Driver
</code></pre>
<h3 id="2、测试整合是否成功"><a href="#2、测试整合是否成功" class="headerlink" title="2、测试整合是否成功"></a>2、测试整合是否成功</h3><pre><code class="java">/**
 * RunWith与ContextConfiguration指定xml的作用与
 * ApplicationContext context = new ClassPathXmlApplicationContext(&quot;spring-persist-mybatis.xml&quot;);类似
 * 前者通过让测试在Spring容器环境下执行，使得DataSource可以被自动注入，后者导入Spring配置文件
 */
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = &#123;&quot;classpath:spring-persist-mybatis.xml&quot;&#125;)
public class TestConnection &#123;
    @Autowired
    DataSource dataSource;

    @Test
    public void test01() throws SQLException &#123;
        //ApplicationContext context = new ClassPathXmlApplicationContext(&quot;spring-persist-mybatis.xml&quot;);
        //DataSource dataSource = context.getBean(DataSource.class);
        Connection connection = dataSource.getConnection();
        System.out.println(connection);
    &#125;
</code></pre>
<p>可以打印出connection的数据，而不是报空指针异常，得出结论：整合成功。</p>
<h2 id="五、配置日志系统"><a href="#五、配置日志系统" class="headerlink" title="五、配置日志系统"></a>五、配置日志系统</h2><p><strong>使用日志的原因：</strong></p>
<pre><code>在实际开发中，如果在所有想查看的地方都通过System.out来打印，会给项目上线带来很多问题
System.out本质是一个IO操作，通常IO操作比较消耗性能。如果项目中过多的System.out，则可能对性能造成影响，而如果使用日志系统，就可以通过控制日	志级别，来**批量控制打印信息**。
</code></pre>
<p>这里使用<strong>slf4j+logback</strong>代替Spring默认使用的commons-loggin日志包。</p>
<h3 id="1、在component中增加依赖"><a href="#1、在component中增加依赖" class="headerlink" title="1、在component中增加依赖"></a>1、在component中增加依赖</h3><pre><code class="xml">&lt;!-- 日志 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
    &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;!-- 其他日志框架的中间转换包 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;jcl-over-slf4j&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;jul-to-slf4j&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<h3 id="2、使用日志打印的方法"><a href="#2、使用日志打印的方法" class="headerlink" title="2、使用日志打印的方法"></a>2、使用日志打印的方法</h3><pre><code class="java">@Test
public void test03()&#123;
    //获取Logger对象，这里传入的Class就是当前打印日志的类
    Logger logger = LoggerFactory.getLogger(TestConnection.class);
    //等级 DEBUG &lt; INFO &lt; WARN &lt; ERROR
    logger.debug(&quot;I am DEBUG!!!&quot;);

    logger.info(&quot;I am INFO!!!&quot;);

    logger.warn(&quot;I am WARN!!!&quot;);

    logger.error(&quot;I am ERROR!!!&quot;);

&#125;
</code></pre>
<h2 id="六、配置声明式事务"><a href="#六、配置声明式事务" class="headerlink" title="六、配置声明式事务"></a>六、配置声明式事务</h2><pre><code>配置声明式事务的**目的**：希望指定的事务方法中，如果存在多个数据库操作，则要么一起提交，要么一起回滚（rollback），即：事务方法中多个数据库操作，只要有一个失败，则所有操作回滚。
</code></pre>
<h3 id="1、声明式事务所依赖的包"><a href="#1、声明式事务所依赖的包" class="headerlink" title="1、声明式事务所依赖的包"></a>1、声明式事务所依赖的包</h3><p>（前面已经加入了Maven依赖，不需要多次操作了）</p>
<pre><code class="xml">&lt;!-- Spring AOP --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.aspectj&lt;/groupId&gt;
    &lt;artifactId&gt;aspectjweaver&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;cglib&lt;/groupId&gt;
    &lt;artifactId&gt;cglib&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<h3 id="2、配置针对事务的Spring配置文件"><a href="#2、配置针对事务的Spring配置文件" class="headerlink" title="2、配置针对事务的Spring配置文件"></a>2、配置针对事务的Spring配置文件</h3><p><strong>spring-persist-tx.xml</strong></p>
<pre><code>事务方法一般定义在service层
</code></pre>
<pre><code class="xml">&lt;!--将org.fall.service包中的组件扫描入容器，因为事务方法一般定义在service层--&gt;
&lt;context:component-scan base-package=&quot;org.fall.service&quot;/&gt;

&lt;!--配置事务管理器--&gt;
&lt;bean id=&quot;txManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;
    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;
&lt;/bean&gt;

&lt;!--配置AOP--&gt;
&lt;aop:config&gt;
    &lt;!--配置切入点表达式--&gt;
    &lt;!--public void org.fall.service.impl.adminServiceImpl(Admin admin)--&gt;
    &lt;aop:pointcut id=&quot;txPointcut&quot; expression=&quot;execution(* *..*ServiceImpl.*(..))&quot;/&gt;

    &lt;!--关联事务通知与切入点--&gt;
    &lt;aop:advisor advice-ref=&quot;txAdvice&quot; pointcut-ref=&quot;txPointcut&quot;/&gt;
&lt;/aop:config&gt;

&lt;!--配置事务通知--&gt;
&lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;txManager&quot;&gt;
    &lt;tx:attributes&gt;
        &lt;!--name属性指定当前要配置的事务方法的方法名，符合名字的配置对应规则--&gt;
        &lt;!--查询方法通常设置为只读，便于数据库根据只读属性进行性能优化--&gt;
        &lt;tx:method name=&quot;get*&quot; read-only=&quot;true&quot;/&gt;
        &lt;tx:method name=&quot;query*&quot; read-only=&quot;true&quot;/&gt;
        &lt;tx:method name=&quot;find*&quot; read-only=&quot;true&quot;/&gt;
        &lt;tx:method name=&quot;count*&quot; read-only=&quot;true&quot;/&gt;

        &lt;!--涉及增删改查操作的方法的配置--&gt;
        &lt;!--propagation属性配置事务方法的传播行为--&gt;
            &lt;!--
                默认行为：REQUIRED，表示当前方法必须运行在事务中，如果没有事务，则开启事务，在自己的事务中运行。
                    如果已经有了已开启的事务，则在当前事务中运行。有可能和其他方法共用同一个事务
                建议设置：REQUIRES_NEW，表示当前方法必须运行在事务中，如果没有事务，则开启事务，在自己的事务中运行。
                    和 REQUIRED 的区别是就算现在已经有了已开启的事务，也一定要开启自己的事务，避免和其他方法共用同一个事务。
            --&gt;
        &lt;!--rollback-for：表示触发什么异常时，进行回滚；默认值：运行时异常，建议设置为运行时异常+编译期异常--&gt;
        &lt;tx:method name=&quot;save*&quot; propagation=&quot;REQUIRES_NEW&quot; rollback-for=&quot;java.lang.Exception&quot;/&gt;
        &lt;tx:method name=&quot;update*&quot; propagation=&quot;REQUIRES_NEW&quot; rollback-for=&quot;java.lang.Exception&quot;/&gt;
        &lt;tx:method name=&quot;remove*&quot; propagation=&quot;REQUIRES_NEW&quot; rollback-for=&quot;java.lang.Exception&quot;/&gt;
        &lt;!--需要了解的是，如果方法名没有匹配的name，则该方法的事务不会生效--&gt;
    &lt;/tx:attributes&gt;
&lt;/tx:advice&gt;
</code></pre>
<pre><code>配置完成后，在org.fall.service包下，进行数据库操作时，触发异常，即发生回滚，不会依然执行
</code></pre>
<h2 id="七、表述层环境搭建"><a href="#七、表述层环境搭建" class="headerlink" title="七、表述层环境搭建"></a>七、表述层环境搭建</h2><pre><code>首先需要确定已经导入了SpringMVC的依赖
</code></pre>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<h3 id="1、配置web-xml"><a href="#1、配置web-xml" class="headerlink" title="1、配置web.xml"></a>1、配置web.xml</h3><pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;web-app xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;
         version=&quot;4.0&quot;&gt;

    &lt;!--配置ContextLoaderListener，加载Spring配置文件--&gt;
    &lt;!--contextConfigLocation需要的内容--&gt;
    &lt;context-param&gt;
        &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
        &lt;param-value&gt;classpath:spring-persist-*.xml&lt;/param-value&gt;
    &lt;/context-param&gt;
    &lt;!--将ContextLoaderListener加入容器--&gt;
    &lt;listener&gt;
        &lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;
    &lt;/listener&gt;

    &lt;!--配置CharacterEncodingFilter，解决乱码问题--&gt;
    &lt;!--如果web.xml中存在多个Filter，则此Filter必须作为过滤器链的第一个Filter--&gt;
    &lt;filter&gt;
        &lt;filter-name&gt;characterEncodingFilter&lt;/filter-name&gt;
        &lt;filter-class&gt;org.springframework.web.filter.CharacterEncodingFilter&lt;/filter-class&gt;
        &lt;!-- 指定字符集编码 --&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;encoding&lt;/param-name&gt;
            &lt;param-value&gt;UTF-8&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;!--强制请求进行编码--&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;forceRequestEncoding&lt;/param-name&gt;
            &lt;param-value&gt;true&lt;/param-value&gt;
        &lt;/init-param&gt;
        &lt;!--强制响应进行编码--&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;forceResponseEncoding&lt;/param-name&gt;
            &lt;param-value&gt;true&lt;/param-value&gt;
        &lt;/init-param&gt;
    &lt;/filter&gt;
    &lt;!--设置过滤器过滤的请求的路径（/*表示全部请求）--&gt;
    &lt;filter-mapping&gt;
        &lt;filter-name&gt;characterEncodingFilter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;

    &lt;!--配置DispatcherServlet（即配置SpringMVC的前端控制器）--&gt;
    &lt;servlet&gt;
        &lt;servlet-name&gt;dispatcherServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;
        &lt;!--指定SpringMVC配置文件--&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
            &lt;param-value&gt;classpath:spring-web-mvc.xml&lt;/param-value&gt;
        &lt;/init-param&gt;

        &lt;!--使DispatcherServlet在Web应用启动时就创建对象并初始化--&gt;
        &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
    &lt;/servlet&gt;
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;dispatcherServlet&lt;/servlet-name&gt;
        &lt;!--根据请求的扩展名决定是否交给SpringMVC来处理--&gt;
        &lt;!--
            请求的扩展名应与预计的响应体格式相同
            要求json数据则后缀.json;	要求页面则后缀.html
        --&gt;
        &lt;url-pattern&gt;*.html&lt;/url-pattern&gt;
        &lt;url-pattern&gt;*.json&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
&lt;/web-app&gt;
</code></pre>
<h3 id="2、配置SpringMVC配置文件"><a href="#2、配置SpringMVC配置文件" class="headerlink" title="2、配置SpringMVC配置文件"></a>2、配置SpringMVC配置文件</h3><pre><code class="xml">&lt;!--配置包扫描，这里将controller层放在mvc包下，因此配置扫描mvc--&gt;
&lt;context:component-scan base-package=&quot;org.fall.mvc&quot;/&gt;

&lt;!--配置视图解析器--&gt;
&lt;bean class=&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;&gt;
    &lt;property name=&quot;prefix&quot; value=&quot;/WEB-INF/&quot;/&gt;
    &lt;property name=&quot;suffix&quot; value=&quot;.jsp&quot;/&gt;
&lt;/bean&gt;

&lt;!--启动注解驱动--&gt;
&lt;mvc:annotation-driven/&gt;
</code></pre>
<h3 id="3、测试SSM整合是否成功"><a href="#3、测试SSM整合是否成功" class="headerlink" title="3、测试SSM整合是否成功"></a>3、测试SSM整合是否成功</h3><pre><code>**Controller控制器代码：**
</code></pre>
<pre><code class="java">@Controller
public class TestHandler &#123;

    @Autowired
    AdminService adminService;

    @RequestMapping(&quot;/test/ssm.html&quot;)
    public String testSSM(Model model)&#123;
        //Admin admin = adminService.queryAdmin(1);
        List&lt;Admin&gt; admins = adminService.getAll();
        model.addAttribute(&quot;admins&quot;, admins);
        return &quot;target&quot;;
    &#125;
&#125;
</code></pre>
<pre><code>**前端代码：**index.jsp
</code></pre>
<pre><code class="html">&lt;%-- 一、无base标签：--%&gt;
    &lt;a href=&quot;$&#123;pageContext.request.contextPath&#125;/test/ssm.html&quot;&gt;测试页面&lt;/a&gt;

&lt;%-- 二、有base标签：--%&gt;
&lt;head&gt;
    &lt;base href=&quot;http://$&#123;pageContext.request.serverName&#125;:$&#123;pageContext.request.serverPort&#125;$&#123;pageContext.request.contextPath&#125;/&quot;&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;a href=&quot;test/ssm.html&quot;&gt;测试页面&lt;/a&gt;
&lt;/body&gt;
</code></pre>
<pre><code>**Base标签的要求：**	

    base 标签必须写在 head 标签内部
  base 标签必须在所有“带具体路径”的标签的前面
    serverName 部分 EL 表达式和 serverPort 部分 EL 表达式之间必须写“:”
  serverPort 部分 EL 表达式和 contextPath 部分 EL 表达式之间绝对不能写“/”
    原因：contextPath 部分 EL 表达式本身就是“/”开头，如果多写一个“/”会干扰 Cookie 的工作机制
   serverPort 部分 EL 表达式后面必须写“/”
</code></pre>
<h2 id="八、SpringMVC环境下的Ajax请求"><a href="#八、SpringMVC环境下的Ajax请求" class="headerlink" title="八、SpringMVC环境下的Ajax请求"></a>八、SpringMVC环境下的Ajax请求</h2><pre><code>检查依赖的包：
</code></pre>
<pre><code class="xml">&lt;!-- Spring 进行 JSON 数据转换依赖 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
    &lt;artifactId&gt;jackson-core&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
    &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<pre><code>加入jQuery：
</code></pre>
<p><img src="/images%5CjQuery%E8%B7%AF%E5%BE%84.png"></p>
<pre><code>测试Ajax（基于jQuery）：

    jQuery代码：
</code></pre>
<pre><code class="javascript">&lt;script src=&quot;jquery/jquery-3.4.1.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
    $(function () &#123;

        //btn1
        //此方式可以在浏览器看到发送的请求体是Form Data(表单数据)
        $(&quot;#btn1&quot;).click(function () &#123;
            $.ajax(&#123;
                url: &quot;send/array/one.html&quot;,         //请求目标资源地址
                type: &quot;post&quot;,                       //请求方式
                data: arrayStr,                     //发送的请求参数
                dataType: &quot;text&quot;,                   //表示如何对待服务器返回的数据
                success: function (response) &#123;
                    alert(response);
                &#125;,
                error: function (response) &#123;
                    alert(response);
                &#125;

            &#125;);
        &#125;);

        //btn2
        //此方式可以在浏览器看到发送的请求体是Request Payload(请求负载)
        $(&quot;#btn2&quot;).click(function () &#123;
            //准备要发送的数据
            var array=[5,8,12];
            //必须先将目标转换成JSON字符串
            var arrayStr = JSON.stringify(array);
            $.ajax(&#123;
                url: &quot;send/array/two.html&quot;,         
                type: &quot;post&quot;,                       
                data: arrayStr,                     
                dataType: &quot;text&quot;,                   
                contentType: &quot;application/json;charset=UTF-8&quot;,  //告诉服务器端当前请求的请求体是JSON格式
                success: function (response) &#123;
                    alert(response);
                &#125;,
                error: function (response) &#123;
                    alert(response);
                &#125;

            &#125;);
        &#125;);

        //btn3
        //传输复杂对象
        $(&quot;#btn3&quot;).click(function () &#123;
            var student = &#123;
                &quot;name&quot;:&quot;Fall&quot;,
                &quot;id&quot;:21,
                &quot;address&quot;:&#123;
                    &quot;province&quot;:&quot;浙江&quot;,
                    &quot;city&quot;:&quot;宁波&quot;
                &#125;,
                &quot;subjects&quot;:[
                    &#123;
                        &quot;subjectName&quot;:&quot;Java&quot;,
                        &quot;score&quot;:96
                    &#125;,
                    &#123;
                        &quot;subjectName&quot;:&quot;Data Struct&quot;,
                        &quot;score&quot;:93
                    &#125;
                ],
                &quot;map&quot;:&#123;
                    &quot;key1&quot;:&quot;value1&quot;,
                    &quot;key2&quot;:&quot;value2&quot;
                &#125;
            &#125;;   //student end
            var studentStr = JSON.stringify(student);
            $.ajax(&#123;
                url: &quot;send/compose/object.html&quot;,         
                type: &quot;post&quot;,                       
                data: studentStr,                     
                dataType: &quot;text&quot;,                   
                contentType: &quot;application/json;charset=UTF-8&quot;,  
                success: function (response) &#123;
                    alert(response);				//在浏览器控制台打印返回的信息
                &#125;,
                error: function (response) &#123;
                    alert(response);
                &#125;
            &#125;);

        &#125;);     //btn3

        //btn4
        //使用ResultEntity，统一返回的格式
        $(&quot;#btn4&quot;).click(function () &#123;
            var student = &#123;
                //...与前面相同
            &#125;;   
            var studentStr = JSON.stringify(student);
            $.ajax(&#123;
                url: &quot;send/compose/object.json&quot;,    //此时是json，表示返回的数据是json格式的
                type: &quot;post&quot;,                       
                data: studentStr,                    
                dataType: &quot;json&quot;,                   //此时服务端返回的数据是json格式
                contentType: &quot;application/json;charset=UTF-8&quot;,  
                success: function (response) &#123;
                    console.log(response);			//在浏览器控制台打印返回的信息
                &#125;,
                error: function (response) &#123;
                    console.log(response);
                &#125;
            &#125;);

        &#125;);
        //btn4
    &#125;);
&lt;/script&gt;
</code></pre>
<pre><code>    对应的四个按钮：
</code></pre>
<pre><code class="html">&lt;button id=&quot;btn1&quot;&gt;Test Ajax One&lt;/button&gt;
&lt;br/&gt;&lt;br/&gt;
&lt;button id=&quot;btn2&quot;&gt;Test Ajax Two&lt;/button&gt;
&lt;br/&gt;&lt;br/&gt;
&lt;button id=&quot;btn3&quot;&gt;Test Compose Object&lt;/button&gt;
&lt;br/&gt;&lt;br/&gt;
&lt;button id=&quot;btn4&quot;&gt;Test ResultEntity&lt;/button&gt;
</code></pre>
<pre><code>    对应的控制层的四个方法：
</code></pre>
<pre><code class="java">    //通过@RequestParam接收数组
    @ResponseBody
    @RequestMapping(&quot;/send/array/one.html&quot;)
    public String testAjax01(@RequestParam(&quot;array&quot;) Integer[] array)&#123;
        for(Integer num : array)&#123;
            System.out.println(&quot;num:&quot;+num);
        &#125;
        return &quot;success&quot;;
    &#125;

    //通过@RequestBody接收数组
    @ResponseBody
    @RequestMapping(&quot;/send/array/two.html&quot;)
    public String testAjax02(@RequestBody Integer[] array)&#123;
        for(Integer num : array)&#123;
            System.out.println(&quot;num:&quot;+num);
        &#125;
        return &quot;success&quot;;
    &#125;

    //通过@RequestBody接收复杂对象
    @ResponseBody
    @RequestMapping(&quot;/send/compose/object.html&quot;)
    public String testSendComposeObject(@RequestBody Student student)&#123;
        System.out.println(student);
        return &quot;success&quot;;
    &#125;

    //通过一个工具类（ResultEntity&lt;T&gt;）统一返回数据的格式
    @ResponseBody
    @RequestMapping(&quot;/send/compose/object.json&quot;)
    public ResultEntity&lt;Student&gt; testResultEntity(@RequestBody Student student)&#123;
        return ResultEntity.successWithData(student);
    &#125;
</code></pre>
<p>&#x3D;&#x3D;如果希望通过@RequestBody接收前端发来的JSON数据，则前端发来的数据需要进行以下几步：&#x3D;&#x3D;</p>
<ol>
<li>准备好要发送的数据（需要是JSON对象或JSON数组）</li>
<li>通过JSON.stringify()方法，转换成JSON字符串</li>
<li>将JSON字符串直接赋值给data属性</li>
<li>必须设置<strong>contentType: “application&#x2F;json;charset&#x3D;UTF-8”</strong></li>
</ol>
<p>此时后端在加入了json依赖，并开启mvc注解驱动，就可以使用RequestBody接收JSON数据。</p>
<h3 id="统一后端返回数据格式"><a href="#统一后端返回数据格式" class="headerlink" title="统一后端返回数据格式"></a>统一后端返回数据格式</h3><p>通过工具类，实现统一后端返回的数据格式</p>
<pre><code>工具类代码：
</code></pre>
<pre><code class="java">public class ResultEntity&lt;T&gt; &#123;
    //设置两个常量
    public static final String SUCCESS = &quot;SUCCESS&quot;;
    public static final String FAILED = &quot;FAILED&quot;;

    //请求错误时，返回的错误信息，对应SUCCESS与FAILED
    private String message;

    //要返回的数据
    private T data;

    //封装当前请求的处理结果是成功还是失败
    private String result;

    //请求处理成功并且不向前端返回数据时，使用的静态方法
    //第一个&lt;Type&gt;表示声明一个泛型Type，第二个和return中的&lt;Type&gt;表示使用该泛型
    public static &lt;Type&gt; ResultEntity&lt;Type&gt; successWithoutData()&#123;
        return new ResultEntity&lt;Type&gt;(null,null,SUCCESS);
    &#125;
    
    //请求处理成功并且向前端返回数据时，使用的静态方法
    public static &lt;Type&gt; ResultEntity&lt;Type&gt; successWithData(Type data)&#123;
        return new ResultEntity&lt;Type&gt;(null,data,SUCCESS);
    &#125;
    
    //请求处理失败，需要返回错误信息时，使用的静态方法
    public static &lt;Type&gt; ResultEntity&lt;Type&gt; failed(String message)&#123;
        return new ResultEntity&lt;&gt;(message,null,FAILED);
    &#125;
    
    /** Getter,Setter,constructor and toString **/
&#125;
</code></pre>
<pre><code>工具类中静态方法的泛型Type，代表了在前端请求后，后端返回的数据的类型；只是因为静态方法中不能调用非静态的属性，因此需要重新声明一个泛型，名	字为Type（其他也可以）。

    即想要返回一个Student对象时，就通过方法
</code></pre>
<pre><code class="java">@RequestMapping(...)
@ResponseBody
public ResultEntity&lt;Student&gt; getStudent()&#123;
    //...例如进行数据库查询操作等
    return ResultEntity.successWithData(student);
&#125;
</code></pre>
<h2 id="九、异常处理"><a href="#九、异常处理" class="headerlink" title="九、异常处理"></a>九、异常处理</h2><p><strong>目标</strong>：统一管理项目中的异常。</p>
<ul>
<li>抛出异常</li>
<li>返回给前端异常信息<ul>
<li>普通请求：在返回的页面上显示异常信息</li>
<li>Ajax请求：返回JSON格式的数据</li>
</ul>
</li>
</ul>
<p>观察浏览器的开发者工具中，发现可以根据客户端发送的请求类型，区别是普通请求还是Ajax请求。</p>
<p><img src="/images%5C%E5%88%A4%E6%96%AD%E8%AF%B7%E6%B1%82%E7%B1%BB%E5%9E%8B.png" alt="判断请求类型"></p>
<p>根据这一特点，编写一个工具类，其中一个静态方法用来判断请求是否是JSON请求</p>
<pre><code class="java">public class CrowdUtil &#123;

    /**
     * @param request
     * @return true==json请求 ; false==普通页面请求
     */
    public static boolean judgeRequestType(HttpServletRequest request)&#123;
        String accept = request.getHeader(&quot;Accept&quot;);
        String header = request.getHeader(&quot;X-Requested-With&quot;);
        return (accept != null &amp;&amp; accept.contains(&quot;application/json&quot;))
                ||
                (header != null &amp;&amp; header.equals(&quot;XMLHttpRequest&quot;));
    &#125;
&#125;
</code></pre>
<h3 id="异常映射实现的方式"><a href="#异常映射实现的方式" class="headerlink" title="异常映射实现的方式"></a>异常映射实现的方式</h3><h4 id="一、通过XML配置实现"><a href="#一、通过XML配置实现" class="headerlink" title="一、通过XML配置实现"></a>一、通过XML配置实现</h4><p>在mvc的配置文件中将SimpleMappingExceptionResolver加入容器，在exceptionMappings中配置异常与错误页面的映射</p>
<p>但是此时并未实现区别JSON请求与普通请求的要求。	</p>
<pre><code class="xml">&lt;!--基于XML的异常映射--&gt;
&lt;bean class=&quot;org.springframework.web.servlet.handler.SimpleMappingExceptionResolver&quot; id=&quot;simpleMappingExceptionResolver&quot;&gt;
    &lt;property name=&quot;exceptionMappings&quot;&gt;
        &lt;props&gt;
            &lt;prop key=&quot;java.lang.Exception&quot;&gt;system-error&lt;/prop&gt;
        &lt;/props&gt;
    &lt;/property&gt;
&lt;/bean&gt;
</code></pre>
<h4 id="二、通过注解实现"><a href="#二、通过注解实现" class="headerlink" title="二、通过注解实现"></a>二、通过注解实现</h4><p>这里通过使用前面编写的工具类的判断方法，实现对不同请求类型进行不同处理。</p>
<pre><code class="java">//注解标明该类是基于注解的异常处理器类
@ControllerAdvice
public class CrowdExceptionResolver &#123;

    //处理空指针异常
    @ExceptionHandler(value = &#123;NullPointerException.class&#125;)
    public ModelAndView resolveNullPointerException(NullPointerException exception,
            HttpServletRequest request, HttpServletResponse response
    ) throws IOException &#123;
        return commonCode(exception,request,response,&quot;system-error&quot;);
    &#125;

    //处理数学异常,这里如果内部操作相同，跳转页面也相同，其实可以放在上面一个方法中，此处只是为了演示
    @ExceptionHandler(value = &#123;ArithmeticException.class&#125;)
    public ModelAndView resolveArithmeticException(ArithmeticException exception,
            HttpServletRequest request,HttpServletResponse response) throws IOException &#123;
        return commonCode(exception,request,response,&quot;system-error&quot;);

    &#125;
    
    //整理出的不同异常的可重用代码
    private ModelAndView commonCode(
            //触发的异常，此处借助多态
            Exception exception,
            //客户器端的请求
            HttpServletRequest request,
            //服务端的响应
            HttpServletResponse response,
            //指定普通页面请求时，去的错误页面
            String viewName
    ) throws IOException &#123;
        boolean judgeRequestType = CrowdUtil.judgeRequestType(request);
        if (judgeRequestType)&#123;
            //if判断-是json请求
            ResultEntity&lt;Object&gt; failed = ResultEntity.failed(exception.getMessage());
            //创建Gson对象
            Gson gson = new Gson();
            //将ResultEntity对象转换成json格式
            String json = gson.toJson(failed);
            //通过原生servlet的response传回异常内容
            response.getWriter().write(json);
            //此时只需要返回null（因为是通过json格式返回数据）
            return null;
        &#125; else &#123;
            //if判断-是普通页面请求
            //创建ModelAndView对象
            ModelAndView modelAndView = new ModelAndView();
            //设置触发异常跳转的页面（会自动被视图解析器加上前后缀）
            modelAndView.setViewName(viewName);
            //将异常信息加入
            modelAndView.addObject(CrowdConstant.ATTR_NAME_EXCEPTION, exception);
            //返回设置完成的ModelAndView
            return modelAndView;
        &#125;
    &#125;

&#125;
</code></pre>
<h2 id="十、以常量管理常用的属性"><a href="#十、以常量管理常用的属性" class="headerlink" title="十、以常量管理常用的属性"></a>十、以常量管理常用的属性</h2><p>对于经常使用到且存在复用的属性名，可以单独设置一个常量类。这样的好处是可以减少因拼写导致的错误。</p>
<pre><code class="java">//常量类
public class CrowdConstant &#123;

    public static final String ATTR_NAME_EXCEPTION = &quot;exception&quot;;
    public static final String MESSAGE_LOGIN_FAILED = &quot;登录失败！请确认账号密码是否正确&quot;;

&#125;
</code></pre>
<h2 id="十一、前端页面引入"><a href="#十一、前端页面引入" class="headerlink" title="十一、前端页面引入"></a>十一、前端页面引入</h2><h3 id="引入登录页面"><a href="#引入登录页面" class="headerlink" title="引入登录页面"></a>引入登录页面</h3><p>1、引入需要的静态资源</p>
<p><img src="/images%5C%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90.png" alt="静态资源"></p>
<p>2、将登录页面的代码复制入创建的<strong>admin-login.jsp</strong>文件，并进行适当的修改（还未完全修改）</p>
<pre><code>主要是修改了编码方式为统一的UTF-8；添加了base标签；提前设置form表单的action和method；设置了账号密码的name属性。
</code></pre>
<pre><code class="jsp">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;zh-CN&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;
    &lt;meta name=&quot;description&quot; content=&quot;&quot;&gt;
    &lt;meta name=&quot;keys&quot; content=&quot;&quot;&gt;
    &lt;meta name=&quot;author&quot; content=&quot;&quot;&gt;
    &lt;base href=&quot;http://$&#123;pageContext.request.serverName&#125;:$&#123;pageContext.request.serverPort&#125;$&#123;pageContext.request.contextPath&#125;/&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;bootstrap/css/bootstrap.css&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;css/font-awesome.min.css&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;css/login.css&quot;&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;nav class=&quot;navbar navbar-inverse navbar-fixed-top&quot; role=&quot;navigation&quot;&gt;
    &lt;div class=&quot;container&quot;&gt;
        &lt;div class=&quot;navbar-header&quot;&gt;
            &lt;div&gt;&lt;a class=&quot;navbar-brand&quot; href=&quot;index.html&quot; style=&quot;font-size:32px;&quot;&gt;尚筹网-创意产品众筹平台&lt;/a&gt;&lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/nav&gt;

&lt;div class=&quot;container&quot;&gt;

    &lt;form action=&quot;admin/login/login.html&quot; method=&quot;post&quot; class=&quot;form-signin&quot; role=&quot;form&quot;&gt;
        &lt;h2 class=&quot;form-signin-heading&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-log-in&quot;&gt;&lt;/i&gt; 用户登录&lt;/h2&gt;
        &lt;div class=&quot;form-group has-success has-feedback&quot;&gt;
            &lt;input type=&quot;text&quot; name=&quot;login-user&quot; class=&quot;form-control&quot; id=&quot;inputSuccess4&quot; placeholder=&quot;请输入登录账号&quot; autofocus&gt;
            &lt;span class=&quot;glyphicon glyphicon-user form-control-feedback&quot;&gt;&lt;/span&gt;
        &lt;/div&gt;
        &lt;div class=&quot;form-group has-success has-feedback&quot;&gt;
            &lt;input type=&quot;text&quot; name=&quot;login-pwd&quot; class=&quot;form-control&quot; id=&quot;inputSuccess4&quot; placeholder=&quot;请输入登录密码&quot; style=&quot;margin-top:10px;&quot;&gt;
            &lt;span class=&quot;glyphicon glyphicon-lock form-control-feedback&quot;&gt;&lt;/span&gt;
        &lt;/div&gt;
        &lt;div class=&quot;checkbox&quot; style=&quot;text-align:right;&quot;&gt;&lt;a href=&quot;reg.html&quot;&gt;我要注册&lt;/a&gt;&lt;/div&gt;
        &lt;button type=&quot;submit&quot; class=&quot;btn btn-lg btn-success btn-block&quot;&gt;登录&lt;/button&gt;
    &lt;/form&gt;
&lt;/div&gt;
&lt;script src=&quot;jquery/jquery-2.1.1.min.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;bootstrap/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<hr>
<h4 id="遇到的奇怪的问题"><a href="#遇到的奇怪的问题" class="headerlink" title="遇到的奇怪的问题"></a>遇到的奇怪的问题</h4><p>在mvc配置文件中通过view-controller，使通过path指定的路径，访问登录页面（因为只需要单纯的访问而不需要附带数据等操作，因此使用此方法相比handler方法转发更加方便）</p>
<pre><code class="xml">&lt;!--通过view-controller 来设置一些直接的页面跳转--&gt;
&lt;mvc:view-controller path=&quot;/admin/login/page.html&quot; view-name=&quot;admin-login&quot;/&gt;
</code></pre>
<pre><code>==但是最后测试下来，发现访问时会**发生404错误**：==

我使用的默认是Edge Beta浏览器，当使用Edge浏览器时，可以通过链接访问登录页面，也可以直接使用` localhost:8888/admin/login/page.html`访问登录页面；但是当使用了chrome浏览器，使用地址栏输入...page.html时，发生奇怪的事情：报404错误，且之后edge也不能访问登录页面。最后尝试了很久，觉得应该是Tomcat缓存的问题，但尝试了多种清理缓存的方法，还是没有效果，最后**去掉了IDEA中对tomcat的一个勾选**：
</code></pre>
<p><img src="/images%5Ctomcat%E7%BC%93%E5%AD%98%E5%87%BA%E9%97%AE%E9%A2%98.png"></p>
<p>这样可以算是“暂时”解决了问题。</p>
<hr>
<h3 id="尝试使用layer弹层组件"><a href="#尝试使用layer弹层组件" class="headerlink" title="尝试使用layer弹层组件"></a>尝试使用layer弹层组件</h3><pre><code>1、网上下载layer.js（此处是3.3.1版本）

2、引入与测试使用layer组件

注意：layer组件依赖于jquery，因此layer的引入必须在jquery之后，否则会出错。
</code></pre>
<pre><code class="html">&lt;script src=&quot;jquery/jquery-3.4.1.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;layer/layer.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
&lt;script&gt;
    $(&quot;#btn5&quot;).click(function () &#123;
        layer.msg(&quot;test layer&quot;);
    &#125;);
&lt;/script&gt;
&lt;body&gt;
     &lt;button id=&quot;btn5&quot;&gt;Test layer&lt;/button&gt;
&lt;/body&gt;
</code></pre>
<h3 id="修饰错误页面"><a href="#修饰错误页面" class="headerlink" title="修饰错误页面"></a>修饰错误页面</h3><p>借助登录页面的样式，给错误页面<strong>换壳</strong></p>
<p>使错误页面可以显示错误信息，并且提供了返回上一层的按钮。</p>
<pre><code class="jsp">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;zh-CN&quot;&gt;
&lt;head&gt;
    &lt;%-- 前面与登录页面相同 --%&gt;
    &lt;script src=&quot;jquery/jquery-3.4.1.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
        $(function () &#123;
            $(&quot;button&quot;).click(function () &#123;
                //用js的方法，完成回退的目的
                window.history.back();
            &#125;);
        &#125;);
    &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;nav class=&quot;navbar navbar-inverse navbar-fixed-top&quot; role=&quot;navigation&quot;&gt;
    &lt;%-- 与登录页面同 --%&gt;
&lt;/nav&gt;
    
&lt;div class=&quot;container&quot;&gt;
    &lt;h1 style=&quot;text-align: center;&quot;&gt;请求出现了错误QAQ&lt;/h1&gt;
    &lt;h2 style=&quot;text-align: center;&quot;&gt;错误消息：$&#123;requestScope.exception.message&#125;&lt;/h2&gt;
    &lt;br/&gt;&lt;br/&gt;
    &lt;button style=&quot;width:150px;margin: 0 auto;&quot; class=&quot;btn btn-lg btn-success btn-block&quot;&gt;返回上一步&lt;/button&gt;
&lt;/div&gt;
    
    &lt;script src=&quot;bootstrap/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>最后此阶段完成时的项目目录结构图如下：</p>
<p><img src="/images%5C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E6%97%B6%E7%9A%84%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84%E5%9B%BE.png" alt="项目结构图"></p>
<h1 id="管理员登录与维护"><a href="#管理员登录与维护" class="headerlink" title="管理员登录与维护"></a>管理员登录与维护</h1><h2 id="一、管理员登陆"><a href="#一、管理员登陆" class="headerlink" title="一、管理员登陆"></a>一、管理员登陆</h2><p>需要做的：</p>
<ol>
<li>对存入数据库的密码进行MD5加密</li>
<li>在登录界面登录失败时的处理</li>
<li>抽取后台页面的公共部分</li>
<li>检查登录状态，防止未登录时访问受保护资源的情况</li>
</ol>
<p>具体操作如下：</p>
<h3 id="1）、MD5加密"><a href="#1）、MD5加密" class="headerlink" title="1）、MD5加密"></a>1）、MD5加密</h3><p>​	使用到的CrowdConstant类中的一些常量：</p>
<pre><code class="java">public class CrowdConstant &#123;
    public static final String ATTR_NAME_EXCEPTION = &quot;exception&quot;;
    public static final String MESSAGE_LOGIN_FAILED = &quot;登录失败！请确认账号密码是否正确&quot;;
    public static final String MESSAGE_STRING_INVALIDATE = &quot;字符串不能为空或长度为0！&quot;;
    public static final String MESSAGE_SYSTEM_ERROR_LOGIN_NOT_UNIQUE = &quot;错误！数据库中存在重复数据！&quot;;
    //登录的用户名
    public static final String LOGIN_ADMIN_NAME = &quot;loginAdmin&quot;;
    public static final String MESSAGE_ACCESS_FORBIDDEN = &quot;还未登录，禁止访问受保护资源！&quot;;
&#125;
</code></pre>
<p>​	进行<strong>加密的工具方法</strong>：</p>
<pre><code class="java">public class CrowdUtil &#123;
    //...其他工具方法省略
    /**
     * 此方法是用于给字符串进行md5加密的工具方法
     * @return 进行md5加密后的结果
     * @param source 传入要加密的内容
     */
    public static String md5(String source)&#123;

        if (source == null || source.length() == 0) &#123;
            //如果传入的加密内容为空或是空字符串，抛出LoginFailedException
            throw new LoginFailedException(CrowdConstant.MESSAGE_STRING_INVALIDATE);
        &#125;

        try &#123;
            //表示算法名
            String algorithm = &quot;md5&quot;;

            //得到MessageDigest对象，设置加密方式为md5
            MessageDigest messageDigest = MessageDigest.getInstance(algorithm);

            //将获得的明文字符串转换为字节数组
            byte[] input = source.getBytes();

            //对转换得到的字节数组进行md5加密
            byte[] output = messageDigest.digest(input);

            //设置BigInteger的signum
            //signum : -1表示负数、0表示零、1表示正数
            int signum = 1;

            //将字节数组转换成Big Integer
            BigInteger bigInteger = new BigInteger(signum,output);

            //设置将bigInteger的值按照16进制转换成字符串，最后全部转换成大写，得到最后的加密结果
            int radix = 16;
            String encoded = bigInteger.toString(radix).toUpperCase();

            //返回加密后的字符串
            return encoded;
        &#125; catch (NoSuchAlgorithmException e) &#123;
            e.printStackTrace();
        &#125;

        //触发异常则返回null
        return null;
    &#125;
&#125;
</code></pre>
<h3 id="2）、判断登录是否成功"><a href="#2）、判断登录是否成功" class="headerlink" title="2）、判断登录是否成功"></a>2）、判断登录是否成功</h3><p>在出现账号密码不正确、密码为空等情况时抛出的异常（继承了RuntimeException）：</p>
<pre><code class="java">/**
 * 登录失败后抛出的异常
 */
public class LoginFailedException extends RuntimeException &#123;
    public LoginFailedException() &#123;
        super();
    &#125;
    public LoginFailedException(String message) &#123;
        super(message);
    &#125;
    public LoginFailedException(String message, Throwable cause) &#123;
        super(message, cause);
    &#125;
    public LoginFailedException(Throwable cause) &#123;
        super(cause);
    &#125;
    protected LoginFailedException(String message, Throwable cause, boolean enableSuppression, boolean writableStackTrace) &#123;
        super(message, cause, enableSuppression, writableStackTrace);
    &#125;
&#125;
</code></pre>
<p>​	在<strong>【1环境搭建】</strong>中已经创建的<strong>CrowdExceptionResolver</strong>异常处理器类中添加针对该异常的处理方法：</p>
<pre><code class="java">// 触发登录失败异常，则继续返回登陆页面
@ExceptionHandler(value = LoginFailedException.class)
public ModelAndView resolverLoginFailedException(
        LoginFailedException exception, HttpServletRequest request,
        HttpServletResponse response) throws IOException &#123;
    String viewName = &quot;admin-login&quot;;
    // （公共代码方法，前面文档已经写过）
    return commonCode(exception,request,response,viewName);
&#125;
</code></pre>
<p>​	可以在登录页面加的适当位置一句下面的代码，以达到<strong>提示异常信息</strong>的目的：</p>
<pre><code class="jsp">&lt;p&gt;$&#123;requestScope.exception.message&#125;&lt;/p&gt;
</code></pre>
<p>​	</p>
<p>​	编写<strong>Service层代码</strong>：</p>
<p>​	主要时根据账号从数据库中取出对应的Admin对象，并与前端传来的账号密码进行比对</p>
<pre><code class="java">@Override
public Admin getAdminByUsername(String adminLoginAcct, String adminPassword) &#123;
    // 1、根据登陆账号查询Admin对象

    // 创建AdminExample对象
    AdminExample adminExample = new AdminExample();

    // 创建Criteria对象
    AdminExample.Criteria criteria = adminExample.createCriteria();

    // 在Criteria对象中封装查询的条件
    criteria.andLoginAcctEqualTo(adminLoginAcct);

    // 调用AdminMapper的方法来查询
    List&lt;Admin&gt; admins = adminMapper.selectByExample(adminExample);

    // 2、判断Admin对象是否为null或数据库数据不正常
    if (admins == null || admins.size() == 0)&#123;
        throw new LoginFailedException(CrowdConstant.MESSAGE_LOGIN_FAILED);
    &#125;
    if (admins.size() &gt; 1)&#123;
        // 数据库的数据存在重复
        throw new LoginFailedException(CrowdConstant.MESSAGE_SYSTEM_ERROR_LOGIN_NOT_UNIQUE);
    &#125;

    // 前面判断完后无异常，取出admin对象
    Admin admin = admins.get(0);

    // 3、如果Admin对象为null 则抛出异常
    if (admin == null)&#123;
        throw new LoginFailedException(CrowdConstant.MESSAGE_LOGIN_FAILED);
    &#125;

    // 4、如果Admin对象不为null，则取出Admin对象的密码
    String userPswdDB = admin.getUserPswd();

    // 5、对表单提交的密码进行md5加密
    String userPswdForm = CrowdUtil.md5(adminPassword);

    // 6、对比两个密码
    // 因为两个密码都是对象，使用字符串的equals方法，如果存在空的密码则会触发空指针异常
    // 因此选用Objects.equals方法
    if (!Objects.equals(userPswdDB,userPswdForm))&#123;
        // 密码不匹配
        throw new LoginFailedException(CrowdConstant.MESSAGE_LOGIN_FAILED);
    &#125;

    // 7、比对结果一致，返回admin对象
    return admin;
&#125;
</code></pre>
<p>​	编写在登录页面点击登录时对应的<strong>Controller代码</strong>：（Controller层调用Service层）</p>
<pre><code class="java">//登录操作的handler
@RequestMapping(&quot;/admin/login/doLogin.html&quot;)
public String doLogin(
        @RequestParam(&quot;login-user&quot;) String username,
        @RequestParam(&quot;login-pwd&quot;) String password,
        HttpSession session) &#123;
    //通过service层方法得到Admin对象
    Admin admin = adminService.getAdminByUsername(username,password);

    //将Admin对象放入Session域
    session.setAttribute(CrowdConstant.LOGIN_ADMIN_NAME, admin);

    //重定向到登录完成后的主页面（重定向防止重复提交表单，增加不必要的数据库访问）
    return &quot;redirect:/admin/main/page.html&quot;;
&#125;
</code></pre>
<p>​	重定向去的页面，因为数据放在session中，因此直接通过mvc:view-controller指定该页面	</p>
<pre><code class="xml">&lt;mvc:view-controller path=&quot;/admin/main/page.html&quot; view-name=&quot;admin-main&quot;/&gt;
</code></pre>
<p>​	若此时比对后，账号密码均符合数据库数据，则进入登录后的主页面&#x3D;&#x3D;<strong>&#x2F;WEB-INF&#x2F;admin-main.jsp</strong>&#x3D;&#x3D;（前端代码大多重复，不在这边复制出来）</p>
<p>​	这里主要有一句前端代码，用来显示已经登录的账号的昵称（从Session中取出）</p>
<pre><code class="jsp">&lt;div class=&quot;btn-group&quot;&gt;
    &lt;button type=&quot;button&quot; class=&quot;btn btn-default btn-success dropdown-toggle&quot; data-toggle=&quot;dropdown&quot;&gt;
        &lt;i class=&quot;glyphicon glyphicon-user&quot;&gt;&lt;/i&gt; $&#123;sessionScope.loginAdmin.userName&#125; &lt;span class=&quot;caret&quot;&gt;&lt;/span&gt;
    &lt;/button&gt;
    ...
&lt;/div&gt;
</code></pre>
<h3 id="3）、抽取后台公共页面"><a href="#3）、抽取后台公共页面" class="headerlink" title="3）、抽取后台公共页面"></a>3）、抽取后台公共页面</h3><p>​	JSP页面中，对公共的页面，可以在一个单独页面中保存，在需要调用这些公共页面的时候通过<code>&lt;%@include file=&quot;...&quot;%&gt;</code>引入这些页面。</p>
<p>​	注意：如果在引入时，发现引入的地方原本的<strong>中文显示乱码</strong>，可以通过给这些公共的页面代码加上一句<code>&lt;%@page pageEncoding=&quot;UTF-8&quot;%&gt;</code></p>
<p>​	这里以抽取的头部标签栏为例（include-nav.jsp）：</p>
<pre><code class="jsp">&lt;%@page pageEncoding=&quot;UTF-8&quot;%&gt;
&lt;nav class=&quot;navbar navbar-inverse navbar-fixed-top&quot; role=&quot;navigation&quot;&gt;
    &lt;div class=&quot;container-fluid&quot;&gt;
        &lt;div class=&quot;navbar-header&quot;&gt;
            &lt;div&gt;&lt;a class=&quot;navbar-brand&quot; style=&quot;font-size:32px;&quot; href=&quot;#&quot;&gt;众筹平台 - 控制面板&lt;/a&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;div id=&quot;navbar&quot; class=&quot;navbar-collapse collapse&quot;&gt;
            &lt;ul class=&quot;nav navbar-nav navbar-right&quot;&gt;
                &lt;li style=&quot;padding-top:8px;&quot;&gt;
                    &lt;div class=&quot;btn-group&quot;&gt;
                        &lt;button type=&quot;button&quot; class=&quot;btn btn-default btn-success dropdown-toggle&quot; data-toggle=&quot;dropdown&quot;&gt;
                            &lt;i class=&quot;glyphicon glyphicon-user&quot;&gt;&lt;/i&gt; $&#123;sessionScope.loginAdmin.userName&#125; &lt;span class=&quot;caret&quot;&gt;&lt;/span&gt;
                        &lt;/button&gt;
                        &lt;ul class=&quot;dropdown-menu&quot; role=&quot;menu&quot;&gt;
                            &lt;li&gt;&lt;a href=&quot;#&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-cog&quot;&gt;&lt;/i&gt; 个人设置&lt;/a&gt;&lt;/li&gt;
                            &lt;li&gt;&lt;a href=&quot;#&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-comment&quot;&gt;&lt;/i&gt; 消息&lt;/a&gt;&lt;/li&gt;
                            &lt;li class=&quot;divider&quot;&gt;&lt;/li&gt;
                            &lt;li&gt;&lt;a href=&quot;admin/login/logout.html&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-off&quot;&gt;&lt;/i&gt; 退出系统&lt;/a&gt;&lt;/li&gt;
                        &lt;/ul&gt;
                    &lt;/div&gt;
                &lt;/li&gt;
                &lt;li style=&quot;margin-left:10px;padding-top:8px;&quot;&gt;
                    &lt;button type=&quot;button&quot; class=&quot;btn btn-default btn-danger&quot;&gt;
                        &lt;span class=&quot;glyphicon glyphicon-question-sign&quot;&gt;&lt;/span&gt; 帮助
                    &lt;/button&gt;
                &lt;/li&gt;
            &lt;/ul&gt;
            &lt;form class=&quot;navbar-form navbar-right&quot;&gt;
                &lt;input type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;查询&quot;&gt;
            &lt;/form&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/nav&gt;
</code></pre>
<p>在对应的页面引入：</p>
<pre><code class="jsp">&lt;body&gt;
    &lt;%-- 头部标签的引入放在原本的位置，代替重复代码 --%&gt;
    &lt;%@include file=&quot;/WEB-INF/include-nav.jsp&quot;%&gt;
    ...
&lt;/body&gt;
</code></pre>
<h3 id="4）、对登录状态进行检查"><a href="#4）、对登录状态进行检查" class="headerlink" title="4）、对登录状态进行检查"></a>4）、对登录状态进行检查</h3><p>主要是通过一个异常配合一个拦截器来实现。</p>
<p>​	①首先创建一个自定义异常AccessForbiddenException，在用户未登录时访问受保护资源时抛出：</p>
<pre><code class="java">// 未登录时访问受保护资源时抛出的异常
public class AccessForbiddenException extends RuntimeException&#123;

    public AccessForbiddenException() &#123;
        super();
    &#125;

    public AccessForbiddenException(String message) &#123;
        super(message);
    &#125;

    public AccessForbiddenException(String message, Throwable cause) &#123;
        super(message, cause);
    &#125;

    public AccessForbiddenException(Throwable cause) &#123;
        super(cause);
    &#125;

    protected AccessForbiddenException(String message, Throwable cause, boolean enableSuppression, boolean writableStackTrace) &#123;
        super(message, cause, enableSuppression, writableStackTrace);
    &#125;
&#125;
</code></pre>
<p>​	②然后创建一个拦截器，拦截除了登录页面、登录请求、登出操作的其他请求，只有能从session域中得到admin对象时，才可以放行：</p>
<pre><code class="java">// 拦截器，用来在未登录时访问受保护页面时进行拦截并抛出AccessForbiddenException
public class LoginInterceptor extends HandlerInterceptorAdapter &#123;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception &#123;
        // 通过request获得session对象
        HttpSession session = request.getSession();

        // 从session域中取出Admin对象
        Admin admin = (Admin) session.getAttribute(CrowdConstant.LOGIN_ADMIN_NAME);

        // 判断admin对象是否为空，若为空表示未登录，抛出异常
        if (admin == null)&#123;
            throw new AccessForbiddenException(CrowdConstant.MESSAGE_ACCESS_FORBIDDEN);
        &#125;

        // admin对象不为空，表示已登录，放行
        return true;
    &#125;
&#125;
</code></pre>
<p>​	③在SpringMVC的容器中注册拦截器：</p>
<pre><code class="xml">&lt;!--在mvc容器中注册拦截器--&gt;
&lt;mvc:interceptors&gt;
    &lt;mvc:interceptor&gt;
        &lt;!-- mapping 表示拦截的路径 --&gt;
        &lt;mvc:mapping path=&quot;/**&quot;/&gt;
        &lt;!-- exclude-mapping表示例外（即不会被拦截器拦截） --&gt;
        &lt;mvc:exclude-mapping path=&quot;/admin/login/page.html&quot;/&gt;
        &lt;mvc:exclude-mapping path=&quot;/admin/login/logout.html&quot;/&gt;
        &lt;mvc:exclude-mapping path=&quot;/admin/login/doLogin.html&quot;/&gt;
        &lt;bean class=&quot;org.fall.mvc.interceptor.LoginInterceptor&quot;/&gt;
    &lt;/mvc:interceptor&gt;
&lt;/mvc:interceptors&gt;
</code></pre>
<p>​	④完善异常映射，在未登录时，触发该异常，应该自动跳转到登陆页面：</p>
<pre><code class="xml">&lt;!--基于XML的异常映射--&gt;
&lt;bean class=&quot;org.springframework.web.servlet.handler.SimpleMappingExceptionResolver&quot; id=&quot;simpleMappingExceptionResolver&quot;&gt;
    &lt;property name=&quot;exceptionMappings&quot;&gt;
        &lt;props&gt;
            &lt;prop key=&quot;java.lang.Exception&quot;&gt;system-error&lt;/prop&gt;
            &lt;!-- 通过xml配置AccessForbiddenException的异常映射 --&gt;
            &lt;prop key=&quot;org.fall.exception.AccessForbiddenException&quot;&gt;admin-login&lt;/prop&gt;
        &lt;/props&gt;
    &lt;/property&gt;
&lt;/bean&gt;
</code></pre>
<p>​	<strong>注意</strong>：经测试，此处不能直接使用基于注解的异常处理。直接使用@ExceptionHandler注解捕捉异常在访问&#x2F;admin&#x2F;main&#x2F;page.html时不会进入该方法<br>​        原因是：上面的&#x2F;admin&#x2F;main&#x2F;page.html视图是在mvc的配置文件中用<strong>mvc:view-controller</strong>修饰的，这种页面，会使用默认的异常处理器<br>​        而不是使用自定义处理器。</p>
<p>​	&#x3D;&#x3D;因此这里必须通过mvc配置文件来配置异常映射；&#x3D;&#x3D;</p>
<p>​	&#x3D;&#x3D;或不使用view-controller修饰&#x2F;admin&#x2F;main&#x2F;page.html，而是把该页面的跳转 放在Controller中。&#x3D;&#x3D;</p>
<h2 id="二、管理员维护"><a href="#二、管理员维护" class="headerlink" title="二、管理员维护"></a>二、管理员维护</h2><p>​	对管理员进行维护：主要目的就是在前端页面友好地显示当前数据库中的管理员数据信息，并且能对其中数据进行增删改查操作。</p>
<p><strong>需要做的：</strong></p>
<ol>
<li><p>分页显示管理员的信息</p>
<pre><code>2. 实现根据关键字查询对应信息
        3. 实现从列表删除指定管理员
    4. 实现新增管理员
    5. 实现修改管理员信息
</code></pre>
</li>
</ol>
<h3 id="1）、分页显示信息"><a href="#1）、分页显示信息" class="headerlink" title="1）、分页显示信息"></a>1）、分页显示信息</h3><h4 id="①引入依赖"><a href="#①引入依赖" class="headerlink" title="①引入依赖"></a>①引入依赖</h4><p>​	为了实现方便，使用了基于jQuery的Pagination插件，实现<strong>显示页码导航条</strong></p>
<p>​	本项目中使用的Pagination版本是1.2；这里将对应的js文件放在jquery文件夹下，css文件放在css文件夹下：</p>
<p><img src="D:\浏览器下载\crowd-funding-master\crowd-funding-master\note\images\pagination相应文件.png" alt="pagination"></p>
<p>​	引入PageHelper，用于在后端进行分页的操作，避免自己再麻烦地去写分页的代码：</p>
<pre><code class="xml">&lt;!-- MyBatis 分页插件 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;
    &lt;artifactId&gt;pagehelper&lt;/artifactId&gt;
    &lt;version&gt;4.0.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<h4 id="②后端代码"><a href="#②后端代码" class="headerlink" title="②后端代码"></a>②后端代码</h4><p>​	1、编写查询Admin信息的SQL语句：</p>
<pre><code class="xml">&lt;!--逆向工程生成的，可以用于引入重复数据--&gt;
&lt;sql id=&quot;Base_Column_List&quot; &gt;
  id, login_acct, user_pswd, user_name, email, create_time
&lt;/sql&gt;

&lt;!--查找符合关键字匹配的数据（没有关键字则默认查找全部数据）--&gt;
&lt;select id=&quot;selectAdminByKeyword&quot; resultMap=&quot;BaseResultMap&quot;&gt;
  select 
  &lt;!--引入前面的sql标签中的内容--&gt;
  &lt;include refid=&quot;Base_Column_List&quot;/&gt;
  from t_admin
  where
  login_acct like CONCAT(&quot;%&quot;,#&#123;keyword&#125;,&quot;%&quot;) or
  user_name like CONCAT(&quot;%&quot;,#&#123;keyword&#125;,&quot;%&quot;) or
  email like CONCAT(&quot;%&quot;,#&#123;keyword&#125;,&quot;%&quot;)
&lt;/select&gt;
</code></pre>
<p>​	2、再AdminMapper接口中编写抽象方法：</p>
<pre><code class="java">//根据关键字查找用户的方法
List&lt;Admin&gt; selectAdminByKeyword(String keyword);
</code></pre>
<p>​	</p>
<p>​	3、在Spring配置文件中原先编写的SqlSessionFactoryBean中加入MyBatis插件—PageHelper</p>
<pre><code class="xml">&lt;bean class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot; id=&quot;sqlSessionFactoryBean&quot;&gt;
    &lt;property name=&quot;configLocation&quot; value=&quot;classpath:mybatis/mybatis-config.xml&quot;/&gt;
    &lt;property name=&quot;mapperLocations&quot; value=&quot;classpath:mybatis/mapper/*.xml&quot;/&gt;
    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;
    
    &lt;!--配置插件--&gt;
    &lt;property name=&quot;plugins&quot;&gt;
        &lt;array&gt;
            &lt;!--配置PageHelper，用于帮助分页--&gt;
            &lt;bean class=&quot;com.github.pagehelper.PageHelper&quot;&gt;
                &lt;property name=&quot;properties&quot;&gt;
                    &lt;props&gt;
                        &lt;!--设置数据库方言（这里就是mysql）--&gt;
                        &lt;prop key=&quot;dialect&quot;&gt;mysql&lt;/prop&gt;
                        &lt;!--让PageHelper自动将浏览器传来的PageNum修正到正确范围--&gt;
                        &lt;prop key=&quot;reasonable&quot;&gt;true&lt;/prop&gt;
                    &lt;/props&gt;
                &lt;/property&gt;
            &lt;/bean&gt;
        &lt;/array&gt;
    &lt;/property&gt;
    
&lt;/bean&gt;
</code></pre>
<p>​	</p>
<p>​	4、在Service层调用该方法，实现查询操作</p>
<p>​	AdminService接口抽象getPageInfo()在实现类的代码：</p>
<pre><code class="java">/**
 * @param keyword 关键字
 * @param pageNum 当前页码
 * @param pageSize 每一页显示的信息数量
 * @return 最后的pageInfo对象
 */
@Override
public PageInfo&lt;Admin&gt; getPageInfo(String keyword, Integer pageNum, Integer pageSize) &#123;
    // 利用PageHelper的静态方法开启分页
    PageHelper.startPage(pageNum,pageSize);

    // 调用Mapper接口的对应方法
    List&lt;Admin&gt; admins = adminMapper.selectAdminByKeyword(keyword);

    // 为了方便页面的使用，把Admin的List封装成PageInfo（放别得到页码等数据）
    PageInfo&lt;Admin&gt; pageInfo = new PageInfo&lt;&gt;(admins);

    // 返回得到的pageInfo对象
    return pageInfo;
&#125;
</code></pre>
<p>​	这里使用PageInfo作为返回值，是因为PageInfo对象中可以携带当前的页码、每页大小、总页数等数据，在前端取值时，比直接返回一个Admin的List更加方便。</p>
<p>​	5、编写Controller层代码：</p>
<pre><code class="java">//显示admin的数据
@RequestMapping(&quot;/admin/page/page.html&quot;)
public String getAdminPage(
        // 传入的关键字，若未传入，默认值为一个空字符串（不能是null）
        @RequestParam(value = &quot;keyword&quot;, defaultValue = &quot;&quot;) String keyword,
        // 传入的页码，默认值为1
        @RequestParam(value = &quot;pageNum&quot;, defaultValue = &quot;1&quot;) Integer pageNum,
        // 传入的页面大小，默认值为5
        @RequestParam(value = &quot;pageSize&quot;, defaultValue = &quot;5&quot;) Integer pageSize,
        // ModelMap用于给前端带数据
        ModelMap modelMap) &#123;
    
    //从AdminService中得到对应传参的列表
    PageInfo&lt;Admin&gt; pageInfo = adminService.getPageInfo(keyword, pageNum, pageSize);
    
    //将得到的PageInfo存入modelMap，传给前端
    modelMap.addAttribute(CrowdConstant.NAME_PAGE_INFO,pageInfo);
    
    //进入对应的显示管理员信息的页面（/WEB-INF/admin-page.jsp）
    return &quot;admin-page&quot;;
&#125;
</code></pre>
<h4 id="③前端代码"><a href="#③前端代码" class="headerlink" title="③前端代码"></a>③前端代码</h4><p>​	在admin-sidebar.jsp页面设置“用户维护”按钮的跳转链接，到controller层的对应RequestMapping</p>
<pre><code class="jsp">&lt;li style=&quot;height:30px;&quot;&gt;
    &lt;a href=&quot;admin/page/page.html&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-user&quot;&gt;&lt;/i&gt; 用户维护&lt;/a&gt;
&lt;/li&gt;
</code></pre>
<p>​		实现在前端页面显示这些得到的数据：</p>
<p>​		为了做判断后再获取各个数据，这里需要引入JSTL：</p>
<pre><code class="jsp">&lt;%@taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;
</code></pre>
<p>​		这里显示管理员信息的主要代码：</p>
<pre><code class="jsp">&lt;thead&gt;
&lt;tr&gt;
    &lt;th width=&quot;30&quot;&gt;#&lt;/th&gt;
    &lt;th width=&quot;30&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;
    &lt;th&gt;账号&lt;/th&gt;
    &lt;th&gt;名称&lt;/th&gt;
    &lt;th&gt;邮箱地址&lt;/th&gt;
    &lt;th width=&quot;100&quot;&gt;操作&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;

&lt;%-- jstl --%&gt;
    &lt;%-- 如果得到的pageInfo的list为空，则表示数据库无数据，显示查不到数据 --%&gt;
&lt;c:if test=&quot;$&#123;empty requestScope.pageInfo.list&#125;&quot;&gt;
    &lt;tr&gt;
        &lt;td colspan=&quot;6&quot;&gt;抱歉，查不到相关的数据！&lt;/td&gt;
    &lt;/tr&gt;
&lt;/c:if&gt;
    &lt;%-- 数据不为空，通过forEach显示数据（前端显示的主要代码） --%&gt;
&lt;c:if test=&quot;$&#123;!empty requestScope.pageInfo.list&#125;&quot;&gt;
    &lt;c:forEach items=&quot;$&#123;requestScope.pageInfo.list&#125;&quot; var=&quot;admin&quot; varStatus=&quot;status&quot;&gt;
        &lt;tr&gt;
            &lt;td&gt;$&#123;status.count&#125;&lt;/td&gt;
            &lt;td&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/td&gt;
            &lt;td&gt;$&#123;admin.loginAcct&#125;&lt;/td&gt;
            &lt;td&gt;$&#123;admin.userName&#125;&lt;/td&gt;
            &lt;td&gt;$&#123;admin.email&#125;&lt;/td&gt;
            
            &lt;%-- 这里下面的按钮还未用到，先忽略 --%&gt;
            &lt;td&gt;
                &lt;button type=&quot;button&quot; class=&quot;btn btn-success btn-xs&quot;&gt;&lt;i
                        class=&quot; glyphicon glyphicon-check&quot;&gt;&lt;/i&gt;&lt;/button&gt;
                &lt;a href=&quot;admin/page/update/$&#123;admin.id&#125;/$&#123;requestScope.pageInfo.pageNum&#125;/$&#123;param.keyword&#125;.html&quot; 
                   class=&quot;btn btn-primary btn-xs&quot;&gt;&lt;i class=&quot; glyphicon glyphicon-pencil&quot;&gt;&lt;/i&gt;&lt;/a&gt;
                &lt;a href=&quot;admin/page/remove/$&#123;admin.id&#125;/$&#123;requestScope.pageInfo.pageNum&#125;/$&#123;param.keyword&#125;.html&quot; 
                   class=&quot;btn btn-danger btn-xs&quot;&gt;
                    &lt;i class=&quot; glyphicon glyphicon-remove&quot;&gt;&lt;/i&gt;
                &lt;/a&gt;
            &lt;/td&gt;
        &lt;/tr&gt;
    &lt;/c:forEach&gt;
&lt;/c:if&gt;

&lt;/tbody&gt;
</code></pre>
<p>​		此时前端已经可以显示被分页后的数据，但是还不能通过导航条来选择页码，这时候需要使用Pagination。</p>
<pre><code class="jsp">&lt;%--引入pagination的css--%&gt;
&lt;link href=&quot;css/pagination.css&quot; rel=&quot;stylesheet&quot; /&gt;
&lt;%--引入基于jquery的paginationjs--%&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;jquery/jquery.pagination.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
    $(function () &#123;
        // 调用一个函数
       initPagination();
    &#125;);

    function initPagination()&#123;
        // 获取分页数据中的总记录数
        var totalRecord = $&#123;requestScope.pageInfo.total&#125;;

        // 声明Pagination设置属性的JSON对象
        var properties = &#123;
            num_edge_entries: 3,                                // 边缘页数
            num_display_entries: 5,                             // 主体页数
            callback: pageSelectCallback,                       // 点击各种翻页反扭时触发的回调函数（执行翻页操作）
            current_page: $&#123;requestScope.pageInfo.pageNum-1&#125;,   // 当前页码
            prev_text: &quot;上一页&quot;,                                 // 在对应上一页操作的按钮上显示的文本
            next_text: &quot;下一页&quot;,                                 // 在对应下一页操作的按钮上显示的文本
            items_per_page: $&#123;requestScope.pageInfo.pageSize&#125;   // 每页显示的数量
        &#125;;
        // pagination()方法就是上面的js文件提供的，需要传入总记录数与上面的json对象
        $(&quot;#Pagination&quot;).pagination(totalRecord,properties);
    &#125;

    // 回调函数的代码
    function pageSelectCallback(pageIndex, jQuery)&#123;
        // pageIndex是当前点击的页码的索引，索引从0开始计算，因此比pageNum小1
        var pageNum = pageIndex+1;

        // 执行页面跳转（带页码与关键字）
        window.location.href = &quot;admin/page/page.html?pageNum=&quot;+pageNum+&quot;&amp;keyword=$&#123;param.keyword&#125;&quot;;

        // 取消当前超链接的默认行为
        return false;
    &#125;
&lt;/script&gt;
</code></pre>
<p>​		<strong>注意：</strong>这里的<strong>jquery.pagination.js</strong>源代码会在绘制完整个导航条后，自动调用回调函数，这样会造成代码死循环，因此需要将调用回调函数的代码去掉。</p>
<p><img src="C:\Users\Administrator_\Desktop\尚筹网项目笔记\images\pagination修改.png"></p>
<p>经过测试，此时分页显示的功能已经实现。</p>
<h3 id="2）、实现关键字查询"><a href="#2）、实现关键字查询" class="headerlink" title="2）、实现关键字查询"></a>2）、实现关键字查询</h3><p>​	找到页面中执行查询操作的部分，修改代码成如下：</p>
<p>​		主要设置了该form表单的action、method、输入框的name、输入框的value</p>
<pre><code class="jsp">&lt;form class=&quot;form-inline&quot; action=&quot;admin/page/page.html&quot; method=&quot;post&quot; role=&quot;form&quot; style=&quot;float:left;&quot;&gt;
    &lt;div class=&quot;form-group has-feedback&quot;&gt;
        &lt;div class=&quot;input-group&quot;&gt;
            &lt;div class=&quot;input-group-addon&quot;&gt;查询条件&lt;/div&gt;
            &lt;input class=&quot;form-control has-success&quot; name=&quot;keyword&quot; type=&quot;text&quot; placeholder=&quot;请输入查询条件&quot; value=&quot;$&#123;param.keyword&#125;&quot;/&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;button type=&quot;submit&quot; class=&quot;btn btn-warning&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-search&quot;&gt;&lt;/i&gt; 查询
    &lt;/button&gt;
&lt;/form&gt;
</code></pre>
<p>​	action指向controller层的查询的方法，且在表单中，附带了 name&#x3D;”keyword” 的数据，也就将keyword带给了后端，后端通过@RequestParam接收keyword，传递给service层等等后续操作。</p>
<p>​	且前面的分页js代码中，通过回调函数的跳转链接中给keyword传值：</p>
<p><code>window.location.href = &quot;admin/page/page.html?pageNum=&quot;+pageNum+&quot;&amp;keyword=$&#123;param.keyword&#125;&quot;;</code></p>
<p>可以使在使用换页操作时，仍然带着关键词换页（要注意的是，这里因为有时候keyword并没有，因此keyword传值必须放在链接的最后一个位置，否则可能会引起错误：如&#x3D;&#x3D;keyword&#x3D;&amp;pageNum&#x3D;2&#x3D;&#x3D;这样的url是有问题的）</p>
<h3 id="3）、删除管理员"><a href="#3）、删除管理员" class="headerlink" title="3）、删除管理员"></a>3）、删除管理员</h3><p><img src="D:\浏览器下载\crowd-funding-master\crowd-funding-master\note\images\删除按钮.png"></p>
<h4 id="①后端代码"><a href="#①后端代码" class="headerlink" title="①后端代码"></a>①后端代码</h4><p>​	</p>
<p>​	Controller层代码：</p>
<pre><code class="java">    @RequestMapping(&quot;/admin/page/remove/&#123;adminId&#125;/&#123;pageNum&#125;/&#123;keyword&#125;.html&quot;)
    public String removeAdmin(
            // 从前端获取的管理员id
            @PathVariable(&quot;adminId&quot;) Integer adminId,
            // 从前端获取的当前页码与关键字（为了删除后跳转的页面仍然是刚才的页面，优化体验）
            @PathVariable(&quot;pageNum&quot;) Integer pageNum,
            @PathVariable(&quot;keyword&quot;) String keyword)&#123;
        
        // 调用service层方法，从数据库根据id删除管理员
        adminService.removeById(adminId);
        
        //删除完成后，重定向（减少数据库操作）返回信息页
        return &quot;redirect:/admin/page/page.html?pageNum=&quot;+pageNum+&quot;&amp;keyword=&quot;+keyword;
    &#125;
</code></pre>
<p>​	Service层代码：</p>
<p>（这里其实需要做一些判断：如不能删除现在登录的管理员账号等，但是这里仅仅是作为练习，此处就不写了；另外，在正式的项目中，一般不会将数据库中的信息完全抹去，因为抹去后恢复就很难了，一般可以在表中设置一个状态码，如1表示用户可用，0表示不可用，也就代表被删除了）</p>
<pre><code class="java">// 根据id删除管理员
@Override
public void removeById(Integer adminId) &#123;
    // Mapper接口的方法，根据主键id删除管理员
    adminMapper.deleteByPrimaryKey(adminId);
&#125;
</code></pre>
<h4 id="②前端代码"><a href="#②前端代码" class="headerlink" title="②前端代码"></a>②前端代码</h4><p>​	修改原本对应修改按钮处的代码成如下：</p>
<pre><code class="jsp">&lt;a href=&quot;admin/page/remove/$&#123;admin.id&#125;/$&#123;requestScope.pageInfo.pageNum&#125;/$&#123;param.keyword&#125;.html&quot; class=&quot;btn btn-danger btn-xs&quot;&gt;
    &lt;i class=&quot; glyphicon glyphicon-remove&quot;&gt;&lt;/i&gt;
&lt;/a&gt;
</code></pre>
<p>​	删除管理员功能至此就实现了。</p>
<h3 id="4）、增加管理员"><a href="#4）、增加管理员" class="headerlink" title="4）、增加管理员"></a>4）、增加管理员</h3><p>​	通过一个新增按钮，跳转到新增页面，进行新增管理员的数据填写，然后存入数据库。</p>
<p><img src="D:\浏览器下载\crowd-funding-master\crowd-funding-master\note\images\新增按钮.png"></p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="①数据库操作"><a href="#①数据库操作" class="headerlink" title="①数据库操作"></a>①数据库操作</h4><p>​		数据库中给loginAcct设置唯一约束（防止添加管理员时使用重复的登录账号）</p>
<pre><code class="sql">ALTER TABLE t_admin ADD UNIQUE INDEX(login_acct)
</code></pre>
<p>​		这里判断login_acct是否唯一最好是放在数据库中判断，如果简单地放后端代码中判断，可能会出现同时添加同一个login_acct操作，由于代码执行前后的原因导致最后写入了一样的login_acct，而通过数据库设置唯一约束，则可以从根本避免出现重复数据。</p>
<h4 id="②前端代码："><a href="#②前端代码：" class="headerlink" title="②前端代码："></a>②前端代码：</h4><p>​	新增按钮修改成如下：</p>
<pre><code class="jsp">&lt;a href=&quot;admin/page/save.html&quot; class=&quot;btn btn-primary&quot; style=&quot;float:right;&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-plus&quot;&gt;新增&lt;/i&gt;&lt;/a&gt;
</code></pre>
<p>​	因为该跳转不需要携带数据等操作，所以直接使用view-controller来跳转</p>
<pre><code class="xml">&lt;!--前往注册admin页面--&gt;
&lt;mvc:view-controller path=&quot;/admin/page/save.html&quot; view-name=&quot;admin-add&quot;/&gt;
</code></pre>
<p>​	admin-add.jsp页面代码（主要看添加数据的表单）：</p>
<p>​	主要做了name属性、action、method的修改，修改为与Admin实体类对象对应的模式</p>
<pre><code class="jsp">&lt;div class=&quot;col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main&quot;&gt;
    &lt;ol class=&quot;breadcrumb&quot;&gt;
        &lt;li&gt;&lt;a href=&quot;admin/main/page.html&quot;&gt;首页&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href=&quot;admin/page/page.html&quot;&gt;数据列表&lt;/a&gt;&lt;/li&gt;
        &lt;li class=&quot;active&quot;&gt;新增&lt;/li&gt;
    &lt;/ol&gt;
    &lt;div class=&quot;panel panel-default&quot;&gt;
        &lt;div class=&quot;panel-heading&quot;&gt;表单数据&lt;div style=&quot;float:right;cursor:pointer;&quot; data-toggle=&quot;modal&quot; data-target=&quot;#myModal&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-question-sign&quot;&gt;&lt;/i&gt;&lt;/div&gt;&lt;/div&gt;
        &lt;div class=&quot;panel-body&quot;&gt;
            &lt;form action=&quot;admin/page/doSave.html&quot; method=&quot;post&quot; role=&quot;form&quot;&gt;
                &lt;p&gt;$&#123;requestScope.exception.message&#125;&lt;/p&gt;
                &lt;div class=&quot;form-group&quot;&gt;
                    &lt;label for=&quot;exampleInputPassword1&quot;&gt;登录账号&lt;/label&gt;
                    &lt;input type=&quot;text&quot; name=&quot;loginAcct&quot; class=&quot;form-control&quot; id=&quot;exampleInputPassword1&quot; placeholder=&quot;请输入登录账号&quot;&gt;
                &lt;/div&gt;
                &lt;div class=&quot;form-group&quot;&gt;
                    &lt;label for=&quot;exampleInputPassword1&quot;&gt;用户密码&lt;/label&gt;
                    &lt;input type=&quot;text&quot; name=&quot;userPswd&quot; class=&quot;form-control&quot; id=&quot;exampleInputPassword1&quot; placeholder=&quot;请输入用户密码&quot;&gt;
                &lt;/div&gt;
                &lt;div class=&quot;form-group&quot;&gt;
                    &lt;label for=&quot;exampleInputPassword1&quot;&gt;用户昵称&lt;/label&gt;
                    &lt;input type=&quot;text&quot; name=&quot;userName&quot; class=&quot;form-control&quot; id=&quot;exampleInputPassword1&quot; placeholder=&quot;请输入用户昵称&quot;&gt;
                &lt;/div&gt;

                &lt;div class=&quot;form-group&quot;&gt;
                    &lt;label for=&quot;exampleInputEmail1&quot;&gt;邮箱地址&lt;/label&gt;
                    &lt;input type=&quot;email&quot; name=&quot;email&quot; class=&quot;form-control&quot; id=&quot;exampleInputEmail1&quot; placeholder=&quot;请输入邮箱地址&quot;&gt;
                    &lt;p class=&quot;help-block label label-warning&quot;&gt;请输入合法的邮箱地址, 格式为： xxxx@xxxx.com&lt;/p&gt;
                &lt;/div&gt;
                &lt;button type=&quot;submit&quot; class=&quot;btn btn-success&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-plus&quot;&gt;&lt;/i&gt; 新增&lt;/button&gt;
                &lt;button type=&quot;reset&quot; class=&quot;btn btn-danger&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-refresh&quot;&gt;&lt;/i&gt; 重置&lt;/button&gt;
            &lt;/form&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h4 id="③后端代码"><a href="#③后端代码" class="headerlink" title="③后端代码"></a>③后端代码</h4><p>​		Controller层代码：</p>
<pre><code class="java">@RequestMapping(&quot;/admin/page/doSave.html&quot;)
public String addAdmin(Admin admin)&#123;
    // 调用service层存储admin对象的方法
    adminService.saveAdmin(admin);
    
    // 重定向会原本的页面，且为了能在添加管理员后看到管理员，设置pageNum为整型的最大值（通过修正到最后一页）
    return &quot;redirect:/admin/page/page.html?pageNum=&quot;+Integer.MAX_VALUE;
&#125;
</code></pre>
<p>​	Service层代码：</p>
<pre><code class="java">@Override
public void saveAdmin(Admin admin) &#123;
    // 生成当前系统时间
    Date date = new Date();
    
    // 格式化时间
    SimpleDateFormat simpleDateFormat = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;);
    String createTime = simpleDateFormat.format(date);
    // 设置管理员创建时间
    admin.setCreateTime(createTime);
    
    // 得到前端传入的密码，加密并放回原本的admin对象
    String source = admin.getUserPswd();
    String encoded = CrowdUtil.md5(source);
    admin.setUserPswd(encoded);
    
    // 执行插入操作
    try &#123;
        adminMapper.insert(admin);
    &#125; catch (Exception e)&#123;
        e.printStackTrace();
        // 这里出现异常的话一般就是DuplicateKeyException（因为插入的loginAcct已存在而触发）
        if(e instanceof DuplicateKeyException)&#123;
            // 如果确实是DuplicateKeyException，此时抛出一个自定义的异常
            throw new LoginAcctAlreadyInUseException(CrowdConstant.MESSAGE_SYSTEM_ERROR_LOGIN_NOT_UNIQUE);
        &#125;
    &#125;
&#125;
</code></pre>
<p>​	这里LoginAcctAlreadyInUseException依然是继承了RuntimeException，因此不重复写了。</p>
<p>​	因为会抛出异常，编写异常处理类：</p>
<pre><code class="java">// 新增管理员时，login_acct已存在，则返回admin-add.jsp页面，附带异常信息
@ExceptionHandler(value = LoginAcctAlreadyInUseException.class)
public ModelAndView resolverLoginAcctAlreadyInUseException(
        LoginAcctAlreadyInUseException exception, HttpServletRequest request,
        HttpServletResponse response) throws IOException &#123;
    String viewName = &quot;admin-add&quot;;
    return commonCode(exception,request,response,viewName);
&#125;
</code></pre>
<p>​	在前端显示异常信息：</p>
<p><img src="D:\浏览器下载\crowd-funding-master\crowd-funding-master\note\images\main-add显示异常信息.png"></p>
<h3 id="5）、更新管理员信息"><a href="#5）、更新管理员信息" class="headerlink" title="5）、更新管理员信息"></a>5）、更新管理员信息</h3><p>​	实现效果：通过管理员信息页面的铅笔按钮，进入修改页面，且页面中存在了对应管理员的现有信息，通过修改这些信息后点击更新按钮，实现管理员信息根系</p>
<p><img src="D:\浏览器下载\crowd-funding-master\crowd-funding-master\note\images\更新按钮.png"></p>
<p>​	</p>
<p>修改铅笔按钮处代码，</p>
<p>携带当前管理员的id（用于显示要修改的管理员信息）、当前页面、关键字（用于修改完后的跳转）：</p>
<pre><code class="jsp">&lt;a href=&quot;admin/page/update/$&#123;admin.id&#125;/$&#123;requestScope.pageInfo.pageNum&#125;/$&#123;param.keyword&#125;.html&quot; 
   class=&quot;btn btn-primary btn-xs&quot;&gt;&lt;i class=&quot; glyphicon glyphicon-pencil&quot;&gt;&lt;/i&gt;&lt;/a&gt;
</code></pre>
<p>​	对应该请求的Controller方法：</p>
<pre><code class="java">    @RequestMapping(&quot;/admin/page/update/&#123;adminId&#125;/&#123;pageNum&#125;/&#123;keyword&#125;.html&quot;)
    public String toUpdatePage(
            @PathVariable(&quot;adminId&quot;) Integer adminId,
            @PathVariable(&quot;pageNum&quot;) Integer pageNum,
            @PathVariable(&quot;keyword&quot;) String keyword,
            ModelMap modelMap)&#123;
        // 调用Service方法，通过id查询admin对象
        Admin admin = adminService.queryAdmin(adminId);
        
        // 将admin对象、页码、关键字存入modelMap，传到前端页面
        modelMap.addAttribute(&quot;admin&quot;, admin);
        modelMap.addAttribute(&quot;pageNum&quot;, pageNum);
        modelMap.addAttribute(&quot;keyword&quot;, keyword);
        
        // 跳转到更新页面WEB-INF/admin-update.jsp
        return &quot;admin-update&quot;;
    &#125;
</code></pre>
<p>​	adminService.queryAdmin(id)就是简单的调用mapper接口通过id查Admin的方法，这里省略。</p>
<p>​	admin-update.jsp页面的代码：</p>
<p>​		更新页面与添加页面其实是类似的，只是更新页面需要在各个文本框中显示要修改的原数据。</p>
<pre><code class="jsp">&lt;div class=&quot;col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main&quot;&gt;
            &lt;ol class=&quot;breadcrumb&quot;&gt;
                &lt;li&gt;&lt;a href=&quot;admin/main/page.html&quot;&gt;首页&lt;/a&gt;&lt;/li&gt;
                &lt;li&gt;&lt;a href=&quot;admin/page/page.html&quot;&gt;数据列表&lt;/a&gt;&lt;/li&gt;
                &lt;li class=&quot;active&quot;&gt;更新&lt;/li&gt;
            &lt;/ol&gt;
            &lt;div class=&quot;panel panel-default&quot;&gt;
                &lt;div class=&quot;panel-heading&quot;&gt;表单数据
                    &lt;div style=&quot;float:right;cursor:pointer;&quot; data-toggle=&quot;modal&quot; data-target=&quot;#myModal&quot;&gt;
                        &lt;i class=&quot;glyphicon glyphicon-question-sign&quot;&gt;&lt;/i&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                &lt;div class=&quot;panel-body&quot;&gt;
                    &lt;form action=&quot;admin/page/doUpdate.html&quot; method=&quot;post&quot; role=&quot;form&quot;&gt;
                        &lt;%-- 显示错误信息 --%&gt;
                        &lt;p&gt;$&#123;requestScope.exception.message&#125;&lt;/p&gt;
                        &lt;%-- type=hidden，因为这些数据不需要（pageNum、keyword）或不应该被修改（id、createTime）只需要传递给后端即可 --%&gt;
                        &lt;input type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;$&#123;requestScope.admin.id&#125;&quot;/&gt;
                        &lt;input type=&quot;hidden&quot; name=&quot;createTime&quot; value=&quot;$&#123;requestScope.admin.createTime&#125;&quot;/&gt;
                        &lt;input type=&quot;hidden&quot; name=&quot;pageNum&quot; value=&quot;$&#123;requestScope.pageNum&#125;&quot;/&gt;
                        &lt;input type=&quot;hidden&quot; name=&quot;keyword&quot; value=&quot;$&#123;requestScope.keyword&#125;&quot;/&gt;
                        &lt;div class=&quot;form-group&quot;&gt;
                            &lt;label for=&quot;exampleInputPassword1&quot;&gt;登录账号&lt;/label&gt;
                            &lt;%-- 通过value给各个文本框赋原始值 --%&gt;
                            &lt;input type=&quot;text&quot; name=&quot;loginAcct&quot; class=&quot;form-control&quot; id=&quot;exampleInputPassword1&quot; 
                                   value=&quot;$&#123;requestScope.admin.loginAcct&#125;&quot; placeholder=&quot;请输入登录账号&quot;&gt;
                        &lt;/div&gt;
                        &lt;div class=&quot;form-group&quot;&gt;
                            &lt;label for=&quot;exampleInputPassword1&quot;&gt;用户昵称&lt;/label&gt;
                            &lt;input type=&quot;text&quot; name=&quot;userName&quot; class=&quot;form-control&quot; id=&quot;exampleInputPassword1&quot; 
                                   value=&quot;$&#123;requestScope.admin.userName&#125;&quot; placeholder=&quot;请输入用户昵称&quot;&gt;
                        &lt;/div&gt;

                        &lt;div class=&quot;form-group&quot;&gt;
                            &lt;label for=&quot;exampleInputEmail1&quot;&gt;邮箱地址&lt;/label&gt;
                            &lt;input type=&quot;email&quot; name=&quot;email&quot; class=&quot;form-control&quot; id=&quot;exampleInputEmail1&quot; 
                                   value=&quot;$&#123;requestScope.admin.email&#125;&quot; placeholder=&quot;请输入邮箱地址&quot;&gt;
                            &lt;p class=&quot;help-block label label-warning&quot;&gt;请输入合法的邮箱地址, 格式为： xxxx@xxxx.com&lt;/p&gt;
                        &lt;/div&gt;
                        &lt;button type=&quot;submit&quot; class=&quot;btn btn-success&quot;&gt;
                            &lt;i class=&quot;glyphicon glyphicon-plus&quot;&gt;修改&lt;/i&gt; 
                        &lt;/button&gt;
                        &lt;button type=&quot;reset&quot; class=&quot;btn btn-danger&quot;&gt;
                            &lt;i class=&quot;glyphicon glyphicon-refresh&quot;&gt;重置&lt;/i&gt; 
                        &lt;/button&gt;
                    &lt;/form&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
</code></pre>
<p>​	更新页面提交后进入的Controller方法：</p>
<pre><code class="java">@RequestMapping(&quot;/admin/page/doUpdate.html&quot;)
public String updateAdmin(Admin admin,@RequestParam(&quot;pageNum&quot;) Integer pageNum,@RequestParam(&quot;keyword&quot;) String keyword)&#123;
    
    // 调用service层 updateAdmin方法
    adminService.updateAdmin(admin);
    
    // 正常执行则进入原先的管理员信息页面
    return &quot;redirect:/admin/page/page.html?pageNum=&quot;+pageNum + &quot;&amp;keyword=&quot;+keyword;
&#125;
</code></pre>
<p>​	service层updateAdmin()方法：</p>
<pre><code class="java">@Override
public void updateAdmin(Admin admin) &#123;
    // 利用try-catch块，处理更新管理员信息时，修改后的loginAcct已经在数据库中存在
    try &#123;
        adminMapper.updateByPrimaryKeySelective(admin);
    &#125; catch (Exception e)&#123;
        e.printStackTrace();
        if (e instanceof DuplicateKeyException)&#123;
            // 当触发该异常时，抛出另一个针对更新时loginAcct已存在的异常
            throw new LoginAcctAlreadyInUseForUpdateException(CrowdConstant.MESSAGE_SYSTEM_ERROR_LOGIN_NOT_UNIQUE);
        &#125;
    &#125;
&#125;
</code></pre>
<p>​	编写异常处理类的代码：</p>
<pre><code class="java">// 更新时，不应将账号改为与其他账号同名
@ExceptionHandler(value = LoginAcctAlreadyInUseForUpdateException.class)
public ModelAndView resolverLoginAcctAlreadyInUseForUpdateException(
        LoginAcctAlreadyInUseForUpdateException exception, HttpServletRequest request,
        HttpServletResponse response) throws IOException &#123;
    // 此时进入的是system-error.jsp的页面
    String viewName = &quot;system-error&quot;;
    return commonCode(exception,request,response,viewName);
&#125;
</code></pre>
<h1 id="【角色维护】页面"><a href="#【角色维护】页面" class="headerlink" title="【角色维护】页面"></a>【角色维护】页面</h1><h2 id="一、分页操作"><a href="#一、分页操作" class="headerlink" title="一、分页操作"></a>一、分页操作</h2><h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><p>将角色数据进行分页显示</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>点击后台主页面的权限管理-&gt;角色维护，通过view-controller进入角色分页显示的页面，浏览器加载页面的数据并初始化一些数据（页码、页大小、关键词等），调用分页函数与后端交互进行分页操作，得到分页后的页面，并生成页码导航条，且可通过关键词来匹配角色。</p>
<p>与管理员维护部分不同的是，这里与后端交互，都通过json格式接收信息，而不通过直接的页面。</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>1、创建数据库表：</p>
<pre><code class="sql">#使用project_rowd数据库
use project_rowd;

#创建t_role表
CREATE TABLE t_role(
    id INT NOT NULL,
    name char(100),
    PRIMARY KEY(id)
);

#设置id自增
ALTER TABLE t_role CHANGE id id INT NOT NULL auto_increment;
</code></pre>
<p>​	</p>
<p>2、逆向生成资源</p>
<p>​		①修改generatorConfig代码：改为t_role表与Role实体类对应</p>
<pre><code class="xml">&lt;!-- 数据库表名与需要的实体类对应映射的指定 --&gt;
&lt;table tableName=&quot;t_role&quot; domainObjectName=&quot;Role&quot;/&gt;
</code></pre>
<p>​		②通过maven中的工具，执行逆向工程，并把生成的内容都移动到正确的位置。</p>
<p>3、编写包含关键字的SQL查询语句</p>
<p>​		RoleMapper.xml</p>
<pre><code class="xml">&lt;!--查询所有匹配的role信息，用于分页显示--&gt;
&lt;select id=&quot;selectRoleByKeyword&quot; resultMap=&quot;BaseResultMap&quot;&gt;
  select id,name
  from t_role
  where
  name like CONCAT(&quot;%&quot;,#&#123;keyword&#125;,&quot;%&quot;)
&lt;/select&gt;
</code></pre>
<p>4、后端代码</p>
<p>​		RoleMapper.java</p>
<pre><code class="java">List&lt;Role&gt; selectRoleByKeyword(String keyword);
</code></pre>
<p>​		RoleServiceImpl.java</p>
<pre><code class="java">@Autowired
RoleMapper roleMapper;

// 获取分页的用户列表
@Override
public PageInfo&lt;Role&gt; getPageInfo(int pageNum, int pageSize, String keyword) &#123;
    // 开启分页
    PageHelper.startPage(pageNum,pageSize);

    // 从mapper方法得到Role的List
    List&lt;Role&gt; roles = roleMapper.selectRoleByKeyword(keyword);

    // 封装为PageInfo对象
    PageInfo&lt;Role&gt; pageInfo = new PageInfo&lt;Role&gt;(roles);

    // 返回pageInfo
    return pageInfo;
&#125;
</code></pre>
<p>​		RoleHandler.java</p>
<pre><code class="java">// 以json形式显示分页后的role信息
@ResponseBody
@RequestMapping(&quot;/role/page/page.json&quot;)
public ResultEntity&lt;PageInfo&lt;Role&gt;&gt; getPageInfo(
        @RequestParam(value = &quot;pageNum&quot;, defaultValue = &quot;1&quot;) Integer pageNum,
        @RequestParam(value = &quot;pageSize&quot;, defaultValue = &quot;5&quot;) Integer pageSize,
        @RequestParam(value = &quot;keyword&quot;, defaultValue = &quot;&quot;) String keyword ) &#123;
    // 从Service层得到pageInfo
    PageInfo&lt;Role&gt; pageInfo = roleService.getPageInfo(pageNum, pageSize, keyword);

    // 返回ResultEntity，Data就是得到的pageInfo
    return ResultEntity.successWithData(pageInfo);
&#125;
</code></pre>
<p>5、前端代码</p>
<p>​		通过view-controller使点击后台主页面的对应按钮时可以跳转到用户维护页面</p>
<p>​		在被提取出来的include-sidebar.jsp中：</p>
<pre><code class="html">&lt;li style=&quot;height:30px;&quot;&gt;
    &lt;a href=&quot;role/to/page.html&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-king&quot;&gt;&lt;/i&gt; 角色维护&lt;/a&gt;
&lt;/li&gt;
</code></pre>
<p>​		将对应路径加载mvc配置文件中</p>
<pre><code class="xml">&lt;!-- 前往角色维护页面 --&gt;
&lt;mvc:view-controller path=&quot;/role/to/page.html&quot; view-name=&quot;role-page&quot;/&gt;
</code></pre>
<p>​		创建显示分页内容的页面——role-page.jsp</p>
<p>​		大体的结构与前面admin-page.jsp类似。</p>
<p>​		在该部分中，分页、页码导航条的内容，提取到外部js文件的各个方法中来实现：</p>
<p>​		<strong>my-role.js</strong></p>
<pre><code class="javascript">// 执行分页，生成分页效果
function generatePage()&#123;
    // 通过getPageInfoRemote()方法得到pageInfo
    var pageInfo = getPageInfoRemote();
    
    // 将pageInfo传入fillTableTBody()方法，在tbody中生成分页后的数据
    fillTableTBody(pageInfo);
&#125;

// 从远程服务器端获取PageInfo数据
function getPageInfoRemote()&#123;

    // 调用$.ajax()函数发送请求，并用ajaxResult接收函数返回值
    var ajaxResult = $.ajax(&#123;
        url:&quot;role/page/page.json&quot;,
        type:&quot;post&quot;,
        // 页码、页大小、关键字均从全局变量中获取
        data:&#123;
            &quot;pageNum&quot;:window.pageNum,
            &quot;pageSize&quot;:window.pageSize,
            &quot;keyword&quot;:window.keyword
        &#125;,
        async:false,        //关闭异步模式，使用同步，这是为了显示页面时保持现有的顺序
        dataType:&quot;json&quot;
    &#125;);

    // 取得当前的响应状态码
    var statusCode = ajaxResult.status;

    // 判断当前状态码是不是200，不是200表示发生错误，通过layer提示错误消息
    if(statusCode != 200) &#123;
        layer.msg(&quot;失败！状态码=&quot; + statusCode + &quot;错误信息=&quot; + ajaxResult.statusText);
        return null;
    &#125;

    // 响应状态码为200，进入下面的代码
    // 通过responseJSON取得handler中的返回值
    var resultEntity = ajaxResult.responseJSON;

    // 从resultEntity取得result属性
    var result = resultEntity.result;

    // 判断result是否是FAILED
    if (result == &quot;FAILED&quot;) &#123;
        // 显示失败的信息
        layer.msg(resultEntity.message);
        return null;
    &#125;

    // result不是失败时，获取pageInfo
    var pageInfo = resultEntity.data;

    // 返回pageInfo
    return pageInfo;
&#125;

// 根据PageInfo填充表格
function fillTableTBody(pageInfo)&#123;

    // 清除tbody中的旧内容
    $(&quot;#rolePageTBody&quot;).empty();

    // 使无查询结果时，不显示导航条
    $(&quot;#Pagination&quot;).empty();

    // 判断pageInfo对象是否有效，无效则表示未查到数据
    if (pageInfo == null || pageInfo == undefined || pageInfo.list == null || pageInfo.list.length == 0) &#123;
        $(&quot;#rolePageTBody&quot;).append(&quot;&lt;tr&gt;&lt;td colspan=&#39;4&#39; align=&#39;center&#39;&gt;抱歉！没有查询到想要的数据&lt;/td&gt;&lt;/tr&gt;&quot;);
        return;
    &#125;

    // pageInfo有效，使用pageInfo的list填充tbody
    for (var i = 0; i &lt; pageInfo.list.length; i++) &#123;

        var role = pageInfo.list[i];
        var roleId = role.id;
        var roleName = role.name;
        var numberTd = &quot;&lt;td&gt;&quot;+(i+1)+&quot;&lt;/td&gt;&quot;;
        var checkboxTd = &quot;&lt;td&gt;&lt;input type=&#39;checkbox&#39;/&gt;&lt;/td&gt;&quot;;
        var roleNameTd = &quot;&lt;td&gt;&quot; + roleName + &quot;&lt;/td&gt;&quot;;

        var checkBtn = &quot;&lt;button type=&#39;button&#39; class=&#39;btn btn-success btn-xs&#39;&gt;&lt;i class=&#39; glyphicon glyphicon-check&#39;&gt;&lt;/i&gt;&lt;/button&gt;&quot;

        var pencilBtn = &quot;&lt;button type=&#39;button&#39; class=&#39;btn btn-primary btn-xs&#39;&gt;&lt;i class=&#39; glyphicon glyphicon-pencil&#39;&gt;&lt;/i&gt;&lt;/button&gt;&quot;

        var removeBtn = &quot;&lt;button type=&#39;button&#39; class=&#39;btn btn-danger btn-xs&#39;&gt;&lt;i class=&#39; glyphicon glyphicon-remove&#39;&gt;&lt;/i&gt;&lt;/button&gt;&quot;

        // 拼接三个小按钮成一个td
        var buttonTd = &quot;&lt;td&gt;&quot;+checkBtn + &quot; &quot; + pencilBtn + &quot; &quot; + removeBtn + &quot;&lt;/td&gt;&quot;;
        
        // 将所有的td拼接成tr
        var tr = &quot;&lt;tr&gt;&quot; + numberTd + checkboxTd + roleNameTd + buttonTd + &quot;&lt;/tr&gt;&quot;;

        // 将拼接后的结果，放入id=rolePageTBody
        $(&quot;#rolePageTBody&quot;).append(tr);
    &#125;

    // 调用generateNavigator()方法传入pageInfo，进行生成分页页码导航条
    generateNavigator(pageInfo);

&#125;

// 生成分页页码导航条
function generateNavigator(pageInfo)&#123;


    //获取分页数据中的总记录数
    var totalRecord = pageInfo.total;

    //声明Pagination设置属性的JSON对象
    var properties = &#123;
        num_edge_entries: 3,                                //边缘页数
        num_display_entries: 5,                             //主体页数
        callback: paginationCallback,                       //点击各种翻页反扭时触发的回调函数（执行翻页操作）
        current_page: (pageInfo.pageNum-1),                 //当前页码
        prev_text: &quot;上一页&quot;,                                 //在对应上一页操作的按钮上的文本
        next_text: &quot;下一页&quot;,                                 //在对应下一页操作的按钮上的文本
        items_per_page: pageInfo.pageSize   				//每页显示的数量
    &#125;;

    // 调用pagination()函数，生成导航条
    $(&quot;#Pagination&quot;).pagination(totalRecord,properties);


&#125;

// 翻页时的回调函数
function paginationCallback(pageIndex, jQuery)&#123;

    // pageIndex是当前页码的索引，因此比pageNum小1
    window.pageNum = pageIndex+1;

    // 重新执行分页代码
    generatePage();

    // 取消当前超链接的默认行为
    return false;

&#125;
</code></pre>
<p>​		编写role-page.jsp页面，进行引入外部js、调用js中的函数等操作</p>
<pre><code class="jsp">&lt;%--引入pagination的css--%&gt;
&lt;link href=&quot;css/pagination.css&quot; rel=&quot;stylesheet&quot; /&gt;
&lt;%--引入基于jquery的paginationjs--%&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;jquery/jquery.pagination.js&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;crowd/my-role.js&quot; charset=&quot;UTF-8&quot;&gt;&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
    $(function ()&#123;
        // 设置各个全局变量，方便外部js文件中使用
        window.pageNum = 1;
        window.pageSize = 5;
        window.keyword = &quot;&quot;;
        // 调用外部的生成分页的函数
        generatePage();
    &#125;
&lt;/script&gt;

    ...中间代码省略
    &lt;div class=&quot;table-responsive&quot;&gt;
        &lt;table class=&quot;table  table-bordered&quot;&gt;
            &lt;thead&gt;
            &lt;tr&gt;
                &lt;th width=&quot;30&quot;&gt;#&lt;/th&gt;
                &lt;th width=&quot;30&quot;&gt;&lt;input type=&quot;checkbox&quot;&gt;&lt;/th&gt;
                &lt;th&gt;名称&lt;/th&gt;
                &lt;th width=&quot;100&quot;&gt;操作&lt;/th&gt;
            &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;%--  tbody的id=rolePageTBody,用于绑定on()函数 --%&gt;
            &lt;tbody id=&quot;rolePageTBody&quot;&gt;
            &lt;/tbody&gt;
            &lt;tfoot&gt;
            &lt;tr&gt;
                &lt;td colspan=&quot;6&quot; align=&quot;center&quot;&gt;
                    &lt;div id=&quot;Pagination&quot; class=&quot;pagination&quot;&gt;&lt;!-- 这里显示分页导航条 --&gt;&lt;/div&gt;
                &lt;/td&gt;
            &lt;/tr&gt;
            &lt;/tfoot&gt;
        &lt;/table&gt;
    &lt;/div&gt;
    ...中间代码省略
</code></pre>
<p>​	至此分页功能已经实现。</p>
<h2 id="二、关键字查询"><a href="#二、关键字查询" class="headerlink" title="二、关键字查询"></a>二、关键字查询</h2><h3 id="目标-1"><a href="#目标-1" class="headerlink" title="目标"></a>目标</h3><p>​			只需要将页面上的查询对应表单和已经封装好的分页函数对接即可。</p>
<h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><p>​			从文本框获得关键字，给查询按钮绑定单击函数，将得到的关键字放入全局变量keyword中，再重新执行generatePage()函数。</p>
<h3 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h3><p>​			查询操作的表单中给input、按钮设置id：</p>
<pre><code class="jsp">&lt;form class=&quot;form-inline&quot; role=&quot;form&quot; style=&quot;float:left;&quot;&gt;
    &lt;div class=&quot;form-group has-feedback&quot;&gt;
        &lt;div class=&quot;input-group&quot;&gt;
            &lt;div class=&quot;input-group-addon&quot;&gt;查询条件&lt;/div&gt;
            &lt;input class=&quot;form-control has-success&quot; id=&quot;inputKeyword&quot; type=&quot;text&quot; placeholder=&quot;请输入查询条件&quot;&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;button id=&quot;searchBtn&quot; type=&quot;button&quot; class=&quot;btn btn-warning&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-search&quot;&gt;&lt;/i&gt; 查询
    &lt;/button&gt;
&lt;/form&gt;
</code></pre>
<p>​		给查询按钮绑定单击函数：</p>
<pre><code class="javascript">$(function ()&#123;
    // 给查询按钮绑定单击响应函数
    $(&quot;#searchBtn&quot;).click(function ()&#123;
        // 设置全局变量的keyword为id=inputKeyword的元素中的内容
        window.keyword = $(&quot;#inputKeyword&quot;).val();
        // 将页码归为1
        window.pageNum = 1;
        // 重新执行分页操作
        generatePage();
    &#125;);
&#125;
</code></pre>
<h2 id="三、保存角色"><a href="#三、保存角色" class="headerlink" title="三、保存角色"></a>三、保存角色</h2><h3 id="目标-2"><a href="#目标-2" class="headerlink" title="目标"></a>目标</h3><p>​		点击新增的按钮后，打开一个模态框，在其中输入新角色信息，点击保存完成操作。</p>
<h3 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h3><p>​		给新增按钮绑定单击响应函数，用于打开模态框，模态框中点击保存后，获取输入的信息，将其中信息通过Ajax请求的方式发送给后端，然后关闭模态框，显示操作结果，清理模态框中的文字，重新加载分页。</p>
<h3 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h3><p>​		①新建一个JSP文件，用于存放用于添加的模态框窗口代码（modal-role-add.jsp）：</p>
<pre><code class="jsp">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; pageEncoding=&quot;UTF-8&quot; %&gt;
&lt;div id=&quot;addRoleModal&quot; class=&quot;modal fade&quot; tabindex=&quot;-1&quot; role=&quot;dialog&quot;&gt;
    &lt;div  class=&quot;modal-dialog&quot; role=&quot;document&quot;&gt;
        &lt;div class=&quot;modal-content&quot;&gt;
            &lt;div class=&quot;modal-header&quot;&gt;
                &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-label=&quot;Close&quot;&gt;&lt;span aria-hidden=&quot;true&quot;&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;
                &lt;h4 class=&quot;modal-title&quot;&gt;尚筹网-角色添加&lt;/h4&gt;
            &lt;/div&gt;
            &lt;div class=&quot;modal-body&quot;&gt;
                &lt;form class=&quot;form-signin&quot; role=&quot;form&quot;&gt;
                    &lt;div class=&quot;form-group has-success has-feedback&quot;&gt;
                        &lt;input type=&quot;text&quot; name=&quot;roleName&quot; class=&quot;form-control&quot; id=&quot;inputSuccess4&quot; placeholder=&quot;请输入角色名称&quot; autofocus&gt;
                        &lt;span class=&quot;glyphicon glyphicon-user form-control-feedback&quot;&gt;&lt;/span&gt;
                    &lt;/div&gt;
                &lt;/form&gt;
            &lt;/div&gt;
            &lt;div class=&quot;modal-footer&quot;&gt;
                &lt;button id=&quot;saveRoleBtn&quot; type=&quot;button&quot; class=&quot;btn btn-primary&quot;&gt;保存&lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>​		②在分页显示的页面引入模态框（放在body标签的末尾）</p>
<pre><code class="jsp">&lt;%@include file=&quot;/WEB-INF/modal-role-add.jsp&quot;%&gt;
</code></pre>
<p>​		③给新增按钮绑定单击响应函数，用于打开模态框</p>
<pre><code class="jsp">// 单击添加按钮，打开添加角色的模态框（这段js代码位于jsp文件的$(function())中）
    $(&quot;#showAddModalBtn&quot;).click(function () &#123;
    $(&quot;#addRoleModal&quot;).modal(&quot;show&quot;);
&#125;);

&lt;%-- body标签中的新增按钮 --%&gt;
&lt;button type=&quot;button&quot; class=&quot;btn btn-primary&quot; 
        style=&quot;float:right;&quot; id=&quot;showAddModalBtn&quot;&gt;
    &lt;i class=&quot;glyphicon glyphicon-plus&quot;&gt;&lt;/i&gt; 新增
&lt;/button&gt;
</code></pre>
<p>​		④点击模态框中的保存按钮后，触发的事件（直接写在jsp中）：</p>
<pre><code class="javascript">// 单击模态框中的保存按钮，给后端发送要保存的数据
$(&quot;#saveRoleBtn&quot;).click(function () &#123;
    // 获取id为addRoleModal的子元素中name为&quot;roleName&quot;的元素的内容，并去空格(trim)
    var roleName = $.trim($(&quot;#addRoleModal [name=roleName]&quot;).val());

    $.ajax(&#123;
        url:&quot;role/do/save.json&quot;,
        type:&quot;post&quot;,
        data:&#123;
          &quot;name&quot;:roleName
        &#125;,
        dataType:&quot;json&quot;,
        success:function (response) &#123;
            // 返回的result为SUCCESS
            if (response.result == &quot;SUCCESS&quot;)&#123;
                layer.msg(&quot;操作成功！&quot;);
                // 进入最后一页 方便显示添加的内容
                window.pageNum = 999;
                // 重新生成分页
                generatePage();
            &#125;
            // 返回的result为FAILED
            if (response.result == &quot;FAILED&quot;)
                layer.msg(&quot;操作失败&quot;+response.message)
        &#125;,
        error:function (response) &#123;
            layer.msg(&quot;statusCode=&quot;+response.status + &quot; message=&quot;+response.statusText);
        &#125;

    &#125;);

    // 关闭模态框
    $(&quot;#addRoleModal&quot;).modal(&quot;hide&quot;);

    // 清理模态框文本框
    $(&quot;#addRoleModal [name=roleName]&quot;).val(&quot;&quot;);

&#125;);
</code></pre>
<p>​		⑤后端controller代码：</p>
<pre><code class="java">@ResponseBody
@RequestMapping(&quot;/role/do/save.json&quot;)
public ResultEntity&lt;String&gt; saveRole(Role role)&#123;
    roleService.saveRole(role);

    return ResultEntity.successWithoutData();
&#125;
</code></pre>
<p>​		⑥Service层代码：</p>
<pre><code class="java">@Override
public void saveRole(Role role) &#123;
    roleMapper.insert(role);
&#125;
</code></pre>
<p>​		</p>
<p>​		此时角色添加功能已经实现。因为数据库中设置了id为自增，因此只需要传入一个角色名，就可以通过Role对象接收，之后由数据库自动加上角色的id。</p>
<h2 id="四、更新角色"><a href="#四、更新角色" class="headerlink" title="四、更新角色"></a>四、更新角色</h2><h3 id="目标-3"><a href="#目标-3" class="headerlink" title="目标"></a>目标</h3><p>​		通过每一个角色的“铅笔”按钮，修改角色信息。</p>
<h3 id="思路-3"><a href="#思路-3" class="headerlink" title="思路"></a>思路</h3><p>​		给铅笔按钮绑定单击响应函数，打开修改角色的模态框，且角色名的文本框中回显当前角色的名称，通过点击模态框中的更新按钮，获取文本框中获取到的角色名，给后端发送Ajax请求，最后完成后关闭模态框，显示操作结果，重新加载分页。</p>
<h3 id="代码-3"><a href="#代码-3" class="headerlink" title="代码"></a>代码</h3><p>​		①修改角色页面的模态框（modal-role-update.jsp）</p>
<pre><code class="jsp">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; pageEncoding=&quot;UTF-8&quot; %&gt;
&lt;div id=&quot;updateRoleModal&quot; class=&quot;modal fade&quot; tabindex=&quot;-1&quot; role=&quot;dialog&quot;&gt;
    &lt;div  class=&quot;modal-dialog&quot; role=&quot;document&quot;&gt;
        &lt;div class=&quot;modal-content&quot;&gt;
            &lt;div class=&quot;modal-header&quot;&gt;
                &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-label=&quot;Close&quot;&gt;&lt;span aria-hidden=&quot;true&quot;&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;
                &lt;h4 class=&quot;modal-title&quot;&gt;尚筹网-角色更新&lt;/h4&gt;
            &lt;/div&gt;
            &lt;div class=&quot;modal-body&quot;&gt;
                &lt;form class=&quot;form-signin&quot; role=&quot;form&quot;&gt;
                    &lt;div class=&quot;form-group has-success has-feedback&quot;&gt;
                        &lt;input type=&quot;text&quot; name=&quot;roleName&quot; class=&quot;form-control&quot; id=&quot;inputSuccess4&quot; placeholder=&quot;请输入角色名称&quot; autofocus&gt;
                        &lt;span class=&quot;glyphicon glyphicon-user form-control-feedback&quot;&gt;&lt;/span&gt;
                    &lt;/div&gt;
                &lt;/form&gt;
            &lt;/div&gt;
            &lt;div class=&quot;modal-footer&quot;&gt;
                &lt;button id=&quot;updateRoleBtn&quot; type=&quot;button&quot; class=&quot;btn btn-success&quot;&gt;更新&lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>​		②JSP页面引入模态框</p>
<pre><code class="jsp">&lt;%@include file=&quot;/WEB-INF/modal-role-update.jsp&quot;%&gt;
</code></pre>
<p>​		</p>
<p>​		修改外部js中生成代码中生成铅笔按钮时，给其添加id与class（id为当前角色的id，class统一为pencilBtn）</p>
<pre><code class="javascript">// 铅笔按钮用于修改role信息。用id属性（也可以是其他属性）携带当前的角色的id，class添加一个pencilBtn，方便添加响应函数
var pencilBtn = 
    &quot;&lt;button type=&#39;button&#39; id=&#39;&quot;+roleId+&quot;&#39; class=&#39;btn btn-primary btn-xs pencilBtn&#39;&gt;&lt;i class=&#39; glyphicon glyphicon-pencil&#39;&gt;&lt;/i&gt;&lt;/button&gt;&quot;
</code></pre>
<p>​		③给每一个铅笔按钮绑定单击函数（写在role-page.jsp文件中）</p>
<p>​		因为这些按钮都通过动态生成，且翻页时Ajax形式的，因此不能简单的通过$(“xxx”).click()实现绑定单击函数（这样绑定在翻页后就		实失效了），而是需要使用jquery的on函数来绑定。</p>
<pre><code class="javascript">// 给铅笔按钮绑定单击响应函数
// 注意，如果这里使用简单的$(&quot;.pencilBtn&quot;).click();来绑定，会发现只在初始页生效，当进入其他页码时，按钮失效
// 因此，这里使用jQuery的on()函数解决上面的问题
// on()函数三个传参：1、事件名 ; 2、真正要绑定的按钮的选择器 ; 3、绑定的函数
$(&quot;#rolePageTBody&quot;).on(&quot;click&quot;,&quot;.pencilBtn&quot;,function () &#123;

    // 打开模态框
    $(&quot;#updateRoleModal&quot;).modal(&quot;show&quot;);

    // 获取表格中当前行的roleName（通过找父元素的前一个兄弟元素）
    var roleName = $(this).parent().prev().text();

    // 根据pencilBtn的id获得角色id
    // 存放在全局变量中，为了让执行更新操作的按钮可以获取到roleId
    window.roleId = this.id;

    // 将得到的roleName填充到模态框中（id=updateRoleModal的元素的后代元素，且name=roleName的文本框）
    $(&quot;#updateRoleModal [name=roleName]&quot;).val(roleName);

&#125;);
</code></pre>
<p>roleName的定位过程：</p>
<p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/定位.jpg"></p>
<p>​		④给模态框中的修改按钮绑定单击函数</p>
<pre><code class="javascript">// 给更新模态框中的更新按钮绑定单击响应函数
$(&quot;#updateRoleBtn&quot;).click(function () &#123;

    // 从模态框的文本框中获得修改后的roleName
    var roleName = $(&quot;#updateRoleModal [name=roleName]&quot;).val();

    $.ajax(&#123;
        url: &quot;role/do/update.json&quot;,
        type: &quot;post&quot;,
        data: &#123;
            &quot;id&quot;:window.roleId,	// 从全局遍历取得当前角色的id
            &quot;name&quot;:roleName
        &#125;,
        dataType: &quot;json&quot;,
        success:function (response) &#123;
            if (response.result == &quot;SUCCESS&quot;)&#123;
                layer.msg(&quot;操作成功！&quot;);
                generatePage();
            &#125;
            if (response.result == &quot;FAILED&quot;)
                layer.msg(&quot;操作失败&quot;+response.message)
        &#125;,
        error:function (response) &#123;
            layer.msg(&quot;statusCode=&quot;+response.status + &quot; message=&quot;+response.statusText);
        &#125;
    &#125;);

    // 关闭模态框
    $(&quot;#updateRoleModal&quot;).modal(&quot;hide&quot;);
    // 由于铅笔按钮每次都会向文本框填充被更新角色的原始数据，因此不需要情况文本框
&#125;);
</code></pre>
<p>​		⑤编写后端代码：</p>
<p>​		Controller层：</p>
<pre><code class="java">@ResponseBody
@RequestMapping(&quot;/role/do/update.json&quot;)
public ResultEntity&lt;String&gt; updateRole(Role role)&#123;
    roleService.updateRole(role);
    return ResultEntity.successWithoutData();
&#125;
</code></pre>
<p>​		Service层：</p>
<pre><code class="java">@Override
public void updateRole(Role role) &#123;
    // 通过主键（id）修改角色名
    roleMapper.updateByPrimaryKey(role);
&#125;
</code></pre>
<h2 id="五、删除角色"><a href="#五、删除角色" class="headerlink" title="五、删除角色"></a>五、删除角色</h2><h3 id="目标-4"><a href="#目标-4" class="headerlink" title="目标"></a>目标</h3><p>​	实现多角色同时删除以及单条角色快速删除</p>
<h3 id="思路-4"><a href="#思路-4" class="headerlink" title="思路"></a>思路</h3><p>​	单击每一个角色对应的红色<strong>X</strong>按钮，或通过多选框选中要删除的角色后，点击页面右上方的删除按钮，弹出模态框询问是否确认删除，并显示被选中的角色名称，点击确认删除后，删除对应的角色</p>
<p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/role-删除按钮.png"></p>
<p>​	给删除按钮与X按钮绑定单击函数，弹出删除确认模态框，给模态框中的确认删除绑定单击函数，点击后发送给后端执行删除操作。</p>
<h3 id="代码-4"><a href="#代码-4" class="headerlink" title="代码"></a>代码</h3><p>​	①确认删除模态框（modal-role-confirm.jsp）</p>
<pre><code class="jsp">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; pageEncoding=&quot;UTF-8&quot; %&gt;
&lt;div id=&quot;confirmRoleModal&quot; class=&quot;modal fade&quot; tabindex=&quot;-1&quot; role=&quot;dialog&quot;&gt;
    &lt;div  class=&quot;modal-dialog&quot; role=&quot;document&quot;&gt;
        &lt;div class=&quot;modal-content&quot;&gt;
            &lt;div class=&quot;modal-header&quot;&gt;
                &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot; aria-label=&quot;Close&quot;&gt;&lt;span aria-hidden=&quot;true&quot;&gt;&amp;times;&lt;/span&gt;&lt;/button&gt;
                &lt;h4 class=&quot;modal-title&quot;&gt;尚筹网-确认删除&lt;/h4&gt;
            &lt;/div&gt;

            &lt;div class=&quot;modal-body&quot;&gt;
                &lt;h4&gt;请确认是否删除下列角色！&lt;/h4&gt;
                &lt;%-- 确认的列表 --%&gt;
                &lt;div id=&quot;confirmList&quot; style=&quot;text-align: center&quot;&gt;&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class=&quot;modal-footer&quot;&gt;
                &lt;button id=&quot;confirmRoleBtn&quot; type=&quot;button&quot; class=&quot;btn btn-success&quot;&gt;确认删除&lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>​	②引入模态框</p>
<pre><code class="jsp">&lt;%@include file=&quot;/WEB-INF/modal-role-confirm.jsp&quot;%&gt;
</code></pre>
<p>​	③先编写多选删除与单选删除统一对应的删除后端代码：</p>
<p>​		Controller层：</p>
<pre><code class="java">@ResponseBody
@RequestMapping(&quot;/role/do/remove.json&quot;)
public ResultEntity&lt;String&gt; removeRole(@RequestBody List&lt;Integer&gt; roleIdArray)&#123;

    // service层方法通过id的List删除角色
    roleService.removeById(roleIdArray);
    
    return ResultEntity.successWithoutData();

&#125;
</code></pre>
<p>​		Service层：</p>
<pre><code class="java">@Override
public void removeById(List&lt;Integer&gt; roleIdList) &#123;
    // 创建RoleExample
    RoleExample roleExample = new RoleExample();

    // 获取Criteria对象
    RoleExample.Criteria criteria = roleExample.createCriteria();

    // 使用Criteria封装查询条件为id的List
    criteria.andIdIn(roleIdList);

    // mapper执行删除操作
    roleMapper.deleteByExample(roleExample);
&#125;
</code></pre>
<p>​	④编写打开确认删除模态框的函数：（被调用时使用，写在外部js文件my-role.js）</p>
<pre><code class="javascript">// 打开确认删除的模态框
function showConfirmModal(roleArray)&#123;
    // 显示模态框
    $(&quot;#confirmRoleModal&quot;).modal(&quot;show&quot;);

    // 清除旧的模态框中的数据
    $(&quot;#confirmList&quot;).empty();

    // 创建一个全局变量数组，用于存放要删除的roleId
    window.roleIdArray = [];

    // 填充数据
    for (var i = 0; i &lt; roleArray.length; i++)&#123;

        var roleId = roleArray[i].id;

        // 将当前遍历到的roleId放入全局变量
        window.roleIdArray.push(roleId);

        var roleName = roleArray[i].name;

        $(&quot;#confirmList&quot;).append(roleName+&quot;&lt;br/&gt;&quot;);
    &#125;

&#125;
</code></pre>
<p>​	</p>
<p>​	⑤为模态框中的确认删除按钮绑定单击事件（写在原本的role-page.jsp中）</p>
<pre><code class="javascript">// 为 “确认删除” 按钮绑定单击事件
$(&quot;#confirmRoleBtn&quot;).click(function () &#123;
    // 将全局变量中的id数组转换为json字符串格式
    var arrayStr = JSON.stringify(window.roleIdArray);

    $.ajax(&#123;
        url: &quot;role/do/remove.json&quot;,
        type: &quot;post&quot;,
        data: arrayStr,									// 将转换后的数据传给后端
        dataType: &quot;json&quot;,
        contentType: &quot;application/json;charset=UTF-8&quot;,	// 表明发送json格式数据
        success:function (response) &#123;
            if (response.result == &quot;SUCCESS&quot;)&#123;
                layer.msg(&quot;操作成功！&quot;);
                generatePage();
            &#125;
            if (response.result == &quot;FAILED&quot;)
                layer.msg(&quot;操作失败&quot;+response.message)
        &#125;,
        error:function (response) &#123;
            layer.msg(&quot;statusCode=&quot;+response.status + &quot; message=&quot;+response.statusText);
        &#125;
    &#125;);

    // 关闭模态框
    $(&quot;#confirmRoleModal&quot;).modal(&quot;hide&quot;);
&#125;);
</code></pre>
<p>​	在外部js文件给X按钮设置id与class（id为角色id，class统一为removeBtn）</p>
<pre><code class="javascript">var removeBtn = &quot;&lt;button type=&#39;button&#39; id=&#39;&quot;+roleId+&quot;&#39; class=&#39;btn btn-danger btn-xs removeBtn&#39;&gt;&lt;i class=&#39; glyphicon glyphicon-remove&#39;&gt;&lt;/i&gt;&lt;/button&gt;&quot;
</code></pre>
<p>​	⑥先编写单条删除的代码</p>
<pre><code class="javascript">// 给单条删除按钮绑定单击事件
$(&quot;#rolePageTBody&quot;).on(&quot;click&quot;,&quot;.removeBtn&quot;,function () &#123;
    
    // 通过X按钮删除时，只有一个角色，因此只需要建一个特殊的数组，存放单个对象即可
    var roleArray = [&#123;
        &quot;id&quot;: this.id,
        &quot;name&quot;: $(this).parent().prev().text()
    &#125;]

    // 调用显示模态框函数，传入roleArray
    showConfirmModal(roleArray);

&#125;);
</code></pre>
<p>​	⑦多选框的操作完善（全选、全不选等）</p>
<p>​		在外部js文件的生成表单的代码中给选择框加id与class（id&#x3D;当前角色的id，class统一为itemBox）</p>
<pre><code class="javascript">var checkboxTd = &quot;&lt;td&gt;&lt;input type=&#39;checkbox&#39; id=&#39;&quot;+roleId+&quot;&#39; class=&#39;itemBox&#39;/&gt;&lt;/td&gt;&quot;;
</code></pre>
<p>​		给全选框设置id（id&#x3D;summaryBox）</p>
<pre><code class="jsp">&lt;thead&gt;
&lt;tr&gt;
    &lt;th width=&quot;30&quot;&gt;#&lt;/th&gt;
    &lt;th width=&quot;30&quot;&gt;&lt;input id=&quot;summaryBox&quot; type=&quot;checkbox&quot;&gt;&lt;/th&gt;
    &lt;th&gt;名称&lt;/th&gt;
    &lt;th width=&quot;100&quot;&gt;操作&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
</code></pre>
<p>​		完善全选全不选：</p>
<pre><code class="javascript">// 单击全选框时，使下面的内容全选/全不选
$(&quot;#summaryBox&quot;).click(function () &#123;
    // 获取当前状态（是否被选中）
    var currentStatus = this.checked;

    $(&quot;.itemBox&quot;).prop(&quot;checked&quot;,currentStatus);

&#125;);

// 由下面的选择框，改变全选框的勾选状态
$(&quot;#rolePageTBody&quot;).on(&quot;click&quot;,&quot;.itemBox&quot;,function () &#123;

    // 获取当前已被选中的itemBox的数量
    var checkedBoxCount = $(&quot;.itemBox:checked&quot;).length;
    // 获取当前的所有的itemBox数量
    var currentBoxCount = $(&quot;.itemBox&quot;).length;

    $(&quot;#summaryBox&quot;).prop(&quot;checked&quot;,checkedBoxCount == currentBoxCount);
&#125;);
</code></pre>
<p>​	⑧给多选删除按钮绑定单击事件</p>
<pre><code class="javascript">// 给多选删除按钮绑定单击事件
$(&quot;#batchRemoveBtn&quot;).click(function ()&#123;

    // 创建一个数组对象，用来存放后面获得的角色对象
    var roleArray = [];

    // 遍历被勾选的内容
    $(&quot;.itemBox:checked&quot;).each(function () &#123;
        // 通过this引用当前遍历得到的多选框的id
        var roleId = this.id;

        // 通过DOM操作获取角色名称
        var roleName = $(this).parent().next().text();

        roleArray.push(&#123;
            &quot;id&quot;:roleId,
            &quot;name&quot;:roleName
        &#125;);
    &#125;);

    // 判断roleArray的长度是否为0
    if (roleArray.length == 0)&#123;
        layer.msg(&quot;请至少选择一个来删除&quot;);
        return ;
    &#125;

    // 显示确认框
    showConfirmModal(roleArray);
&#125;);
</code></pre>
<p>​	角色删除功能至此完成。</p>
<p>​	角色维护部分的代码也全部完成。【菜单维护】页面</p>
<p>在【菜单维护】页面，通过树形结构，使用<strong>zTree</strong>显示整个菜单。</p>
<p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/树形结构图.png" alt="树形结构图"></p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="一、在数据库创建菜单表："><a href="#一、在数据库创建菜单表：" class="headerlink" title="一、在数据库创建菜单表："></a>一、在数据库创建菜单表：</h3><pre><code class="sql">#使用project_rowd表
use project_rowd;

#创建菜单的数据库表
create table t_menu
(
    id int(11) not null auto_increment, 
    pid int(11), 
    name varchar(200), 
    url varchar(200),
    icon varchar(200), 
    primary key (id)
);

#插入数据
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;1&#39;,NULL,&#39; 系统权限菜单&#39;,&#39;glyphicon glyphicon-th-list&#39;,NULL);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;2&#39;,&#39;1&#39;,&#39; 控 制 面 板 &#39;,&#39;glyphicon glyphicon-dashboard&#39;,&#39;main.htm&#39;);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;3&#39;,&#39;1&#39;,&#39;权限管理&#39;,&#39;glyphicon glyphicon glyphicon-tasks&#39;,NULL);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;4&#39;,&#39;3&#39;,&#39; 用 户 维 护 &#39;,&#39;glyphicon glyphicon-user&#39;,&#39;user/index.htm&#39;);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;5&#39;,&#39;3&#39;,&#39; 角 色 维 护 &#39;,&#39;glyphicon glyphicon-king&#39;,&#39;role/index.htm&#39;);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;6&#39;,&#39;3&#39;,&#39; 菜 单 维 护 &#39;,&#39;glyphicon glyphicon-lock&#39;,&#39;permission/index.htm&#39;);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;7&#39;,&#39;1&#39;,&#39; 业 务 审 核 &#39;,&#39;glyphicon glyphicon-ok&#39;,NULL);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;8&#39;,&#39;7&#39;,&#39; 实名认证审核&#39;,&#39;glyphicon glyphicon-check&#39;,&#39;auth_cert/index.htm&#39;);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;9&#39;,&#39;7&#39;,&#39; 广 告 审 核 &#39;,&#39;glyphicon glyphicon-check&#39;,&#39;auth_adv/index.htm&#39;);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;10&#39;,&#39;7&#39;,&#39; 项 目 审 核 &#39;,&#39;glyphicon glyphicon-check&#39;,&#39;auth_project/index.htm&#39;);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;11&#39;,&#39;1&#39;,&#39; 业 务 管 理 &#39;,&#39;glyphicon glyphicon-th-large&#39;,NULL);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;12&#39;,&#39;11&#39;,&#39; 资 质 维 护 &#39;,&#39;glyphicon glyphicon-picture&#39;,&#39;cert/index.htm&#39;);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;13&#39;,&#39;11&#39;,&#39; 分 类 管 理 &#39;,&#39;glyphicon glyphicon-equalizer&#39;,&#39;certtype/index.htm&#39;);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;14&#39;,&#39;11&#39;,&#39; 流 程 管 理 &#39;,&#39;glyphicon glyphicon-random&#39;,&#39;process/index.htm&#39;);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;15&#39;,&#39;11&#39;,&#39; 广 告 管 理 &#39;,&#39;glyphicon glyphicon-hdd&#39;,&#39;advert/index.htm&#39;);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;16&#39;,&#39;11&#39;,&#39; 消 息 模 板 &#39;,&#39;glyphicon glyphicon-comment&#39;,&#39;message/index.htm&#39;);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;17&#39;,&#39;11&#39;,&#39; 项 目 分 类 &#39;,&#39;glyphicon glyphicon-list&#39;,&#39;projectType/index.htm&#39;);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;18&#39;,&#39;11&#39;,&#39; 项 目 标 签 &#39;,&#39;glyphicon glyphicon-tags&#39;,&#39;tag/index.htm&#39;);
insert into `t_menu` (`id`, `pid`, `name`, `icon`, `url`) values(&#39;19&#39;,&#39;1&#39;,&#39; 参 数 管 理 &#39;,&#39;glyphicon glyphicon-list-alt&#39;,&#39;param/index.htm&#39;);
</code></pre>
<p>数据库中，节点与父节点通过pid关联，节点的pid就是其父节点的id；若pid&#x3D;null，则表示该节点为根节点</p>
<h3 id="二、逆向工程"><a href="#二、逆向工程" class="headerlink" title="二、逆向工程"></a>二、逆向工程</h3><p>逆向生成实体类、mapper文件等</p>
<pre><code class="xml">&lt;!-- 数据库表名与需要的实体类对应映射的指定 --&gt;
&lt;table tableName=&quot;t_menu&quot; domainObjectName=&quot;Menu&quot;/&gt;
</code></pre>
<p>创建Service层接口与实现类、Controller层。</p>
<p><strong>MenuService</strong>、<strong>MenuServiceImpl</strong>、<strong>MenuHandler</strong></p>
<p>为了在页面上获取方便，给Menu实体类增加两个变量，并设置Get、Set方法：</p>
<pre><code class="java">// 子节点的集合，初始化时为了避免空指针异常
private List&lt;Menu&gt; children = new ArrayList&lt;&gt;();
// 控制节点默认是否为打开状态，设置为true表示默认打开
private Boolean open = true;
</code></pre>
<h2 id="在页面显示树形结构"><a href="#在页面显示树形结构" class="headerlink" title="在页面显示树形结构"></a>在页面显示树形结构</h2><h3 id="一、后端操作"><a href="#一、后端操作" class="headerlink" title="一、后端操作"></a>一、后端操作</h3><p>​	在Java代码中把查询到的表单数据组合成一棵树</p>
<p>Controller：</p>
<pre><code class="java">@ResponseBody
@RequestMapping(&quot;/menu/do/get.json&quot;)
public ResultEntity&lt;Menu&gt; getWholeTree()&#123;
    // 通过service层方法得到全部Menu对象的List
    List&lt;Menu&gt; menuList = menuService.getAll();

    // 声明一个Menu对象root，用来存放找到的根节点
    Menu root = null;

    // 使用map表示每一个菜单与id的对应关系
    Map&lt;Integer,Menu&gt; menuMap = new HashMap&lt;&gt;();

    // 将菜单id与菜单对象以K-V对模式存入map
    for(Menu menu: menuList)&#123;
        menuMap.put(menu.getId(),menu);
    &#125;

    for (Menu menu : menuList)&#123;
        Integer pid = menu.getPid();

        if (pid == null)&#123;
            // pid为null表示该menu是根节点
            root = menu;
            continue;
        &#125;
        // 通过当前遍历的menu的pid得到其父节点
        Menu father = menuMap.get(pid);
        // 为父节点添加子节点为当前节点
        father.getChildren().add(menu);
    &#125;
    
    // 将根节点作为data返回（返回根节点也就返回了整棵树）
    return ResultEntity.successWithData(root);
&#125;
</code></pre>
<p>Service层：</p>
<pre><code class="java">@Override
public List&lt;Menu&gt; getAll() &#123;
    // 直接传入一个new出来的Example，也就查询了整个表的数据
    return menuMapper.selectByExample(new MenuExample());
&#125;
</code></pre>
<h3 id="二、前端操作"><a href="#二、前端操作" class="headerlink" title="二、前端操作"></a>二、前端操作</h3><p>通过view-controller设置跳转：</p>
<pre><code class="xml">    &lt;!-- 前往菜单维护页面 --&gt;
&lt;mvc:view-controller path=&quot;/menu/to/page.html&quot; view-name=&quot;menu-page&quot;/&gt;
</code></pre>
<p>之后在sidebar的页面，将对应【菜单维护】的链接设置成menu&#x2F;to&#x2F;page.html</p>
<p>需要使用zTree，因此要引入zTree的文件：</p>
<p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/zTree组件.png" alt="zTree组件"></p>
<p>创建menu-page.jsp页面：</p>
<p>这里给出的时main div中的内容</p>
<pre><code class="jsp">&lt;div class=&quot;col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main&quot;&gt;
    &lt;div class=&quot;panel panel-default&quot;&gt;
        &lt;div class=&quot;panel-heading&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-th-list&quot;&gt;&lt;/i&gt; 权限菜单列表 
            &lt;div style=&quot;float:right;cursor:pointer;&quot; data-toggle=&quot;modal&quot; data-target=&quot;#myModal&quot;&gt;
                &lt;i class=&quot;glyphicon glyphicon-question-sign&quot;&gt;
                &lt;/i&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;panel-body&quot;&gt;
            &lt;ul id=&quot;treeDemo&quot; class=&quot;ztree&quot;&gt;
                &lt;%-- 显示树形结构依附于上面的ul --%&gt;
            &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>并且在头部引入zTree的文件：</p>
<pre><code class="jsp">&lt;link rel=&quot;stylesheet&quot; href=&quot;ztree/zTreeStyle.css&quot;/&gt;
&lt;script type=&quot;text/javascript&quot; src=&quot;ztree/jquery.ztree.all-3.5.min.js&quot;&gt;&lt;/script&gt;
</code></pre>
<p>则在前端显示树形结构的代码：</p>
<p>​	将生成树形结构等代码提取到外部js文件<strong>my-menu.js</strong></p>
<pre><code class="javascript">// 封装生成树形结构的代码
function generateTree()&#123;
    $.ajax(&#123;
        url:&quot;menu/do/get.json&quot;,
        type:&quot;post&quot;,
        dataType:&quot;json&quot;,
        success:function (response) &#123;
            if (response.result == &quot;SUCCESS&quot;)&#123;
                // 成功 则设置下列属性
                var setting = &#123;
                    view:&#123;
                        // 设置每一个标签的图标
                        &quot;addDiyDom&quot;:myAddDiyDom,
                        // 设置悬浮在标签上时的函数
                        &quot;addHoverDom&quot;:myAddHoverDom,
                        // 设置从标签上移除时的函数
                        &quot;removeHoverDom&quot;:myRemoveHoverDom
                    &#125;,
                    data:&#123;
                        key:&#123;
                            // 实现“点了不跑”，也就是设置了这里的url后，会根据该url去寻找页面，如果页面找不到，则不跳转
                            /*
                                	zTree 节点数据保存节点链接的目标 URL 的属性名称。
                                特殊用途：当后台数据只能生成 url 属性，又不想实现点击节点跳转的功能时，可以直接修改此属性为其他不存在的属性名称
                                默认值：&quot;url&quot;
                            */
                            url: &quot;NotExist&quot;
                        &#125;
                    &#125;
                &#125;;
                // 通过response得到data，就是后端传来的查询结构
                var zNodes = response.data;
                // 执行zTree的初始化函数，传参分别是依附的ul的id（通过jQuery选择器）、setting变量、查询到的树形结构
                $.fn.zTree.init($(&quot;#treeDemo&quot;), setting, zNodes);
            &#125;
            if (response.result == &quot;FAILED&quot;)
                layer.msg(&quot;操作失败&quot;+response.message)
        &#125;,
        error:function (response) &#123;
            layer.msg(&quot;statusCode=&quot;+response.status + &quot; message=&quot;+response.statusText);
        &#125;
    &#125;);
&#125;
</code></pre>
<p>而对应放在setting的view中的三个函数：</p>
<pre><code class="javascript">function myAddDiyDom(treeId, treeNode) &#123;
    // treeId就是树形结构依附的ul的id
    // treeNode就是当前节点全部数据（包括后端查询得到的）

    // 根据zTree中每一个图标span的id的规则：
    // 如treeDemo_7_ico
    // id结构就是ul的id_当前节点序号_ico（tId就是id_当前节点序号）
    // 可以拼出每一个span的id：
    var spanId = treeNode.tId + &quot;_ico&quot;;
    // 删除旧的class，增加新得到的class
    $(&quot;#&quot;+spanId).removeClass().addClass(treeNode.icon);
&#125;

// 鼠标覆盖时，显示按钮组
function myAddHoverDom(treeId, treeNode) &#123;
    // 定义增加、修改、删除节点的标签字符串
    var addBtn = &quot;&lt;a id=&#39;&quot;+treeNode.id+&quot;&#39; class=&#39;addBtn btn btn-info dropdown-toggle btn-xs&#39; style=&#39;margin-left:10px;padding-top:0px;&#39; href=&#39;#&#39; title=&#39;增加节点&#39;&gt;&amp;nbsp;&amp;nbsp;&lt;i class=&#39;fa fa-fw fa-plus rbg &#39;&gt;&lt;/i&gt;&lt;/a&gt;&quot;;
    var editBtn = &quot;&lt;a id=&#39;&quot;+treeNode.id+&quot;&#39; class=&#39;editBtn btn btn-info dropdown-toggle btn-xs&#39; style=&#39;margin-left:10px;padding-top:0px;&#39; href=&#39;#&#39; title=&#39;修改节点&#39;&gt;&amp;nbsp;&amp;nbsp;&lt;i class=&#39;fa fa-fw fa-edit rbg &#39;&gt;&lt;/i&gt;&lt;/a&gt;&quot;;
    var removeBtn = &quot;&lt;a id=&#39;&quot;+treeNode.id+&quot;&#39; class=&#39;removeBtn btn btn-info dropdown-toggle btn-xs&#39; style=&#39;margin-left:10px;padding-top:0px;&#39; href=&#39;#&#39; title=&#39;删除节点&#39;&gt;&amp;nbsp;&amp;nbsp;&lt;i class=&#39;fa fa-fw fa-times rbg &#39;&gt;&lt;/i&gt;&lt;/a&gt;&quot;;

    // btn用于存放不同的节点显示的不同的按钮
    var btn = &quot;&quot;;

    // 得到每个节点的level，根据level决定显示的按钮组的内容
    var level = treeNode.level;

    // 按照一定规则设置按钮组span的id
    var btnGroupId = &quot;btnGroupTreeDemo_&quot;+treeNode.id;

    // 如果此时按钮组已经有内容了，则不再往下执行
    if ($(&quot;#&quot;+btnGroupId).length &gt; 0)&#123;
        return ;
    &#125;

    // 根据level决定按钮组内部显示的内容
    if (level === 0)&#123;
        btn = addBtn;
    &#125; else if (level === 1)&#123;
        btn = addBtn + editBtn;
        // 判断是否子节点，有子节点则不显示删除按钮，没有子节点则显示删除按钮
        if (treeNode.children.length === 0)&#123;
            btn = btn + removeBtn;
        &#125;
    &#125; else &#123;
        // level==3则显示删除按钮与修改按钮
        btn = editBtn+removeBtn;
    &#125;

    // 拼接a标签的id（treeDemo_x_a）
    var aId = treeNode.tId + &quot;_a&quot;;

    // 根据id，在a标签后加按钮组
    $(&quot;#&quot;+aId).after(&quot;&lt;span id=&#39;&quot;+btnGroupId+&quot;&#39;&gt;&quot;+btn+&quot;&lt;/span&gt;&quot;);

&#125;

// 鼠标移开时，隐藏按钮组
function myRemoveHoverDom(treeId, treeNode) &#123;
    // 按钮组span的id
    var btnGroupId = &quot;btnGroupTreeDemo_&quot;+treeNode.id;
    // 删除此id的标签
    $(&quot;#&quot;+btnGroupId).remove();
&#125;
</code></pre>
<h2 id="【添加子节点】按钮"><a href="#【添加子节点】按钮" class="headerlink" title="【添加子节点】按钮"></a>【添加子节点】按钮</h2><h3 id="目标："><a href="#目标：" class="headerlink" title="目标："></a><strong>目标：</strong></h3><p>实现给当前节点添加子节点，并保存到数据库中。</p>
<h3 id="思路："><a href="#思路：" class="headerlink" title="思路："></a><strong>思路：</strong></h3><p>点击“+”按钮，打开模态框，输入要保存的节点的名字，并选择图标后，点击保存，发送Ajax请求到后端，执行保存工作。</p>
<h3 id="代码："><a href="#代码：" class="headerlink" title="代码："></a><strong>代码：</strong></h3><h4 id="后端代码："><a href="#后端代码：" class="headerlink" title="后端代码："></a>后端代码：</h4><p>Controller：</p>
<pre><code class="java">@ResponseBody
@RequestMapping(&quot;/menu/save.json&quot;)
public ResultEntity&lt;String&gt; saveMenu(Menu menu)&#123;

    menuService.saveMenu(menu);

    return ResultEntity.successWithoutData();
&#125;
</code></pre>
<p>Service：</p>
<pre><code class="java">@Override
public void saveMenu(Menu menu) &#123;
    menuMapper.insert(menu);
&#125;
</code></pre>
<h4 id="前端代码："><a href="#前端代码：" class="headerlink" title="前端代码："></a>前端代码：</h4><p>新增一个模态框页面<strong>modal-menu-add.jsp</strong>：</p>
<pre><code class="jsp">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html;charset=UTF-8&quot;
   pageEncoding=&quot;UTF-8&quot;%&gt;
&lt;div id=&quot;menuAddModal&quot; class=&quot;modal fade&quot; tabindex=&quot;-1&quot; role=&quot;dialog&quot;&gt;
   &lt;div class=&quot;modal-dialog&quot; role=&quot;document&quot;&gt;
      &lt;div class=&quot;modal-content&quot;&gt;
         &lt;div class=&quot;modal-header&quot;&gt;
            &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot;
               aria-label=&quot;Close&quot;&gt;
               &lt;span aria-hidden=&quot;true&quot;&gt;&amp;times;&lt;/span&gt;
            &lt;/button&gt;
            &lt;h4 class=&quot;modal-title&quot;&gt;尚筹网-添加节点&lt;/h4&gt;
         &lt;/div&gt;
         &lt;form&gt;
            &lt;div class=&quot;modal-body&quot;&gt;
               请输入节点名称：&lt;input type=&quot;text&quot; name=&quot;name&quot; /&gt;&lt;br /&gt;
               请输入URL地址：&lt;input type=&quot;text&quot; name=&quot;url&quot; /&gt;&lt;br /&gt;
               &lt;i class=&quot;glyphicon glyphicon-th-list&quot;&gt;&lt;/i&gt;
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-th-list&quot; /&gt;&amp;nbsp;
               
               &lt;i class=&quot;glyphicon glyphicon-dashboard&quot;&gt;&lt;/i&gt; 
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-dashboard&quot; /&gt; &amp;nbsp;
               
               &lt;i class=&quot;glyphicon glyphicon glyphicon-tasks&quot;&gt;&lt;/i&gt; 
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon glyphicon-tasks&quot; /&gt; &amp;nbsp;
               
               &lt;i class=&quot;glyphicon glyphicon-user&quot;&gt;&lt;/i&gt; 
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-user&quot; /&gt; &amp;nbsp;
               
               &lt;i class=&quot;glyphicon glyphicon-king&quot;&gt;&lt;/i&gt; 
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-king&quot; /&gt; &amp;nbsp;
               
               &lt;i class=&quot;glyphicon glyphicon-lock&quot;&gt;&lt;/i&gt; 
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-lock&quot; /&gt; &amp;nbsp;
               
               &lt;i class=&quot;glyphicon glyphicon-ok&quot;&gt;&lt;/i&gt; 
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-ok&quot; /&gt; &amp;nbsp;
               
               &lt;i class=&quot;glyphicon glyphicon-check&quot;&gt;&lt;/i&gt; 
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-check&quot; /&gt; &amp;nbsp;
               
               &lt;i class=&quot;glyphicon glyphicon-th-large&quot;&gt;&lt;/i&gt;
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-th-large&quot; /&gt; &lt;br /&gt; 
               
               &lt;i class=&quot;glyphicon glyphicon-picture&quot;&gt;&lt;/i&gt; 
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-picture&quot; /&gt; &amp;nbsp;
               
               &lt;i class=&quot;glyphicon glyphicon-equalizer&quot;&gt;&lt;/i&gt; 
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-equalizer&quot; /&gt; &amp;nbsp;
               
               &lt;i class=&quot;glyphicon glyphicon-random&quot;&gt;&lt;/i&gt; 
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-random&quot; /&gt; &amp;nbsp;
               
               &lt;i class=&quot;glyphicon glyphicon-hdd&quot;&gt;&lt;/i&gt; 
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-hdd&quot; /&gt; &amp;nbsp;
               
               &lt;i class=&quot;glyphicon glyphicon-comment&quot;&gt;&lt;/i&gt; 
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-comment&quot; /&gt; &amp;nbsp;
               
               &lt;i class=&quot;glyphicon glyphicon-list&quot;&gt;&lt;/i&gt; 
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-list&quot; /&gt; &amp;nbsp;
               
               &lt;i class=&quot;glyphicon glyphicon-tags&quot;&gt;&lt;/i&gt; 
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-tags&quot; /&gt; &amp;nbsp;
               
               &lt;i class=&quot;glyphicon glyphicon-list-alt&quot;&gt;&lt;/i&gt; 
               &lt;input type=&quot;radio&quot; name=&quot;icon&quot; value=&quot;glyphicon glyphicon-list-alt&quot; /&gt; &amp;nbsp;
               &lt;br /&gt;
               
            &lt;/div&gt;
            &lt;div class=&quot;modal-footer&quot;&gt;
               &lt;button id=&quot;menuSaveBtn&quot; type=&quot;button&quot; class=&quot;btn btn-default&quot;&gt;
                   &lt;i class=&quot;glyphicon glyphicon-plus&quot;&gt;&lt;/i&gt; 保存&lt;/button&gt;
               &lt;button id=&quot;menuResetBtn&quot; type=&quot;reset&quot; class=&quot;btn btn-primary&quot;&gt;
                   &lt;i class=&quot;glyphicon glyphicon-refresh&quot;&gt;&lt;/i&gt; 重置&lt;/button&gt;
            &lt;/div&gt;
         &lt;/form&gt;
      &lt;/div&gt;
   &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>在显示菜单结构的页面代码上引入模态框页面（这里将添加、修改、删除的页面都引入了，后面就不做多余的解释了）：</p>
<pre><code class="jsp">&lt;%@include file=&quot;/WEB-INF/modal-menu-add.jsp&quot;%&gt;
&lt;%@include file=&quot;/WEB-INF/modal-menu-edit.jsp&quot;%&gt;
&lt;%@include file=&quot;/WEB-INF/modal-menu-confirm.jsp&quot;%&gt;
</code></pre>
<p>给添加按钮添加单击函数：</p>
<pre><code class="javascript">// 给“+”按钮，添加单击响应函数，打开添加节点的模态框
$(&quot;#treeDemo&quot;).on(&quot;click&quot;,&quot;.addBtn&quot;,function () &#123;
    // 将当前按钮的id保存为全局变量pid，方便后面调用
    window.pid = this.id;
    // 打开模态框
    $(&quot;#menuAddModal&quot;).modal(&quot;show&quot;);
    // 关闭默认跳转行为
    return false;
&#125;);
</code></pre>
<p>打开模态框后，输入内容，点击的保存按钮的单击响应函数：</p>
<pre><code class="javascript">// 添加节点模态框中保存按钮的单击事件
$(&quot;#menuSaveBtn&quot;).click(function () &#123;
    // 从输入框中获得name，并去掉前后空格
    var name = $.trim($(&quot;#menuAddModal [name=name]&quot;).val());
    // 从输入框中获得url，并去掉前后空格
    var url = $.trim($(&quot;#menuAddModal [name=url]&quot;).val());
    // 下面的选项中获得被选中的icon的值
    var icon = $(&quot;#menuAddModal [name=icon]:checked&quot;).val();

    $.ajax(&#123;
        url:&quot;menu/save.json&quot;,
        type:&quot;post&quot;,
        &quot;data&quot;:&#123;
            &quot;name&quot;:name,
            &quot;url&quot;:url,
            &quot;icon&quot;:icon,
            // 从全局变量获得该节点的父节点id
            &quot;pid&quot;:window.pid
        &#125;,
        dataType:&quot;json&quot;,
        success:function (response) &#123;
            if(response.result == &quot;SUCCESS&quot;)&#123;
                layer.msg(&quot;操作成功！&quot;);

                // 重新生成树形结构
                generateTree();
            &#125;
            if (response.result == &quot;FAILED&quot;)&#123;
                layer.msg(&quot;操作失败！&quot;);
            &#125;
        &#125;,
        error:function (response) &#123;
            layer.msg(response.status + &quot; &quot; + response.statusText);
        &#125;

    &#125;);

    // 关闭模态框
    $(&quot;#menuAddModal&quot;).modal(&quot;hide&quot;);

    // 清空模态框内的数据(通过模拟用户单击“重置”按钮)
    $(&quot;#menuResetBtn&quot;).click();

&#125;);
</code></pre>
<h2 id="【修改节点】按钮"><a href="#【修改节点】按钮" class="headerlink" title="【修改节点】按钮"></a>【修改节点】按钮</h2><h3 id="目标：-1"><a href="#目标：-1" class="headerlink" title="目标："></a>目标：</h3><p>修改当前选择节点的信息，但是不修改父节点</p>
<h3 id="思路：-1"><a href="#思路：-1" class="headerlink" title="思路："></a>思路：</h3><p>点击按钮组中的修改按钮，打开修改模态框，回显原本的name、url、icon数据，修改完成后点击模态框中的修改按钮，发送Ajax请求，后端完成在数据库进行修改。</p>
<h3 id="代码：-1"><a href="#代码：-1" class="headerlink" title="代码："></a>代码：</h3><h4 id="后端代码：-1"><a href="#后端代码：-1" class="headerlink" title="后端代码："></a>后端代码：</h4><p>Controller：</p>
<pre><code class="java">@ResponseBody
@RequestMapping(&quot;/menu/edit.json&quot;)
public ResultEntity&lt;String&gt; editMenu(Menu menu)&#123;
    menuService.editMenu(menu);
    return ResultEntity.successWithoutData();
&#125;
</code></pre>
<p>Service：</p>
<pre><code class="java">@Override
public void editMenu(Menu menu) &#123;
    // 有选择地更新，如果menu中有的值为null（如这里的pid），则不会更新该内容
    menuMapper.updateByPrimaryKeySelective(menu);
&#125;
</code></pre>
<h4 id="前端代码：-1"><a href="#前端代码：-1" class="headerlink" title="前端代码："></a>前端代码：</h4><p>修改的模态框内容与添加模态框基本相同（此模态框的div的id为menuEditModal）</p>
<p>给修改按钮添加单击响应函数：</p>
<pre><code class="javascript">// 动态生成的修改按钮，单击打开修改的模态框
$(&quot;#treeDemo&quot;).on(&quot;click&quot;,&quot;.editBtn&quot;,function () &#123;

    // 保存此按钮的id
    window.id = this.id;

    $(&quot;#menuEditModal&quot;).modal(&quot;show&quot;);

    // 要实现通过id拿到整个节点的信息，需要拿到zTreeObj
    var zTreeObj = $.fn.zTree.getZTreeObj(&quot;treeDemo&quot;);

    var key = &quot;id&quot;;
    var value = window.id;

    // getNodeByParam，通过id得到当前的整个节点
    // 注意：id为treeNode的id，返回的就是那个treeNode
    var currentNode = zTreeObj.getNodeByParam(key,value);

    $(&quot;#menuEditModal [name=name]&quot;).val(currentNode.name);

    $(&quot;#menuEditModal [name=url]&quot;).val(currentNode.url);
    // 这里currentNode.icon其实是数组形式，利用这个值，放在[]中，传回val，就可以使相匹配的值回显在模态框中
    $(&quot;#menuEditModal [name=icon]&quot;).val([currentNode.icon]);

    return false;
&#125;);
</code></pre>
<p>给模态框中的修改按钮添加单击响应函数：</p>
<pre><code class="javascript">// 修改的模态框”修改按钮“的单击事件
$(&quot;#menuEditBtn&quot;).click(function () &#123;
    var name = $.trim($(&quot;#menuEditModal [name=name]&quot;).val());

    var url = $.trim($(&quot;#menuEditModal [name=url]&quot;).val());

    var icon = $(&quot;#menuEditModal [name=icon]:checked&quot;).val();

    $.ajax(&#123;
        url:&quot;menu/edit.json&quot;,
        type:&quot;post&quot;,
        &quot;data&quot;:&#123;
            &quot;id&quot;:window.id,
            &quot;name&quot;:name,
            &quot;url&quot;:url,
            &quot;icon&quot;:icon
        &#125;,
        dataType:&quot;json&quot;,
        success:function (response) &#123;
            if(response.result == &quot;SUCCESS&quot;)&#123;
                layer.msg(&quot;操作成功！&quot;);

                // 重新生成树形结构
                generateTree();
            &#125;
            if (response.result == &quot;FAILED&quot;)&#123;
                layer.msg(&quot;操作失败！&quot;);
            &#125;
        &#125;,
        error:function (response) &#123;
            layer.msg(response.status + &quot; &quot; + response.statusText);
        &#125;

    &#125;);

    // 关闭模态框
    $(&quot;#menuEditModal&quot;).modal(&quot;hide&quot;);

&#125;);
</code></pre>
<h2 id="【删除节点】按钮"><a href="#【删除节点】按钮" class="headerlink" title="【删除节点】按钮"></a>【删除节点】按钮</h2><h3 id="目标：-2"><a href="#目标：-2" class="headerlink" title="目标："></a>目标：</h3><p>点击删除按钮可以删除选中节点</p>
<h3 id="思路：-2"><a href="#思路：-2" class="headerlink" title="思路："></a>思路：</h3><p>给动态生成的按钮组中的删除按钮，添加单击响应函数，打开删除的确认模态框，模态框中显示图标+节点名字，点击确认删除后，给后端发送Ajax请求，由后端从服务器删除对应节点。</p>
<h3 id="代码：-2"><a href="#代码：-2" class="headerlink" title="代码："></a>代码：</h3><h4 id="后端代码：-2"><a href="#后端代码：-2" class="headerlink" title="后端代码："></a>后端代码：</h4><p>Controller：</p>
<pre><code class="java">@ResponseBody
@RequestMapping(&quot;/menu/remove.json&quot;)
public ResultEntity&lt;String&gt; removeMenu(Integer id)&#123;
    menuService.removeMenuById(id);
    return ResultEntity.successWithoutData();
&#125;
</code></pre>
<p>Service：</p>
<pre><code class="java">@Override
public void removeMenuById(Integer id) &#123;
    menuMapper.deleteByPrimaryKey(id);
&#125;
</code></pre>
<h4 id="前端代码：-2"><a href="#前端代码：-2" class="headerlink" title="前端代码："></a>前端代码：</h4><p>模态框代码（modal-menu-confirm.jsp）：</p>
<pre><code class="jsp">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html;charset=UTF-8&quot;
   pageEncoding=&quot;UTF-8&quot;%&gt;
&lt;div id=&quot;menuConfirmModal&quot; class=&quot;modal fade&quot; tabindex=&quot;-1&quot; role=&quot;dialog&quot;&gt;
   &lt;div class=&quot;modal-dialog&quot; role=&quot;document&quot;&gt;
      &lt;div class=&quot;modal-content&quot;&gt;
         &lt;div class=&quot;modal-header&quot;&gt;
            &lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;modal&quot;
               aria-label=&quot;Close&quot;&gt;
               &lt;span aria-hidden=&quot;true&quot;&gt;&amp;times;&lt;/span&gt;
            &lt;/button&gt;
            &lt;h4 class=&quot;modal-title&quot;&gt;尚筹网系统弹窗&lt;/h4&gt;
         &lt;/div&gt;
         &lt;form&gt;
            &lt;div class=&quot;modal-body&quot;&gt;
               您真的要删除&lt;span id=&quot;removeNodeSpan&quot;&gt;&lt;/span&gt;这个节点吗？
            &lt;/div&gt;
            &lt;div class=&quot;modal-footer&quot;&gt;
               &lt;button id=&quot;confirmBtn&quot; type=&quot;button&quot; class=&quot;btn btn-danger&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-ok&quot;&gt;&lt;/i&gt;确认&lt;/button&gt;
            &lt;/div&gt;
         &lt;/form&gt;
      &lt;/div&gt;
   &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>给动态生成的删除按钮绑定单击响应函数：</p>
<pre><code class="javascript">// 动态生成的删除按钮的单击事件，（打开确认模态框）
$(&quot;#treeDemo&quot;).on(&quot;click&quot;,&quot;.removeBtn&quot;,function () &#123;
    // 将当前的id放入全局变量
    window.id = this.id;
    
    // 打开模态框
    $(&quot;#menuConfirmModal&quot;).modal(&quot;show&quot;);

    // 拿到zTreeObject
    var zTreeObj = $.fn.zTree.getZTreeObj(&quot;treeDemo&quot;);

    var key = &quot;id&quot;;
    var value = window.id;

    // 通过getNodeByParam()，传入当前节点的id，得到当前节点的对象
    var currentNode = zTreeObj.getNodeByParam(key, value);

    // 通过得到的节点对象得到该节点的name与icon
    var name = currentNode.name;
    var icon = currentNode.icon;

    // 回显-向id=removeNodeSpan的span标签添加html语句（显示图标与节点名）
    $(&quot;#removeNodeSpan&quot;).html(&quot;【&lt;i class=&#39;&quot;+icon+&quot;&#39;&gt;&quot;+name+&quot;】&lt;/i&gt;&quot;);

    // 关闭默认跳转
    return false;

&#125;);
</code></pre>
<p>给确认模态框中的确认删除按钮添加响应函数：</p>
<pre><code class="javascript">    // 确认模态框中，“确认”按钮的单击事件（发送Ajax请求）
    $(&quot;#confirmBtn&quot;).click(function () &#123;
        $.ajax(&#123;
            url:&quot;menu/remove.json&quot;,
            type:&quot;post&quot;,
            &quot;data&quot;:&#123;
                // 只传入一个id
                &quot;id&quot;:window.id,
            &#125;,
            dataType:&quot;json&quot;,
            success:function (response) &#123;
                if(response.result == &quot;SUCCESS&quot;)&#123;
                    layer.msg(&quot;操作成功！&quot;);

                    // 重新生成树形结构
                    generateTree();
                &#125;
                if (response.result == &quot;FAILED&quot;)&#123;
                    layer.msg(&quot;操作失败！&quot;);
                &#125;
            &#125;,
            error:function (response) &#123;
                layer.msg(response.status + &quot; &quot; + response.statusText);
            &#125;
        &#125;);

        $(&quot;#menuConfirmModal&quot;).modal(&quot;hide&quot;);
    &#125;);

&#125;);
</code></pre>
<h2 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h2><p>在<strong>删除</strong>、<strong>添加</strong>按钮中，直接通过this.id给全局的id赋值，传入到getNodeByParam()函数中得到节点对象，是因为在js中生成动态按钮的时候已经设置好了按钮的id就是当前treeNode的id，因此可以通过按钮的id来得到当前的treeNode（也就包含了当前节点的所有信息），再由treeNode得到如菜单的name、url、icon等。</p>
<h1 id="权限分配"><a href="#权限分配" class="headerlink" title="权限分配"></a>权限分配</h1><p>在实现权限控制之前，这里先完成给Admin分配Role和给Role分配Auth的功能。</p>
<h2 id="一、给Admin分配Role"><a href="#一、给Admin分配Role" class="headerlink" title="一、给Admin分配Role"></a>一、给Admin分配Role</h2><h3 id="目标-5"><a href="#目标-5" class="headerlink" title="目标"></a>目标</h3><p>​	通过前端页面操作，将Admin与Role之间的关系保存到数据库</p>
<h3 id="思路-5"><a href="#思路-5" class="headerlink" title="思路"></a>思路</h3><p>​	给下面的按钮，添加单击响应函数</p>
<p><img src="D:\浏览器下载\crowd-funding-master\crowd-funding-master\note\images\Admin分配Role.png"></p>
<p>打开如下页面：</p>
<p><img src="D:\浏览器下载\crowd-funding-master\crowd-funding-master\note\images\Admin分配Role页面.png"></p>
<p>通过左右按钮，可以改变角色分配的情况。</p>
<h3 id="代码-5"><a href="#代码-5" class="headerlink" title="代码"></a>代码</h3><h4 id="1）、创建关联数据库表"><a href="#1）、创建关联数据库表" class="headerlink" title="1）、创建关联数据库表"></a>1）、创建关联数据库表</h4><p>​		<strong>inner_admin_role</strong></p>
<pre><code class="sql">USE project_rowd;

CREATE TABLE inner_admin_role
( 
    id INT NOT NULL AUTO_INCREMENT,
    admin_id INT,
    role_id INT,
    PRIMARY KEY (id) 
);
</code></pre>
<p>​	该表因为并不是一个实体类的表，只用于表示关联关系，因此不需要进行逆向工程生成。</p>
<h4 id="2）、前后端代码"><a href="#2）、前后端代码" class="headerlink" title="2）、前后端代码"></a>2）、前后端代码</h4><p>修改admin-page.jsp中对应按钮的单击响应函数：</p>
<p>跳转到assign&#x2F;to&#x2F;page.html页面，附带当前的页码、关键词以及当前按钮对应的admin的id</p>
<pre><code class="jsp">&lt;a href=&quot;assign/to/page.html?adminId=$&#123;admin.id&#125;&amp;pageNum=$&#123;requestScope.pageInfo.pageNum&#125;&amp;keyword=$&#123;param.keyword&#125;&quot; class=&quot;btn btn-success btn-xs&quot;&gt;
    &lt;i class=&quot; glyphicon glyphicon-check&quot;&gt;
    &lt;/i&gt;
&lt;/a&gt;
</code></pre>
<p><strong>创建处理权限分配功能的控制类：AssignHandler</strong></p>
<p>对应controller中的方法：</p>
<pre><code class="java">@RequestMapping(&quot;/assign/to/page.html&quot;)
public String toAssignPage(@RequestParam(&quot;adminId&quot;) Integer adminId, ModelMap modelMap)&#123;

    // 得到对应当前adminId未被分配的角色（Role）List
    List&lt;Role&gt; UnAssignedRoleList = roleService.queryUnAssignedRoleList(adminId);

    // 得到对应当前adminId已被分配的角色（Role）List
    List&lt;Role&gt; AssignedRoleList = roleService.queryAssignedRoleList(adminId);

    // 将已选择的、未选择的放入modelMap
    modelMap.addAttribute(&quot;UnAssignedRoleList&quot;,UnAssignedRoleList);
    modelMap.addAttribute(&quot;AssignedRoleList&quot;,AssignedRoleList);

    // 请求转发到assign-role.jsp
    return &quot;assign-role&quot;;
&#125;
</code></pre>
<p>service层方法：</p>
<pre><code class="java">@Override
public List&lt;Role&gt; queryUnAssignedRoleList(Integer adminId) &#123;
    return roleMapper.queryUnAssignedRoleList(adminId);
&#125;

@Override
public List&lt;Role&gt; queryAssignedRoleList(Integer adminId) &#123;
    return roleMapper.queryAssignedRoleList(adminId);
&#125;
</code></pre>
<p>roleMapper.xml文件中对应的两个SQL语句（通过in 与 not in查询已分配和未分配的）：</p>
<pre><code class="xml">&lt;!--查询对应adminId的未被分配的Role--&gt;
&lt;select id=&quot;queryUnAssignedRoleList&quot; resultMap=&quot;BaseResultMap&quot;&gt;
  select id,name
  from t_role
  where
  id not in (select role_id from inner_admin_role where admin_id = #&#123;adminId&#125;)
&lt;/select&gt;

&lt;!--查询对应adminId的已被分配的Role--&gt;
&lt;select id=&quot;queryAssignedRoleList&quot; resultMap=&quot;BaseResultMap&quot;&gt;
  select id,name
  from t_role
  where
  id in (select role_id from inner_admin_role where admin_id = #&#123;adminId&#125;)
&lt;/select&gt;
</code></pre>
<p>查询到数据，并存入modelMap中后，跳转到assign-role.jsp页面</p>
<p>在该页面显示查询到的信息：</p>
<p>需要在文件的头部引入jstl，使用forEach遍历的到的List，分别在两个select标签中显示出来；并且将前面页面传给后端的页码、关键词、Admin的id放在隐藏域，一起发送给后端。</p>
<pre><code class="jsp">&lt;form action=&quot;assign/do/assign.html&quot; method=&quot;post&quot; role=&quot;form&quot; class=&quot;form-inline&quot;&gt;                        
    &lt;!--隐藏域保存不会改变的adminId、pageNum、keyword，在提交时一起传给后端--&gt;
    &lt;input type=&quot;hidden&quot; value=&quot;$&#123;param.adminId&#125;&quot; name=&quot;adminId&quot;/&gt;
    &lt;input type=&quot;hidden&quot; value=&quot;$&#123;param.pageNum&#125;&quot; name=&quot;pageNum&quot;/&gt;
    &lt;input type=&quot;hidden&quot; value=&quot;$&#123;param.keyword&#125;&quot; name=&quot;keyword&quot;/&gt;
    &lt;div class=&quot;form-group&quot;&gt;
        &lt;label for=&quot;exampleInputPassword1&quot;&gt;未分配角色列表&lt;/label&gt;&lt;br&gt;
        &lt;select class=&quot;form-control&quot; multiple=&quot;&quot; size=&quot;10&quot; style=&quot;width:100px;overflow-y:auto;&quot;&gt;
            &lt;c:forEach items=&quot;$&#123;requestScope.UnAssignedRoleList&#125;&quot; var=&quot;role&quot;&gt;
                &lt;option value=&quot;$&#123;role.id&#125;&quot;&gt;$&#123;role.name&#125;&lt;/option&gt;
            &lt;/c:forEach&gt;
        &lt;/select&gt;
    &lt;/div&gt;
    &lt;div class=&quot;form-group&quot;&gt;
        &lt;ul&gt;
            &lt;li id=&quot;toRightBtn&quot; class=&quot;btn btn-default glyphicon glyphicon-chevron-right&quot;&gt;&lt;/li&gt;
            &lt;br&gt;
            &lt;li id=&quot;toLeftBtn&quot; class=&quot;btn btn-default glyphicon glyphicon-chevron-left&quot; style=&quot;margin-top:20px;&quot;&gt;&lt;/li&gt;
        &lt;/ul&gt;
    &lt;/div&gt;
    &lt;div class=&quot;form-group&quot; style=&quot;margin-left:40px;&quot;&gt;
        &lt;label for=&quot;exampleInputPassword1&quot;&gt;已分配角色列表&lt;/label&gt;&lt;br&gt;
        &lt;!-- 被选中要分配的部分，name设置为roleIdList --&gt;
        &lt;select name=&quot;roleIdList&quot; class=&quot;form-control&quot; multiple=&quot;&quot; size=&quot;10&quot; style=&quot;width:100px;overflow-y:auto;&quot;&gt;
            &lt;c:forEach items=&quot;$&#123;requestScope.AssignedRoleList&#125;&quot; var=&quot;role&quot;&gt;
                &lt;option value=&quot;$&#123;role.id&#125;&quot;&gt;$&#123;role.name&#125;&lt;/option&gt;
            &lt;/c:forEach&gt;
        &lt;/select&gt;
    &lt;/div&gt;
    &lt;button id=&quot;submitBtn&quot; type=&quot;submit&quot; style=&quot;width:100px;margin-top: 20px;margin-left: 230px;&quot; class=&quot;btn btn-sm btn-success btn-block&quot;&gt;提交&lt;/button&gt;
&lt;/form&gt;
</code></pre>
<p>完成显示后，需要：</p>
<p>​	①实现通过左右按钮，调整选中的Role的位置</p>
<p>​	②给“提交”按钮设置单击响应函数（为了使点击提交的时候，保证已经选中了“已分配”框的全部内容，能将数据完整地传给后端），最后将将表单内容发送给		<strong>assign&#x2F;do&#x2F;assign.html</strong></p>
<pre><code class="javascript">&lt;script type=&quot;text/javascript&quot;&gt;
    $(function () &#123;

        // 给向右的按钮添加单击响应函数，将左边选中的添加到右边
        $(&quot;#toRightBtn&quot;).click(function ()&#123;
            $(&quot;select:eq(0)&gt;option:selected&quot;).appendTo(&quot;select:eq(1)&quot;);
        &#125;);
        // 给向左的按钮添加单击响应函数，将右边选中的添加到左边
        $(&quot;#toLeftBtn&quot;).click(function ()&#123;
            $(&quot;select:eq(1)&gt;option:selected&quot;).appendTo(&quot;select:eq(0)&quot;);
        &#125;);

        // 给提交按钮添加单击响应函数，使其在提交前，先全选“已分配角色列表”的选项，使提交时会提交全部
        // 避免不提交之前存在的option的bug
        $(&quot;#submitBtn&quot;).click(function () &#123;
            $(&quot;select:eq(1)&gt;option&quot;).prop(&quot;selected&quot;,&quot;selected&quot;);
        &#125;);

    &#125;);
&lt;/script&gt;
</code></pre>
<p>​	后端Controller代码：</p>
<pre><code class="java">@RequestMapping(&quot;/assign/do/assign.html&quot;)
public String saveAdminRoleRelationship(
        @RequestParam(&quot;adminId&quot;) Integer adminId,
        @RequestParam(&quot;pageNum&quot;) Integer pageNum,
        @RequestParam(&quot;keyword&quot;) String keyword,
        // 允许roleIdList为空（因为可能已分配的被清空）
        @RequestParam(value = &quot;roleIdList&quot;, required = false) List&lt;Integer&gt; roleIdList
)&#123;
    // 调用service层方法
    adminService.saveAdminRoleRelationship(adminId, roleIdList);

    //重定向（减少数据库操作）返回信息页
    return &quot;redirect:/admin/page/page.html?pageNum=&quot;+pageNum+&quot;&amp;keyword=&quot;+keyword;
&#125;
</code></pre>
<p>​	Service层方法：</p>
<pre><code class="java">@Override
public void saveAdminRoleRelationship(Integer adminId, List&lt;Integer&gt; roleIdList) &#123;

    // 先清除旧的对应inner_admin_role表中对应admin_id的数据
    adminMapper.clearOldRelationship(adminId);

    // 如果roleIdList非空，则将该list保存到数据库表中，且admin_id=adminId
    if (roleIdList != null &amp;&amp; roleIdList.size() &gt; 0)&#123;
        adminMapper.saveAdminRoleRelationship(adminId,roleIdList);
    &#125;
    // roleIdList为空，则清空后不做操作

&#125;
</code></pre>
<p>​	AdminMapper.xml中的两个SQL语句：</p>
<pre><code class="xml">&lt;!-- 清除inner_admin_role表中对应adminId的旧数据 --&gt;
&lt;delete id=&quot;clearOldRelationship&quot;&gt;
  delete from inner_admin_role
  where admin_id = #&#123;adminId&#125;
&lt;/delete&gt;

&lt;!-- 向inner_admin_role表中插入关系（借助foreach标签） --&gt;
&lt;insert id=&quot;saveAdminRoleRelationship&quot;&gt;
  insert into inner_admin_role(admin_id, role_id) values
  &lt;foreach collection=&quot;roleIdList&quot; item=&quot;roleId&quot; separator=&quot;,&quot;&gt;
    (#&#123;adminId&#125;,#&#123;roleId&#125;)
  &lt;/foreach&gt;
&lt;/insert&gt;
</code></pre>
<p>​	这里注意因为插入的语句传入了两个变量，因此需要在mapper接口中用@Param标注出来；下面就是对应的mapper接口的方法：</p>
<pre><code class="java">void saveAdminRoleRelationship(@Param(&quot;adminId&quot;) Integer adminId, @Param(&quot;roleIdList&quot;) List&lt;Integer&gt; roleIdList);

void clearOldRelationship(Integer adminId);
</code></pre>
<p>至此，已经实现了给Admin分配Role的功能。</p>
<h2 id="二、给Role分配Auth"><a href="#二、给Role分配Auth" class="headerlink" title="二、给Role分配Auth"></a>二、给Role分配Auth</h2><h3 id="目标-6"><a href="#目标-6" class="headerlink" title="目标"></a>目标</h3><p>​	将Role与Auth的关联关系保存到数据r库。</p>
<h3 id="思路-6"><a href="#思路-6" class="headerlink" title="思路"></a>思路</h3><p>通过role-page页面的下面的按钮，打开分配Auth的模态框</p>
<p><img src="D:\浏览器下载\crowd-funding-master\crowd-funding-master\note\images\Role分配Auth.png"></p>
<p>模态框：</p>
<p><img src="D:\浏览器下载\crowd-funding-master\crowd-funding-master\note\images\Role分配Auth模态框.png"></p>
<h3 id="代码-6"><a href="#代码-6" class="headerlink" title="代码"></a>代码</h3><h4 id="1）、准备数据库表"><a href="#1）、准备数据库表" class="headerlink" title="1）、准备数据库表"></a>1）、准备数据库表</h4><p>​	<strong>t_auth表：</strong></p>
<pre><code class="sql">use project_rowd;

# 建t_auth表
CREATE TABLE t_auth (
    id int(11) NOT NULL AUTO_INCREMENT,
    name varchar(200) DEFAULT NULL,
    title varchar(200) DEFAULT NULL,
    category_id int(11) DEFAULT NULL,

    PRIMARY KEY (id)
);

# 给t_auth表插入数据
INSERT INTO t_auth(id,`name`,title,category_id) VALUES(1,&#39;&#39;,&#39;用户模块&#39;,NULL);
INSERT INTO t_auth(id,`name`,title,category_id) VALUES(2,&#39;user:delete&#39;,&#39;删除&#39;,1);
INSERT INTO t_auth(id,`name`,title,category_id) VALUES(3,&#39;user:get&#39;,&#39;查询&#39;,1);
INSERT INTO t_auth(id,`name`,title,category_id) VALUES(4,&#39;&#39;,&#39;角色模块&#39;,NULL);
INSERT INTO t_auth(id,`name`,title,category_id) VALUES(5,&#39;role:delete&#39;,&#39;删除&#39;,4);
INSERT INTO t_auth(id,`name`,title,category_id) VALUES(6,&#39;role:get&#39;,&#39;查询&#39;,4);
INSERT INTO t_auth(id,`name`,title,category_id) VALUES(7,&#39;role:add&#39;,&#39;新增&#39;,4);
</code></pre>
<p>​	逆向生成Auth实体类、Mapper，并创建AuthService接口、等。</p>
<p>​	关联表inner_role_auth：</p>
<pre><code class="sql">use project_rowd;

CREATE TABLE inner_role_auth( 
    id INT NOT NULL AUTO_INCREMENT,
    role_id INT,
    auth_id INT,
    PRIMARY KEY (id) 
);
</code></pre>
<p>​	该表和inner_admin_role相似，不需要进行逆向工程</p>
<h4 id="2）、前后端代码-1"><a href="#2）、前后端代码-1" class="headerlink" title="2）、前后端代码"></a>2）、前后端代码</h4><p>​	因为role页面的按钮是在my-role.js中动态生成的，修改其中的代码，给checkBtn添加id等于当前的role的id，添加class “checkBtn”：</p>
<pre><code class="javascript">var checkBtn = &quot;&lt;button type=&#39;button&#39; id=&#39;&quot;+roleId+&quot;&#39; class=&#39;btn btn-success btn-xs checkBtn&#39;&gt;&lt;i class=&#39; glyphicon glyphicon-check&#39;&gt;&lt;/i&gt;&lt;/button&gt;&quot;
</code></pre>
<p>​	</p>
<h5 id="显示树形结构"><a href="#显示树形结构" class="headerlink" title="显示树形结构"></a>显示树形结构</h5><p>在role-page.jsp中给对应按钮添加单击响应函数：</p>
<pre><code class="javascript">// 给分配权限的按钮添加单击响应函数，打开分配模态框
$(&quot;#rolePageTBody&quot;).on(&quot;click&quot;,&quot;.checkBtn&quot;,function () &#123;

    // 将当前按钮的id放入全局变量
    window.roleId = this.id;
    // 打开模态框
    $(&quot;#assignModal&quot;).modal(&quot;show&quot;);
    // 生成权限信息
    generateAuthTree();
&#125;);
</code></pre>
<p>通过zTree生成权限信息generateAuthTree()，且将从后端查到的已经分配的权限回显到模态框中：</p>
<p>这里直接交给zTree自己组装树形结构</p>
<p>​	要使自动组装需要开启简单JSON功能</p>
<pre><code class="javascript">// 生成权限信息的树形结构
function generateAuthTree()&#123;

    var ajaxReturn = $.ajax(&#123;
        url: &quot;assign/get/tree.json&quot;,
        type: &quot;post&quot;,
        async: false,
        dataType: &quot;json&quot;
    &#125;);

    if (ajaxReturn.status != 200)&#123;
        layer.msg(&quot;请求出错！错误码：&quot;+ ajaxReturn.status + &quot;错误信息：&quot; + ajaxReturn.statusText);
        return ;
    &#125;

    var resultEntity = ajaxReturn.responseJSON;

    if (resultEntity.result == &quot;FAILED&quot;)&#123;
        layer.msg(&quot;操作失败！&quot;+resultEntity.message);
    &#125;

    if (resultEntity.result == &quot;SUCCESS&quot;)&#123;
        var authList = resultEntity.data;
        // 将服务端查询到的list交给zTree自己组装
        var setting = &#123;
            data: &#123;
                // 开启简单JSON功能
                simpleData: &#123;
                    enable: true,
                    // 通过pIdKey属性设置父节点的属性名，而不使用默认的pId
                    pIdKey: &quot;categoryId&quot;
                &#125;,
                key: &#123;
                    // 设置在前端显示的节点名是查询到的title，而不是使用默认的name
                    name:&quot;title&quot;
                &#125;,
            &#125;,

            check: &#123;
                enable:true
            &#125;
        &#125;;

        // 生成树形结构信息
        $.fn.zTree.init($(&quot;#authTreeDemo&quot;), setting, authList);

        // 设置节点默认是展开的
        // 1 得到zTreeObj
        var zTreeObj = $.fn.zTree.getZTreeObj(&quot;authTreeDemo&quot;);
        // 2 设置默认展开
        zTreeObj.expandAll(true);

        // ----------回显部分----------
        
        // 回显（勾选）后端查出的匹配的权限
        ajaxReturn = $.ajax(&#123;
            url: &quot;assign/get/checked/auth/id.json&quot;,
            type: &quot;post&quot;,
            dataType: &quot;json&quot;,
            async: false,
            data:&#123;
                &quot;roleId&quot;:window.roleId
            &#125;
        &#125;);

        if (ajaxReturn.status != 200)&#123;
            layer.msg(&quot;请求出错！错误码：&quot;+ ajaxReturn.status + &quot;错误信息：&quot; + ajaxReturn.statusText);
            return ;
        &#125;

        resultEntity = ajaxReturn.responseJSON;

        if (resultEntity.result == &quot;FAILED&quot;)&#123;
            layer.msg(&quot;操作失败！&quot;+resultEntity.message);
        &#125;

        if (resultEntity.result == &quot;SUCCESS&quot;)&#123;
            var authIdArray = resultEntity.data;

            // 遍历得到的autoId的数组
            // 根据authIdArray勾选对应的节点
            for (var i = 0; i &lt; authIdArray.length; i++)&#123;
                var authId = authIdArray[i];

                // 通过id得到treeNode
                var treeNode = zTreeObj.getNodeByParam(&quot;id&quot;,authId);

                // checked设置为true，表示勾选节点
                var checked = true;

                // checkTypeFlag设置为false，表示不联动勾选，
                // 即父节点的子节点未完全勾选时不改变父节点的勾选状态
                // 否则会出现bug：前端只要选了一个子节点，传到后端后，下次再调用时，发现前端那个子节点的所有兄弟节点也被勾选了，
                // 因为在子节点勾选时，父节点也被勾选了，之后前端显示时，联动勾选，导致全部子节点被勾选
                var checkTypeFlag = false;

                // zTreeObj的checkNode方法 执行勾选操作
                zTreeObj.checkNode(treeNode,checked,checkTypeFlag);
            &#125;
        &#125;

    &#125;
&#125;
</code></pre>
<p>Controller层<strong>（显示树形结构部分）</strong>：</p>
<pre><code class="java">@ResponseBody
@RequestMapping(&quot;/assign/get/tree.json&quot;)
public ResultEntity&lt;List&lt;Auth&gt;&gt; getAuthTree()&#123;
    List&lt;Auth&gt; authList = authService.queryAuthList();

    return ResultEntity.successWithData(authList);
&#125;
</code></pre>
<p>Service层：</p>
<pre><code class="java">@Override
public List&lt;Auth&gt; queryAuthList() &#123;
    // 直接传入一个new的AuthExample，查询全部的Auth
    return authMapper.selectByExample(new AuthExample());
&#125;
</code></pre>
<p>Controller层<strong>（回显已分配权限部分）</strong>：</p>
<pre><code class="java">// 获得被勾选的auth信息
@ResponseBody
@RequestMapping(&quot;/assign/get/checked/auth/id.json&quot;)
public ResultEntity&lt;List&lt;Integer&gt;&gt; getAuthByRoleId(Integer roleId)&#123;
    List&lt;Integer&gt; authIdList = authService.getAuthByRoleId(roleId);
    return ResultEntity.successWithData(authIdList);
&#125;
</code></pre>
<p>Service层：</p>
<pre><code class="java">@Override
public List&lt;Integer&gt; getAuthByRoleId(Integer roleId) &#123;
    return authMapper.getAuthByRoleId(roleId);
&#125;
</code></pre>
<p>Mapper接口与authMapper.xml文件的sql：</p>
<pre><code class="java">List&lt;Integer&gt; getAuthByRoleId(Integer roleId);
</code></pre>
<pre><code class="xml">&lt;!--从inner_role_auth查找匹配roleId的auth_id--&gt;
&lt;select id=&quot;getAuthByRoleId&quot; resultType=&quot;int&quot;&gt;
  select auth_id from inner_role_auth
  where role_id = #&#123;roleId&#125;
&lt;/select&gt;
</code></pre>
<h5 id="分配权限功能"><a href="#分配权限功能" class="headerlink" title="分配权限功能"></a>分配权限功能</h5><p>给模态框的提交按钮绑定单击响应函数</p>
<pre><code class="javascript">// 给分配权限的模态框中的提交按钮设置单击响应函数
$(&quot;#assignBtn&quot;).click(function () &#123;
    // 声明一个数组，用来存放被勾选的auth的id
    var authIdArray = [];

    // 拿到zTreeObj
    var zTreeObj = $.fn.zTree.getZTreeObj(&quot;authTreeDemo&quot;);

    // 通过getCheckedNodes方法拿到被选中的option信息
    var authArray = zTreeObj.getCheckedNodes();

    for (var i = 0; i &lt; authArray.length; i++) &#123;
        // 从被选中的auth中遍历得到每一个auth的id
        var authId = authArray[i].id;
        // 通过push方法将得到的id存入authIdArray
        authIdArray.push(authId);
    &#125;
    var requestBody = &#123;
        // 为了后端取值方便，两个数据都用数组格式存放，后端统一用List&lt;Integer&gt;获取
        &quot;roleId&quot;:[window.roleId],
        &quot;authIdList&quot;:authIdArray
    &#125;
    requestBody = JSON.stringify(requestBody);

    $.ajax(&#123;
        url: &quot;assign/do/save/role/auth/relationship.json&quot;,
        type: &quot;post&quot;,
        data: requestBody,
        contentType: &quot;application/json;charset=UTF-8&quot;,
        dataType: &quot;json&quot;,
        success: function (response) &#123;
            if (response.result == &quot;SUCCESS&quot;)&#123;
                layer.msg(&quot;操作成功！&quot;);
            &#125;
            if (response.result == &quot;FAILED&quot;)&#123;
                layer.msg(&quot;操作失败！提示信息：&quot;+ response.message);
            &#125;
        &#125;,
        error: function (response) &#123;
            layer.msg(response.status + &quot;  &quot; + response.statusText);
        &#125;
    &#125;);

    // 关闭模态框
    $(&quot;#assignModal&quot;).modal(&quot;hide&quot;);
&#125;);
</code></pre>
<p>​	Controller层代码：</p>
<pre><code class="java">@ResponseBody
@RequestMapping(&quot;/assign/do/save/role/auth/relationship.json&quot;)
public ResultEntity&lt;String&gt; saveRoleAuthRelationship(
        // 用一个map接收前端发来的数据
        @RequestBody Map&lt;String,List&lt;Integer&gt;&gt; map ) &#123;
    // 保存更改后的Role与Auth关系
    authService.saveRoleAuthRelationship(map);
    
    return ResultEntity.successWithoutData();
&#125;
</code></pre>
<p>​	Service层方法：</p>
<pre><code class="java">@Override
public void saveRoleAuthRelationship(Map&lt;String, List&lt;Integer&gt;&gt; map) &#123;
    // 从map获取到roleId、authIdList
    List&lt;Integer&gt; roleIdList = map.get(&quot;roleId&quot;);
    Integer roleId = roleIdList.get(0);

    List&lt;Integer&gt; authIdList = map.get(&quot;authIdList&quot;);

    // 1 清除原有的关系信息
    authMapper.deleteOldRelationshipByRoleId(roleId);


    // 2 当authIdList有效时，添加前端获取的新的关系信息
    if (authIdList != null &amp;&amp; authIdList.size() &gt; 0)&#123;
        authMapper.insertNewRelationship(roleId,authIdList);
    &#125;
&#125;
</code></pre>
<p>​	Mapper接口与authMapper.xml文件的sql代码：</p>
<pre><code class="java">void deleteOldRelationshipByRoleId(Integer roleId);

void insertNewRelationship(@Param(&quot;roleId&quot;) Integer roleId, @Param(&quot;authIdList&quot;) List&lt;Integer&gt; authIdList);
</code></pre>
<pre><code class="xml">&lt;!--通过roleId删除inner_role_auth表中旧的关系--&gt;
&lt;delete id=&quot;deleteOldRelationshipByRoleId&quot;&gt;
  delete from inner_role_auth where
  role_id = #&#123;roleId&#125;
&lt;/delete&gt;

&lt;!--向inner_role_auth表中插入新的关系--&gt;
&lt;insert id=&quot;insertNewRelationship&quot;&gt;
  insert into inner_role_auth(role_id, auth_id) values
  &lt;foreach collection=&quot;authIdList&quot; item=&quot;authId&quot; separator=&quot;,&quot;&gt;
    (#&#123;roleId&#125;,#&#123;authId&#125;)
  &lt;/foreach&gt;
&lt;/insert&gt;
</code></pre>
<p>​		此时分配权限的功能也实现了。</p>
<h1 id="在项目中加入SpringSecurity"><a href="#在项目中加入SpringSecurity" class="headerlink" title="在项目中加入SpringSecurity"></a>在项目中加入SpringSecurity</h1><p>目标：在原本的项目中使用SpringSecurity，替换原本自己写的登录、访问等机制。</p>
<h2 id="一、加入SpringSecurity环境"><a href="#一、加入SpringSecurity环境" class="headerlink" title="一、加入SpringSecurity环境"></a>一、加入SpringSecurity环境</h2><h3 id="1）、加入依赖"><a href="#1）、加入依赖" class="headerlink" title="1）、加入依赖"></a>1）、加入依赖</h3><p>在父工程的pom文件规定SpringSecurity的版本信息：</p>
<pre><code class="xml">&lt;!-- SpringSecurity 依赖配置 --&gt;
&lt;!-- $&#123;fall.spring.security.version&#125;：就是4.2.10.RELEASE版本 --&gt;

&lt;!-- SpringSecurity 对 Web 应用进行权限管理 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
    &lt;artifactId&gt;spring-security-web&lt;/artifactId&gt;
    &lt;version&gt;$&#123;fall.spring.security.version&#125;&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- SpringSecurity 配置 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
    &lt;artifactId&gt;spring-security-config&lt;/artifactId&gt;
    &lt;version&gt;$&#123;fall.spring.security.version&#125;&lt;/version&gt;
&lt;/dependency&gt;
&lt;!-- SpringSecurity 标签库 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
    &lt;artifactId&gt;spring-security-taglibs&lt;/artifactId&gt;
    &lt;version&gt;$&#123;fall.spring.security.version&#125;&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>在component工程中引入依赖：</p>
<pre><code class="xml">&lt;!-- SpringSecurity 对 Web 应用进行权限管理 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
    &lt;artifactId&gt;spring-security-web&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- SpringSecurity 配置 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
    &lt;artifactId&gt;spring-security-config&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- SpringSecurity 标签库 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
    &lt;artifactId&gt;spring-security-taglibs&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<h3 id="2）、在web-xml中配置"><a href="#2）、在web-xml中配置" class="headerlink" title="2）、在web.xml中配置"></a>2）、在web.xml中配置</h3><pre><code class="xml">&lt;!--加入 SpringSecurity 控制权限的 Filter--&gt;
&lt;filter&gt;
    &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
    &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;
&lt;/filter&gt;

&lt;filter-mapping&gt;
    &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
</code></pre>
<h3 id="3）、创建基于注解的SpringSecurity配置类"><a href="#3）、创建基于注解的SpringSecurity配置类" class="headerlink" title="3）、创建基于注解的SpringSecurity配置类"></a>3）、创建基于注解的SpringSecurity配置类</h3><pre><code class="java">@Configuration			// 设置为配置类
@EnableWebSecurity		// 开启web环境下的权限控制功能
// 需要继承WebSecurityConfigurerAdapter
public class WebAppSecurityConfig extends WebSecurityConfigurerAdapter &#123;


&#125;
</code></pre>
<h3 id="注意：-1"><a href="#注意：-1" class="headerlink" title="注意："></a>注意：</h3><p>此时启动Tomcat，会&#x3D;&#x3D;触发找不到springSecurityFilterChain Bean的问题&#x3D;&#x3D;，这是因为我们创建的WebAppSecurityConfig配置类放在mvc的包下，是交给SpringMVC去扫描的（因为需要让SpringSecurity针对浏览器进行权限控制，就需要让SpringMVC来扫描配置类）。但是DelegatingFilterProxy初始化时，会默认到Spring的容器中寻找springSecurityFilterChain组件，这样是不可能找到的；而在第一次请求时，它依然会去Spring容器中寻找，还是找不到，因此会触发该异常。</p>
<p>解决方案：</p>
<p>​	一、修改源码，让DelegatingFilterProxy先扫描SpringMVC的容器；</p>
<p>​	二、将Spring的IOC容器和SpringMVC的IOC容器在web.xml中合为一个。</p>
<p>这里选用了<strong>第二种方法</strong>（修改源码的方式相对较复杂，并且修改后，在后面实验过程也需要修改源码，方法二则可以比较快捷）</p>
<p><img src="D:\浏览器下载\crowd-funding-master\crowd-funding-master\note\images\SpringSecurity的问题.png"></p>
<pre><code class="xml">&lt;!--配置DispatcherServlet（即配置SpringMVC的前端控制器）--&gt;
&lt;servlet&gt;
    &lt;servlet-name&gt;dispatcherServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;
    &lt;!--指定SpringMVC配置文件--&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
        &lt;param-value&gt;classpath:spring-*.xml&lt;/param-value&gt;
    &lt;/init-param&gt;

    &lt;!--使DispatcherServlet在Web应用启动时就创建对象并初始化--&gt;
    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
&lt;/servlet&gt;
</code></pre>
<p>此时该异常就可以解决了</p>
<h2 id="二、在项目中使用SpringSecurity"><a href="#二、在项目中使用SpringSecurity" class="headerlink" title="二、在项目中使用SpringSecurity"></a>二、在项目中使用SpringSecurity</h2><h3 id="1）、放行登录页与静态资源"><a href="#1）、放行登录页与静态资源" class="headerlink" title="1）、放行登录页与静态资源"></a>1）、放行登录页与静态资源</h3><p>这里需要<strong>重写WebSecurityConfigurerAdapter的configure(HttpSecurity security)方法</strong>。</p>
<pre><code class="java">@Configuration
@EnableWebSecurity
public class WebAppSecurityConfig extends WebSecurityConfigurerAdapter &#123;
    
    @Override
    protected void configure(HttpSecurity security) throws Exception &#123;
        // String数组，列出需要放行的资源的路径
        String[] permitUrls = &#123;&quot;/index.jsp&quot;,&quot;/bootstrap/**&quot;,
                &quot;/crowd/**&quot;,&quot;/css/**&quot;,&quot;/fonts/**&quot;,&quot;/img/**&quot;,
                &quot;/jquery/**&quot;,&quot;/layer/**&quot;,&quot;/script/**&quot;,&quot;/ztree/**&quot;,&quot;/admin/login/page.html&quot;&#125;;
        security
                .authorizeRequests()        // 表示对请求进行授权
                .antMatchers(permitUrls)    // 传入的ant风格的url
                .permitAll()                // 允许上面的所有请求，不需要认证

                .anyRequest()               // 设置其他未设置的全部请求
                .authenticated()            // 表示需要认证
                ;
    &#125;
&#125;
</code></pre>
<h3 id="2）、进行登录认证"><a href="#2）、进行登录认证" class="headerlink" title="2）、进行登录认证"></a>2）、进行登录认证</h3><p>依旧是通过configure(HttpSecurity security)方法，在上面的代码的security设置的基础上再加入下面的代码：</p>
<pre><code class="java">@Override
protected void configure(HttpSecurity security) throws Exception &#123;
    security.
        .csrf()         // 设置csrf
        .disable()      // 关闭csrf

        .formLogin()                                    // 开启表单登录功能
        .loginPage(&quot;/admin/login/page.html&quot;)            // 指定登陆页面
        .usernameParameter(&quot;login-user&quot;)                // 设置表单中对应用户名的标签的name属性名
        .passwordParameter(&quot;login-pwd&quot;)                 // 设置表单中对应密码的标签的name属性名
        .loginProcessingUrl(&quot;/security/do/login.html&quot;)  // 设置登录请求的提交地址
        .defaultSuccessUrl(&quot;/admin/main/page.html&quot;)     // 设置登陆成功后前往的地址
        .and()
        .logout()                                       // 开启退出登录功能
        .logoutUrl(&quot;/security/do/logout.html&quot;)          // 设置退出登录的url
        .logoutSuccessUrl(&quot;/admin/login/page.html&quot;)    // 设置退出成功后前往的页面
&#125;
</code></pre>
<p>这里开启了登录与退出功能后，要修改原先的登录按钮、退出按钮的触发的url，以达到通过SpringSecurity进行登录退出的目的。</p>
<p>关闭csrf是因为这里开发环境为了方便（否则所有提交都需要是post方式，且需要再隐藏域中带csrf的信息，在开发时就比较麻烦）</p>
<p>①修改<strong>admin-login.jsp</strong>的代码:</p>
<p>主要是修改了表单的action、输入框的账号密码的name要与前面的usernameParameter、passwordParameter中的参数相同。</p>
<p>​	通过**${SPRING_SECURITY_LAST_EXCEPTION.message}**可以在前端显示由Spring Security抛出的异常信息</p>
<pre><code class="jsp">&lt;form action=&quot;security/do/login.html&quot; method=&quot;post&quot; class=&quot;form-signin&quot; role=&quot;form&quot;&gt;
    &lt;h2 class=&quot;form-signin-heading&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-log-in&quot;&gt;&lt;/i&gt; 用户登录&lt;/h2&gt;
    &lt;p&gt;$&#123;requestScope.exception.message&#125;&lt;/p&gt;
    &lt;p&gt;$&#123;SPRING_SECURITY_LAST_EXCEPTION.message&#125;&lt;/p&gt;
    &lt;div class=&quot;form-group has-success has-feedback&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;login-user&quot; class=&quot;form-control&quot; id=&quot;inputSuccess4&quot; placeholder=&quot;请输入登录账号&quot; autofocus&gt;
        &lt;span class=&quot;glyphicon glyphicon-user form-control-feedback&quot;&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class=&quot;form-group has-success has-feedback&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;login-pwd&quot; class=&quot;form-control&quot; id=&quot;inputSuccess4&quot; placeholder=&quot;请输入登录密码&quot; style=&quot;margin-top:10px;&quot;&gt;
        &lt;span class=&quot;glyphicon glyphicon-lock form-control-feedback&quot;&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class=&quot;checkbox&quot; style=&quot;text-align:right;&quot;&gt;&lt;a href=&quot;reg.html&quot;&gt;我要注册&lt;/a&gt;&lt;/div&gt;
    &lt;button type=&quot;submit&quot; class=&quot;btn btn-lg btn-success btn-block&quot;&gt;登录&lt;/button&gt;
&lt;/form&gt;
</code></pre>
<p>②修改登录后的页面中退出按钮的代码<strong>include-nav.jsp</strong>：</p>
<pre><code class="jsp">&lt;ul class=&quot;dropdown-menu&quot; role=&quot;menu&quot;&gt;
    &lt;li&gt;&lt;a href=&quot;#&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-cog&quot;&gt;&lt;/i&gt; 个人设置&lt;/a&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&quot;#&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-comment&quot;&gt;&lt;/i&gt; 消息&lt;/a&gt;&lt;/li&gt;
    &lt;li class=&quot;divider&quot;&gt;&lt;/li&gt;
    &lt;li&gt;&lt;a href=&quot;security/do/logout.html&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-off&quot;&gt;&lt;/i&gt; 退出系统&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</code></pre>
<p>此处先演示通过内存的登录认证：</p>
<p>需要重写WebSecurityConfigurerAdapter的configure(AuthenticationManagerBuilder builder)方法。</p>
<pre><code class="java">@Configuration
@EnableWebSecurity
public class WebAppSecurityConfig extends WebSecurityConfigurerAdapter &#123;
    @Override
    protected void configure(AuthenticationManagerBuilder builder) throws Exception &#123;
        builder
                .inMemoryAuthentication()        // 开启在内存中进行身份验证（开发时暂用）
                .withUser(&quot;tom&quot;)        		 // 设置用户名
                .password(&quot;123456&quot;)              // 设置密码
                .roles(&quot;ADMIN&quot;);                 // 设置权限
    &#125;
&#125;
</code></pre>
<p>测试可用后，替换为通过数据库进行用户登录的认证</p>
<p>前提条件：</p>
<ol>
<li>可以通过前端传入的用户名从数据库得到Admin对象</li>
<li>可以通过AdminId得到admin对应角色的List</li>
<li>可以通过AdminId得到权限的name的List</li>
</ol>
<p>满足这些条件后，通过实现UserDetailsService接口，通过其**loadUserByUsername(String username)**方法，传入username，返回最后的结果，也就是所有验则操作交给该实现类来处理。</p>
<p>条件1：</p>
<p>在AdminServiceImpl中添加getAdminByLoginAcct方法（其接口也需要添加该方法）：</p>
<pre><code class="java">@Override
public Admin getAdminByLoginAcct(String loginAcct) &#123;	// 通过loginAcct得到Admin对象
    AdminExample example = new AdminExample();
    AdminExample.Criteria criteria = example.createCriteria();
    criteria.andLoginAcctEqualTo(loginAcct);
    List&lt;Admin&gt; admins = adminMapper.selectByExample(example);
    Admin admin = admins.get(0);
    return admin;
&#125;
</code></pre>
<p>条件2：</p>
<p>RoleServiceImpl：此处可以使用前面写好的Service方法，通过adminId得到已经分配的角色的List</p>
<pre><code class="java">@Override
public List&lt;Role&gt; queryAssignedRoleList(Integer adminId) &#123;
    return roleMapper.queryAssignedRoleList(adminId);
&#125;
</code></pre>
<p>条件3：</p>
<p>AuthServiceImpl：</p>
<pre><code class="java">@Override
public List&lt;String&gt; getAuthNameByAdminId(Integer adminId) &#123;
    return authMapper.selectAuthNameByAdminId(adminId);
&#125;
</code></pre>
<p>AuthMapper.xml：（记得给Mapper接口添加selectAuthNameByAdminId抽象方法，这里省略了）</p>
<p>通过左外连接查询符合要求的权限名字：</p>
<pre><code class="xml">&lt;!-- 通过admin的id得到auth的name --&gt;
&lt;select id=&quot;selectAuthNameByAdminId&quot; resultType=&quot;string&quot;&gt;
  SELECT
  DISTINCT t_auth.name
  from t_auth
  LEFT JOIN inner_role_auth ON inner_role_auth.auth_id = t_auth.id
  LEFT JOIN inner_admin_role ON inner_admin_role.role_id = inner_role_auth.role_id
  WHERE inner_admin_role.admin_id = #&#123;adminId&#125;
  AND t_auth.name != &quot;&quot; and t_auth.name IS NOT NULL
&lt;/select&gt;
</code></pre>
<p>此外，为了方便之后在前端获得Admin更多的信息，创建一个SecurityAdmin类，继承User类，使其在loadUserByUsername方法中返回时，内容更多：</p>
<pre><code class="java">/**
 * 为了能方便地获取到原始地Admin对象，因此创建一个SecurityAdmin类，继承User。
 */
public class SecurityAdmin extends User &#123;

    private Admin originalAdmin;

    public SecurityAdmin(Admin admin, List&lt;GrantedAuthority&gt; authorities)&#123;
        
        // 调用父类的构造方法
        super(admin.getUserName(),admin.getUserPswd(),authorities);
        
        // 将Admin对象放入对象
        this.originalAdmin = admin;

    &#125;

    public Admin getOriginalAdmin()&#123;
        return this.originalAdmin;
    &#125;
&#125;
</code></pre>
<p>最后编写UserDetailsService的实现类CrowdUserDetailsService：</p>
<pre><code class="java">@Component		// 也需要扫描入SpringMVC容器，用于自动注入
public class CrowdUserDetailsService implements UserDetailsService &#123;

    @Autowired
    private AdminService adminService;

    @Autowired
    private RoleService roleService;

    @Autowired
    private AuthService authService;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;
        // 通过用户名得到Admin对象
        Admin admin = adminService.getAdminByLoginAcct(username);

        // 通过AdminId得到角色List
        List&lt;Role&gt; roles = roleService.queryAssignedRoleList(admin.getId());

        // 通过AdminId得到权限name地List
        List&lt;String&gt; authNameList = authService.getAuthNameByAdminId(admin.getId());

        // 创建List用来存放GrantedAuthority（权限信息）
        List&lt;GrantedAuthority&gt; authorities = new ArrayList&lt;&gt;();

        // 向List存放角色信息，注意角色必须要手动加上 “ROLE_” 前缀
        for (Role role : roles)&#123;
            String roleName = &quot;ROLE_&quot; + role.getName();
            SimpleGrantedAuthority simpleGrantedAuthority = new SimpleGrantedAuthority(roleName);
            authorities.add(simpleGrantedAuthority);
        &#125;

        // 向List存放权限信息
        for (String authName : authNameList)&#123;
            SimpleGrantedAuthority simpleGrantedAuthority = new SimpleGrantedAuthority(authName);
            authorities.add(simpleGrantedAuthority);
        &#125;

        // 将Admin对象、权限信息封装入SecurityAdmin对象（User的子类）
        SecurityAdmin securityAdmin = new SecurityAdmin(admin,authorities);

        // 返回SecurityAdmin对象
        return securityAdmin;
    &#125;
&#125;
</code></pre>
<p>注意：如果使存入的是角色，这种方式的存入必须要手动加入<strong>”ROLE_“</strong>前缀。</p>
<p>最后在配置类中使用CrowdUserDetailsService：</p>
<pre><code class="java">@Configuration
@EnableWebSecurity
public class WebAppSecurityConfig extends WebSecurityConfigurerAdapter &#123;

    @Autowired
    UserDetailsService userDetailsService;

    @Override
    protected void configure(AuthenticationManagerBuilder builder) throws Exception &#123;
        builder
                .userDetailsService(userDetailsService);
    &#125;
&#125;
</code></pre>
<h3 id="3）、密码加密与擦除"><a href="#3）、密码加密与擦除" class="headerlink" title="3）、密码加密与擦除"></a>3）、密码加密与擦除</h3><h4 id="①密码加密"><a href="#①密码加密" class="headerlink" title="①密码加密"></a>①密码加密</h4><p>通过BCryptPasswordEncoder，进行加密</p>
<p>首先将BCryptPasswordEncoder加入IOC容器：</p>
<p>（因为现在只有一个IOC容器了，因此放在哪个Spring配置文件中都可以，这里是放在spring-persist-tx.xml中）</p>
<pre><code class="xml">&lt;!-- 将BCryptPasswordEncoder装配入IOC容器 --&gt;
&lt;bean class=&quot;org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder&quot; id=&quot;passwordEncoder&quot;/&gt;
</code></pre>
<p>之后在配置类中使用加密：</p>
<pre><code class="java">@Configuration
@EnableWebSecurity
public class WebAppSecurityConfig extends WebSecurityConfigurerAdapter &#123;

    @Autowired
    UserDetailsService userDetailsService;

    @Autowired
    BCryptPasswordEncoder passwordEncoder;

    @Override
    protected void configure(AuthenticationManagerBuilder builder) throws Exception &#123;
        builder
                .userDetailsService(userDetailsService)
                .passwordEncoder(passwordEncoder);      // 使用BCryptPasswordEncoder进行带盐值的密码加密
    &#125;
&#125;
</code></pre>
<h4 id="②密码擦除"><a href="#②密码擦除" class="headerlink" title="②密码擦除"></a>②密码擦除</h4><p>对于User对象中自带的密码属性，SpringSecurity已经擦除了，我们只需要删除SecurityAdmin对象中Admin对象的密码即可：</p>
<p><strong>修改SecurityAdmin的构造方法</strong>，最后添加一个<strong>设置userPswd&#x3D;null</strong>即可</p>
<pre><code class="java">public SecurityAdmin(Admin admin, List&lt;GrantedAuthority&gt; authorities)&#123;
    super(admin.getUserName(),admin.getUserPswd(),authorities);

    this.originalAdmin = admin;
    // 为了保证安全性，擦除放入originalAdmin的对象的密码
    this.originalAdmin.setUserPswd(null);
&#125;
</code></pre>
<h3 id="4）、前端显示登录用户昵称"><a href="#4）、前端显示登录用户昵称" class="headerlink" title="4）、前端显示登录用户昵称"></a>4）、前端显示登录用户昵称</h3><p>修改include-nav.jsp的代码：</p>
<p>①引入Spring Security的标签库</p>
<p><code>&lt;%@taglib prefix=&quot;security&quot; uri=&quot;http://www.springframework.org/security/tags&quot; %&gt;</code></p>
<p>②使用security标签显示昵称</p>
<p><code>&lt;security:authentication property=&quot;principal.originalAdmin.userName&quot;/&gt;</code></p>
<pre><code class="jsp">&lt;%--引入security标签库--%&gt;
&lt;%@taglib prefix=&quot;security&quot; uri=&quot;http://www.springframework.org/security/tags&quot; %&gt;
&lt;nav class=&quot;navbar navbar-inverse navbar-fixed-top&quot; role=&quot;navigation&quot;&gt;
    &lt;div class=&quot;container-fluid&quot;&gt;
        &lt;div class=&quot;navbar-header&quot;&gt;
            &lt;div&gt;&lt;a class=&quot;navbar-brand&quot; style=&quot;font-size:32px;&quot; href=&quot;#&quot;&gt;众筹平台 - 控制面板&lt;/a&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;div id=&quot;navbar&quot; class=&quot;navbar-collapse collapse&quot;&gt;
            &lt;ul class=&quot;nav navbar-nav navbar-right&quot;&gt;
                &lt;li style=&quot;padding-top:8px;&quot;&gt;
                    &lt;div class=&quot;btn-group&quot;&gt;
                        &lt;button type=&quot;button&quot; class=&quot;btn btn-default btn-success dropdown-toggle&quot; data-toggle=&quot;dropdown&quot;&gt;
                            &lt;i class=&quot;glyphicon glyphicon-user&quot;&gt;
                          &lt;%--通过principal.originalAdmin.userName得到当前用户的昵称（principal其实就是前面返回的SecurityAdmin对象）--%&gt;
                                &lt;security:authentication property=&quot;principal.originalAdmin.userName&quot;/&gt;
                            &lt;/i&gt;
                            &lt;span class=&quot;caret&quot;&gt;&lt;/span&gt;
                        &lt;/button&gt;
</code></pre>
<p>property中，principal其实就代表了loadUserByUsername返回的SecurityAdmin对象，因此可以从中取出originalAdmin，得到username。</p>
<p><strong>这也是为什么，需要擦除密码，如果不擦除，那么可以直接从前端获得密码，这样并不安全。</strong></p>
<h3 id="5）、权限控制"><a href="#5）、权限控制" class="headerlink" title="5）、权限控制"></a>5）、权限控制</h3><p>假设这样一些数据：<br>    用户：adminOperator<br>        角色：经理<br>            权限：无<br>        角色：经理操作者<br>            权限：user:save<br>    最终组装后：ROLE_经理，ROLE_经理操作者，user:save</p>
<p>​	用户：roleOperator<br>​		角色：部长<br>​			权限：无<br>​		角色：部长操作者<br>​			权限：role:delete<br>​	最终组装后：ROLE_部长，ROLE_部长操作者，role:delete</p>
<p>①设置只有拥有经理角色时，可以访问用户的分页显示页面，只有拥有部长角色时，可以访问角色分页页面</p>
<p>先在前端写好的页面中设置好对应上面的用户的各项数据（角色、权限等）</p>
<p>设置页面的权限：</p>
<p>方法一：通过configure(HttpSecurity security)方法，用HttpSecurity设置：</p>
<pre><code class="java">    @Override
    protected void configure(HttpSecurity security) throws Exception &#123;
        security
            .authorizeRequests()        // 表示对请求进行授权
            .antMatchers(permitUrls)    // 传入的ant风格的url
            .permitAll()                // 允许上面的所有请求，不需要认证
            
            .antMatchers(&quot;/admin/page/page.html&quot;)	// 设置要得到admin的分页信息
            .hasRole(&quot;经理&quot;);						   // 必须具有经理的角色
    &#125;
</code></pre>
<p>也可以不用hasRole这类，而是使用<strong>access()方法</strong></p>
<pre><code class="java">@Override
protected void configure(HttpSecurity security) throws Exception &#123;
    security
            .authorizeRequests()        // 表示对请求进行授权
            .antMatchers(permitUrls)    // 传入的ant风格的url
            .permitAll()                // 允许上面的所有请求，不需要认证

            .antMatchers(&quot;/admin/page/page.html&quot;)   // 设置要得到admin的分页信息
            .access(&quot;hasRole(&#39;经理&#39;) or hasAuthority(&#39;user:get&#39;)&quot;) // 必须具有经理的角色或有user:get的权限
&#125;
</code></pre>
<p>方法二：在对应的Handler方法上加**@PreAuthorize()注解**：</p>
<pre><code class="java">// 以json形式显示分页后的role信息
@PreAuthorize(&quot;hasRole(&#39;部长&#39;)&quot;)
@ResponseBody
@RequestMapping(&quot;/role/page/page.json&quot;)
public ResultEntity&lt;PageInfo&lt;Role&gt;&gt; getPageInfo(
        @RequestParam(value = &quot;pageNum&quot;, defaultValue = &quot;1&quot;) Integer pageNum,
        @RequestParam(value = &quot;pageSize&quot;, defaultValue = &quot;5&quot;) Integer pageSize,
        @RequestParam(value = &quot;keyword&quot;, defaultValue = &quot;&quot;) String keyword ) &#123;
    // 从Service层得到pageInfo
    PageInfo&lt;Role&gt; pageInfo = roleService.getPageInfo(pageNum, pageSize, keyword);

    // 返回ResultEntity，Data就是得到的pageInfo
    return ResultEntity.successWithData(pageInfo);
&#125;
</code></pre>
<p>&#x3D;&#x3D;注意：通过加注解的方法设置，则必须在配置类上加**@EnableGlobalMethodSecurity(prePostEnabled &#x3D; true)**注解&#x3D;&#x3D;</p>
<p><strong>hasAuthority()中放权限信息，hasRole()中放角色信息。</strong></p>
<p>而通过access方法，可以让拥有经理角色，或有user:get权限的用户访问用户分页页面。</p>
<p>此时如果在添加用户的handler方法上加注解，设置只有有user:save权限的用户可以进行新增操作：</p>
<pre><code class="java">@PreAuthorize(&quot;hasAuthority(&#39;user:save&#39;)&quot;)
@RequestMapping(&quot;/admin/page/doSave.html&quot;)
public String addAdmin(Admin admin)&#123;
    // 调用service层存储admin对象的方法
    adminService.saveAdmin(admin);

    // 重定向会原本的页面，且为了能在添加管理员后看到管理员，设置pageNum为整型的最大值（通过修正到最后一页）
    return &quot;redirect:/admin/page/page.html?pageNum=&quot;+Integer.MAX_VALUE;
&#125;
</code></pre>
<p>则roleOperator只能访问分页页面，但是不能进行用户增加操作，而adminOperator可以进行用户增加操作。</p>
<p><strong>给SpringSecurity的权限控制添加异常映射的机制</strong></p>
<p>通过exceptionHandling()方法，以及accessDeniedHandler()传入一个AccessDeniedHandler的匿名实现类：</p>
<p><strong>注意：这种方法，只对security中配置的角色、权限控制有效，在方法上加注解的方式的权限控制，异常会交给前面我们自己编写的异常控制类，因为方法上加注解，抛出异常会被异常控制类捕捉到，但是在configure方法中设置角色、权限信息，则无法被异常控制类捕捉到，需要借助exceptionHandling。</strong></p>
<pre><code class="java">@Override
protected void configure(HttpSecurity security) throws Exception &#123;
    security
        .exceptionHandling()
        .accessDeniedHandler(new AccessDeniedHandler() &#123;
            @Override
            public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException e) 
                throws IOException, ServletException &#123;
                request.setAttribute(&quot;exception&quot;, new Exception(&quot;抱歉，您没有权限访问该资源！&quot;));
                request.getRequestDispatcher(&quot;/WEB-INF/system-error.jsp&quot;).forward(request,response);
            &#125;
        &#125;);
&#125;
</code></pre>
<h4 id="页面元素的权限控制"><a href="#页面元素的权限控制" class="headerlink" title="页面元素的权限控制"></a>页面元素的权限控制</h4><p>可以对页面上的局部元素进行访问权限的控制：</p>
<p>需要在JSP页面中引入SpringSecurity的标签库</p>
<p><code>&lt;%@taglib prefix=&quot;security&quot; uri=&quot;http://www.springframework.org/security/tags&quot; %&gt;</code></p>
<p>控制如下：</p>
<p>通过<strong>security:authorize</strong>标签，access与前面的方法一样，在里面写表达式，满足角色、权限的条件则会显示给用户，如果不满足，就不会显示。</p>
<pre><code class="jsp">&lt;div class=&quot;col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main&quot;&gt;
    &lt;h1 class=&quot;page-header&quot;&gt;控制面板&lt;/h1&gt;
    &lt;div class=&quot;row placeholders&quot;&gt;
        
        &lt;security:authorize access=&quot;hasRole(&#39;经理&#39;)&quot;&gt;
            &lt;div class=&quot;col-xs-6 col-sm-3 placeholder&quot;&gt;
                &lt;img data-src=&quot;holder.js/200x200/auto/sky&quot; class=&quot;img-responsive&quot; alt=&quot;Generic placeholder thumbnail&quot;&gt;
                &lt;h4&gt;Label&lt;/h4&gt;
                &lt;span class=&quot;text-muted&quot;&gt;Something else&lt;/span&gt;
            &lt;/div&gt;
        &lt;/security:authorize&gt;
        &lt;security:authorize access=&quot;hasAuthority(&#39;role:delete&#39;)&quot;&gt;
            &lt;div class=&quot;col-xs-6 col-sm-3 placeholder&quot;&gt;
                &lt;img data-src=&quot;holder.js/200x200/auto/vine&quot; class=&quot;img-responsive&quot; alt=&quot;Generic placeholder thumbnail&quot;&gt;
                &lt;h4&gt;Label&lt;/h4&gt;
                &lt;span class=&quot;text-muted&quot;&gt;Something else&lt;/span&gt;
            &lt;/div&gt;
        &lt;/security:authorize&gt;
        
        ... ...
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h1 id="一、Spring-Cloud基本组件"><a href="#一、Spring-Cloud基本组件" class="headerlink" title="一、Spring Cloud基本组件"></a>一、Spring Cloud基本组件</h1><p>​	注册中心： Eureka<br>​	负载均衡： Ribbon<br>​	声明式调用远程方法： Feign<br>​	熔断、降级、监控： Hystrix<br>​	网关： Zuul</p>
<h2 id="原理："><a href="#原理：" class="headerlink" title="原理："></a><strong>原理：</strong></h2><p>各个微服务的提供者（provider）将各自注册入Eureka注册中心，可以指定一个模块，导入Feign的相关依赖，专门用于编写对应各个提供者的接口，通过Feign，将抽象方法与微服务的具体方法联系起来。而微服务的使用者（consumer）也注册入Eureka，并依赖前面的Feign接口模块，这样可以通过自动装配各个接口，来调用接口的方法，而这些方法就是在微服务中被实现的，并且可以直接在使用者工程中使用；</p>
<p>Ribbon提供了客户端负载均衡的功能，但是并不需要开发时主动配置，就有默认的配置。</p>
<p>Hystrix的作用则是给provider提供熔断机制（在provider中提供方法的备用方法）、给consumer提供降级功能（在consumer中给调用远程方法处增加备用方法，通常是在调用失败时，在方法中匿名实现接口，使用自己实现的接口的方法），并且提供了监控provider的功能（Hystrix Dashboard）；</p>
<p>Zuul的作用则是给外部提供一个统一的入口，如浏览器等访问时，就可以通过Zuul提供的入口，进行相对简单的访问。</p>
<h1 id="二、各服务具体配置内容"><a href="#二、各服务具体配置内容" class="headerlink" title="二、各服务具体配置内容"></a>二、各服务具体配置内容</h1><p>此处Spring Boot版本：  2.3.3RELEASE</p>
<p>​		Spring Cloud版本：Hoxton.SR8</p>
<p>在parent工程管理依赖信息</p>
<pre><code class="xml">&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;!-- 导入SpringCloud需要的依赖信息 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
            &lt;version&gt;Hoxton.SR8&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;!-- SpringBoot依赖信息 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt;
            &lt;version&gt;2.3.3.RELEASE&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;
</code></pre>
<h2 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h2><h3 id="服务端："><a href="#服务端：" class="headerlink" title="服务端："></a>服务端：</h3><p>依赖：</p>
<pre><code class="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>主启动类</p>
<pre><code class="java">@EnableEurekaServer
@SpringBootApplication
public class CrowdMainApp &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(CrowdMainApp.class, args);
    &#125;
&#125;
</code></pre>
<p>application.yml</p>
<pre><code class="yml">server:					# 服务的端口号
  port: 1000
spring:					# Spring的应用名
  application:
    name: crowd-eureka
eureka:					# Eureka的服务端设置hostname，客户端通过hostname与端口访问
  instance:
    hostname: localhost
  client:
    fetch-registry: false				# 自己就是注册中心，因此不注册自己
    register-with-eureka: false			# 自己就是注册中心，不需要从注册中心取回信息
    service-url:						# 客户端访问Eureka时，使用的地址
      defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/
</code></pre>
<h3 id="客户端："><a href="#客户端：" class="headerlink" title="客户端："></a>客户端：</h3><p>依赖</p>
<pre><code class="xml">&lt;!-- eureka客户端依赖 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>yml配置：</p>
<pre><code class="yml">server:
  port: 2000
spring:
  application:
    name: crowd-mysql		# application.name会显示在Eureka的页面
eureka:
  client:
    service-url:
      defaultZone: http://localhost:1000/eureka/
</code></pre>
<p>&#x3D;&#x3D;<strong>注意</strong>&#x3D;&#x3D;：低版本的Spring Cloud可能需要在主启动类上加@EnableEurekaClient或@EnableDiscoveryClient注解。</p>
<h2 id="Feign"><a href="#Feign" class="headerlink" title="Feign"></a>Feign</h2><p>Feign的依赖spring-cloud-starter-openfeign一般会加入到一个通用的接口模块，其他消费者项目依赖该模块，以得到这些接口，来调用接口对应的远程方法。</p>
<p>依赖</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<h3 id="统一接口"><a href="#统一接口" class="headerlink" title="统一接口"></a>统一接口</h3><p>远程调用方法的接口示例：</p>
<pre><code class="java">@FeignClient(&quot;crowd-mysql&quot;)
public interface MySQLRemoteService &#123;

    @RequestMapping(&quot;/get/member/by/login/acct/remote&quot;)
    public ResultEntity&lt;MemberPO&gt; getMemberPOByLoginAcctRemote(@RequestParam(&quot;loginacct&quot;) String loginacct);
&#125;
</code></pre>
<p><strong>@RequestMapping中的url必须与远程方法的@RequestMapping中的url相同；方法的声明也必须完全相同，其中参数前的@RequestParam、@RequestBody等，也必须保持一致</strong></p>
<h3 id="远程方法"><a href="#远程方法" class="headerlink" title="远程方法"></a>远程方法</h3><pre><code class="java">@RestController
public class MemberProviderHandler &#123;

    @Autowired
    MemberService memberService;

    @RequestMapping(&quot;/get/member/by/login/acct/remote&quot;)
    public ResultEntity&lt;MemberPO&gt; getMemberPOByLoginAcctRemote(@RequestParam(&quot;loginacct&quot;) String loginacct)&#123;
        try &#123;
            MemberPO memberPO = memberService.getMemberPOByLoginAcct(loginacct);
            return ResultEntity.successWithData(memberPO);
        &#125; catch (Exception e)&#123;
            e.printStackTrace();
            return ResultEntity.failed(e.getMessage());
        &#125;
    &#125;

&#125;
</code></pre>
<h3 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h3><p>在Consumer中想要调用接口模块中对应的远程方法，则必须在主启动类上加入@EnableFeignClients注解开启Feign客户端功能。</p>
<p>前提也需要引入前面接口项目的依赖</p>
<pre><code class="java">@EnableFeignClients
@SpringBootApplication
public class CrowdMainApp &#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(CrowdMainApp.class, args);
    &#125;
&#125;
</code></pre>
<h2 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h2><p>Hystrix提供了服务提供端的熔断功能、服务使用端的降级功能以及对提供端的监控功能。</p>
<h3 id="熔断："><a href="#熔断：" class="headerlink" title="熔断："></a>熔断：</h3><p>依赖</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>主启动类设置开启断路器功能</p>
<pre><code class="java">// 开启断路器功能
@EnableCircuitBreaker
@SpringBootApplication
public class SpringCloudStudyProviderApplication &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(SpringCloudStudyProviderApplication.class, args);
    &#125;

&#125;
</code></pre>
<p>handler层的方法中添加一个备用方法，作为熔断时的备用：</p>
<p>触发异常、长时间未响应等情况都会触发服务端熔断</p>
<pre><code class="java">@RestController
public class EmployeeHandler &#123;


    // @HystrixCommand表示出现问题时，使用fallbackMethod的属性值的方法名的方法作为备用方法
    @HystrixCommand(fallbackMethod = &quot;getEmpBackup&quot;)
    @RequestMapping(&quot;/provider/circuit/breaker/get/emp&quot;)
    public ResultEntity&lt;Employee&gt; getEmp(@RequestParam(&quot;signal&quot;) String signal) throws InterruptedException &#123;
        if (&quot;quick-bang&quot;.equals(signal)) &#123;
            throw new RuntimeException();
        &#125;
        if (&quot;slow-bang&quot;.equals(signal)) &#123;
            Thread.sleep(5000);
        &#125;
        return ResultEntity.successWithData(new Employee(99,&quot;FallBack&quot;,2888.88));
    &#125;

    // getEmp熔断时的备用方法
    public ResultEntity&lt;Employee&gt; getEmpBackup(@RequestParam(&quot;signal&quot;) String signal) &#123;
        return ResultEntity.failed(&quot;熔断生效-因为signal：&quot; + signal);
    &#125;

&#125;
</code></pre>
<h3 id="降级："><a href="#降级：" class="headerlink" title="降级："></a>降级：</h3><p>以下的对接口的设置发生在接口模块，而不是consumer模块</p>
<p>依赖</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>通过一个自己实现的FallbackFactory接口实现类，定义降级操作</p>
<pre><code class="java">// 通过实现FallbackFactory接口，给出consumer端的备用方案（降级）
// 自定义的FallbackFactory必须通过@Component加入IOC容器，
// 否则在对应接口的@FeignClient注解中通过fallbackFactory属性设置时会找不到该类
@Component
// 通过FallbackFactory的泛型指出是对谁进行降级操作
public class MyFallbackFactory implements FallbackFactory&lt;EmployeeRemoteService&gt; &#123;
    @Override
    public EmployeeRemoteService create(Throwable throwable) &#123;
        return new EmployeeRemoteService() &#123;
            // 不想进行降级操作就直接返回null
            @Override
            public Employee getEmployeeRemoteToFeign(String keyword) &#123;
                return null;
            &#125;
            // 实现的该方法，就是在原本service中该方法不可达时，备用调用的方法
            @Override
            public ResultEntity&lt;Employee&gt; getEmp(String signal) throws InterruptedException &#123;
                return ResultEntity.failed(&quot;执行降级&quot; + throwable.getMessage());
            &#125;
        &#125;;
    &#125;
&#125;
</code></pre>
<p>EmployeeService使用FallbackFactory：</p>
<pre><code class="java">// value指定eureka中的application name，fallbackFactory指定代表备用方案的FallbackFactory实现类
@FeignClient(value = &quot;fall-provider&quot; , fallbackFactory = MyFallbackFactory.class)
public interface EmployeeRemoteService &#123;

    @RequestMapping(&quot;/provider/feign/get/employee/remote&quot;)
    public Employee getEmployeeRemoteToFeign(@RequestParam(&quot;keyword&quot;) String keyword);

    @RequestMapping(&quot;/provider/circuit/breaker/get/emp&quot;)
    public ResultEntity&lt;Employee&gt; getEmp(@RequestParam(&quot;signal&quot;) String signal) throws InterruptedException;

&#125;
</code></pre>
<p>consumer模块的操作：</p>
<p>在application.yml文件中设置开启hystrix：</p>
<pre><code class="yml">feign:
  hystrix:
    enabled: true
</code></pre>
<h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><p>监控仪表盘模块：</p>
<p>依赖</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix-dashboard&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>主启动类开启仪表盘功能</p>
<pre><code class="java">@EnableHystrixDashboard
@SpringBootApplication
public class MyDashboardMainApp &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(MyDashboardMainApp.class, args);
    &#125;
&#125;
</code></pre>
<p>application.yml</p>
<pre><code class="yml">server:
  port: 8000
spring:
  application:
    name: fall-dashboard
hystrix:
  dashboard:
    proxy-stream-allow-list: localhost		# 设置允许监控的列表，不设置正确的话会在监控页面出现无法连接的提示
</code></pre>
<p>被监控的模块：</p>
<p>依赖</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>application.yml加入：</p>
<pre><code class="yml">management:
  endpoints:
    web:
      exposure:
        include: hystrix.stream
</code></pre>
<p>通过Hystrix Dashboard工程的端口访问监控首页</p>
<p>如 ： <a target="_blank" rel="noopener" href="http://localhost:8000/hystrix">http://localhost:8000/hystrix</a></p>
<p>在页面中通过<a href="http://url:port/actutor/hystrix.stream，访问对应url和port的监控页面">http://url:port/actutor/hystrix.stream，访问对应url和port的监控页面</a></p>
<h2 id="Zuul"><a href="#Zuul" class="headerlink" title="Zuul"></a>Zuul</h2><p>Zuul网关与Eureka整合，将自身注册入Eureka，并通过application-name管理其中注册的服务等，让外界可以直接通过Zuul访问各项微服务。</p>
<p>依赖</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-netflix-zuul&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>application.yml</p>
<pre><code class="yml">server:
  port: 9000
spring:
  application:
    name: fall-zuul
eureka:
  client:
    service-url:
      defaultZone: http://localhost:5000/eureka/
zuul:
  routes:
    employee:                           # 设置“/zuul-emp/”来代替微服务的名字，“employee”是自定义的，可以使用其他的名字
      serviceId: fall-feign-consumer
      path: /zuul-emp/**
  ignored-services:                     # 设置不能通过“fall-feign-consumer”（微服务的名字）来访问，只能通过包装后的path
    - fall-feign-consumer
  # ignored-services: &#39;*&#39; ：用于忽视所有微服务的名称
</code></pre>
<p>主启动类</p>
<pre><code class="java">// 启动Zuul代理功能
@EnableZuulProxy
@SpringBootApplication
public class MyZuulMainApp &#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(MyZuulMainApp.class,args);
    &#125;
&#125;
</code></pre>
<p>此时用户就可以通过：</p>
<p><code>http://localhost:9000/application-name/requestMapping的url </code>来访问</p>
<h3 id="ZuulFilter"><a href="#ZuulFilter" class="headerlink" title="ZuulFilter"></a>ZuulFilter</h3><p>Zuul中提供的一个过滤器，可以通过ZuulFilter进行登录检测等。</p>
<p>需要继承ZuulFilter，并通过@Component加入IOC容器</p>
<pre><code class="java">@Component
// 继承ZuulFilter，并放入IOC容器，通过该类可通过网关进行过滤
public class MyZuulFilter extends ZuulFilter &#123;

    Logger logger = LoggerFactory.getLogger(MyZuulFilter.class);



    @Override
    public String filterType() &#123;
        // filterType用pre返回，表示在目标微服务之前执行过滤操作
        String filterType = &quot;pre&quot;;
        return filterType;
    &#125;

    @Override
    public int filterOrder() &#123;
        return 0;
    &#125;

    /***
     *
     * @return true: 表示需要过率； false:表示直接放行
     */
    @Override
    public boolean shouldFilter() &#123;
        // 获取当前的RequestContext对象
        RequestContext context = RequestContext.getCurrentContext();

        // 通过RequestContext对象得到当前请求对象
        HttpServletRequest request = context.getRequest();

        // 判断
        String signal = request.getParameter(&quot;signal&quot;);

        // signal==&quot;hello&quot;时,进入过滤
        return &quot;hello&quot;.equals(signal);
    &#125;

    @Override
    public Object run() throws ZuulException &#123;

        logger.info(&quot;signal==hello,进入过滤！&quot;);
        System.err.println(&quot;signal==hello,进入过滤！&quot;);

        // 官方文档指出当前实现会忽略该返回值
        // 因此直接返回null即可
        return null;
    &#125;
&#125;
</code></pre>
<h1 id="前台会员系统架构"><a href="#前台会员系统架构" class="headerlink" title="前台会员系统架构"></a>前台会员系统架构</h1><h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/前台会员架构图.png"></p>
<h2 id="需要创建的工程"><a href="#需要创建的工程" class="headerlink" title="需要创建的工程"></a>需要创建的工程</h2><p>​    父工程：crowdfunding07-member-parent<br>​    注册中心：crowdfunding08-member-eureka<br>​    实体类模块：crowdfunding09-member-entity<br>​    MySQL数据服务：crowdfunding10-member-mysql-provider<br>​    Redis数据服务：crowdfunding11-member-redis-provider<br>​    会员中心：crowdfunding12-member-authentication-consumer<br>​    项目维护：crowdfunding13-member-project-consumer<br>​    订单维护：crowdfunding14-member-order-consumer<br>​    支付功能：crowdfunding15-member-pay-consumer<br>​    网关：crowdfunding16-member-zuul<br>​    API模块：crowdfunding17-member-api</p>
<p>父工程下面的工程都是父工程的子工程</p>
<h2 id="parent工程约定版本号"><a href="#parent工程约定版本号" class="headerlink" title="parent工程约定版本号"></a>parent工程约定版本号</h2><pre><code class="xml">&lt;!-- 在parent工程进行依赖管理 --&gt;
&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;!-- 导入SpringCloud需要的依赖信息 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
            &lt;version&gt;Hoxton.SR8&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;!-- SpringBoot依赖信息 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt;
            &lt;version&gt;2.3.3.RELEASE&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;!--SpringBoot整合MyBatis的依赖--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;2.1.3&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!--druid依赖信息--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;druid&lt;/artifactId&gt;
            &lt;version&gt;1.1.17&lt;/version&gt;
        &lt;/dependency&gt;

    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;
</code></pre>
<h2 id="搭建环境约定"><a href="#搭建环境约定" class="headerlink" title="搭建环境约定"></a>搭建环境约定</h2><p>包名：</p>
<p>​	所有新建的包都作为org.fall的子包</p>
<p>主启动类类名：</p>
<p>​	CrowdMainApp</p>
<p>端口号：</p>
<pre><code>    注册中心：crowdfunding08-member-eureka                  1000
    MySQL数据服务：crowdfunding10-member-mysql-provider     2000
    Redis数据服务：crowdfunding11-member-redis-provider     3000
    会员中心：crowdfunding12-member-authentication-consumer 4000
    项目维护：crowdfunding13-member-project-consumer        5000
    订单维护：crowdfunding14-member-order-consumer          7000
    支付功能：crowdfunding15-member-pay-consumer            8000
    网关：crowdfunding16-member-zuul                        80
</code></pre>
<h1 id="分布式的各个工程"><a href="#分布式的各个工程" class="headerlink" title="分布式的各个工程"></a>分布式的各个工程</h1><h2 id="1、Eureka"><a href="#1、Eureka" class="headerlink" title="1、Eureka"></a>1、Eureka</h2><p>依赖：</p>
<pre><code class="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>application.yml：</p>
<pre><code class="yml">server:
  port: 1000
spring:
  application:
    name: crowd-eureka
eureka:
  instance:
    hostname: localhost
  client:
    fetch-registry: false
    register-with-eureka: false
    service-url:
      defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/
</code></pre>
<p>主启动类：</p>
<pre><code class="java">@EnableEurekaServer
@SpringBootApplication
public class CrowdMainApp &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(CrowdMainApp.class, args);
    &#125;
&#125;
</code></pre>
<h2 id="2、Entity"><a href="#2、Entity" class="headerlink" title="2、Entity"></a>2、Entity</h2><p>为了使用lombok插件，引入lombok的依赖</p>
<pre><code class="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
        &lt;artifactId&gt;lombok&lt;/artifactId&gt;
        &lt;version&gt;1.16.12&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>项目结构：</p>
<p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/member-entity结构.png"></p>
<p>VO:</p>
<p>​	View Object  视图对象</p>
<p>​		可以用于接收浏览器发来的数据，也可以把数据发送给浏览器显示</p>
<p>PO：</p>
<p>​	Persistent Object  持久化对象</p>
<p>​		与数据库的表对应</p>
<h2 id="3、MySQL"><a href="#3、MySQL" class="headerlink" title="3、MySQL"></a>3、MySQL</h2><p>依赖</p>
<pre><code class="xml">&lt;dependencies&gt;

    &lt;!-- druid连接池 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
        &lt;artifactId&gt;druid&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;!-- MyBatis依赖 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
        &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;!-- mysql驱动 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;mysql&lt;/groupId&gt;
        &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;!-- eureka客户端依赖 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;!-- web环境（为了能对外暴露接口） --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;!-- 测试 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
        &lt;exclusions&gt;
            &lt;exclusion&gt;
                &lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;
                &lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;
            &lt;/exclusion&gt;
        &lt;/exclusions&gt;
    &lt;/dependency&gt;

    &lt;!-- 实体类依赖 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.fall&lt;/groupId&gt;
        &lt;artifactId&gt;crowdfunding09-member-entity&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;!-- 工具类依赖 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.example&lt;/groupId&gt;
        &lt;artifactId&gt;crowdfunding05-common-util&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/dependency&gt;

&lt;/dependencies&gt;
</code></pre>
<p>建数据库表</p>
<pre><code class="sql">CREATE TABLE t_member (
    id INT ( 11 ) NOT NULL auto_increment,
    login_acct VARCHAR ( 255 ) NOT NULL,
    user_pswd CHAR ( 200 ) NOT NULL,
    user_name VARCHAR ( 255 ),
    email VARCHAR ( 255 ),
    authstaus INT ( 4 ) COMMENT &#39;实名认证状态 0- 未实名认证, 1- 实名认证申请中, 2- 已实名认证&#39;,
    user_type INT ( 4 ) COMMENT &#39;0- 个人 , 1- 企业&#39;,
    real_name VARCHAR ( 255 ),
    card_num VARCHAR ( 255 ),
    acct_type INT ( 4 ) COMMENT &#39;0- 企业, 1- 个体, 2- 个人, 3- 政府&#39;,
    PRIMARY KEY ( id ) 
)
</code></pre>
<p>使用前面后台系统的逆向工程，逆向生成java代码：</p>
<p>这里设置实体类的名字为MemberPO（就是加上PO）</p>
<pre><code class="xml">&lt;!-- 数据库表名与需要的实体类对应映射的指定 --&gt;
&lt;table tableName=&quot;t_member&quot; domainObjectName=&quot;MemberPO&quot;/&gt;
</code></pre>
<p><strong>生成后注意修改接口等的包路径的信息，因为之前后台使用的包规则和前台的有区别。</strong></p>
<p>之后把生成的文件放入对应的路径</p>
<p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/mysql-member.png" alt="mapper"></p>
<p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/entity-member.png" alt="entity"></p>
<p>给主启动类加上**@MapperScan**注解用于扫描Mapper接口</p>
<pre><code class="java">@MapperScan(&quot;org.fall.mapper&quot;)
@SpringBootApplication
public class CrowdMainApp &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(CrowdMainApp.class, args);
    &#125;
&#125;
</code></pre>
<p>配置application.yml</p>
<pre><code class="yml">server:
  port: 2000
spring:
  application:
    name: crowd-mysql
  datasource:
    name: mydb
    type: com.alibaba.druid.pool.DruidDataSource
    url: jdbc:mysql://localhost:3306/project_rowd?serverTimezone=UTC
    username: root
    password: root
    driver-class-name: com.mysql.cj.jdbc.Driver
eureka:
  client:
    service-url:
      defaultZone: http://localhost:1000/eureka/
mybatis:
  mapper-locations: classpath*:/mybatis/mapper/*Mapper.xml
logging:
  level:
    org.fall.mapper: debug
    org.fall.test: debug
</code></pre>
<h3 id="MySQL对外暴露服务"><a href="#MySQL对外暴露服务" class="headerlink" title="MySQL对外暴露服务"></a>MySQL对外暴露服务</h3><p>进入到crowdfunding17-member-api工程</p>
<p>先添加依赖</p>
<pre><code class="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.example&lt;/groupId&gt;
        &lt;artifactId&gt;crowdfunding05-common-util&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.fall&lt;/groupId&gt;
        &lt;artifactId&gt;crowdfunding09-member-entity&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>在org.fall.api包中建一个接口<strong>MySQLRemoteService</strong></p>
<pre><code class="java">@FeignClient(&quot;crowd-mysql&quot;)
public interface MySQLRemoteService &#123;

    @RequestMapping(&quot;/get/member/by/login/acct/remote&quot;)
    ResultEntity&lt;MemberPO&gt; getMemberPOByLoginAcctRemote(@RequestParam(&quot;loginacct&quot;) String loginacct);
&#125;
</code></pre>
<p>与MySQL工程中的Handler中的方法对应：</p>
<pre><code class="java">@RestController
public class MemberProviderHandler &#123;

    @Autowired
    MemberService memberService;

    @RequestMapping(&quot;/get/member/by/login/acct/remote&quot;)
    public ResultEntity&lt;MemberPO&gt; getMemberPOByLoginAcctRemote(@RequestParam(&quot;loginacct&quot;) String loginacct)&#123;
        try &#123;
            MemberPO memberPO = memberService.getMemberPOByLoginAcct(loginacct);
            return ResultEntity.successWithData(memberPO);
        &#125; catch (Exception e)&#123;
            e.printStackTrace();
            return ResultEntity.failed(e.getMessage());
        &#125;
    &#125;

&#125;
</code></pre>
<p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/mysql-接口.png"></p>
<h2 id="4、Redis"><a href="#4、Redis" class="headerlink" title="4、Redis"></a>4、Redis</h2><p>依赖</p>
<pre><code class="xml">&lt;dependencies&gt;

    &lt;!-- redis依赖 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;!-- eureka客户端依赖 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;!-- web环境（为了能对外暴露接口） --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;!-- 测试 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
        &lt;exclusions&gt;
            &lt;exclusion&gt;
                &lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;
                &lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;
            &lt;/exclusion&gt;
        &lt;/exclusions&gt;
    &lt;/dependency&gt;

    &lt;!-- 实体类依赖 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.fall&lt;/groupId&gt;
        &lt;artifactId&gt;crowdfunding09-member-entity&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;!-- 工具类依赖 --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.example&lt;/groupId&gt;
        &lt;artifactId&gt;crowdfunding05-common-util&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>主启动类</p>
<pre><code class="java">@SpringBootApplication
public class CrowdMainApp &#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(CrowdMainApp.class, args);
    &#125;
&#125;
</code></pre>
<p>application.yml</p>
<pre><code class="yml">server:
  port: 3000

eureka:
  client:
    service-url:
      defaultZone: http://localhost:1000/eureka/
spring:
  application:
    name: crowd-redis
  redis:
    host: 192.168.0.102
</code></pre>
<h3 id="Redis对外暴露服务"><a href="#Redis对外暴露服务" class="headerlink" title="Redis对外暴露服务"></a>Redis对外暴露服务</h3><p>先编写自己的handler方法：</p>
<pre><code class="java">@RestController
public class RedisProviderHandler &#123;

    // 自动注入StringRedisTemplate
    @Autowired
    private StringRedisTemplate redisTemplate;

    @RequestMapping(&quot;/set/redis/key/value/remote&quot;)
    ResultEntity&lt;String&gt; setRedisKeyValueRemote(
            @RequestParam(&quot;key&quot;) String key,
            @RequestParam(&quot;value&quot;) String value
    )&#123;

        try &#123;
            ValueOperations&lt;String, String&gt; operations = redisTemplate.opsForValue();
            operations.set(key,value);
            return ResultEntity.successWithoutData();
        &#125;catch (Exception e)&#123;
            e.printStackTrace();
            return ResultEntity.failed(e.getMessage());
        &#125;

    &#125;

    @RequestMapping(&quot;/set/redis/key/value/with/timeout/remote&quot;)
    ResultEntity&lt;String&gt; setRedisKeyValueWithTimeoutRemote(
            @RequestParam(&quot;key&quot;) String key,
            @RequestParam(&quot;value&quot;) String value,
            @RequestParam(&quot;time&quot;) long time,
            @RequestParam(&quot;timeUnit&quot;) TimeUnit timeUnit
    )&#123;
        try &#123;
            ValueOperations&lt;String, String&gt; operations = redisTemplate.opsForValue();
            operations.set(key,value,time,timeUnit);
            return ResultEntity.successWithoutData();
        &#125;catch (Exception e)&#123;
            e.printStackTrace();
            return ResultEntity.failed(e.getMessage());
        &#125;

    &#125;


    @RequestMapping(&quot;/get/redis/value/by/key/remote&quot;)
    ResultEntity&lt;String&gt; getRedisValueByKeyRemote(
            @RequestParam(&quot;key&quot;) String key
    )&#123;

        try &#123;
            ValueOperations&lt;String, String&gt; operations = redisTemplate.opsForValue();
            String value = operations.get(key);
            return ResultEntity.successWithData(value);
        &#125;catch (Exception e)&#123;
            e.printStackTrace();
            return ResultEntity.failed(e.getMessage());
        &#125;


    &#125;


    @RequestMapping(&quot;/remove/redis/key/by/key/remote&quot;)
    ResultEntity&lt;String&gt; RemoveRedisKeyByKeyRemote(
            @RequestParam(&quot;key&quot;) String key
    )&#123;
        try &#123;
            redisTemplate.delete(key);
            return ResultEntity.successWithoutData();
        &#125;catch (Exception e)&#123;
            e.printStackTrace();
            return ResultEntity.failed(e.getMessage());
        &#125;

    &#125;


&#125;
</code></pre>
<p>crowdfunding17-member-api接口</p>
<pre><code class="java">@FeignClient(&quot;crowd-redis&quot;)
public interface RedisRemoteService &#123;

    @RequestMapping(&quot;/set/redis/key/value/remote&quot;)
    ResultEntity&lt;String&gt; setRedisKeyValueRemote(
            @RequestParam(&quot;key&quot;) String key,
            @RequestParam(&quot;value&quot;) String value
    );

    @RequestMapping(&quot;/set/redis/key/value/with/timeout/remote&quot;)
    ResultEntity&lt;String&gt; setRedisKeyValueWithTimeoutRemote(
            @RequestParam(&quot;key&quot;) String key,
            @RequestParam(&quot;value&quot;) String value,
            @RequestParam(&quot;time&quot;) long time,
            @RequestParam(&quot;timeUnit&quot;) TimeUnit timeUnit
            );

    @RequestMapping(&quot;/get/redis/value/by/key/remote&quot;)
    ResultEntity&lt;String&gt; getRedisValueByKeyRemote(
            @RequestParam(&quot;key&quot;) String key
    );

    @RequestMapping(&quot;/remove/redis/key/by/key/remote&quot;)
    ResultEntity&lt;String&gt; RemoveRedisKeyByKeyRemote(
            @RequestParam(&quot;key&quot;) String key
    );

&#125;
</code></pre>
<h2 id="5、认证页面工程"><a href="#5、认证页面工程" class="headerlink" title="5、认证页面工程"></a>5、认证页面工程</h2><p>依赖</p>
<pre><code class="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.fall&lt;/groupId&gt;
        &lt;artifactId&gt;crowdfunding17-member-api&lt;/artifactId&gt;
        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>主启动类</p>
<pre><code class="java">// 开启feign客户端功能
@EnableFeignClients
@SpringBootApplication
public class CrowdMainApp &#123;
    public static void main(String[] args) &#123;
        SpringApplication.run(CrowdMainApp.class, args);
    &#125;
&#125;
</code></pre>
<p>application.yml</p>
<pre><code class="yml">server:
  port: 4000
spring:
  application:
    name: crowd-auth
  thymeleaf:
    prefix: classpath:/templates/
    suffix: .html
eureka:
  client:
    service-url:
      defaultZone: http://localhost:1000/eureka/
</code></pre>
<p>加入首页页面作为测试用：</p>
<p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/前台首页.png"></p>
<p>目录结构：</p>
<p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/auth目录结构.png"></p>
<p>在PortalHandler类中添加映射：</p>
<pre><code class="java">@Controller
public class PortalHandler &#123;

    // 首页，直接访问，而不用加额外的路径
    @RequestMapping(&quot;/&quot;)
    public String showPortalPage()&#123;
        return &quot;portal&quot;;
    &#125;

&#125;
</code></pre>
<h2 id="6、Zuul网关"><a href="#6、Zuul网关" class="headerlink" title="6、Zuul网关"></a>6、Zuul网关</h2><p>依赖</p>
<pre><code class="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-netflix-zuul&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<p>主配置类：</p>
<pre><code class="java">// 开启Zuul
@EnableZuulProxy
@SpringBootApplication
public class CrowdMainApp &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(CrowdMainApp.class,args);
    &#125;

&#125;
</code></pre>
<p>application.yml</p>
<pre><code class="yml">server:
  port: 80			# 80端口可以直接通过域名/ip访问，不用额外加端口号
spring:
  application:
    name: crowd-zuul
eureka:
  client:
    service-url:
      defaultZone: http://localhost:1000/eureka/
zuul:
  ignored-services: &quot;*&quot;       # 表示忽视直接通过application-name访问微服务，必须通过route
  sensitive-headers: &quot;*&quot;      # 在Zuul向其他微服务重定向时，保持原本的头信息（请求头、响应头）
  routes:                     # 指定网关路由
    crowd-protal:
      service-id: crowd-auth  # 对应application-name
      path: /**               # 表示直接通过根路径访问，必须加上**，否则多层路径无法访问
</code></pre>
<p>到这里，基础的环境就搭建完成了，附上搭建完成的项目目录结构图：</p>
<p><img src="/images/%E5%89%8D%E5%8F%B0%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.png">会员注册</p>
<h2 id="目标-7"><a href="#目标-7" class="headerlink" title="目标"></a><strong>目标</strong></h2><p>​	实现通过手机验证码来完成会员账号的注册。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a><strong>实现</strong></h2><h3 id="1、在阿里云市场购买短信验证码"><a href="#1、在阿里云市场购买短信验证码" class="headerlink" title="1、在阿里云市场购买短信验证码"></a>1、在阿里云市场购买短信验证码</h3><p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/短信接口购买.png"></p>
<p>这里选择的版本不需要引入额外的依赖，通过JDK1.8直接可以使用</p>
<p>店铺中给出的示例代码：</p>
<pre><code class="java">package com.aliyun.test;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.net.UnknownHostException;
import java.util.List;
import java.util.Map;

public class Tools &#123;
    public static void main(String[] args) &#123;
        String host = &quot;http://smsmsgs.market.alicloudapi.com&quot;;  // 【1】请求地址 支持http 和 https 及 WEBSOCKET
        String path = &quot;/smsmsgs&quot;; // 【2】后缀
        String appcode = &quot;你自己的AppCode&quot;; // 【3】开通服务后 买家中心-查看AppCode
        String param = &quot;123456&quot;;  // 【4】请求参数，详见文档描述
        String phone = &quot;18030939917&quot;;  //  【4】请求参数，详见文档描述
        String sign = &quot;175622&quot;;   //  【4】请求参数，详见文档描述
        String skin = &quot;1&quot;;  //  【4】请求参数，详见文档描述
        String urlSend = host + path + &quot;?param=&quot; + param +&quot;&amp;phone=&quot;+phone +&quot;&amp;sign=&quot;+sign +&quot;&amp;skin=&quot;+skin;  // 【5】拼接请求链接
        try &#123;
            URL url = new URL(urlSend);
            HttpURLConnection httpURLCon = (HttpURLConnection) url.openConnection();
            httpURLCon.setRequestProperty(&quot;Authorization&quot;, &quot;APPCODE &quot; + appcode);// 格式Authorization:APPCODE (中间是英文空格)
            int httpCode = httpURLCon.getResponseCode();
            if (httpCode == 200) &#123;
                String json = read(httpURLCon.getInputStream());
                System.out.println(&quot;正常请求计费(其他均不计费)&quot;);
                System.out.println(&quot;获取返回的json:&quot;);
                System.out.print(json);
            &#125; else &#123;
                Map&lt;String, List&lt;String&gt;&gt; map = httpURLCon.getHeaderFields();
                String error = map.get(&quot;X-Ca-Error-Message&quot;).get(0);
                if (httpCode == 400 &amp;&amp; error.equals(&quot;Invalid AppCode `not exists`&quot;)) &#123;
                    System.out.println(&quot;AppCode错误 &quot;);
                &#125; else if (httpCode == 400 &amp;&amp; error.equals(&quot;Invalid Url&quot;)) &#123;
                    System.out.println(&quot;请求的 Method、Path 或者环境错误&quot;);
                &#125; else if (httpCode == 400 &amp;&amp; error.equals(&quot;Invalid Param Location&quot;)) &#123;
                    System.out.println(&quot;参数错误&quot;);
                &#125; else if (httpCode == 403 &amp;&amp; error.equals(&quot;Unauthorized&quot;)) &#123;
                    System.out.println(&quot;服务未被授权（或URL和Path不正确）&quot;);
                &#125; else if (httpCode == 403 &amp;&amp; error.equals(&quot;Quota Exhausted&quot;)) &#123;
                    System.out.println(&quot;套餐包次数用完 &quot;);
                &#125; else &#123;
                    System.out.println(&quot;参数名错误 或 其他错误&quot;);
                    System.out.println(error);
                &#125;
            &#125;

        &#125; catch (MalformedURLException e) &#123;
            System.out.println(&quot;URL格式错误&quot;);
        &#125; catch (UnknownHostException e) &#123;
            System.out.println(&quot;URL地址错误&quot;);
        &#125; catch (Exception e) &#123;
            // 打开注释查看详细报错异常信息
            // e.printStackTrace();
        &#125;

    &#125;

    /*
     * 读取返回结果
     */
    private static String read(InputStream is) throws IOException &#123;
        StringBuffer sb = new StringBuffer();
        BufferedReader br = new BufferedReader(new InputStreamReader(is));
        String line = null;
        while ((line = br.readLine()) != null) &#123;
            line = new String(line.getBytes(), &quot;utf-8&quot;);
            sb.append(line);
        &#125;
        br.close();
        return sb.toString();
    &#125;
&#125;
</code></pre>
<h3 id="2、将该API在项目中使用"><a href="#2、将该API在项目中使用" class="headerlink" title="2、将该API在项目中使用"></a>2、将该API在项目中使用</h3><p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/MemberHandler.png"></p>
<p>前端点击“发送验证码”按钮：</p>
<pre><code class="html">&lt;!-- 给手机号的输入框加name=phoneNum --&gt;
&lt;div class=&quot;form-group has-success has-feedback&quot;&gt;
    &lt;input type=&quot;text&quot; name=&quot;phoneNum&quot; class=&quot;form-control&quot; id=&quot;inputSuccess4&quot; placeholder=&quot;请输入手机号&quot; style=&quot;margin-top:10px;&quot;&gt;
    &lt;span class=&quot;glyphicon glyphicon glyphicon-earphone form-control-feedback&quot;&gt;&lt;/span&gt;
&lt;/div&gt;

&lt;!-- 按钮加上id=sendBtn --&gt;
&lt;button type=&quot;button&quot; id=&quot;sendBtn&quot; class=&quot;btn btn-lg btn-success btn-block&quot;&gt; 获取验证码&lt;/button&gt;

&lt;!-- sendBtn的单击响应函数 --&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
        $(function () &#123;
            $(&quot;#sendBtn&quot;).click(function () &#123;
                // 获取name=phoneNum的val
                var phoneNum = $.trim($(&quot;[name=phoneNum]&quot;).val());
                $.ajax(&#123;
                    url: &quot;/auth/member/send/short/message.json&quot;,
                    type: &quot;post&quot;,
                    data: &#123;
                        &quot;phoneNum&quot;:phoneNum
                    &#125;,
                    dataType: &quot;json&quot;,
                    success: function (response) &#123;
                        var result = response.result;
                        if (result == &quot;SUCCESS&quot;)&#123;
                            layer.msg(&quot;发送成功！&quot;);
                        &#125; else &#123;
                            layer.msg(&quot;发送失败 请重试！&quot;);
                        &#125;
                    &#125;,
                    error: function (response) &#123;
                        layer.msg(response.status + &quot; &quot; + response.statusText);
                    &#125;
                &#125;);
            &#125;);
        &#125;);
&lt;/script&gt;
</code></pre>
<p>发送验证码的方法：</p>
<p>通过工具方法，调用api发送验证码，并将发送成功后返回的验证码放入redis域中，方便验证时取用</p>
<pre><code class="java">@Autowired
RedisRemoteService redisRemoteService;

// 自动注入对象，对象的属性从application.yml文件中获取
@Autowired
ShortMessageProperties shortMessageProperties;

// 发送验证码
@ResponseBody
@RequestMapping(&quot;/auth/member/send/short/message.json&quot;)
// 从前端获取手机号
public ResultEntity&lt;String&gt; sendShortMessage(@RequestParam(&quot;phoneNum&quot;) String phoneNum)&#123;

    // 调用工具类中的发送验证码的方法，可以从配置文件中读取配置的接口信息
    ResultEntity&lt;String&gt; sendResultEntity = CrowdUtil.sendCodeByShortMessage(
            // 通过一个properties类+application.yml的配置，装配API需要的参数
            shortMessageProperties.getHost(),
            shortMessageProperties.getPath(),
            shortMessageProperties.getAppCode(),
            phoneNum,
            shortMessageProperties.getSign(),
            shortMessageProperties.getSkin());

    // 判断-发送成功
    if (ResultEntity.SUCCESS.equals(sendResultEntity.getResult()))&#123;

        // 得到ResultEntity中的验证码
        String code = sendResultEntity.getData();

        // 将验证码存入到redis中（验证码会过期，因此需要设置TTL，这里设置为5分钟）
        ResultEntity&lt;String&gt; redisResultEntity = redisRemoteService.setRedisKeyValueWithTimeoutRemote(
                CrowdConstant.REDIS_CODE_PREFIX + phoneNum, code, 5, TimeUnit.MINUTES);

        // 判断存入redis是否成功
        if (ResultEntity.SUCCESS.equals(redisResultEntity.getResult()))&#123;
            // 存入成功，返回成功
            return ResultEntity.successWithoutData();
        &#125; else &#123;
            // 存入失败，返回redis返回的ResultEntity
            return redisResultEntity;
        &#125;
    &#125; else &#123;
        // 发送验证码失败，返回发送验证码的ResultEntity
        return sendResultEntity;
    &#125;
&#125;
</code></pre>
<p>工具方法**sendCodeByShortMessage(…)**：</p>
<pre><code class="java">/**
 *
 * @param host  请求的地址
 * @param path  请求的后缀
 * @param appCode   购入的api的appCode
 * @param phoneNum  发送验证码的目的号码
 * @param sign      签名编号
 * @param skin      模板编号
 * @return          发送成功则返回发送的验证码，放在ResultEntity中，失败则返回失败的ResultEntity
 */
public static ResultEntity&lt;String&gt; sendCodeByShortMessage(
        String host,
        String path,
        String appCode,
        String phoneNum,
        String sign,
        String skin
)&#123;
    // 生成验证码
    StringBuilder builder = new StringBuilder();
    for (int i = 0; i &lt; 4; i++)&#123;
        int random = (int)(Math.random()*10);
        builder.append(random);
    &#125;
    String param = builder.toString();  
    String urlSend = host + path + &quot;?param=&quot; + param + &quot;&amp;phone=&quot; + phoneNum + &quot;&amp;sign=&quot; + sign + &quot;&amp;skin=&quot; + skin;  
    try &#123;
        URL url = new URL(urlSend);
        HttpURLConnection httpURLCon = (HttpURLConnection) url.openConnection();
        httpURLCon.setRequestProperty(&quot;Authorization&quot;, &quot;APPCODE &quot; + appCode);// 格式Authorization:APPCODE (中间是英文空格)
        int httpCode = httpURLCon.getResponseCode();
        if (httpCode == 200) &#123;
            String json = read(httpURLCon.getInputStream());
            System.out.println(&quot;正常请求计费(其他均不计费)&quot;);
            System.out.println(&quot;获取返回的json:&quot;);
            System.out.print(json);
            return ResultEntity.successWithData(param);
        &#125; else &#123;
            Map&lt;String, List&lt;String&gt;&gt; map = httpURLCon.getHeaderFields();
            String error = map.get(&quot;X-Ca-Error-Message&quot;).get(0);
            if (httpCode == 400 &amp;&amp; error.equals(&quot;Invalid AppCode `not exists`&quot;)) &#123;
                return ResultEntity.failed(&quot;AppCode错误 &quot;);
            &#125; else if (httpCode == 400 &amp;&amp; error.equals(&quot;Invalid Url&quot;)) &#123;
                return ResultEntity.failed(&quot;请求的 Method、Path 或者环境错误&quot;);
            &#125; else if (httpCode == 400 &amp;&amp; error.equals(&quot;Invalid Param Location&quot;)) &#123;
                return ResultEntity.failed(&quot;参数错误&quot;);
            &#125; else if (httpCode == 403 &amp;&amp; error.equals(&quot;Unauthorized&quot;)) &#123;
                return ResultEntity.failed(&quot;服务未被授权（或URL和Path不正确）&quot;);
            &#125; else if (httpCode == 403 &amp;&amp; error.equals(&quot;Quota Exhausted&quot;)) &#123;
                return ResultEntity.failed(&quot;套餐包次数用完 &quot;);
            &#125; else &#123;
                return ResultEntity.failed(&quot;参数名错误 或 其他错误&quot; + error);
            &#125;
        &#125;

    &#125; catch (MalformedURLException e) &#123;
        return ResultEntity.failed(&quot;URL格式错误&quot;);
    &#125; catch (UnknownHostException e) &#123;
        return ResultEntity.failed(&quot;URL地址错误&quot;);
    &#125; catch (Exception e) &#123;
         e.printStackTrace();
        return ResultEntity.failed(&quot;套餐包次数用完 &quot;);
    &#125;
&#125;


/*
 * 读取返回结果
 */
private static String read(InputStream is) throws IOException &#123;
    StringBuilder sb = new StringBuilder();
    BufferedReader br = new BufferedReader(new InputStreamReader(is));
    String line = null;
    while ((line = br.readLine()) != null) &#123;
        line = new String(line.getBytes(), StandardCharsets.UTF_8);
        sb.append(line);
    &#125;
    br.close();
    return sb.toString();
&#125;
</code></pre>
<p>ShortMessageProperties：</p>
<pre><code class="java">@AllArgsConstructor
@NoArgsConstructor
@Data
// 加入ioc容器
@Component
// 给类设置在配置文件中设置时的前缀为“short.message”
@ConfigurationProperties(prefix = &quot;short.message&quot;)
public class ShortMessageProperties &#123;
    private String host;
    private String path;
    private String appCode;
    private String sign;
    private String skin;
&#125;
</code></pre>
<p>在application.yml中配置：</p>
<pre><code class="yml">short:
  message:
    host: http://smsmsgs.market.alicloudapi.com
    path: /smsmsgs
    appCode: d0c8d0bf07cec8ac09bec086f0a8  # 这里就是购买得到的appCode
    sign: 1
    skin: 2
</code></pre>
<p><strong>注意</strong>：想要使用application.yml&#x2F;properties文件来配置类，需要加入依赖：</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>验证码获取完成后，进行注册操作：</p>
<p>前端的表单，添加action、method，给所有input标签设置对应的name，并且添加一个p标签，用于显示注册出错时的信息：</p>
<pre><code class="html">&lt;form action=&quot;/auth/member/do/register.html&quot;  method=&quot;post&quot; class=&quot;form-signin&quot; role=&quot;form&quot;&gt;
    &lt;h2 class=&quot;form-signin-heading&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-log-in&quot;&gt;&lt;/i&gt; 用户注册&lt;/h2&gt;
    &lt;p th:text=&quot;$&#123;message&#125;&quot;&gt;&lt;/p&gt;
    &lt;div class=&quot;form-group has-success has-feedback&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;loginAcct&quot; class=&quot;form-control&quot; id=&quot;inputSuccess4&quot; placeholder=&quot;请输入登录账号&quot; autofocus&gt;
        &lt;span class=&quot;glyphicon glyphicon-user form-control-feedback&quot;&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class=&quot;form-group has-success has-feedback&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;userPswd&quot; class=&quot;form-control&quot; id=&quot;inputSuccess4&quot; placeholder=&quot;请输入登录密码&quot; style=&quot;margin-top:10px;&quot;&gt;
        &lt;span class=&quot;glyphicon glyphicon-lock form-control-feedback&quot;&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class=&quot;form-group has-success has-feedback&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;userName&quot; class=&quot;form-control&quot; id=&quot;inputSuccess4&quot; placeholder=&quot;请输入用户昵称&quot; style=&quot;margin-top:10px;&quot;&gt;
        &lt;span class=&quot;glyphicon glyphicon-lock form-control-feedback&quot;&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class=&quot;form-group has-success has-feedback&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;email&quot; class=&quot;form-control&quot; id=&quot;inputSuccess4&quot; placeholder=&quot;请输入邮箱地址&quot; style=&quot;margin-top:10px;&quot;&gt;
        &lt;span class=&quot;glyphicon glyphicon glyphicon-envelope form-control-feedback&quot;&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class=&quot;form-group has-success has-feedback&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;phoneNum&quot; class=&quot;form-control&quot; id=&quot;inputSuccess4&quot; placeholder=&quot;请输入手机号&quot; style=&quot;margin-top:10px;&quot;&gt;
        &lt;span class=&quot;glyphicon glyphicon glyphicon-earphone form-control-feedback&quot;&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class=&quot;form-group has-success has-feedback&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;code&quot; class=&quot;form-control&quot; id=&quot;inputSuccess4&quot; placeholder=&quot;请输入验证码&quot; style=&quot;margin-top:10px;&quot;&gt;
        &lt;span class=&quot;glyphicon glyphicon glyphicon-comment form-control-feedback&quot;&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;button type=&quot;button&quot; id=&quot;sendBtn&quot; class=&quot;btn btn-lg btn-success btn-block&quot;&gt; 获取验证码&lt;/button&gt;
    &lt;button type=&quot;submit&quot; class=&quot;btn btn-lg btn-success btn-block&quot;&gt;注册&lt;/button&gt;
&lt;/form&gt;
</code></pre>
<p>编写后端的方法：</p>
<pre><code class="java">@Autowired
private RedisRemoteService redisRemoteService;

@Autowired
private MySQLRemoteService mySQLRemoteService;
// 进行用户注册操作
@RequestMapping(&quot;/auth/member/do/register.html&quot;)
public String doMemberRegister(MemberVO memberVO, ModelMap modelMap)&#123;
    // 获取手机号
    String phoneNum = memberVO.getPhoneNum();

    // 拼接为redis存放的key
    String key = CrowdConstant.REDIS_CODE_PREFIX + phoneNum;

    // 通过key寻找value（验证码）
    ResultEntity&lt;String&gt; resultEntity = redisRemoteService.getRedisValueByKeyRemote(key);

    String result = resultEntity.getResult();

    // 判断获取redis中的验证码是否成功
    if (ResultEntity.FAILED.equals(result))&#123;
        // 失败，返回主页页面
        modelMap.addAttribute(CrowdConstant.ATTR_NAME_MESSAGE, resultEntity.getMessage());
        return &quot;member-reg&quot;;
    &#125;

    // 获取redis中的验证码的值
    String redisCode = resultEntity.getData();
    if (redisCode == null)&#123;
        modelMap.addAttribute(CrowdConstant.ATTR_NAME_MESSAGE,CrowdConstant.MESSAGE_CODE_NOT_EXIST);
        return &quot;member-reg&quot;;
    &#125;

    // 获取表单提交的验证码
    String formCode = memberVO.getCode();

    // 如果redis中的验证码与表单提交的验证码不同
    if (!Objects.equals(formCode,redisCode))&#123;
        // request域存入不匹配的message
        modelMap.addAttribute(CrowdConstant.ATTR_NAME_MESSAGE,CrowdConstant.MESSAGE_CODE_INVALID);
        // 返回注册页面
        return &quot;member-reg&quot;;
    &#125;

    // 验证码比对一致，删除redis中的验证码数据
    redisRemoteService.removeRedisKeyByKeyRemote(key);

    // 进行注册操作

    // 1、加密
    BCryptPasswordEncoder bCryptPasswordEncoder = new BCryptPasswordEncoder();
    String formPwd = memberVO.getUserPswd();
    String encode = bCryptPasswordEncoder.encode(formPwd);

    // 2、将加密后的密码放入MemberVO对象
    memberVO.setUserPswd(encode);

    // 3、执行保存
    MemberPO memberPO = new MemberPO();
    BeanUtils.copyProperties(memberVO,memberPO);
    ResultEntity&lt;String&gt; saveResultEntity = mySQLRemoteService.saveMemberRemote(memberPO);

    // 4、判断保存是否成功
    String saveResult = saveResultEntity.getResult();
    if (ResultEntity.FAILED.equals(saveResult))&#123;
        // 保存失败，则返回保存操作的ResultEntity中的message，存入request域的message
        modelMap.addAttribute(CrowdConstant.ATTR_NAME_MESSAGE, saveResultEntity.getMessage());
        // 回到注册页面
        return &quot;member-reg&quot;;
    &#125;

    // 全部判断成功，跳转到登录页面
    return &quot;redirect:http://localhost/auth/to/member/login/page.html&quot;;
&#125;
</code></pre>
<p><strong>&#x3D;&#x3D;远程方法调用记得保持API模块中的方法名和@RequestMapping中的参数 与 MySQL模块中的保持一致，后面不再特意提及&#x3D;&#x3D;</strong></p>
<p>crowdfunding17-member-api：</p>
<pre><code class="java">@FeignClient(&quot;crowd-mysql&quot;)
public interface MySQLRemoteService &#123;

    @RequestMapping(&quot;/get/member/by/login/acct/remote&quot;)
    ResultEntity&lt;MemberPO&gt; getMemberPOByLoginAcctRemote(@RequestParam(&quot;loginacct&quot;) String loginacct);

    @RequestMapping(&quot;/save/member/remote&quot;)
    ResultEntity&lt;String&gt; saveMemberRemote(@RequestBody MemberPO memberPO);
&#125;
</code></pre>
<p>crowdfunding10-member-mysql-provider：</p>
<pre><code class="java">@RestController
public class MemberProviderHandler &#123;

    @Autowired
    MemberService memberService;

    @RequestMapping(&quot;/get/member/by/login/acct/remote&quot;)
    public ResultEntity&lt;MemberPO&gt; getMemberPOByLoginAcctRemote(@RequestParam(&quot;loginacct&quot;) String loginacct)&#123;
        try &#123;
            MemberPO memberPO = memberService.getMemberPOByLoginAcct(loginacct);
            return ResultEntity.successWithData(memberPO);
        &#125; catch (Exception e)&#123;
            e.printStackTrace();
            return ResultEntity.failed(e.getMessage());
        &#125;
    &#125;

    @RequestMapping(&quot;/save/member/remote&quot;)
    public ResultEntity&lt;String&gt; saveMemberRemote(@RequestBody MemberPO memberPO)&#123;
        try &#123;
            memberService.saveMember(memberPO);
            return ResultEntity.successWithoutData();
        &#125; catch (Exception e)&#123;
            if (e instanceof DuplicateKeyException)&#123;
                return ResultEntity.failed(CrowdConstant.MESSAGE_SYSTEM_ERROR_LOGIN_NOT_UNIQUE);
            &#125;
            return ResultEntity.failed(e.getMessage());
        &#125;
    &#125;
&#125;
</code></pre>
<p>测试时发现第一次注册时会发生错误，这是因为第一次注册时，连接redis等时间长，让ribbon以为超时而报错，在application.yml中配置：</p>
<pre><code class="yml"># 由于项目刚启动第一次进行redis操作时会比较慢，可能被ribbon认为是超时报错，因此通过下面的配置延长ribbon超时的时间
ribbon:
  ReadTimeout: 10000
  ConnectTimeout: 10000
</code></pre>
<p>注册功能实现完成。</p>
<h1 id="会员登录"><a href="#会员登录" class="headerlink" title="会员登录"></a>会员登录</h1><h2 id="初始的登录操作"><a href="#初始的登录操作" class="headerlink" title="初始的登录操作"></a>初始的登录操作</h2><p>前端登录页面的表单：</p>
<pre><code class="html">&lt;form action=&quot;/auth/do/member/login.html&quot; method=&quot;post&quot; class=&quot;form-signin&quot; role=&quot;form&quot;&gt;
    &lt;h2 class=&quot;form-signin-heading&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-log-in&quot;&gt;&lt;/i&gt; 用户登录&lt;/h2&gt;
    &lt;p th:text=&quot;$&#123;message&#125;&quot;&gt;登陆失败时显示的提示&lt;/p&gt;
    &lt;p th:text=&quot;$&#123;session.message&#125;&quot;&gt;未登录时访问受限现实的提示&lt;/p&gt;
    &lt;div class=&quot;form-group has-success has-feedback&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;loginAcct&quot; class=&quot;form-control&quot; id=&quot;inputSuccess4&quot; placeholder=&quot;请输入登录账号&quot; autofocus&gt;
        &lt;span class=&quot;glyphicon glyphicon-user form-control-feedback&quot;&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class=&quot;form-group has-success has-feedback&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;loginPswd&quot; class=&quot;form-control&quot; id=&quot;inputSuccess4&quot; placeholder=&quot;请输入登录密码&quot; style=&quot;margin-top:10px;&quot;&gt;
        &lt;span class=&quot;glyphicon glyphicon-lock form-control-feedback&quot;&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class=&quot;checkbox&quot; style=&quot;text-align:right;&quot;&gt;&lt;a href=&quot;reg.html&quot; th:href=&quot;@&#123;/auth/to/member/reg/page.html&#125;&quot;&gt;我要注册&lt;/a&gt;&lt;/div&gt;
    &lt;button type=&quot;submit&quot; class=&quot;btn btn-lg btn-success btn-block&quot; href=&quot;member.html&quot; &gt; 登录&lt;/button&gt;
&lt;/form&gt;
</code></pre>
<p>注：下面的代码在这里必须有(thymeleaf的名称空间、base标签给出url的必须地址)</p>
<p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/thymeleaf页面头部.png"></p>
<p>登录操作的handler方法：</p>
<pre><code class="java">// 登录操作
@RequestMapping(&quot;/auth/do/member/login.html&quot;)
public String doMemberLogin(
        @RequestParam(&quot;loginAcct&quot;) String loginAcct,
        @RequestParam(&quot;loginPswd&quot;) String loginPswd,
        ModelMap modelMap,
        HttpSession session) &#123;

    // 远程方法调用，通过loinAcct，得到数据库中的对应Member
    ResultEntity&lt;MemberPO&gt; resultEntity = mySQLRemoteService.getMemberPOByLoginAcctRemote(loginAcct);

    // 判断-查询操作是否成功
    if (ResultEntity.FAILED.equals(resultEntity.getResult()))&#123;
        // 查询失败，返回登陆页面
        modelMap.addAttribute(CrowdConstant.ATTR_NAME_MESSAGE, resultEntity.getMessage());
        return &quot;member-login&quot;;
    &#125;

    // 查询操作成功，则取出MemberPO对象
    MemberPO memberPO = resultEntity.getData();

    // 判断得到的MemberPO是否为空
    if (memberPO == null)&#123;
        // 为空则返回登陆页面
        modelMap.addAttribute(CrowdConstant.ATTR_NAME_MESSAGE, CrowdConstant.MESSAGE_LOGIN_FAILED);
        return &quot;member-login&quot;;
    &#125;

    // 返回的MemberPO非空，取出数据库中的密码（已经加密的）
    String userPswd = memberPO.getUserPswd();

    // 使用BCryptPasswordEncoder，比对表单的密码与数据库中的密码是否匹配
    BCryptPasswordEncoder passwordEncoder = new BCryptPasswordEncoder();
    boolean matches = passwordEncoder.matches(loginPswd, userPswd);

    // 判断-密码不同
    if (!matches)&#123;
        // 返回登陆页面，存入相应的提示信息
        modelMap.addAttribute(CrowdConstant.ATTR_NAME_MESSAGE, CrowdConstant.MESSAGE_LOGIN_FAILED);
        return &quot;member-login&quot;;
    &#125;

    // 密码匹配，则通过一个LoginMemberVO对象，存入需要在session域通信的用户信息（这样只在session域放一些相对不私秘的信息，保护用户隐私）
    LoginMemberVO loginMember = new LoginMemberVO(memberPO.getId(), memberPO.getUserName(), memberPO.getEmail());

    // 将LoginMemberVO对象存入session域(因为session会放入redis，因此LoginMemberVO必须实现序列化)
    session.setAttribute(CrowdConstant.ATTR_NAME_LOGIN_MEMBER,loginMember);

    // 重定向到登陆成功后的主页面
    return &quot;redirect:http://localhost/auth/to/member/center/page.html&quot;;
&#125;
</code></pre>
<p><strong>&#x3D;&#x3D;因为session会放入redis，因此LoginMemberVO必须实现序列化&#x3D;&#x3D;</strong></p>
<p>跳转入登录成功后的页面：</p>
<p><strong>member-center.html</strong></p>
<p>主要有在前端显示登录后的用户昵称（从session域取出，通过 “<strong>[[${}]]</strong>“ ）：</p>
<p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/登录成功页面显示member1.png"></p>
<p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/登录成功页面显示member2.png"></p>
<h2 id="退出登陆"><a href="#退出登陆" class="headerlink" title="退出登陆"></a>退出登陆</h2><pre><code class="html">&lt;li&gt;
    &lt;a href=&quot;index.html&quot; th:href=&quot;@&#123;/auth/do/member/logout.html&#125;&quot;&gt;
        &lt;i class=&quot;glyphicon glyphicon-off&quot;&gt;&lt;/i&gt; 退出系统
    &lt;/a&gt;
&lt;/li&gt;
</code></pre>
<p>后端：</p>
<pre><code class="java">// 退出登录
@RequestMapping(&quot;/auth/do/member/logout.html&quot;)
public String doLogout(HttpSession session)&#123;
    // 清除session域数据
    session.invalidate();

    // 重定向到首页
    return &quot;redirect:http://localhost/&quot;;
&#125;
</code></pre>
<h2 id="Session共享"><a href="#Session共享" class="headerlink" title="Session共享"></a>Session共享</h2><p>在分布式和集群的环境下，每一个模块运行在各自的单独的Tomcat服务器上，而Session被不同的Tomcat隔离，因此无法互通，导致程序运行时会发生数据不互通的情况。</p>
<p>针对这个问题，这边采用后端统一存储Session数据的方法——将Session数据存入到Redis中（这样速度比MySQL更快）</p>
<p>Spring也提供了此工具：<strong>spring-session</strong></p>
<p>spring-session的依赖：</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.session&lt;/groupId&gt;
    &lt;artifactId&gt;spring-session-data-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>同时因为使用redis存储session，也需要引入redis的依赖</p>
<pre><code class="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>此处先给crowdfunding12-member-authentication-consumer与crowdfunding16-member-zuul模块加上了spring-session的相关依赖。</p>
<p>在<strong>两处的application.yml文件</strong>中都配置：</p>
<pre><code class="yml">spring:
  # 设置redis服务器的ip
  redis:
    host: 192.168.0.101
  # 设置spring-session的存储方式为存入redis中
  session:
    store-type: redis
</code></pre>
<p>此时两个微服务之间的session可以进行互通了。</p>
<h2 id="登录验证操作"><a href="#登录验证操作" class="headerlink" title="登录验证操作"></a>登录验证操作</h2><p>先在util工程中设置好不被过滤器过滤的内容：</p>
<p>org.fall.util:</p>
<pre><code class="java">public class AccessPassResources &#123;

    // 保存不被过滤的请求
    public static final Set&lt;String&gt; PASS_RES_SET = new HashSet&lt;&gt;();

    // 静态代码块中加入不被过滤的内容
    static &#123;
        PASS_RES_SET.add(&quot;/&quot;);
        PASS_RES_SET.add(&quot;/auth/to/member/reg/page.html&quot;);
        PASS_RES_SET.add(&quot;/auth/to/member/login/page.html&quot;);
        PASS_RES_SET.add(&quot;/auth/member/send/short/message.json&quot;);
        PASS_RES_SET.add(&quot;/auth/member/do/register.html&quot;);
        PASS_RES_SET.add(&quot;/auth/do/member/login.html&quot;);
        PASS_RES_SET.add(&quot;/auth/do/member/logout.html&quot;);
        PASS_RES_SET.add(&quot;/error&quot;);
        PASS_RES_SET.add(&quot;/favicon.ico&quot;);
    &#125;

    // 保存不被过滤的静态资源
    public static final Set&lt;String&gt; STATIC_RES_SET = new HashSet&lt;&gt;();
    
    // 静态代码块中加入不被过滤的内容
    static &#123;
        STATIC_RES_SET.add(&quot;bootstrap&quot;);
        STATIC_RES_SET.add(&quot;css&quot;);
        STATIC_RES_SET.add(&quot;fonts&quot;);
        STATIC_RES_SET.add(&quot;img&quot;);
        STATIC_RES_SET.add(&quot;jquery&quot;);
        STATIC_RES_SET.add(&quot;layer&quot;);
        STATIC_RES_SET.add(&quot;script&quot;);
        STATIC_RES_SET.add(&quot;ztree&quot;);
    &#125;

    /**
     * @param servletPath 当前请求的路径  就是localhost:8080/aaa/bbb/ccc中的 “aaa/bbb/ccc”
     * @return true: 表示该资源是静态资源; false: 表示该资源不是静态资源
     */
    public static boolean judgeIsStaticResource(String servletPath)&#123;

        // 先判断字符串是否为空
        if (servletPath == null || servletPath.length() == 0)&#123;
            throw new RuntimeException(CrowdConstant.MESSAGE_STRING_INVALIDATE);
        &#125;

        // 通过“/”来分割得到的请求路径
        String[] split = servletPath.split(&quot;/&quot;);

        // split[0]是一个空字符串，因此取split[1]，相当于/aaa/bbb/ccc的“aaa”
        String path = split[1];

        // 判断是否包含得到的请求的第一个部分
        return STATIC_RES_SET.contains(path);
    &#125;


&#125;
</code></pre>
<p>在这里登录验证操作交给ZuulFilter的子类来完成：</p>
<p>Zuul模块的org.fall.filter包下：</p>
<pre><code class="java">// 加入ioc容器
@Component
public class CrowdAccessFilter extends ZuulFilter &#123;
    
    // return &quot;pre&quot; 表示在请求发生其前进行过滤
    @Override
    public String filterType() &#123;
        return &quot;pre&quot;;
    &#125;

    @Override
    public int filterOrder() &#123;
        return 0;
    &#125;

    /**
     *
     * @return true:表示被拦截; false: 表示放行
     */
    @Override
    public boolean shouldFilter() &#123;

        // 通过getCurrentContext得到当前的RequestContext
        RequestContext requestContext = RequestContext.getCurrentContext();

        // 通过RequestContext得到HttpServletRequest
        HttpServletRequest request = requestContext.getRequest();

        // 获得当前请求的路径
        String servletPath = request.getServletPath();

        // 判断当前请求路径是否包含在不被过滤的请求的set集合中
        boolean isPassContains = AccessPassResources.PASS_RES_SET.contains(servletPath);

        // 如果包含在set中，返回false，表示不被过滤
        if (isPassContains)&#123;
            return false;
        &#125;

        // 判断是否是静态资源
        boolean isStaticResource = AccessPassResources.judgeIsStaticResource(servletPath);

        // 是静态资源则工具方法返回true，因为应该放行，所以取反，返回false
        return !isStaticResource;
    &#125;

    @Override
    public Object run() throws ZuulException &#123;

        // 通过getCurrentContext得到当前的RequestContext
        RequestContext requestContext = RequestContext.getCurrentContext();

        // 通过RequestContext得到HttpServletRequest
        HttpServletRequest request = requestContext.getRequest();

        // 得到session
        HttpSession session = request.getSession();

        // 从session中得到“loginMember”
        Object loginMember = session.getAttribute(CrowdConstant.ATTR_NAME_LOGIN_MEMBER);

        // 判断得到的loginMember是否为空
        if (loginMember == null)&#123;
            // 为空 取得response，为了后面进行重定向
            HttpServletResponse response = requestContext.getResponse();

            // 向session域中存放&quot;message&quot;:&quot;还未登录，禁止访问受保护资源！&quot;,为了在重定向后能够在前台显示错误信息
            session.setAttribute(CrowdConstant.ATTR_NAME_MESSAGE, CrowdConstant.MESSAGE_ACCESS_FORBIDDEN);
            
            try &#123;
                // 重定向到登录页面
                response.sendRedirect(&quot;/auth/to/member/login/page.html&quot;);
            &#125; catch (IOException e) &#123;
                e.printStackTrace();
            &#125;
        &#125;

        // 返回null就是不操作
        return null;
    &#125;
&#125;
</code></pre>
<p>这里Zuul模块中的application.yml一定要设置 *<em>sensitive-headers: “</em>“**，保持原有的头信息，否则重定向后重新创建了request、response对象，就无法携带session的信息了 ：</p>
<pre><code class="yml">zuul:
  ignored-services: &quot;*&quot;       # 表示忽视直接通过application-name访问微服务，必须通过route
  sensitive-headers: &quot;*&quot;      # 在Zuul向其他微服务重定向时，保持原本的头信息（请求头、响应头）
  routes:                     # 指定网关路由
    crowd-protal:
      service-id: crowd-auth  # 对应application-name
      path: /**               # 表示直接通过根路径访问，必须加上**，否则多层路径无法访问
</code></pre>
<h2 id="分布式项目中重定向问题"><a href="#分布式项目中重定向问题" class="headerlink" title="分布式项目中重定向问题"></a>分布式项目中重定向问题</h2><p>在两个不同的网站，浏览器工作时不会使用相同的cookie，也就使不同微服务之间无法很好地同步数据。因此分布式项目中重定向时，需要带上前缀：这里使用Zuul，且端口号为80，因此可以看到上面crowdfunding12-member-authentication-consumer模块的代码中的重定向都是转发到localhost上，类似：</p>
<pre><code class="java"> return &quot;redirect:http://localhost/xxx/xxx&quot;;
</code></pre>
<h2 id="ClassNotFound异常处理"><a href="#ClassNotFound异常处理" class="headerlink" title="ClassNotFound异常处理"></a>ClassNotFound异常处理</h2><p>Zuul必须引入crowdfunding09-member-entity的依赖，否则会出现反序列化LoginMemberVO对象时ClassNotFounding的异常</p>
<h2 id="从个人中心跳转到发起项目的页面："><a href="#从个人中心跳转到发起项目的页面：" class="headerlink" title="从个人中心跳转到发起项目的页面："></a>从个人中心跳转到发起项目的页面：</h2><pre><code class="html">&lt;div class=&quot;list-group-item &quot; style=&quot;cursor:pointer;&quot;&gt;
    &lt;a th:href=&quot;@&#123;/auth/to/member/crowd/page.html&#125;&quot; style=&quot;text-decoration: none&quot;&gt;我的众筹&lt;/a&gt;
    &lt;span class=&quot;badge&quot;&gt;&lt;i class=&quot;glyphicon glyphicon-chevron-right&quot;&gt;&lt;/i&gt;&lt;/span&gt;
&lt;/div&gt;
</code></pre>
<p>通过view-controller跳转到member-crowd.html页面。</p>
<p>完善跳转的代码、以及对登录用户昵称的显示，这里都和member-center.html页面类似</p>
<h1 id="登录与注册功能的view-controller"><a href="#登录与注册功能的view-controller" class="headerlink" title="登录与注册功能的view-controller"></a>登录与注册功能的view-controller</h1><p>因为这部分比较少，因此抽取出来放在一起；Spring Boot不再使用原本的Spring配置文件，而是改用配置类，而想要在MVC中设置view-controller，需要通过实现WebMvcConfigurer接口，通过其中的addViewControllers方法：</p>
<pre><code class="java">@Configuration
public class CrowdWebMvcConfig implements WebMvcConfigurer &#123;


    @Override
    public void addViewControllers(ViewControllerRegistry registry) &#123;
        // 前端请求的url地址
        String urlPath = &quot;/auth/to/member/reg/page.html&quot;;

        // 实际后端跳转页面（会自动拼上前后缀）
        String viewName = &quot;member-reg&quot;;

        // 前往用户注册页面
        registry.addViewController(urlPath).setViewName(viewName);

        // 前往登录页面
        registry.addViewController(&quot;/auth/to/member/login/page.html&quot;).setViewName(&quot;member-login&quot;);

        // 前往登录完成后的用户主页面
        registry.addViewController(&quot;/auth/to/member/center/page.html&quot;).setViewName(&quot;member-center&quot;);
        
        // 前往“我的众筹”页面
        registry.addViewController(&quot;/auth/to/member/crowd/page.html&quot;).setViewName(&quot;member-crowd&quot;);
    &#125;
&#125;# 一、“发起项目” 建模

## 1、创建数据库表

```sql
# 分类表
CREATE TABLE t_type (
    id INT ( 11 ) NOT NULL auto_increment,
    name VARCHAR ( 255 ) COMMENT &#39;分类名称&#39;,
    remark VARCHAR ( 255 ) COMMENT &#39;分类介绍&#39;,
    PRIMARY KEY ( id ) 
);

# 项目分类中间表
create table t_project_type (
    id	int not null auto_increment,
    projectid	int(11),
    typeid	int(11),
    primary key (id)
);

# 标签表
create table t_tag
(	
    id	int(11) not null auto_increment,
    pid	int(11),
    name	varchar(255),
    primary key (id)
);

# 项目标签中间表
create table t_project_tag
(
    id	int(11) not null auto_increment,
    projectid	int(11),
    tagid	int(11),
    primary key (id)	
);	

# 项目表
create table t_project	
(	
    id	int(11) not null auto_increment,
    project_name	varchar(255) comment &#39;项目名称&#39;,
    project_description	varchar(255) comment &#39;项目描述&#39;,
    money	bigint (11) comment &#39;筹集金额&#39;,
    day	int(11) comment &#39;筹集天数&#39;,
    status	int(4) comment &#39;0-即将开始，1-众筹中，2-众筹成功，3-众筹失败&#39;,	
    deploydate	varchar(10) comment &#39;项目发起时间&#39;,
    supportmoney	bigint(11) comment &#39;已筹集到的金额&#39;,
    supporter	int(11) comment &#39;支持人数&#39;,
    completion	int(3) comment &#39;百分比完成度&#39;,
    memberid	int(11) comment &#39;发起人的会员 id&#39;,
    createdate	varchar(19) comment &#39;项目创建时间&#39;,
    follower	int(11) comment &#39;关注人数&#39;,
    header_picture_path	varchar(255) comment &#39;头图路径&#39;,
    primary key (id)	
);	

# 项目表项目详情图片表中间表
create table t_project_item_pic
(
    id	int(11) not null auto_increment,
    projectid	int(11),
    item_pic_path	varchar(255),
    primary key (id)
);

# 项目发起人信息表
create table t_member_launch_info
(		
    id	int(11) not null auto_increment,
    memberid	int(11)	comment &#39;会员 id&#39;,
    description_simple   varchar(255)   comment &#39;简单介绍&#39;,
    description_detail   varchar(255)   comment &#39;详细介绍&#39;,
    phone_num	varchar(255)   comment &#39;联系电话&#39;,
    service_num	varchar(255)	comment &#39;客服电话&#39;,
    primary key (id)		
);		

# 回报信息表
create table t_return		
(		
    id	int(11) not null auto_increment,
    projectid	int(11),	
    type	int(4) comment &#39;0 - 实物回报， 1 虚拟物品回报&#39;,
    supportmoney	int(11) comment &#39;支持金额&#39;,
    content	varchar(255) comment &#39;回报内容&#39;,
    count	int(11) comment &#39;回报产品限额，“0”为不限回报数量&#39;,
    signalpurchase	int(11) comment &#39;是否设置单笔限购&#39;,
    purchase	int(11) comment &#39;具体限购数量&#39;,
    freight	int(11) comment &#39;运费，“0”为包邮&#39;,
    invoice	int(4) comment &#39;0 - 不开发票， 1 - 开发票&#39;,
    returndate	int(11) comment &#39;项目结束后多少天向支持者发送回报&#39;,
    describ_pic_path	varchar(255) comment &#39;说明图片路径&#39;,
    primary key (id)		
);		

# 发起人确认信息表
create table t_member_confirm_info	
(		
    id	int(11) not null auto_increment,
    memberid	int(11) comment &#39;会员 id&#39;,
    paynum	varchar(200) comment &#39;易付宝企业账号&#39;,
    cardnum	varchar(200) comment &#39;法人身份证号&#39;,
    primary key (id)		
);		
```

## 2、逆向工程

![逆向工程配置文件](images/逆向工程.png)

```xml
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE generatorConfiguration
        PUBLIC &quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;&gt;

&lt;generatorConfiguration&gt;
    &lt;context id=&quot;atguiguTables&quot; targetRuntime=&quot;MyBatis3&quot;&gt;
        &lt;commentGenerator&gt;
            &lt;!-- 是否去除自动生成的注释 true：是 ： false:否 --&gt;
            &lt;property name=&quot;suppressAllComments&quot; value=&quot;true&quot; /&gt;
        &lt;/commentGenerator&gt;

        &lt;!-- 数据库链接URL、用户名、密码 --&gt;
        &lt;jdbcConnection
                driverClass=&quot;com.mysql.cj.jdbc.Driver&quot;
                connectionURL=&quot;jdbc:mysql://localhost:3306/project_rowd?serverTimezone=UTC&quot;
                userId=&quot;root&quot;
                password=&quot;root&quot;&gt;
        &lt;/jdbcConnection&gt;

        &lt;!--
        默认false，把JDBC DECIMAL 和 NUMERIC 类型解析为 Integer
            true，把JDBC DECIMAL 和 NUMERIC 类型解析为java.math.BigDecimal
        --&gt;
        &lt;javaTypeResolver&gt;
            &lt;property name=&quot;forceBigDecimals&quot; value=&quot;false&quot; /&gt;
        &lt;/javaTypeResolver&gt;

        &lt;!--
        生成model模型，对应的包路径，以及文件存放路径(targetProject)，targetProject可以指定具体的路径,如./src/main/java，
        也可以使用“MAVEN”来自动生成，这样生成的代码会在target/generatord-source目录下
        --&gt;
        &lt;!--&lt;javaModelGenerator targetPackage=&quot;com.joey.mybaties.test.pojo&quot; targetProject=&quot;MAVEN&quot;&gt;--&gt;
        &lt;javaModelGenerator targetPackage=&quot;org.fall.entity.po&quot; targetProject=&quot;.\src\main\java&quot;&gt;
            &lt;!--是否让schema作为包的后缀--&gt;
            &lt;property name=&quot;enableSubPackages&quot; value=&quot;false&quot;/&gt;
            &lt;!-- 从数据库返回的值被清理前后的空格  --&gt;
            &lt;property name=&quot;trimStrings&quot; value=&quot;true&quot; /&gt;
        &lt;/javaModelGenerator&gt;

        &lt;!--对应的mapper.xml文件  --&gt;
        &lt;sqlMapGenerator targetPackage=&quot;mapper&quot; targetProject=&quot;.\src\main\java&quot;&gt;
            &lt;!--是否让schema作为包的后缀--&gt;
            &lt;property name=&quot;enableSubPackages&quot; value=&quot;false&quot;/&gt;
        &lt;/sqlMapGenerator&gt;

        &lt;!-- 对应的Mapper接口类文件 --&gt;
        &lt;javaClientGenerator type=&quot;XMLMAPPER&quot; targetPackage=&quot;org.fall.mapper&quot; targetProject=&quot;.\src\main\java&quot;&gt;
            &lt;!--是否让schema作为包的后缀--&gt;
            &lt;property name=&quot;enableSubPackages&quot; value=&quot;false&quot;/&gt;
        &lt;/javaClientGenerator&gt;


        &lt;!-- 数据库表名与需要的实体类对应映射的指定 --&gt;
        &lt;table tableName=&quot;t_type&quot; domainObjectName=&quot;TypePO&quot; /&gt;
        &lt;table tableName=&quot;t_tag&quot; domainObjectName=&quot;TagPO&quot; /&gt;
        &lt;table tableName=&quot;t_project&quot; domainObjectName=&quot;ProjectPO&quot; /&gt;
        &lt;table tableName=&quot;t_project_item_pic&quot; domainObjectName=&quot;ProjectItemPicPO&quot; /&gt;
        &lt;table tableName=&quot;t_member_launch_info&quot; domainObjectName=&quot;MemberLaunchInfoPO&quot; /&gt;
        &lt;table tableName=&quot;t_return&quot; domainObjectName=&quot;ReturnPO&quot; /&gt;
        &lt;table tableName=&quot;t_member_confirm_info&quot; domainObjectName=&quot;MemberConfirmInfoPO&quot; /&gt;

    &lt;/context&gt;
&lt;/generatorConfiguration&gt;
```

通过MAVEN工具生成实体类、mapper接口即mapper文件，并放入对应的各个目录。

## 3、创建与浏览器对应的VO对象

![发起项目-vo对象](images/发起项目-vo对象.png)

详细内容见代码，与浏览器发来的数据相对应。



# 二、“发起项目”功能实现

**总目标：**把各个前端表单的数据汇总到一起，并存入各个数据库表中。

**思路：**

![发起项目-思路](images/发起项目-思路.png)



项目部分的页面与代码主要在**crowdfunding13-member-project-consumer**模块完成



## 项目发起部分

### 1、跳转到众筹页面

**Zuul模块**的配置文件application.yml中增加project模块的访问路径

```yml
zuul:
  ignored-services: &quot;*&quot;       # 表示忽视直接通过application-name访问微服务，必须通过route
  sensitive-headers: &quot;*&quot;      # 在Zuul向其他微服务重定向时，保持原本的头信息（请求头、响应头）
  routes:                     # 指定网关路由
    crowd-protal:
      service-id: crowd-auth  # 对应application-name
      path: /**               # 表示直接通过根路径访问，必须加上**，否则多层路径无法访问
    crowd-project:
      service-id: crowd-project
      path: /project/**
```

**project模块**的配置文件先进行基础的配置：

```yml
server:
  port: 5000
spring:
  application:
    name: crowd-project
  thymeleaf:
    prefix: classpath:/templates/
    suffix: .html
  redis:
    host: 192.168.0.101
  session:
    store-type: redis
eureka:
  client:
    service-url:
      defaultZone: http://localhost:1000/eureka/
```

给 **我的众筹 **-&gt; **发起众筹**按钮绑定单击响应函数，以跳转到发起众筹的页面

```html
&lt;li class=&quot; pull-right&quot;&gt;
    &lt;button type=&quot;button&quot; class=&quot;btn btn-warning&quot; 			    onclick=&quot;window.location.href=&#39;http://localhost/project/agree/protocol/page.html&#39;&quot;&gt;
        发起众筹
    &lt;/button&gt;
&lt;/li&gt;
```

在project模块的CrowdWebMvcConfig类中，配置view-controller

```java
@Configuration
public class CrowdWebMvcConfig implements WebMvcConfigurer &#123;
    @Override
    public void addViewControllers(ViewControllerRegistry registry) &#123;
        registry.addViewController(&quot;/do/crowd/launch/page.html&quot;).setViewName(&quot;project-launch&quot;);
        registry.addViewController(&quot;/agree/protocol/page.html&quot;).setViewName(&quot;project-agree&quot;);
        registry.addViewController(&quot;/return/info/page.html&quot;).setViewName(&quot;project-return&quot;);
        registry.addViewController(&quot;/create/confirm/page.html&quot;).setViewName(&quot;project-confirm&quot;);
        registry.addViewController(&quot;/create/success.html&quot;).setViewName(&quot;project-success&quot;);
    &#125;
&#125;
```

点击发起众筹后，进入协议同意的页面，给同意按钮绑定下一个页面（项目及发起人信息 页面）的url

```html
&lt;div class=&quot;panel-footer&quot; style=&quot;text-align:center;&quot;&gt;
    &lt;a class=&quot;btn btn-warning btn-lg&quot; href=&quot;project/launch/project/page&quot; th:href=&quot;@&#123;http://localhost/project/do/crowd/launch/page.html&#125;&quot;&gt;阅读并同意协议&lt;/a&gt;
&lt;/div&gt;
```



### 2、处理项目及发起人信息页面

![](images/发起项目-项目及发起人信息.png)



**表单的action：**

```html
&lt;form id=&quot;projectForm&quot; th:action=&quot;@&#123;/project/create/project/information&#125;&quot; method=&quot;post&quot; 
      enctype=&quot;multipart/form-data&quot; class=&quot;form-horizontal&quot;&gt;
```

通过下一步按钮，绑定单击响应函数，进行表单的提交操作



**后端handler方法：**

```java
// 自动注入OSSProperties
@Autowired
private OSSProperties ossProperties;

/**
 * 进行创建项目操作，成功后进入回报页面
 * @param projectVO  前端表单的数据自动装入ProjectVO对象
 * @param headerPicture 前端上传的头图
 * @param detailPictureList 前端上传的详情图片的list
 * @param session 用于存放信息
 * @param modelMap 用于发生错误时传递信息
 * @return 进入下一步的页面
 * @throws IOException
 */
@RequestMapping(&quot;/create/project/information&quot;)
public String createProject(
        ProjectVO projectVO,
        MultipartFile headerPicture,
        List&lt;MultipartFile&gt; detailPictureList,
        HttpSession session,
        ModelMap modelMap ) throws IOException &#123;

    // 一、完成头图的上传
    // 判断headerPicture对象是否为空
    boolean headerPictureEmpty = headerPicture.isEmpty();

    if (headerPictureEmpty)&#123;
        // 头图为空，存入提示信息，且返回原本的页面
        modelMap.addAttribute(CrowdConstant.ATTR_NAME_MESSAGE, CrowdConstant.MESSAGE_HEADER_PIC_EMPTY);
        return &quot;project-launch&quot;;
    &#125;
    // 头图不为空 进行上传操作
    ResultEntity&lt;String&gt; headerPictureResultEntity = CrowdUtil.uploadFileToOSS(ossProperties.getEndPoint(),
            ossProperties.getAccessKeyId(),
            ossProperties.getAccessKeySecret(),
            headerPicture.getInputStream(),
            ossProperties.getBucketName(),
            ossProperties.getBucketDomain(),
            headerPicture.getOriginalFilename());
    // 判断是否上传成功
    String result = headerPictureResultEntity.getResult();
    if (ResultEntity.FAILED.equals(result))&#123;
        // 上传失败
        modelMap.addAttribute(CrowdConstant.ATTR_NAME_MESSAGE, CrowdConstant.MESSAGE_HEADER_PIC_UPLOAD_FAILED);
        return &quot;project-launch&quot;;
    &#125; else &#123;
        // 上传成功
        // 得到存入OSS服务器的文件名
        String headerPicturePath = headerPictureResultEntity.getData();

        // 存入ProjectVO对象
        projectVO.setHeaderPicturePath(headerPicturePath);
    &#125;

    // 二、完成详情图片的上传

    // 创建用于存放详情图片的路径的List对象
    List&lt;String&gt; detailPicturePathList = new ArrayList&lt;&gt;();

    // 判断详情图片是否为空
    if (detailPictureList == null || detailPictureList.size() == 0)&#123;
        // 详情图片为空，加入提示信息，返回原本页面
        modelMap.addAttribute(CrowdConstant.ATTR_NAME_MESSAGE, CrowdConstant.MESSAGE_DETAIL_PIC_EMPTY);
        return &quot;project-launch&quot;;
    &#125;
    // 详情图片不为空 遍历List
    for (MultipartFile detailPicture : detailPictureList) &#123;
        // 判断当前MultipartFile是否有效
        if (detailPicture.isEmpty())&#123;
            // 当前图片为空，也返回原本的页面
            modelMap.addAttribute(CrowdConstant.ATTR_NAME_MESSAGE, CrowdConstant.MESSAGE_DETAIL_PIC_EMPTY);
            return &quot;project-launch&quot;;
        &#125;
        // 不为空，开始存放详情图片
        ResultEntity&lt;String&gt; detailPictureResultEntity = CrowdUtil.uploadFileToOSS(ossProperties.getEndPoint(),
                ossProperties.getAccessKeyId(),
                ossProperties.getAccessKeySecret(),
                detailPicture.getInputStream(),
                ossProperties.getBucketName(),
                ossProperties.getBucketDomain(),
                detailPicture.getOriginalFilename());
        // 检查上传的结果
        String detailPictureResult = detailPictureResultEntity.getResult();
        if (ResultEntity.FAILED.equals(detailPictureResult))&#123;
            // 上传失败
            modelMap.addAttribute(CrowdConstant.ATTR_NAME_MESSAGE, CrowdConstant.MESSAGE_DETAIL_PIC_UPLOAD_FAILED);
            return &quot;project-launch&quot;;
        &#125;
        // 上传成功
        // 将当前上传后的路径放入list
        detailPicturePathList.add(detailPictureResultEntity.getData());
    &#125;

    // 将detailPicturePathList存入ProjectVO对象
    projectVO.setDetailPicturePathList(detailPicturePathList);

    // 后续操作
    // 将ProjectVO对象放入session域
    session.setAttribute(CrowdConstant.ATTR_NAME_TEMPLE_PROJECT, projectVO);

    // 进入下一个收集回报信息的页面
    return &quot;redirect:http://localhost/project/return/info/page.html&quot;;
&#125;
```

上面方法中使用的**CrowdUtil.uploadFileToOSS(ossProperties**方法：

在CrowdUtil模块中需要引入OSS的依赖

```xml
&lt;dependency&gt;
    &lt;groupId&gt;com.aliyun.oss&lt;/groupId&gt;
    &lt;artifactId&gt;aliyun-sdk-oss&lt;/artifactId&gt;
    &lt;version&gt;3.5.0&lt;/version&gt;
&lt;/dependency&gt;
```

```java
public static ResultEntity&lt;String&gt; uploadFileToOSS(
        String endPoint,
        String accessKeyId,
        String accessKeySecret,
        InputStream inputStream,
        String bucketName,
        String bucketDomain,
        String originalName )&#123;

    // 创建OSSClient实例
    OSS ossClient = new OSSClientBuilder().build(endPoint,accessKeyId,accessKeySecret);

    // 生成上传文件的目录，按照日期来划分目录
    String folderName = new SimpleDateFormat(&quot;yyyyMMdd&quot;).format(new Date());

    // 生成上传文件在OSS服务器上保存的文件名,通过uuid生成随机uuid，将其中的“-”删去（替换成空字符串）
    String fileMainName = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;);

    // 从原始文件名中获取文件扩展名
    String extensionName = originalName.substring(originalName.lastIndexOf(&quot;.&quot;));

    // 使用目录、文件主体名称、文件扩展名拼接得到对象名称
    String objectName = folderName + &quot;/&quot; + fileMainName + extensionName;


    try &#123;
        // 调用OSS客户端对象的方法上传文件并获取响应结果数据
        PutObjectResult putObjectResult = ossClient.putObject(bucketName,objectName,inputStream);

        // 从响应结果中获取具体的响应消息
        ResponseMessage responseMessage = putObjectResult.getResponse();

        // 根据响应状态判断是否成功
        if (responseMessage == null) &#123;
            // 拼接访问刚刚上传的文件的路径
            String ossFileAccessPath = bucketDomain + &quot;/&quot; + objectName;

            // 返回成功，并带上访问路径
            return ResultEntity.successWithData(ossFileAccessPath);
        &#125;else &#123;
            // 获取响应状态码
            int statusCode = responseMessage.getStatusCode();
            
            // 没有成功 获取错误消息
            String errorMessage = responseMessage.getErrorResponseAsString();

            return ResultEntity.failed(&quot;当前响应状态码=&quot; + statusCode + &quot; 错误消息=&quot; + errorMessage);
        &#125;
    &#125; catch (Exception e)&#123;
        e.printStackTrace();
        return ResultEntity.failed(e.getMessage());
    &#125; finally &#123;
        // 最后关闭OSSClient
        ossClient.shutdown();
    &#125;
    
&#125;
```

通过自动注入的 ossProperties给上面的工具方法传入参数

参数放在application.yml中

```yml
aliyun:
  oss:
    access-key-id: LTAI4G9FJwmy9GEHLWziB
    access-key-secret: tNUUkzf3pPEWmlYmuKSaW7skl4
    bucket-domain: http://fall2020.oss-cn-hangzhou.aliyuncs.com
    bucket-name: fall2020
    end-point: oss-cn-hangzhou.aliyuncs.com
```





## 收集回报信息部分



![](images/发起项目-回报页面.png)



### 1、“上传图片”按钮

按钮的标签：

```html
&lt;button type=&quot;button&quot; id=&quot;uploadBtn&quot;
        class=&quot;btn btn-primary btn-lg active&quot;&gt;上传图片
&lt;/button&gt;
```

对应的单击响应函数：

```javascript
    // 在文件上传框的值改变事件响应函数中预览并上传图片
    $(&quot;[name=returnPicture]&quot;).change(function (event) &#123;

        var file = event.target.files[0];

        var url = window.url || window.webkitURL;

        var path = url.createObjectURL(file);

        $(this).next().next().next().next().attr(&quot;src&quot;, path).show();

        // 将上传的文件封装到FormData对象中
        var formData = new FormData();

        formData.append(&quot;returnPicture&quot;, file);

        // 发送Ajax请求上传文件
        $.ajax(&#123;
            &quot;url&quot;: &quot;[[@&#123;/project/create/upload/return/picture.json&#125;]]&quot;,
            &quot;type&quot;: &quot;post&quot;,
            &quot;data&quot;: formData,
            &quot;contentType&quot;: false,
            &quot;processData&quot;: false,
            &quot;dataType&quot;: &quot;json&quot;,
            &quot;success&quot;: function (response) &#123;

                var result = response.result;

                if (result == &quot;SUCCESS&quot;) &#123;
                    alert(&quot;上传成功！&quot;);

                    // 如果上传成功，则从响应体数据中获取图片的访问路径
                    returnObj.describPicPath = response.data;
                &#125;

                if (result == &quot;FAILED&quot;) &#123;
                    alert(response.message);
                &#125;

            &#125;,
            &quot;error&quot;: function (response) &#123;
                alert(response.status + &quot; &quot; + response.statusText);
            &#125;
        &#125;);

    &#125;);
```

后端handler方法：

```java
// 回报页面上传图片时触发的ajax请求对应的handler方法
@ResponseBody
@RequestMapping(&quot;/create/upload/return/picture.json&quot;)
public ResultEntity&lt;String&gt; uploadReturnPicture(@RequestParam(&quot;returnPicture&quot;) MultipartFile returnPicture) throws IOException &#123;
    // 判断是否是有效上传
    boolean pictureIsEmpty = returnPicture.isEmpty();
    if (pictureIsEmpty)&#123;
        // 如果上传文件为空
        ResultEntity.failed(CrowdConstant.MESSAGE_RETURN_PIC_EMPTY);
    &#125;

    // 进行上传到OSS服务器的操作
    ResultEntity&lt;String&gt; returnPictureResultEntity = CrowdUtil.uploadFileToOSS(ossProperties.getEndPoint(),
            ossProperties.getAccessKeyId(),
            ossProperties.getAccessKeySecret(),
            returnPicture.getInputStream(),
            ossProperties.getBucketName(),
            ossProperties.getBucketDomain(),
            returnPicture.getOriginalFilename());
    
    // 返回上传结果
    return returnPictureResultEntity;
&#125;
```



### 2、“确定”按钮

按钮的标签：

```html
&lt;button type=&quot;button&quot; class=&quot;btn btn-primary&quot; id=&quot;okBtn&quot;&gt;确定&lt;/button&gt;
```

对应的单击响应函数：

```javascript
// 点击确定按钮，绑定单击响应函数
$(&quot;#okBtn&quot;).click(function () &#123;

    // 1.收集表单数据
    returnObj.type = $(&quot;[name=type]:checked&quot;).val();
    returnObj.supportmoney = $(&quot;[name=supportmoney]&quot;).val();
    returnObj.content = $(&quot;[name=content]&quot;).val();
    returnObj.count = $(&quot;[name=count]&quot;).val();
    returnObj.signalpurchase = $(&quot;[name=signalpurchase]:checked&quot;).val();
    returnObj.purchase = $(&quot;[name=purchase]&quot;).val();
    returnObj.freight = $(&quot;[name=freight]&quot;).val();
    returnObj.invoice = $(&quot;[name=invoice]:checked&quot;).val();
    returnObj.returndate = $(&quot;[name=returndate]&quot;).val();

    // 2.发送Ajax请求
    $.ajax(&#123;
        &quot;url&quot;: &quot;[[@&#123;/project/create/save/return.json&#125;]]&quot;,
        &quot;type&quot;: &quot;post&quot;,
        &quot;dataType&quot;: &quot;json&quot;,
        &quot;data&quot;: returnObj,
        &quot;success&quot;: function (response) &#123;
            var result = response.result;
            if (result == &quot;SUCCESS&quot;) &#123;
                alert(&quot;这一条保存成功！&quot;);

                // 使用returnObj填充表格
                var orderTd = &quot;&lt;td&gt;&quot; + (++order) + &quot;&lt;/td&gt;&quot;;
                var supportmoneyTd = &quot;&lt;td&gt;&quot; + returnObj.supportmoney + &quot;&lt;/td&gt;&quot;;
                var countTd = &quot;&lt;td&gt;&quot; + returnObj.count + &quot;&lt;/td&gt;&quot;;
                var signalpurchaseTd = &quot;&lt;td&gt;&quot; + (returnObj.signalpurchase == 0 ? &quot;不限购&quot; : (&quot;限购&quot; + returnObj.purchase)) + &quot;&lt;/td&gt;&quot;;
                var contentTd = &quot;&lt;td&gt;&quot; + returnObj.content + &quot;&lt;/td&gt;&quot;;
                var returndateTd = &quot;&lt;td&gt;&quot; + returnObj.returndate + &quot;天以后返还&lt;/td&gt;&quot;;
                var freightTd = &quot;&lt;td&gt;&quot; + (returnObj.freight == 0 ? &quot;包邮&quot; : returnObj.freight) + &quot;&lt;/td&gt;&quot;;
                var operationTd = &quot;&lt;td&gt;&lt;button type=&#39;button&#39; class=&#39;btn btn-primary btn-xs&#39;&gt;&lt;i class=&#39; glyphicon glyphicon-pencil&#39;&gt;&lt;/i&gt;&lt;/button&gt;&amp;nbsp;&lt;button type=&#39;button&#39; class=&#39;btn btn-danger btn-xs&#39;&gt;&lt;i class=&#39; glyphicon glyphicon-remove&#39;&gt;&lt;/i&gt;&lt;/button&gt;&lt;/td&gt;&quot;;
                var trHTML = &quot;&lt;tr&gt;&quot; + orderTd + supportmoneyTd + countTd + signalpurchaseTd + contentTd + returndateTd + freightTd + operationTd + &quot;&lt;/tr&gt;&quot;;

                $(&quot;#returnTableBody&quot;).append(trHTML);

                $(&quot;#returnPictureImage&quot;).hide();
            &#125;

            if (result == &quot;FAILED&quot;) &#123;
                alert(&quot;这一条保存失败！&quot;);
            &#125;

            // 后续操作
            // 仅仅调用click()函数而不传入回调函数表示点击一下这个按钮
            $(&quot;#resetBtn&quot;).click();

            // 将表单部分div隐藏
            $(&quot;.returnFormDiv&quot;).hide();
        &#125;
    &#125;);
&#125;);
```

对应的后端handler方法：

```java
// 回报页面保存回报信息的ajax请求对应的方法
@ResponseBody
@RequestMapping(&quot;/create/save/return.json&quot;)
public ResultEntity&lt;String&gt; saveReturn(ReturnVO returnVO, HttpSession session) &#123;
    try &#123;
        // 从session域取出ProjectVO对象
        ProjectVO projectVO = (ProjectVO)session.getAttribute(CrowdConstant.ATTR_NAME_TEMPLE_PROJECT);

        // 判断ProjectVO是否回null
        if (projectVO == null)&#123;
            return ResultEntity.failed(CrowdConstant.MESSAGE_TEMPLE_PROJECT_MISSING);
        &#125;

        // ProjectVO不为null
        // 取出projectVO中的returnVOList
        List&lt;ReturnVO&gt; returnVOList = projectVO.getReturnVOList();

        // 判断取出的list是否为空或长度为0
        if (returnVOList == null || returnVOList.size() == 0)&#123;
            // 初始化returnVOList
            returnVOList = new ArrayList&lt;&gt;();
            // 存入projectVO
            projectVO.setReturnVOList(returnVOList);
        &#125;
        // 向returnVOList中存放当前接收的returnVO
        returnVOList.add(returnVO);

        // 重新将ProjectVO存入session域
        session.setAttribute(CrowdConstant.ATTR_NAME_TEMPLE_PROJECT,projectVO);

        // 全部操作正常完成，返回成功的ResultEntity
        return ResultEntity.successWithoutData();

    &#125; catch (Exception e)&#123;
        e.printStackTrace();
        // 出现异常返回failed，带上异常信息
        return ResultEntity.failed(e.getMessage());
    &#125;
&#125;
```



### 3、“下一步”按钮

```html
&lt;a th:href=&quot;@&#123;/project/create/confirm/page.html&#125;&quot; class=&quot;btn btn-warning btn-lg&quot;&gt;下一步&lt;/a&gt;
```

通过view-controller跳转到手机确认信息的页面



## 收集确认信息部分

### 1、前端页面

```html
&lt;form id=&quot;confirmForm&quot; th:action=&quot;@&#123;/project/create/confirm.html&#125;&quot; method=&quot;post&quot; role=&quot;form&quot;&gt;
    &lt;div class=&quot;form-group&quot;&gt;
         &lt;label for=&quot;exampleInputEmail1&quot;&gt;易付宝企业账号：&lt;/label&gt;&lt;input type=&quot;email&quot; name=&quot;paynum&quot; class=&quot;form-control&quot; 
                                                                id=&quot;exampleInputEmail1&quot; /&gt;
    &lt;/div&gt;
    &lt;div class=&quot;form-group&quot;&gt;
         &lt;label for=&quot;exampleInputPassword1&quot;&gt;法人身份证号：&lt;/label&gt;&lt;input type=&quot;password&quot; name=&quot;cardnum&quot; class=&quot;form-control&quot; 
                                                                  id=&quot;exampleInputPassword1&quot; /&gt;
    &lt;/div&gt;
&lt;/form&gt;
... ...
&lt;script type=&quot;text/javascript&quot;&gt;
    $(function()&#123;
        $(&quot;#submitBtn&quot;).click(function()&#123;
            $(&quot;#confirmForm&quot;).submit();
        &#125;);
    &#125;);
&lt;/script&gt;
&lt;button type=&quot;button&quot; id=&quot;submitBtn&quot; class=&quot;btn  btn-warning btn-lg&quot;&gt;提交&lt;/button&gt;
```

### 2、后端页面



```java
@RequestMapping(&quot;/create/confirm.html&quot;)
public String saveConfirm(MemberConfirmInfoVO memberConfirmInfoVO,HttpSession session, ModelMap modelMap)&#123;
    // 从session域取出ProjectVO对象
    ProjectVO projectVO = (ProjectVO)session.getAttribute(CrowdConstant.ATTR_NAME_TEMPLE_PROJECT);

    // 判断ProjectVO是否回null
    if (projectVO == null)&#123;
        // 这里不多做处理了，就直接抛出异常
        throw new RuntimeException(CrowdConstant.MESSAGE_TEMPLE_PROJECT_MISSING);
    &#125;

    // ProjectVO正常，开始向其中存放MemberConfirmInfo
    projectVO.setMemberConfirmInfoVO(memberConfirmInfoVO);

    // 从session域中读取当前登录的用户
    LoginMemberVO loginMember = (LoginMemberVO)session.getAttribute(CrowdConstant.ATTR_NAME_LOGIN_MEMBER);
    Integer memberId = loginMember.getId();

    // 调用远程方法保存ProjectVO对象和当前登录的用户的id
    ResultEntity&lt;String&gt; saveResultEntity = mySQLRemoteService.saveProjectRemote(projectVO, memberId);

    String result = saveResultEntity.getResult();

    if (ResultEntity.FAILED.equals(result))&#123;
        // 保存出错，返回确认的界面，并且携带错误的消息
        modelMap.addAttribute(CrowdConstant.ATTR_NAME_MESSAGE, saveResultEntity.getMessage());
        return &quot;project-confirm&quot;;
    &#125;

    // 保存正常完成，删除session中临时存放的ProjectVO
    session.removeAttribute(CrowdConstant.ATTR_NAME_TEMPLE_PROJECT);

    // 进入成功页面
    return &quot;redirect:http://localhost/project/create/success.html&quot;;
&#125;
```



### 3、API模块的远程方法：

```java
@RequestMapping(&quot;/save/project/remote&quot;)
ResultEntity&lt;String&gt; saveProjectRemote(@RequestBody ProjectVO projectVO, @RequestParam(&quot;memberId&quot;) Integer memberId);
```





### 4、mysql-provider模块的对应代码

#### controller层

```java
// 将ProjectVO中的数据存入各个数据库
@RequestMapping(&quot;/save/project/remote&quot;)
public ResultEntity&lt;String&gt; saveProjectRemote(@RequestBody ProjectVO projectVO, @RequestParam(&quot;memberId&quot;) Integer memberId)&#123;
    // 调用本地service进行保存
    try &#123;
        projectService.saveProject(projectVO, memberId);
        return ResultEntity.successWithoutData();
    &#125; catch (Exception e)&#123;
        e.printStackTrace();
        return ResultEntity.failed(e.getMessage());
    &#125;

&#125;
```



#### service层

```java
@Service
public class ProjectServiceImpl implements ProjectService &#123;

    @Autowired
    ProjectPOMapper projectPOMapper;

    @Autowired
    ProjectItemPicPOMapper projectItemPicPOMapper;

    @Autowired
    MemberLaunchInfoPOMapper memberLaunchInfoPOMapper;

    @Autowired
    ReturnPOMapper returnPOMapper;

    @Autowired
    MemberConfirmInfoPOMapper memberConfirmInfoPOMapper;

    @Override
    public void saveProject(ProjectVO projectVO, Integer memberId) &#123;

        // 一、保存ProjectPO对象
        // 1.初始化一个ProjectPO
        ProjectPO projectPO = new ProjectPO();

        // 2.利用工具方法，给ProjectPO赋值
        BeanUtils.copyProperties(projectVO,projectPO);

        // 3.给projectPO设置memberId
        projectPO.setMemberid(memberId);

        // 4.给projectPO设置项目创建时间
        String createDate = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).format(new Date());
        projectPO.setCreatedate(createDate);

        // 5.设置status=0，表示项目即将开始
        projectPO.setStatus(0);

        // 6.向数据库保存ProjectPO
        // 为了在ProjectPO得到自增的主键，
        // 在mapper的xml文件中对应的insert标签增加了useGeneratedKeys=&quot;true&quot; keyProperty=&quot;id&quot;的配置
        projectPOMapper.insertSelective(projectPO);

        
        // 得到projectId
        Integer projectId = projectPO.getId();

        

        // 二、保存项目、分类关联关系信息
        // 1.得到TypeList
        List&lt;Integer&gt; typeIdList = projectVO.getTypeIdList();
        // 2.执行保存操作
        projectPOMapper.saveTypeRelationship(projectId, typeIdList);

        
        // 三、保存项目、标签关联关系信息
        // 1. 得到TagIdList
        List&lt;Integer&gt; tagIdList = projectVO.getTagIdList();
        // 2.执行保存操作
        projectPOMapper.saveTagRelationship(projectId, tagIdList);

        
        // 四、保存项目中详情图片路径信息
        // 1.得到detailPicturePathList
        List&lt;String&gt; detailPicturePathList = projectVO.getDetailPicturePathList();

        // 2.执行保存操作
        projectItemPicPOMapper.insertPathList(projectId, detailPicturePathList);

        
        // 五、保存项目发起人信息
        // 1.得到发起人信息
        MemberLauchInfoVO memberLauchInfoVO = projectVO.getMemberLauchInfoVO();

        // 2.初始化MemberLaunchInfoPO
        MemberLaunchInfoPO memberLaunchInfoPO = new MemberLaunchInfoPO();

        // 3.给MemberLaunchInfoPO赋值
        BeanUtils.copyProperties(memberLauchInfoVO,memberLaunchInfoPO);

        // 4.设置MemberLaunchInfoPO的memberId
        memberLaunchInfoPO.setMemberid(memberId);

        // 5.保存发起人信息
        memberLaunchInfoPOMapper.insertSelective(memberLaunchInfoPO);

        
        // 六、保存项目回报信息
        // 1.得到项目汇报信息的List
        List&lt;ReturnVO&gt; returnVOList = projectVO.getReturnVOList();

        // 2.初始化一个ReturnPO的list
        List&lt;ReturnPO&gt; returnPOList = new ArrayList&lt;&gt;();

        // 3.遍历给ReturnPO赋值 并存入List
        for (ReturnVO returnVO : returnVOList)&#123;
            ReturnPO returnPO = new ReturnPO();
            BeanUtils.copyProperties(returnVO,returnPO);
            returnPOList.add(returnPO);
        &#125;
        // 4.将returnPOList存入数据库
        returnPOMapper.insertReturnPOList(projectId,returnPOList);

        
        // 七、保存项目确认信息
        // 1.得到MemberConfirmInfoVO
        MemberConfirmInfoVO memberConfirmInfoVO = projectVO.getMemberConfirmInfoVO();

        // 2.初始化MemberConfirmInfoPO对象
        MemberConfirmInfoPO memberConfirmInfoPO = new MemberConfirmInfoPO();

        // 3.给MemberConfirmInfoPO赋值
        BeanUtils.copyProperties(memberConfirmInfoVO,memberConfirmInfoPO);

        // 4.给MemberConfirmInfoPO设置memberId
        memberConfirmInfoPO.setMemberid(memberId);

        // 将MemberConfirmInfoPO存入数据库
        memberConfirmInfoPOMapper.insertSelective(memberConfirmInfoPO);

    &#125;
&#125;
</code></pre>
<p>Mapper因为量较多，这里省略了，可以在项目代码中直接查看</p>
<p>在首页显示当前的项目数据，并且按照type分类，点击每一个项目，可以进入项目的详情页面。</p>
<h1 id="一、首页显示项目数据"><a href="#一、首页显示项目数据" class="headerlink" title="一、首页显示项目数据"></a>一、首页显示项目数据</h1><h2 id="1、创建实体类"><a href="#1、创建实体类" class="headerlink" title="1、创建实体类"></a>1、创建实体类</h2><p>实体类的内容与浏览器端需要显示的内容相匹配</p>
<p><strong>PortalTypeVO</strong>：代表页面的分类信息</p>
<pre><code class="java">@Data
@AllArgsConstructor
@NoArgsConstructor
public class PortalTypeVO &#123;
    private Integer id;
    private String name;
    private String remark;
    private List&lt;PortalProjectVO&gt; portalProjectVOList;
&#125;
</code></pre>
<p><strong>PortalProjectVO</strong>：代表每一个分类中的项目的简介</p>
<pre><code class="java">@Data
@AllArgsConstructor
@NoArgsConstructor
public class PortalProjectVO &#123;
    private Integer projectId;
    private String projectName;
    private String headerPicturePath;
    private Integer money;
    private String deployDate;
    private Integer percentage;
    private Integer supporter;
&#125;
</code></pre>
<h2 id="2、编写SQL语句"><a href="#2、编写SQL语句" class="headerlink" title="2、编写SQL语句"></a>2、编写SQL语句</h2><p>这里因为是项目相关的信息，因此写在ProjectPOMapper.xml文件中：</p>
<p>查询当前数据库中所有的type，并通过typeId与t_project_type、t_project表关联查询出每一个type所包含的Project信息</p>
<pre><code class="xml">&lt;select id=&quot;selectPortalProjectVOList&quot; resultType=&quot;org.fall.entity.vo.PortalProjectVO&quot;&gt;
  select
  t_project.id projectId,
  project_name projectName,
  header_picture_path headerPicturePath,
  money,
  deploydate deployDate,
  (supportmoney/money)*100 percentage,
  supporter
  from t_project
  left join t_project_type on t_project.id = t_project_type.projectid
  where t_project_type.typeid = #&#123;id&#125;
  order by t_project.id DESC
  limit 0,4	&lt;!--首页中每一个分类最多显示4个项目，因此用limit限制--&gt;
&lt;/select&gt;

&lt;!-- loadPortalProjectListResultMap --&gt;
&lt;resultMap id=&quot;loadPortalProjectListResultMap&quot; type=&quot;org.fall.entity.vo.PortalTypeVO&quot;&gt;
  &lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt;
  &lt;result column=&quot;name&quot; property=&quot;name&quot;/&gt;
  &lt;result column=&quot;remark&quot; property=&quot;remark&quot;/&gt;
  &lt;!-- 通过typeId查询对应项目信息的list --&gt;
  &lt;collection property=&quot;portalProjectVOList&quot; column=&quot;id&quot; select=&quot;selectPortalProjectVOList&quot;/&gt;
&lt;/resultMap&gt;

&lt;!-- selectPortalTypeVOList --&gt;
&lt;select id=&quot;selectPortalTypeVOList&quot; resultMap=&quot;loadPortalProjectListResultMap&quot;&gt;
  select id,name,remark from t_type
&lt;/select&gt;
</code></pre>
<p>Mapper接口的方法：</p>
<pre><code class="java">List&lt;PortalTypeVO&gt; selectPortalTypeVOList();
</code></pre>
<h2 id="3、对外暴露接口"><a href="#3、对外暴露接口" class="headerlink" title="3、对外暴露接口"></a>3、对外暴露接口</h2><p>Service层接口：</p>
<pre><code class="java">DetailProjectVO getDetailProjectVO(Integer projectId);
</code></pre>
<p>Service层实现类：</p>
<pre><code class="java">@Override
public List&lt;PortalTypeVO&gt; getPortalTypeVOList() &#123;
    return projectPOMapper.selectPortalTypeVOList();
&#125;
</code></pre>
<p>handler方法：</p>
<pre><code class="java">@RequestMapping(&quot;/get/portal/type/project/data/remote&quot;)
public ResultEntity&lt;List&lt;PortalTypeVO&gt;&gt; getPortalTypeProjectDataRemote()&#123;
    try &#123;
        List&lt;PortalTypeVO&gt; portalTypeVOList = projectService.getPortalTypeVOList();
        return ResultEntity.successWithData(portalTypeVOList);
    &#125; catch (Exception e)&#123;
        e.printStackTrace();
        return ResultEntity.failed(e.getMessage());
    &#125;
&#125;
</code></pre>
<p>远程api模块的对应接口：</p>
<pre><code class="java">@RequestMapping(&quot;/get/portal/type/project/data/remote&quot;)
public ResultEntity&lt;List&lt;PortalTypeVO&gt;&gt; getPortalTypeProjectDataRemote();
</code></pre>
<h2 id="4、调用远程方法"><a href="#4、调用远程方法" class="headerlink" title="4、调用远程方法"></a>4、调用远程方法</h2><p>因为概要信息显示在首页，因此需要修改auth-consumer模块的首页的handler方法：</p>
<pre><code class="java">// 首页
@RequestMapping(&quot;/&quot;)
public String showPortalPage(ModelMap modelMap)&#123;

    // 调用MySQLRemoteService提供的方法查询首页要显示的数据
    ResultEntity&lt;List&lt;PortalTypeVO&gt;&gt; resultEntity = mySQLRemoteService.getPortalTypeProjectDataRemote();
    // 如果操作成功，将得到的list加入请求域
    if (ResultEntity.SUCCESS.equals(resultEntity.getResult()))&#123;
        List&lt;PortalTypeVO&gt; portalTypeVOList = resultEntity.getData();
        modelMap.addAttribute(CrowdConstant.ATTR_NAME_PORTAL_TYPE_LIST,portalTypeVOList);
    &#125;

    return &quot;portal&quot;;
&#125;
</code></pre>
<h2 id="5、前端显示"><a href="#5、前端显示" class="headerlink" title="5、前端显示"></a>5、前端显示</h2><p>在前端通过请求域中的数据，显示在前端，详见代码。</p>
<p>这里给出跳转到每一个<strong>项目详情页面</strong>的代码：（拼接projecId以进入对应projectId的详情页面）</p>
<pre><code class="html">&lt;h3 class=&quot;break&quot;&gt;
    &lt;a th:href=&quot;@&#123;http://localhost/project/show/project/detail/&#125; + $&#123;project.projectId&#125;&quot; th:text=&quot;$&#123;project.projectName&#125;&quot;&gt;
        活性富氢净水直饮机
    &lt;/a&gt;
&lt;/h3&gt;
</code></pre>
<h1 id="二、显示单个项目详情"><a href="#二、显示单个项目详情" class="headerlink" title="二、显示单个项目详情"></a>二、显示单个项目详情</h1><h2 id="1、创建实体类-1"><a href="#1、创建实体类-1" class="headerlink" title="1、创建实体类"></a>1、创建实体类</h2><p><strong>DetailProjectVO</strong>：代表详情页面的项目信息</p>
<pre><code class="java">@Data
@AllArgsConstructor
@NoArgsConstructor
public class DetailProjectVO &#123;

    private Integer projectId;
    private String projectName;
    private String projectDesc;
    private Integer followerCount;
    private Integer day;
    private Integer status;
    private String statusText;
    private Integer money;
    private Integer supportMoney;
    private Integer percentage;
    private String deployDate;
    private Integer lastDay;
    private Integer supporterCount;
    private String headerPicturePath;
    private List&lt;String&gt; detailPicturePathList;
    private List&lt;DetailReturnVO&gt; detailReturnVOList;


&#125;
</code></pre>
<p><strong>DetailReturnVO</strong>：代表每一个项目中的回报信息</p>
<pre><code class="java">@Data
@AllArgsConstructor
@NoArgsConstructor
public class DetailReturnVO &#123;

    // 回报主键信息
    private Integer returnId;

    // 当前栏位需要支持的金额
    private Integer supportMoney;

    // 是否限购，0时无限额，1时有限额
    private Integer signalPurchase;

    // 具体的限额数量
    private Integer purchase;

    // 当前栏位的支持者数量
    private Integer supporterCount;

    // 运费 0时表示包邮
    private Integer freight;

    // 众筹成功多少天后发货
    private Integer returnDate;

    // 回报的详细内容
    private String content;


&#125;
</code></pre>
<h2 id="2、编写SQL语句-1"><a href="#2、编写SQL语句-1" class="headerlink" title="2、编写SQL语句"></a>2、编写SQL语句</h2><p>这里依然是写在ProjectPOMapper.xml文件中：</p>
<pre><code class="xml">&lt;resultMap id=&quot;loadProjectDetailResultMap&quot; type=&quot;org.fall.entity.vo.DetailProjectVO&quot;&gt;
  &lt;id column=&quot;id&quot; property=&quot;projectId&quot;/&gt;
  &lt;result column=&quot;project_name&quot; property=&quot;projectName&quot; /&gt;
  &lt;result column=&quot;project_description&quot; property=&quot;projectDesc&quot; /&gt;
  &lt;result column=&quot;money&quot; property=&quot;money&quot; /&gt;
  &lt;result column=&quot;status&quot; property=&quot;status&quot; /&gt;
  &lt;result column=&quot;deploydate&quot; property=&quot;deployDate&quot; /&gt;
  &lt;result column=&quot;supportmoney&quot; property=&quot;supportMoney&quot; /&gt;
  &lt;result column=&quot;supporter&quot; property=&quot;supporterCount&quot; /&gt;
  &lt;result column=&quot;percentage&quot; property=&quot;percentage&quot; /&gt;
  &lt;result column=&quot;follower&quot; property=&quot;followerCount&quot; /&gt;
  &lt;result column=&quot;day&quot; property=&quot;day&quot;/&gt;
  &lt;result column=&quot;header_picture_path&quot; property=&quot;headerPicturePath&quot; /&gt;
  &lt;collection property=&quot;detailPicturePathList&quot; column=&quot;id&quot; select=&quot;selectDetailPicturePathList&quot;/&gt;
  &lt;collection property=&quot;detailReturnVOList&quot; column=&quot;id&quot; select=&quot;selectDetailReturnVOList&quot;/&gt;
&lt;/resultMap&gt;

&lt;select id=&quot;selectDetailReturnVOList&quot; resultType=&quot;org.fall.entity.vo.DetailReturnVO&quot;&gt;
  select
      id returnId,
      supportmoney supportMoney,
      signalpurchase signalPurchase,
      purchase,
      freight ,
      returndate returnDate,
      content
  from
      t_return
  where
      projectid=#&#123;id&#125;
&lt;/select&gt;

&lt;select id=&quot;selectDetailPicturePathList&quot; resultType=&quot;string&quot;&gt;
  select item_pic_path from t_project_item_pic where projectid=#&#123;id&#125;
&lt;/select&gt;

&lt;select id=&quot;selectDetailProjectVO&quot; resultMap=&quot;loadProjectDetailResultMap&quot;&gt;
  select
      id,
      project_name,
      project_description,
      money,
      day,
      status,
      deploydate,
      supportmoney,
      supporter,
      (supportmoney/money)*100 percentage,
      follower,
      header_picture_path
  from
      t_project
      where id=#&#123;projectId&#125;
&lt;/select&gt;
</code></pre>
<p>Mapper接口的方法：</p>
<pre><code class="java">DetailProjectVO selectDetailProjectVO(Integer projectId);
</code></pre>
<h2 id="3、对外暴露接口-1"><a href="#3、对外暴露接口-1" class="headerlink" title="3、对外暴露接口"></a>3、对外暴露接口</h2><p>service层接口：</p>
<pre><code class="java">DetailProjectVO getDetailProjectVO(Integer projectId);
</code></pre>
<p>service层实现类：</p>
<p>实现类中根据当前数据，得到了statusText、项目剩余时间、</p>
<pre><code class="java">@Override
public DetailProjectVO getDetailProjectVO(Integer projectId) &#123;
    // 得到DetailProjectVO对象
    DetailProjectVO detailProjectVO = projectPOMapper.selectDetailProjectVO(projectId);

    // 根据status 确定status的状态
    Integer status = detailProjectVO.getStatus();
    switch (status)&#123;
        case 0:
            detailProjectVO.setStatusText(&quot;即将开始&quot;);
            break;
        case 1:
            detailProjectVO.setStatusText(&quot;众筹中&quot;);
            break;
        case 2:
            detailProjectVO.setStatusText(&quot;众筹成功&quot;);
            break;
        case 3:
            detailProjectVO.setStatusText(&quot;众筹失败&quot;);
            break;
        default:
            break;
    &#125;

    // 根据deployDate计算lastDay
    String deployDate = detailProjectVO.getDeployDate();

    // 获取当前日期
    Date currentDay = new Date();

    // 把众筹的日期转换为Date类型
    SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);
    try &#123;
        Date deployDay = format.parse(deployDate);

        // 获取当前日期的时间戳
        long currentDayTime = currentDay.getTime();

        // 获取众筹日期的时间戳
        long deployDayTime = deployDay.getTime();

        // 通过当前日期时间戳-众筹日期时间戳，得到已经去过的时间
        Integer passDay = (int)(currentDayTime - deployDayTime) / 1000 / 60 / 60 / 24;

        // 用设置的众筹天数-过去的时间 得到剩余时间
        int lastDay = detailProjectVO.getDay() - passDay;

        // 给当前的DetailProjectVO对象设置剩余时间
        detailProjectVO.setLastDay(lastDay);

    &#125; catch (ParseException e) &#123;
        e.printStackTrace();
    &#125;

    // 最后返回完善后的detailProjectVO对象
    return detailProjectVO;
&#125;
</code></pre>
<p>handler方法：</p>
<pre><code class="java">// 传入的 /&#123;projectId&#125; 需要在传参处使用 @PathVariable(&quot;projectId&quot;)来接收
@RequestMapping(&quot;/get/detail/project/remote/&#123;projectId&#125;&quot;)
public ResultEntity&lt;DetailProjectVO&gt; getDetailProjectVORemote(@PathVariable(&quot;projectId&quot;) Integer projectId)&#123;
    return ResultEntity.successWithData(projectService.getDetailProjectVO(projectId));
&#125;
</code></pre>
<p>远程api模块的对应接口：</p>
<pre><code class="java">@RequestMapping(&quot;/get/detail/project/remote/&#123;projectId&#125;&quot;)
public ResultEntity&lt;DetailProjectVO&gt; getDetailProjectVORemote(@PathVariable(&quot;projectId&quot;) Integer projectId);
</code></pre>
<h2 id="4、调用远程方法-1"><a href="#4、调用远程方法-1" class="headerlink" title="4、调用远程方法"></a>4、调用远程方法</h2><pre><code class="java">@RequestMapping(&quot;/show/project/detail/&#123;projectId&#125;&quot;)
public String getDetailProject(@PathVariable(&quot;projectId&quot;) Integer projectId,ModelMap modelMap)&#123;
    ResultEntity&lt;DetailProjectVO&gt; resultEntity = mySQLRemoteService.getDetailProjectVORemote(projectId);
    if (ResultEntity.SUCCESS.equals(resultEntity.getResult()))&#123;
        DetailProjectVO detailProjectVO = resultEntity.getData();
        modelMap.addAttribute(CrowdConstant.ATTR_NAME_DETAIL_PROJECT,detailProjectVO);
    &#125;
    return &quot;project-show-detail&quot;;
&#125;
</code></pre>
<h2 id="5、前端显示-1"><a href="#5、前端显示-1" class="headerlink" title="5、前端显示"></a>5、前端显示</h2><p>详见代码，这里省略</p>
<p>在首页显示当前的项目数据，并且按照type分类，点击每一个项目，可以进入项目的详情页面。</p>
<h1 id="一、首页显示项目数据-1"><a href="#一、首页显示项目数据-1" class="headerlink" title="一、首页显示项目数据"></a>一、首页显示项目数据</h1><h2 id="1、创建实体类-2"><a href="#1、创建实体类-2" class="headerlink" title="1、创建实体类"></a>1、创建实体类</h2><p>实体类的内容与浏览器端需要显示的内容相匹配</p>
<p><strong>PortalTypeVO</strong>：代表页面的分类信息</p>
<pre><code class="java">@Data
@AllArgsConstructor
@NoArgsConstructor
public class PortalTypeVO &#123;
    private Integer id;
    private String name;
    private String remark;
    private List&lt;PortalProjectVO&gt; portalProjectVOList;
&#125;
</code></pre>
<p><strong>PortalProjectVO</strong>：代表每一个分类中的项目的简介</p>
<pre><code class="java">@Data
@AllArgsConstructor
@NoArgsConstructor
public class PortalProjectVO &#123;
    private Integer projectId;
    private String projectName;
    private String headerPicturePath;
    private Integer money;
    private String deployDate;
    private Integer percentage;
    private Integer supporter;
&#125;
</code></pre>
<h2 id="2、编写SQL语句-2"><a href="#2、编写SQL语句-2" class="headerlink" title="2、编写SQL语句"></a>2、编写SQL语句</h2><p>这里因为是项目相关的信息，因此写在ProjectPOMapper.xml文件中：</p>
<p>查询当前数据库中所有的type，并通过typeId与t_project_type、t_project表关联查询出每一个type所包含的Project信息</p>
<pre><code class="xml">&lt;select id=&quot;selectPortalProjectVOList&quot; resultType=&quot;org.fall.entity.vo.PortalProjectVO&quot;&gt;
  select
  t_project.id projectId,
  project_name projectName,
  header_picture_path headerPicturePath,
  money,
  deploydate deployDate,
  (supportmoney/money)*100 percentage,
  supporter
  from t_project
  left join t_project_type on t_project.id = t_project_type.projectid
  where t_project_type.typeid = #&#123;id&#125;
  order by t_project.id DESC
  limit 0,4	&lt;!--首页中每一个分类最多显示4个项目，因此用limit限制--&gt;
&lt;/select&gt;

&lt;!-- loadPortalProjectListResultMap --&gt;
&lt;resultMap id=&quot;loadPortalProjectListResultMap&quot; type=&quot;org.fall.entity.vo.PortalTypeVO&quot;&gt;
  &lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt;
  &lt;result column=&quot;name&quot; property=&quot;name&quot;/&gt;
  &lt;result column=&quot;remark&quot; property=&quot;remark&quot;/&gt;
  &lt;!-- 通过typeId查询对应项目信息的list --&gt;
  &lt;collection property=&quot;portalProjectVOList&quot; column=&quot;id&quot; select=&quot;selectPortalProjectVOList&quot;/&gt;
&lt;/resultMap&gt;

&lt;!-- selectPortalTypeVOList --&gt;
&lt;select id=&quot;selectPortalTypeVOList&quot; resultMap=&quot;loadPortalProjectListResultMap&quot;&gt;
  select id,name,remark from t_type
&lt;/select&gt;
</code></pre>
<p>Mapper接口的方法：</p>
<pre><code class="java">List&lt;PortalTypeVO&gt; selectPortalTypeVOList();
</code></pre>
<h2 id="3、对外暴露接口-2"><a href="#3、对外暴露接口-2" class="headerlink" title="3、对外暴露接口"></a>3、对外暴露接口</h2><p>Service层接口：</p>
<pre><code class="java">DetailProjectVO getDetailProjectVO(Integer projectId);
</code></pre>
<p>Service层实现类：</p>
<pre><code class="java">@Override
public List&lt;PortalTypeVO&gt; getPortalTypeVOList() &#123;
    return projectPOMapper.selectPortalTypeVOList();
&#125;
</code></pre>
<p>handler方法：</p>
<pre><code class="java">@RequestMapping(&quot;/get/portal/type/project/data/remote&quot;)
public ResultEntity&lt;List&lt;PortalTypeVO&gt;&gt; getPortalTypeProjectDataRemote()&#123;
    try &#123;
        List&lt;PortalTypeVO&gt; portalTypeVOList = projectService.getPortalTypeVOList();
        return ResultEntity.successWithData(portalTypeVOList);
    &#125; catch (Exception e)&#123;
        e.printStackTrace();
        return ResultEntity.failed(e.getMessage());
    &#125;
&#125;
</code></pre>
<p>远程api模块的对应接口：</p>
<pre><code class="java">@RequestMapping(&quot;/get/portal/type/project/data/remote&quot;)
public ResultEntity&lt;List&lt;PortalTypeVO&gt;&gt; getPortalTypeProjectDataRemote();
</code></pre>
<h2 id="4、调用远程方法-2"><a href="#4、调用远程方法-2" class="headerlink" title="4、调用远程方法"></a>4、调用远程方法</h2><p>因为概要信息显示在首页，因此需要修改auth-consumer模块的首页的handler方法：</p>
<pre><code class="java">// 首页
@RequestMapping(&quot;/&quot;)
public String showPortalPage(ModelMap modelMap)&#123;

    // 调用MySQLRemoteService提供的方法查询首页要显示的数据
    ResultEntity&lt;List&lt;PortalTypeVO&gt;&gt; resultEntity = mySQLRemoteService.getPortalTypeProjectDataRemote();
    // 如果操作成功，将得到的list加入请求域
    if (ResultEntity.SUCCESS.equals(resultEntity.getResult()))&#123;
        List&lt;PortalTypeVO&gt; portalTypeVOList = resultEntity.getData();
        modelMap.addAttribute(CrowdConstant.ATTR_NAME_PORTAL_TYPE_LIST,portalTypeVOList);
    &#125;

    return &quot;portal&quot;;
&#125;
</code></pre>
<h2 id="5、前端显示-2"><a href="#5、前端显示-2" class="headerlink" title="5、前端显示"></a>5、前端显示</h2><p>在前端通过请求域中的数据，显示在前端，详见代码。</p>
<p>这里给出跳转到每一个<strong>项目详情页面</strong>的代码：（拼接projecId以进入对应projectId的详情页面）</p>
<pre><code class="html">&lt;h3 class=&quot;break&quot;&gt;
    &lt;a th:href=&quot;@&#123;http://localhost/project/show/project/detail/&#125; + $&#123;project.projectId&#125;&quot; th:text=&quot;$&#123;project.projectName&#125;&quot;&gt;
        活性富氢净水直饮机
    &lt;/a&gt;
&lt;/h3&gt;
</code></pre>
<h1 id="二、显示单个项目详情-1"><a href="#二、显示单个项目详情-1" class="headerlink" title="二、显示单个项目详情"></a>二、显示单个项目详情</h1><h2 id="1、创建实体类-3"><a href="#1、创建实体类-3" class="headerlink" title="1、创建实体类"></a>1、创建实体类</h2><p><strong>DetailProjectVO</strong>：代表详情页面的项目信息</p>
<pre><code class="java">@Data
@AllArgsConstructor
@NoArgsConstructor
public class DetailProjectVO &#123;

    private Integer projectId;
    private String projectName;
    private String projectDesc;
    private Integer followerCount;
    private Integer day;
    private Integer status;
    private String statusText;
    private Integer money;
    private Integer supportMoney;
    private Integer percentage;
    private String deployDate;
    private Integer lastDay;
    private Integer supporterCount;
    private String headerPicturePath;
    private List&lt;String&gt; detailPicturePathList;
    private List&lt;DetailReturnVO&gt; detailReturnVOList;


&#125;
</code></pre>
<p><strong>DetailReturnVO</strong>：代表每一个项目中的回报信息</p>
<pre><code class="java">@Data
@AllArgsConstructor
@NoArgsConstructor
public class DetailReturnVO &#123;

    // 回报主键信息
    private Integer returnId;

    // 当前栏位需要支持的金额
    private Integer supportMoney;

    // 是否限购，0时无限额，1时有限额
    private Integer signalPurchase;

    // 具体的限额数量
    private Integer purchase;

    // 当前栏位的支持者数量
    private Integer supporterCount;

    // 运费 0时表示包邮
    private Integer freight;

    // 众筹成功多少天后发货
    private Integer returnDate;

    // 回报的详细内容
    private String content;


&#125;
</code></pre>
<h2 id="2、编写SQL语句-3"><a href="#2、编写SQL语句-3" class="headerlink" title="2、编写SQL语句"></a>2、编写SQL语句</h2><p>这里依然是写在ProjectPOMapper.xml文件中：</p>
<pre><code class="xml">&lt;resultMap id=&quot;loadProjectDetailResultMap&quot; type=&quot;org.fall.entity.vo.DetailProjectVO&quot;&gt;
  &lt;id column=&quot;id&quot; property=&quot;projectId&quot;/&gt;
  &lt;result column=&quot;project_name&quot; property=&quot;projectName&quot; /&gt;
  &lt;result column=&quot;project_description&quot; property=&quot;projectDesc&quot; /&gt;
  &lt;result column=&quot;money&quot; property=&quot;money&quot; /&gt;
  &lt;result column=&quot;status&quot; property=&quot;status&quot; /&gt;
  &lt;result column=&quot;deploydate&quot; property=&quot;deployDate&quot; /&gt;
  &lt;result column=&quot;supportmoney&quot; property=&quot;supportMoney&quot; /&gt;
  &lt;result column=&quot;supporter&quot; property=&quot;supporterCount&quot; /&gt;
  &lt;result column=&quot;percentage&quot; property=&quot;percentage&quot; /&gt;
  &lt;result column=&quot;follower&quot; property=&quot;followerCount&quot; /&gt;
  &lt;result column=&quot;day&quot; property=&quot;day&quot;/&gt;
  &lt;result column=&quot;header_picture_path&quot; property=&quot;headerPicturePath&quot; /&gt;
  &lt;collection property=&quot;detailPicturePathList&quot; column=&quot;id&quot; select=&quot;selectDetailPicturePathList&quot;/&gt;
  &lt;collection property=&quot;detailReturnVOList&quot; column=&quot;id&quot; select=&quot;selectDetailReturnVOList&quot;/&gt;
&lt;/resultMap&gt;

&lt;select id=&quot;selectDetailReturnVOList&quot; resultType=&quot;org.fall.entity.vo.DetailReturnVO&quot;&gt;
  select
      id returnId,
      supportmoney supportMoney,
      signalpurchase signalPurchase,
      purchase,
      freight ,
      returndate returnDate,
      content
  from
      t_return
  where
      projectid=#&#123;id&#125;
&lt;/select&gt;

&lt;select id=&quot;selectDetailPicturePathList&quot; resultType=&quot;string&quot;&gt;
  select item_pic_path from t_project_item_pic where projectid=#&#123;id&#125;
&lt;/select&gt;

&lt;select id=&quot;selectDetailProjectVO&quot; resultMap=&quot;loadProjectDetailResultMap&quot;&gt;
  select
      id,
      project_name,
      project_description,
      money,
      day,
      status,
      deploydate,
      supportmoney,
      supporter,
      (supportmoney/money)*100 percentage,
      follower,
      header_picture_path
  from
      t_project
      where id=#&#123;projectId&#125;
&lt;/select&gt;
</code></pre>
<p>Mapper接口的方法：</p>
<pre><code class="java">DetailProjectVO selectDetailProjectVO(Integer projectId);
</code></pre>
<h2 id="3、对外暴露接口-3"><a href="#3、对外暴露接口-3" class="headerlink" title="3、对外暴露接口"></a>3、对外暴露接口</h2><p>service层接口：</p>
<pre><code class="java">DetailProjectVO getDetailProjectVO(Integer projectId);
</code></pre>
<p>service层实现类：</p>
<p>实现类中根据当前数据，得到了statusText、项目剩余时间、</p>
<pre><code class="java">@Override
public DetailProjectVO getDetailProjectVO(Integer projectId) &#123;
    // 得到DetailProjectVO对象
    DetailProjectVO detailProjectVO = projectPOMapper.selectDetailProjectVO(projectId);

    // 根据status 确定status的状态
    Integer status = detailProjectVO.getStatus();
    switch (status)&#123;
        case 0:
            detailProjectVO.setStatusText(&quot;即将开始&quot;);
            break;
        case 1:
            detailProjectVO.setStatusText(&quot;众筹中&quot;);
            break;
        case 2:
            detailProjectVO.setStatusText(&quot;众筹成功&quot;);
            break;
        case 3:
            detailProjectVO.setStatusText(&quot;众筹失败&quot;);
            break;
        default:
            break;
    &#125;

    // 根据deployDate计算lastDay
    String deployDate = detailProjectVO.getDeployDate();

    // 获取当前日期
    Date currentDay = new Date();

    // 把众筹的日期转换为Date类型
    SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;);
    try &#123;
        Date deployDay = format.parse(deployDate);

        // 获取当前日期的时间戳
        long currentDayTime = currentDay.getTime();

        // 获取众筹日期的时间戳
        long deployDayTime = deployDay.getTime();

        // 通过当前日期时间戳-众筹日期时间戳，得到已经去过的时间
        Integer passDay = (int)(currentDayTime - deployDayTime) / 1000 / 60 / 60 / 24;

        // 用设置的众筹天数-过去的时间 得到剩余时间
        int lastDay = detailProjectVO.getDay() - passDay;

        // 给当前的DetailProjectVO对象设置剩余时间
        detailProjectVO.setLastDay(lastDay);

    &#125; catch (ParseException e) &#123;
        e.printStackTrace();
    &#125;

    // 最后返回完善后的detailProjectVO对象
    return detailProjectVO;
&#125;
</code></pre>
<p>handler方法：</p>
<pre><code class="java">// 传入的 /&#123;projectId&#125; 需要在传参处使用 @PathVariable(&quot;projectId&quot;)来接收
@RequestMapping(&quot;/get/detail/project/remote/&#123;projectId&#125;&quot;)
public ResultEntity&lt;DetailProjectVO&gt; getDetailProjectVORemote(@PathVariable(&quot;projectId&quot;) Integer projectId)&#123;
    return ResultEntity.successWithData(projectService.getDetailProjectVO(projectId));
&#125;
</code></pre>
<p>远程api模块的对应接口：</p>
<pre><code class="java">@RequestMapping(&quot;/get/detail/project/remote/&#123;projectId&#125;&quot;)
public ResultEntity&lt;DetailProjectVO&gt; getDetailProjectVORemote(@PathVariable(&quot;projectId&quot;) Integer projectId);
</code></pre>
<h2 id="4、调用远程方法-3"><a href="#4、调用远程方法-3" class="headerlink" title="4、调用远程方法"></a>4、调用远程方法</h2><pre><code class="java">@RequestMapping(&quot;/show/project/detail/&#123;projectId&#125;&quot;)
public String getDetailProject(@PathVariable(&quot;projectId&quot;) Integer projectId,ModelMap modelMap)&#123;
    ResultEntity&lt;DetailProjectVO&gt; resultEntity = mySQLRemoteService.getDetailProjectVORemote(projectId);
    if (ResultEntity.SUCCESS.equals(resultEntity.getResult()))&#123;
        DetailProjectVO detailProjectVO = resultEntity.getData();
        modelMap.addAttribute(CrowdConstant.ATTR_NAME_DETAIL_PROJECT,detailProjectVO);
    &#125;
    return &quot;project-show-detail&quot;;
</code></pre>
<h1 id="一、搭建order-consumer环境"><a href="#一、搭建order-consumer环境" class="headerlink" title="一、搭建order-consumer环境"></a>一、搭建order-consumer环境</h1><h2 id="1、依赖"><a href="#1、依赖" class="headerlink" title="1、依赖"></a>1、依赖</h2><p>​	与前几个消费者模块的依赖基本一致</p>
<h2 id="2、application-yml"><a href="#2、application-yml" class="headerlink" title="2、application.yml"></a>2、application.yml</h2><pre><code class="yml">server:
  port: 6000
spring:
  application:
    name: crowd-order
  thymeleaf:
    prefix: classpath:/templates/
    suffix: .html
  redis:
    host: 192.168.0.101
  session:
    store-type: redis
eureka:
  client:
    service-url:
      defaultZone: http://localhost:1000/eureka/
</code></pre>
<h2 id="3、在Zuul中添加模块"><a href="#3、在Zuul中添加模块" class="headerlink" title="3、在Zuul中添加模块"></a>3、在Zuul中添加模块</h2><pre><code class="yml">zuul:
  ignored-services: &quot;*&quot;       # 表示忽视直接通过application-name访问微服务，必须通过route
  sensitive-headers: &quot;*&quot;      # 在Zuul向其他微服务重定向时，保持原本的头信息（请求头、响应头）
  routes:                     # 指定网关路由
    crowd-protal:
      service-id: crowd-auth  # 对应application-name
      path: /**               # 表示直接通过根路径访问，必须加上**，否则多层路径无法访问
    crowd-project:
      service-id: crowd-project
      path: /project/**
    crowd-order:
      service-id: crowd-order
      path: /order/**
</code></pre>
<h1 id="二、创建对应数据库表"><a href="#二、创建对应数据库表" class="headerlink" title="二、创建对应数据库表"></a>二、创建对应数据库表</h1><pre><code class="sql"># 建表t_order（订单表）
CREATE TABLE `t_order` (
    `id` INT NOT NULL AUTO_INCREMENT COMMENT &#39;主键&#39;,
    `order_num` CHAR(100) COMMENT &#39;订单号&#39;,
    `pay_order_num` CHAR(100) COMMENT &#39;支付宝流水号&#39;,
    `order_amount` DOUBLE(10,5) COMMENT &#39;订单金额&#39;,
    `invoice` INT COMMENT &#39;是否开发票（0 不开，1 开）&#39;,
    `invoice_title` CHAR(100) COMMENT &#39;发票抬头&#39;,
    `order_remark` CHAR(100) COMMENT &#39;订单备注&#39;,
    `address_id` CHAR(100) COMMENT &#39;收货地址 id&#39;, 
    PRIMARY KEY (`id`)
);


# 建表t_address（收货地址表）
CREATE TABLE t_address (
    `id` INT NOT NULL AUTO_INCREMENT COMMENT &#39;主键&#39;,
    `receive_name` CHAR(100) COMMENT &#39;收件人&#39;,
    `phone_num` CHAR(100) COMMENT &#39;手机号&#39;,
    `address` CHAR(200) COMMENT &#39;收货地址&#39;,
    `member_id` INT COMMENT &#39;用户 id&#39;,
    PRIMARY KEY (`id`)
);


# 建表t_order_project（项目信息表）
CREATE TABLE `t_order_project` (
    `id` INT NOT NULL AUTO_INCREMENT COMMENT &#39;主键&#39;,
    `project_name` CHAR(200) COMMENT &#39;项目名称&#39;,
    `launch_name` CHAR(100) COMMENT &#39;发起人&#39;,
    `return_content` CHAR(200) COMMENT &#39;回报内容&#39;,
    `return_count` INT COMMENT &#39;回报数量&#39;,
    `support_price` INT COMMENT &#39;支持单价&#39;,
    `freight` INT COMMENT &#39;配送费用&#39;,
    `order_id` INT COMMENT &#39;订单表的主键&#39;, 
    PRIMARY KEY (`id`)
);
</code></pre>
<h1 id="三、页面-确认回报内容"><a href="#三、页面-确认回报内容" class="headerlink" title="三、页面-确认回报内容"></a>三、页面-确认回报内容</h1><h2 id="1、跳转到确认回报页面"><a href="#1、跳转到确认回报页面" class="headerlink" title="1、跳转到确认回报页面"></a>1、跳转到确认回报页面</h2><p>修改project-consumer模块的project-show-detail.html页面代码，使点击支持按钮后跳转到确认回报的页面（需要附带上<strong>当前回报内容的id</strong>）：</p>
<pre><code class="html">&lt;a class=&quot;btn btn-warning btn-lg&quot; th:href=&quot;&#39;http://localhost/order/confirm/return/info/&#39; + $&#123;return.returnId&#125;&quot;&gt;
    支持
&lt;/a&gt;
</code></pre>
<p>通过order-consumer模块的handler方法，进入确认回报页面</p>
<pre><code class="java">    // 进入确认回报信息的页面
    @RequestMapping(&quot;/confirm/return/info/&#123;returnId&#125;&quot;)
    public String confirmReturnInfo(
            @PathVariable(&quot;returnId&quot;) Integer returnId,
            HttpSession session) &#123;

        ResultEntity&lt;OrderProjectVO&gt; resultEntity = mySQLRemoteService.getOrderProjectVO(returnId);

        if (ResultEntity.SUCCESS.equals(resultEntity.getResult()))&#123;
            session.setAttribute(&quot;orderProjectVO&quot;, resultEntity.getData());
        &#125;

        return &quot;order-confirm-return&quot;;
    &#125;
</code></pre>
<h2 id="2、远程方法"><a href="#2、远程方法" class="headerlink" title="2、远程方法"></a>2、远程方法</h2><p><strong>api接口模块：</strong></p>
<pre><code class="java">@RequestMapping(&quot;/get/order/project/vo/remote&quot;)
ResultEntity&lt;OrderProjectVO&gt; getOrderProjectVO(@RequestParam(&quot;returnId&quot;) Integer returnId);
</code></pre>
<p><strong>mysql模块的handler方法：</strong></p>
<pre><code class="java">@RequestMapping(&quot;/get/order/project/vo/remote&quot;)
ResultEntity&lt;OrderProjectVO&gt; getOrderProjectVO(@RequestParam(&quot;returnId&quot;) Integer returnId) &#123;

    try &#123;
        OrderProjectVO orderProjectVO = orderService.getOrderProjectVO(returnId);
        return ResultEntity.successWithData(orderProjectVO);
    &#125; catch (Exception e) &#123;
        e.printStackTrace();
        return ResultEntity.failed(e.getMessage());
    &#125;
&#125;
</code></pre>
<p><strong>mysql模块的service实现类方法（接口代码省略）：</strong></p>
<pre><code class="java">@Override
public OrderProjectVO getOrderProjectVO(Integer returnId) &#123;
    return orderProjectPOMapper.selectOrderProjectVO(returnId);
&#125;
</code></pre>
<p>mapper接口中，selectOrderProjectVO抽象方法对应的<strong>Mybatis代码：</strong></p>
<pre><code class="xml">&lt;select id=&quot;selectOrderProjectVO&quot; resultType=&quot;org.fall.entity.vo.OrderProjectVO&quot;&gt;
  select distinct
    project_name projectName,
    description_simple launchName,
    content returnContent,
    count returnCount,
    t_return.supportmoney supportPrice,
    freight,
    signalpurchase signalPurchase,
    purchase
  from t_project
  left join t_member_launch_info on t_project.memberid = t_member_launch_info.memberid
  left join t_return on t_project.id = t_return.projectid
  where t_return.id = #&#123;returnId&#125;
&lt;/select&gt;
</code></pre>
<h2 id="3、前台显示"><a href="#3、前台显示" class="headerlink" title="3、前台显示"></a>3、前台显示</h2><p>截取，从session域中通过orderProjectVO得到项目与回报的各种信息：</p>
<pre><code class="html">&lt;div class=&quot;col-md-12 column&quot;&gt;
    &lt;table class=&quot;table table-bordered&quot; style=&quot;text-align:center;&quot;&gt;
        &lt;thead&gt;
        &lt;tr style=&quot;background-color:#ddd;&quot;&gt;
            &lt;td&gt;项目名称&lt;/td&gt;
            &lt;td&gt;发起人&lt;/td&gt;
            &lt;td width=&quot;300&quot;&gt;回报内容&lt;/td&gt;
            &lt;td width=&quot;80&quot;&gt;回报数量&lt;/td&gt;
            &lt;td&gt;支持单价&lt;/td&gt;
            &lt;td&gt;配送费用&lt;/td&gt;
        &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody&gt;
        &lt;tr&gt;
            &lt;td th:text=&quot;$&#123;session.orderProjectVO.projectName&#125;&quot;&gt;活性富氢净水直饮机&lt;/td&gt;
            &lt;td th:text=&quot;$&#123;session.orderProjectVO.launchName&#125;&quot;&gt;深圳市博实永道电子商务有限公司&lt;/td&gt;
            &lt;td th:text=&quot;$&#123;session.orderProjectVO.returnContent&#125;&quot;&gt;每满1750人抽取一台活性富氢净水直饮机，至少抽取一台。&lt;/td&gt;
            &lt;td &gt;
                &lt;input id=&quot;returnCountInput&quot; type=&quot;text&quot; class=&quot;form-control&quot; style=&quot;width:60px;&quot; th:value=&quot;$&#123;session.orderProjectVO.returnCount&#125;&quot;&gt;
            &lt;/td&gt;
            &lt;td style=&quot;color:#F60&quot;&gt;￥[[$&#123;session.orderProjectVO.supportPrice&#125;]]&lt;/td&gt;
            &lt;td th:if=&quot;$&#123;session.orderProjectVO.freight&#125; == 0&quot;&gt;免运费&lt;/td&gt;
            &lt;td th:if=&quot;$&#123;session.orderProjectVO.freight&#125; &gt; 0&quot; th:text=&quot;$&#123;session.orderProjectVO.freight&#125;&quot;&gt;运费&lt;/td&gt;
        &lt;/tr&gt;
        &lt;/tbody&gt;
    &lt;/table&gt;
    &lt;div style=&quot;float:right;&quot;&gt;
        &lt;p&gt;总价(含运费)：￥
            &lt;span id=&quot;totalAmount&quot; style=&quot;font-size:16px;color:#F60;&quot; 
                          th:text=&quot;$&#123;session.orderProjectVO.freight&#125; + ($&#123;session.orderProjectVO.supportPrice&#125; * $&#123;session.orderProjectVO.returnCount&#125;)&quot;&gt;1.00
            &lt;/span&gt;
        &lt;/p&gt;
        &lt;button id=&quot;submitBtn&quot; type=&quot;button&quot; class=&quot;btn btn-warning btn-lg&quot; style=&quot;float:right;&quot; &gt;
            &lt;i class=&quot;glyphicon glyphicon-credit-card&quot;&gt;&lt;/i&gt; 去结算
        &lt;/button&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<p>为了实现<strong>修改回报数量文本框中的内容，自动修改总价</strong>的功能：</p>
<p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/确认回报内容页面.png"></p>
<p>通过一端js代码：</p>
<pre><code class="javascript">var signalPurchase = [[$&#123;session.orderProjectVO.signalPurchase&#125;]];

var purchase = [[$&#123;session.orderProjectVO.purchase&#125;]];

var freight = [[$&#123;session.orderProjectVO.freight&#125;]]

var supportPrice = [[$&#123;session.orderProjectVO.supportPrice&#125;]]

// 自动修正总价的功能
// 当id=returnCountInput的标签发送改动时触发
$(&quot;#returnCountInput&quot;).change(function () &#123;
    // 得到回报数量框内输入的量
    var count = $.trim($(this).val());
    // 判断是否输入了有效数字
    if (count == null || count == &quot;&quot;) &#123;
        alert(&quot;请输入有效的数字！&quot;);
        // 恢复为默认值
        $(this).val(this.defaultValue);
    &#125;
    // 判断是否超过限购数量
    if (signalPurchase == 1 &amp;&amp; purchase &lt; count) &#123;
        alert(&quot;不能超过限购数量！&quot;);
        // 恢复为默认值
        $(this).val(this.defaultValue);
        return ;
    &#125;

    // 满足上述条件 计算最后的总价
    $(&quot;#totalAmount&quot;).text(freight + supportPrice * count);
&#125;);
</code></pre>
<h1 id="四、页面-确认订单"><a href="#四、页面-确认订单" class="headerlink" title="四、页面-确认订单"></a>四、页面-确认订单</h1><h2 id="1、跳转到确认订单的页面"><a href="#1、跳转到确认订单的页面" class="headerlink" title="1、跳转到确认订单的页面"></a>1、跳转到确认订单的页面</h2><p>通过给确认回报内容的页面的<strong>“去结算”</strong>按钮添加单击响应函数：</p>
<p><img src="D:/浏览器下载/crowd-funding-master/crowd-funding-master/note/images/跳转确认订单页面.png"></p>
<pre><code class="javascript">$(&quot;#submitBtn&quot;).click(function () &#123;
    var returnCount = $(&quot;#returnCountInput&quot;).val();
    window.location.href=&quot;/order/confirm/order/&quot; + returnCount;
&#125;);
</code></pre>
<p>后端handler方法进行跳转操作：</p>
<pre><code class="java">@RequestMapping(&quot;/confirm/order/&#123;returnCount&#125;&quot;)
public String toConfirmOrderPage(
        @PathVariable(&quot;returnCount&quot;) Integer returnCount,
        HttpSession session ) &#123;
    
    // 从session域拿到orderProjectVO对象
    OrderProjectVO orderProjectVO = (OrderProjectVO) session.getAttribute(&quot;orderProjectVO&quot;);

    // 给orderProjectVO设置回报的数量
    orderProjectVO.setReturnCount(returnCount);

    // 重新将orderProjectVO放回session域
    session.setAttribute(&quot;orderProjectVO&quot;,orderProjectVO);

    // 获取当前的用户的Address对象（即收货地址信息）

    // 1、先得到当前的用户id
    LoginMemberVO loginMember = (LoginMemberVO)session.getAttribute(CrowdConstant.ATTR_NAME_LOGIN_MEMBER);
    Integer memberId = loginMember.getId();

    // 2、通过用户id得到他的收货地址的List
    ResultEntity&lt;List&lt;AddressVO&gt;&gt; resultEntity = mySQLRemoteService.getAddressListByMemberIdRemote(memberId);

    if (ResultEntity.SUCCESS.equals(resultEntity.getResult())) &#123;
        // 3、如果成功，则将收货地址放入session域
        List&lt;AddressVO&gt; addressVOList = resultEntity.getData();
        session.setAttribute(&quot;addressVOList&quot;, addressVOList);
    &#125;

    // 进入确认订单页面
    return &quot;order-confirm-order&quot;;
&#125;
</code></pre>
<h2 id="2、在确认订单页面显示需要的数据"><a href="#2、在确认订单页面显示需要的数据" class="headerlink" title="2、在确认订单页面显示需要的数据"></a>2、在确认订单页面显示需要的数据</h2><h3 id="显示收货信息"><a href="#显示收货信息" class="headerlink" title="显示收货信息"></a>显示收货信息</h3><p>&#96;&#96;&#96;html</p>
<div th:if="$
      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 2554163051@qq.com </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">💰</a>
</p>






    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2016-2020 Yelog
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>Help us with donation</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">alipay</label></span><span><label><input type="radio" name="pay" value="weixin">weixin</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
    #post .pjax article :not(pre) > code {
        color: #24292e;
        font-family: SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;
        background-color: rgba(27,31,35,.05);
        border-radius: 3px;
        font-size: 85%;
        margin: 0;
        padding: .2em .4em;
    }
    
</style>







</html>
